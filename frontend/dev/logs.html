<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚° - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« */
        .log-table th { background: #2c3e50; color: #fff; padding: 8px 10px; font-size: 13px; position: sticky; top: 0; z-index: 10; }
        .log-table td { padding: 5px 10px; font-size: 12px; vertical-align: top; border-bottom: 1px solid #f1f5f9; }
        .log-table tr:hover { background: #f8fafc; }
        .log-table .col-ts   { width: 160px; font-family: monospace; color: #64748b; white-space: nowrap; }
        .log-table .col-lvl  { width: 80px; text-align: center; }
        .log-table .col-svc  { width: 110px; font-family: monospace; font-size: 11px; color: #4b5563; }
        .log-table .col-msg  { font-family: monospace; word-break: break-all; }

        /* ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ */
        .lvl-error   { background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
        .lvl-warning { background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
        .lvl-info    { background:#dbeafe; color:#1e40af; border:1px solid #93c5fd; }
        .lvl-debug   { background:#f3f4f6; color:#6b7280; border:1px solid #d1d5db; }
        .lvl-badge {
            display: inline-block; padding: 1px 7px; border-radius: 10px;
            font-size: 11px; font-weight: 700;
        }
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
        .filter-btns { display: flex; gap: 6px; flex-wrap: wrap; }
        .filter-btn {
            padding: 4px 14px; border-radius: 16px; border: 1.5px solid #d1d5db;
            background: #fff; color: #374151; font-size: 13px; cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn:hover { border-color: #6b7280; background: #f9fafb; }
        .filter-btn.active-all     { border-color:#6b7280; background:#374151; color:#fff; }
        .filter-btn.active-ERROR   { border-color:#ef4444; background:#fee2e2; color:#991b1b; }
        .filter-btn.active-WARNING { border-color:#f59e0b; background:#fef3c7; color:#92400e; }
        .filter-btn.active-INFO    { border-color:#3b82f6; background:#dbeafe; color:#1e40af; }
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ */
        .filter-bar { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:14px 16px; margin-bottom:14px; }
        /* è‡ªå‹•æ›´æ–°ãƒœã‚¿ãƒ³ */
        .auto-refresh-on { background:#d1fae5 !important; border-color:#10b981 !important; color:#065f46 !important; }
        /* ã‚¨ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹ */
        .error-box { background:#fee2e2; border:1px solid #fca5a5; border-radius:8px; padding:14px 16px; color:#991b1b; margin-bottom:12px; }
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading-indicator { color:#6b7280; font-size:14px; }
        /* ãƒ­ãƒ¼ãƒ‰ãƒ¢ã‚¢ãƒœã‚¿ãƒ³ */
        #load-more-btn { margin-top: 10px; }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- å·¦å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-title">ğŸ–¥ï¸ Linuxç®¡ç†é‹ç”¨</h1>
            <p class="sidebar-subtitle">
                <span class="env-badge dev">ã€é–‹ç™ºã€‘</span>
            </p>
        </div>

        <nav class="sidebar-menu">
            <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div class="menu-item" onclick="location.href='dashboard.html'">
                <span class="menu-item-icon">ğŸ“Š</span>
                <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
            </div>

            <!-- Linuxç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>âš™ï¸</span><span>Linuxç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</div><div class="submenu-item-badge">è¨ˆç”»ä¸­</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼</div><div class="submenu-item-badge">è¨ˆç”»ä¸­</div></div>
                        <div class="submenu-item" onclick="location.href='dashboard.html?page=services'"><div class="submenu-item-name">ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒ¼ãƒãƒ¼</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item" onclick="location.href='audit.html'"><div class="submenu-item-name">ç›£æŸ»ãƒ­ã‚°</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item" onclick="location.href='dashboard.html?page=audit-log'"><div class="submenu-item-name">ã‚·ã‚¹ãƒ†ãƒ æ“ä½œãƒ­ã‚°</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒ</div><div class="submenu-item-badge">è¨ˆç”»ä¸­</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</div><div class="submenu-item-badge">è¨ˆç”»ä¸­</div></div>
                    </div>
                </div>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ  ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>ğŸ’»</span><span>ã‚·ã‚¹ãƒ†ãƒ </span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item disabled"><div class="submenu-item-name">èµ·å‹•ãƒ»ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³</div><div class="submenu-item-badge">v0.2</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ãƒ‡ã‚£ã‚¹ã‚¯ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ </div><div class="submenu-item-badge">v0.2</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ãƒ‡ã‚£ã‚¹ã‚¯ã‚¯ã‚©ãƒ¼ã‚¿</div><div class="submenu-item-badge">v0.3</div></div>
                        <div class="submenu-item" onclick="location.href='dashboard.html?page=disk'"><div class="submenu-item-name">ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ã‚£ã‚¹ã‚¯</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item" onclick="location.href='users.html'"><div class="submenu-item-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ›´æ–°</div><div class="submenu-item-badge">v0.3</div></div>
                        <div class="submenu-item" onclick="location.href='cron.html'"><div class="submenu-item-name">Cronã‚¸ãƒ§ãƒ–</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item" onclick="location.href='processes.html'"><div class="submenu-item-name">å®Ÿè¡Œä¸­ãƒ—ãƒ­ã‚»ã‚¹</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                    </div>
                </div>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚° ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item open">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>ğŸ“œ</span><span>ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item active" onclick="location.href='logs.html'"><div class="submenu-item-name">ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚«ãƒ¼ãƒãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div><div class="submenu-item-badge">v0.2</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">èªè¨¼ãƒ­ã‚°</div><div class="submenu-item-badge">v0.2</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°</div><div class="submenu-item-badge">v0.3</div></div>
                    </div>
                </div>
            </div>

            <!-- ã‚µãƒ¼ãƒãƒ¼ ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>ğŸ–¥ï¸</span><span>ã‚µãƒ¼ãƒãƒ¼</span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item" onclick="location.href='servers.html'"><div class="submenu-item-name">ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ä¸€è¦§</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">Apache Webã‚µãƒ¼ãƒãƒ¼</div><div class="submenu-item-badge">v0.4</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">MySQL / MariaDB</div><div class="submenu-item-badge">v0.4</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">PostgreSQL</div><div class="submenu-item-badge">v0.4</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">SSHã‚µãƒ¼ãƒãƒ¼</div><div class="submenu-item-badge">v0.4</div></div>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>ğŸŒ</span><span>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯</span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item" onclick="location.href='network.html'"><div class="submenu-item-name">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æƒ…å ±</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">Linuxãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«</div><div class="submenu-item-badge">v0.4</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ»ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤</div><div class="submenu-item-badge">v0.4</div></div>
                    </div>
                </div>
            </div>

            <!-- ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>ğŸ”§</span><span>ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢</span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item" onclick="location.href='hardware.html'"><div class="submenu-item-name">ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æƒ…å ±</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">SMARTãƒ‰ãƒ©ã‚¤ãƒ–çŠ¶æ…‹</div><div class="submenu-item-badge">v0.4</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚»ãƒ³ã‚µãƒ¼ (lm-sensors)</div><div class="submenu-item-badge">v0.4</div></div>
                    </div>
                </div>
            </div>

            <!-- ã‚¯ãƒ©ã‚¹ã‚¿/ãƒ„ãƒ¼ãƒ« ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>ğŸ”—</span><span>ã‚¯ãƒ©ã‚¹ã‚¿/ãƒ„ãƒ¼ãƒ«</span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚¯ãƒ©ã‚¹ã‚¿SSH</div><div class="submenu-item-badge">v0.5</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚¯ãƒ©ã‚¹ã‚¿Cronã‚¸ãƒ§ãƒ–</div><div class="submenu-item-badge">v0.5</div></div>
                        <div class="submenu-item disabled" style="text-decoration:line-through;"><div class="submenu-item-name">ã‚³ãƒãƒ³ãƒ‰ã‚·ã‚§ãƒ«</div><div class="submenu-item-badge" style="color:#ef4444;">ç¦æ­¢</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</div><div class="submenu-item-badge">v0.4</div></div>
                    </div>
                </div>
            </div>

            <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®š ã‚«ãƒ†ã‚´ãƒª -->
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>âš¡</span><span>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span></div>
                    <span class="accordion-icon">â–¼</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-submenu">
                        <div class="submenu-item" onclick="location.href='settings.html'"><div class="submenu-item-name">çµ±åˆè¨­å®š</div><div class="submenu-item-badge">å®Ÿè£…æ¸ˆã¿</div></div>
                        <div class="submenu-item disabled"><div class="submenu-item-name">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š</div><div class="submenu-item-badge">v0.3</div></div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="sidebar-footer">
            <div class="user-info" onclick="toggleUserMenu(event)">
                <div class="user-avatar"><span class="avatar-icon">ğŸ‘¤</span></div>
                <span class="user-menu-indicator">â–¼</span>
                <div class="user-menu" id="user-menu">
                    <div class="user-menu-header">
                        <span class="user-menu-icon">ğŸ‘¤</span>
                        <div class="user-menu-info">
                            <div class="user-menu-name" id="user-menu-username">-</div>
                            <div class="user-menu-role" id="user-menu-role">-</div>
                        </div>
                    </div>
                    <div class="user-menu-divider"></div>
                    <div class="user-menu-items">
                        <div class="user-menu-item">
                            <span class="user-menu-item-icon">ğŸ“§</span>
                            <span class="user-menu-item-text" id="user-menu-email">-</span>
                        </div>
                    </div>
                    <div class="user-menu-divider"></div>
                    <button class="btn btn-danger" onclick="logout(); event.stopPropagation();" style="width:100%; font-size:var(--font-size-sm);">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="main-header">
            <h2>ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h2>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-sm btn-outline-success" id="auto-refresh-btn" onclick="toggleAutoRefresh()">
                    â± è‡ªå‹•æ›´æ–°: OFF
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogs(true)">
                    ğŸ”„ æ›´æ–°
                </button>
                <a href="dashboard.html" class="btn btn-sm btn-outline-primary">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            </div>
        </div>

        <div class="main-body">

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ -->
            <div class="filter-bar">
                <div class="row g-2 align-items-end">
                    <!-- ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ -->
                    <div class="col-sm-3">
                        <label class="form-label form-label-sm mb-1">ã‚µãƒ¼ãƒ“ã‚¹å</label>
                        <select class="form-select form-select-sm" id="service-select">
                            <option value="nginx">nginx</option>
                            <option value="sshd">sshd</option>
                            <option value="systemd">systemd</option>
                            <option value="apache2">apache2</option>
                            <option value="mysql">mysql</option>
                            <option value="postgresql">postgresql</option>
                            <option value="cron">cron</option>
                            <option value="kernel">kernel</option>
                            <option value="auth">auth</option>
                        </select>
                    </div>
                    <!-- å–å¾—è¡Œæ•° -->
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">å–å¾—è¡Œæ•°</label>
                        <select class="form-select form-select-sm" id="lines-select">
                            <option value="50">50è¡Œ</option>
                            <option value="100" selected>100è¡Œ</option>
                            <option value="200">200è¡Œ</option>
                            <option value="500">500è¡Œ</option>
                        </select>
                    </div>
                    <!-- é–‹å§‹æ—¥æ™‚ -->
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">é–‹å§‹æ—¥æ™‚</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="filter-start">
                    </div>
                    <!-- çµ‚äº†æ—¥æ™‚ -->
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">çµ‚äº†æ—¥æ™‚</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="filter-end">
                    </div>
                    <!-- æ¤œç´¢ãƒœã‚¿ãƒ³ -->
                    <div class="col-sm-3">
                        <button class="btn btn-sm btn-primary w-100" onclick="fetchLogs(true)">ğŸ” ãƒ­ã‚°å–å¾—</button>
                    </div>
                </div>

                <!-- ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="mt-3 d-flex align-items-center gap-3 flex-wrap">
                    <span class="text-muted small fw-semibold">ãƒ¬ãƒ™ãƒ«çµã‚Šè¾¼ã¿:</span>
                    <div class="filter-btns">
                        <button class="filter-btn active-all" id="btn-ALL"     onclick="setLevelFilter('ALL')">ALL</button>
                        <button class="filter-btn"            id="btn-ERROR"   onclick="setLevelFilter('ERROR')">âŒ ERROR</button>
                        <button class="filter-btn"            id="btn-WARNING" onclick="setLevelFilter('WARNING')">âš ï¸ WARNING</button>
                        <button class="filter-btn"            id="btn-INFO"    onclick="setLevelFilter('INFO')">â„¹ï¸ INFO</button>
                    </div>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
            <div id="error-container"></div>

            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
            <div id="loading-indicator" class="text-center py-3" style="display:none;">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>èª­ã¿è¾¼ã¿ä¸­...
            </div>

            <!-- çµ±è¨ˆè¡Œ -->
            <div id="stats-row" class="d-flex gap-3 mb-2 small text-muted" style="display:none!important;"></div>

            <!-- ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div id="log-container" style="display:none;">
                <div class="table-responsive" style="max-height:560px; overflow-y:auto;">
                    <table class="table table-sm log-table">
                        <thead>
                            <tr>
                                <th class="col-ts">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</th>
                                <th class="col-lvl">ãƒ¬ãƒ™ãƒ«</th>
                                <th class="col-svc">ã‚µãƒ¼ãƒ“ã‚¹</th>
                                <th class="col-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                            </tr>
                        </thead>
                        <tbody id="log-tbody"></tbody>
                    </table>
                </div>
                <div class="text-center" id="load-more-area" style="display:none;">
                    <button class="btn btn-sm btn-outline-secondary" id="load-more-btn" onclick="loadMore()">
                        â• ã‚‚ã£ã¨èª­ã¿è¾¼ã‚€
                    </button>
                </div>
                <div class="text-muted small mt-1" id="log-count-label"></div>
            </div>

            <!-- ç©ºçŠ¶æ…‹ -->
            <div id="empty-state" class="text-center py-5 text-muted" style="display:none;">
                <p>ğŸ“œ è¡¨ç¤ºã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
                <p class="small">ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ã€Œãƒ­ã‚°å–å¾—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
            </div>

        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>
'use strict';

// ===== èªè¨¼ãƒã‚§ãƒƒã‚¯ =====
const token = localStorage.getItem('access_token');
if (!token) { window.location.href = 'dashboard.html'; }

// ===== çŠ¶æ…‹ç®¡ç† =====
let allParsedLogs  = [];   // å…¨ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ­ã‚°
let filteredLogs   = [];   // ãƒ•ã‚£ãƒ«ã‚¿å¾Œãƒ­ã‚°
let displayedCount = 0;
const PAGE_SIZE    = 100;
let levelFilter    = 'ALL';
let autoRefreshTimer = null;
let currentService = '';

// ===== HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— =====
function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// ===== ãƒ­ã‚°è¡Œã®ãƒ‘ãƒ¼ã‚¹ =====
// syslog: "Mar 10 12:34:56 host svc[pid]: msg"
// journald: "2024-03-10T12:34:56+09:00 host svc[pid]: msg"
// systemd: "Mar 10 12:34:56 svc[pid]: msg"
function parseLogLine(line, serviceName) {
    let timestamp = '';
    let level     = 'INFO';
    let service   = serviceName || '';
    let message   = line;

    // ISO timestamp
    const isoMatch = line.match(/^(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}[^\s]*)/);
    if (isoMatch) {
        timestamp = isoMatch[1];
        message   = line.slice(isoMatch[0].length).trim();
    }
    // Syslog timestamp: "Jan  1 12:34:56" or "Mar 10 12:34:56"
    else {
        const syslogMatch = line.match(/^([A-Za-z]{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2})/);
        if (syslogMatch) {
            timestamp = syslogMatch[1];
            message   = line.slice(syslogMatch[0].length).trim();
        }
    }

    // Extract service from "hostname svc[pid]:" or "svc[pid]:"
    const svcMatch = message.match(/^[\w.-]+\s+([\w./@-]+)(?:\[\d+\])?:\s*/);
    if (svcMatch) {
        service = svcMatch[1];
        message = message.slice(svcMatch[0].length);
    } else {
        const svcMatch2 = message.match(/^([\w./@-]+)(?:\[\d+\])?:\s*/);
        if (svcMatch2) {
            service = svcMatch2[1];
            message = message.slice(svcMatch2[0].length);
        }
    }

    // Detect log level
    if (/\b(error|err|critical|crit|fatal|emerg|alert)\b/i.test(message) ||
        /\b(ERROR|CRITICAL|FATAL|EMERG)\b/.test(message)) {
        level = 'ERROR';
    } else if (/\b(warn(?:ing)?)\b/i.test(message) || /\bWARN(?:ING)?\b/.test(message)) {
        level = 'WARNING';
    } else if (/\b(debug)\b/i.test(message) || /\bDEBUG\b/.test(message)) {
        level = 'DEBUG';
    } else {
        level = 'INFO';
    }

    return { timestamp, level, service: service || serviceName, message, raw: line };
}

// ===== ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ HTML =====
function levelBadge(level) {
    const cls = {
        ERROR:   'lvl-error',
        WARNING: 'lvl-warning',
        INFO:    'lvl-info',
        DEBUG:   'lvl-debug',
    }[level] || 'lvl-debug';
    return `<span class="lvl-badge ${cls}">${escapeHtml(level)}</span>`;
}

// ===== æ™‚é–“ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ =====
function matchesTimeRange(log) {
    const startStr = document.getElementById('filter-start').value;
    const endStr   = document.getElementById('filter-end').value;
    if (!startStr && !endStr) return true;
    if (!log.timestamp) return true;
    try {
        const ts = new Date(log.timestamp);
        if (startStr && ts < new Date(startStr)) return false;
        if (endStr   && ts > new Date(endStr))   return false;
    } catch(e) { return true; }
    return true;
}

// ===== ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ =====
function applyFilters() {
    filteredLogs = allParsedLogs.filter(log => {
        if (levelFilter !== 'ALL' && log.level !== levelFilter) return false;
        if (!matchesTimeRange(log)) return false;
        return true;
    });
    displayedCount = 0;
    renderLogs();
}

// ===== ãƒ­ã‚°è¡Œæç”» =====
function renderLogs() {
    const tbody    = document.getElementById('log-tbody');
    const logCont  = document.getElementById('log-container');
    const empty    = document.getElementById('empty-state');
    const countLbl = document.getElementById('log-count-label');
    const moreArea = document.getElementById('load-more-area');

    if (filteredLogs.length === 0) {
        logCont.style.display = 'none';
        empty.style.display   = 'block';
        return;
    }

    logCont.style.display = 'block';
    empty.style.display   = 'none';

    const slice   = filteredLogs.slice(displayedCount, displayedCount + PAGE_SIZE);
    const isReset = displayedCount === 0;
    if (isReset) tbody.innerHTML = '';

    const frag = document.createDocumentFragment();
    slice.forEach(log => {
        const tr = document.createElement('tr');

        const tdTs = document.createElement('td');
        tdTs.className = 'col-ts';
        tdTs.textContent = log.timestamp || 'â€”';
        tr.appendChild(tdTs);

        const tdLvl = document.createElement('td');
        tdLvl.className = 'col-lvl';
        tdLvl.innerHTML = levelBadge(log.level);
        tr.appendChild(tdLvl);

        const tdSvc = document.createElement('td');
        tdSvc.className = 'col-svc';
        tdSvc.textContent = log.service || 'â€”';
        tr.appendChild(tdSvc);

        const tdMsg = document.createElement('td');
        tdMsg.className = 'col-msg';
        tdMsg.textContent = log.message;
        tr.appendChild(tdMsg);

        frag.appendChild(tr);
    });
    tbody.appendChild(frag);

    displayedCount += slice.length;
    const total = filteredLogs.length;
    countLbl.textContent = `è¡¨ç¤º: ${displayedCount} / ${total} ä»¶`;
    moreArea.style.display = displayedCount < total ? 'block' : 'none';
}

// ===== ã‚‚ã£ã¨èª­ã¿è¾¼ã‚€ =====
function loadMore() { renderLogs(); }

// ===== ãƒ­ã‚°å–å¾— =====
async function fetchLogs(resetDisplay) {
    const serviceName = document.getElementById('service-select').value;
    const lines       = parseInt(document.getElementById('lines-select').value, 10);
    if (!serviceName) { showError('ã‚µãƒ¼ãƒ“ã‚¹åã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

    currentService = serviceName;
    clearError();
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('log-container').style.display     = 'none';
    document.getElementById('empty-state').style.display       = 'none';

    try {
        const response = await fetch(
            `${window.location.origin}/api/logs/${encodeURIComponent(serviceName)}?lines=${lines}`,
            { headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` } }
        );

        if (response.status === 401) {
            localStorage.removeItem('access_token');
            window.location.href = 'dashboard.html';
            return;
        }
        if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.detail || `HTTPã‚¨ãƒ©ãƒ¼ ${response.status}`);
        }

        const data = await response.json();
        const rawLines = data.logs || [];

        allParsedLogs = rawLines.map(line => parseLogLine(line, serviceName));

        if (resetDisplay) {
            displayedCount = 0;
        }
        applyFilters();

    } catch (err) {
        showError(`ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(err.message)}`);
    } finally {
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

// ===== ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆ =====
function setLevelFilter(level) {
    levelFilter = level;
    ['ALL','ERROR','WARNING','INFO'].forEach(l => {
        const btn = document.getElementById('btn-' + l);
        if (!btn) return;
        btn.className = 'filter-btn' + (l === level ? ` active-${l}` : '');
    });
    applyFilters();
}

// ===== è‡ªå‹•æ›´æ–° =====
function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        btn.textContent = 'â± è‡ªå‹•æ›´æ–°: OFF';
        btn.classList.remove('auto-refresh-on');
    } else {
        autoRefreshTimer = setInterval(() => fetchLogs(true), 10000);
        btn.textContent = 'â± è‡ªå‹•æ›´æ–°: ON (10ç§’)';
        btn.classList.add('auto-refresh-on');
        fetchLogs(true);
    }
}

// ===== ã‚¨ãƒ©ãƒ¼è¡¨ç¤º =====
function showError(msg) {
    const c = document.getElementById('error-container');
    c.innerHTML = `<div class="error-box">âš ï¸ ${escapeHtml(msg)}</div>`;
}
function clearError() {
    document.getElementById('error-container').innerHTML = '';
}

// ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
function logout() {
    localStorage.removeItem('access_token');
    window.location.href = 'dashboard.html';
}

// ===== åˆæœŸåŒ– =====
document.addEventListener('DOMContentLoaded', () => {
    if (typeof restoreAccordionState === 'function') {
        restoreAccordionState();
    }
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    if (typeof api !== 'undefined') {
        api.request('GET', '/api/auth/me').then(data => {
            const u = data.user || data;
            const nameEl  = document.getElementById('user-menu-username');
            const roleEl  = document.getElementById('user-menu-role');
            const emailEl = document.getElementById('user-menu-email');
            if (nameEl)  nameEl.textContent  = u.username || '-';
            if (roleEl)  roleEl.textContent  = u.role     || '-';
            if (emailEl) emailEl.textContent = u.email    || '-';
        }).catch(() => {});
    }
});
</script>
</body>
</html>
