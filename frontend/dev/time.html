<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»ç®¡ç† - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .time-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .time-title { font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 14px; }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }
        .metric-item {
            background: #f9fafb;
            border-radius: 6px;
            padding: 12px 16px;
        }
        .metric-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; }
        .metric-value { font-size: 15px; font-weight: bold; color: #111827; word-break: break-all; }
        .ntp-synced { color: #059669; }
        .ntp-unsynced { color: #dc2626; }
        .tz-search { max-width: 300px; }
        .tz-list { max-height: 260px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; }
        .tz-item {
            padding: 7px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
        }
        .tz-item:hover { background: #eff6ff; }
        .tz-item.selected { background: #dbeafe; font-weight: bold; }
        .tz-item:last-child { border-bottom: none; }
        .admin-only-badge {
            background: #fef3c7;
            color: #92400e;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        .nav-tabs .nav-link { cursor: pointer; color: #374151; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #2563eb; }
        .clock-display {
            font-size: 36px;
            font-weight: 700;
            color: #1d4ed8;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸ• ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»ç®¡ç†</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="time-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('status')" id="tab-status">ğŸ• ç¾åœ¨æ™‚åˆ»</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('timezone')" id="tab-timezone">
                        ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›´
                        <span class="admin-only-badge ms-1">Admin</span>
                    </a>
                </li>
            </ul>

            <!-- â”€â”€ TAB: ç¾åœ¨æ™‚åˆ»ãƒ»çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="pane-status">
                <!-- ãƒ©ã‚¤ãƒ–ã‚¯ãƒ­ãƒƒã‚¯ -->
                <div class="time-card text-center mb-3">
                    <div class="metric-label mb-2">ã‚·ã‚¹ãƒ†ãƒ ç¾åœ¨æ™‚åˆ»ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼‰</div>
                    <div class="clock-display" id="live-clock">--:--:--</div>
                    <div class="text-muted small mt-1" id="live-date">----/--/--</div>
                    <div class="text-muted small" id="live-tz">Timezone: ...</div>
                </div>

                <!-- ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»è©³ç´° -->
                <div class="time-card" id="time-status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="time-title">ğŸ“Š æ™‚åˆ»ãƒ»NTP çŠ¶æ…‹è©³ç´°</div>
                        <span id="status-loading" class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                    <div class="metric-grid" id="time-status-grid">
                        <!-- JS ã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- â”€â”€ TAB: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›´ï¼ˆAdmin ã®ã¿ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="pane-timezone" style="display:none">
                <div class="alert alert-warning d-flex align-items-center mb-3">
                    <span class="me-2" style="font-size:20px">âš ï¸</span>
                    <div>
                        ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›´ã¯ <strong>Admin æ¨©é™</strong> ãŒå¿…è¦ã§ã™ã€‚
                        å¤‰æ›´ã™ã‚‹ã¨ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ™‚åˆ»è¡¨ç¤ºã«å½±éŸ¿ã—ã¾ã™ã€‚
                    </div>
                </div>

                <div class="time-card">
                    <div class="time-title">ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³é¸æŠ</div>
                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label fw-semibold small">ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æ¤œç´¢</label>
                            <input
                                type="text"
                                class="form-control form-control-sm tz-search mb-2"
                                id="tz-search"
                                placeholder="ä¾‹: Asia, Tokyo, UTC..."
                                oninput="filterTimezones()"
                            >
                            <div class="tz-list" id="tz-list">
                                <div class="text-muted small p-3">èª­ã¿è¾¼ã¿ä¸­...</div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <label class="form-label fw-semibold small">é¸æŠä¸­ã®ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</label>
                            <div class="metric-item mb-3">
                                <div class="metric-value" id="selected-tz-display">é¸æŠã—ã¦ãã ã•ã„</div>
                            </div>

                            <label class="form-label fw-semibold small">å¤‰æ›´ç†ç”±ï¼ˆå¿…é ˆï¼‰</label>
                            <input
                                type="text"
                                class="form-control form-control-sm mb-3"
                                id="tz-reason"
                                placeholder="ä¾‹: ã‚µãƒ¼ãƒãƒ¼ç§»è»¢ã«ä¼´ã„ JST ã«å¤‰æ›´"
                                maxlength="500"
                            >

                            <button
                                class="btn btn-primary btn-sm"
                                onclick="applyTimezone()"
                                id="tz-apply-btn"
                                disabled
                            >
                                ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’å¤‰æ›´ã™ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- /.main-body -->
    </main>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
    <script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('time')):renderSidebar('time');</script>
<script src="../js/components.js"></script>
<script>
// ===================================================================
// System Time ç®¡ç†ãƒšãƒ¼ã‚¸
// ===================================================================

const API_BASE = '/api';
let allTimezones = [];
let selectedTimezone = '';
let clockInterval = null;
let currentTzOffset = 0;

// â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    if (typeof initSidebar === 'function') initSidebar();
    loadTimeStatus();
    startLiveClock();
});

// â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tab) {
    ['status', 'timezone'].forEach(t => {
        document.getElementById(`pane-${t}`).style.display = t === tab ? '' : 'none';
        document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    });
    if (tab === 'timezone' && allTimezones.length === 0) loadTimezones();
}

// â”€â”€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¯ãƒ­ãƒƒã‚¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startLiveClock() {
    function tick() {
        const now = new Date();
        const hms = now.toLocaleTimeString('ja-JP', { hour12: false });
        const ymd = now.toLocaleDateString('ja-JP', {
            year: 'numeric', month: '2-digit', day: '2-digit',
        });
        document.getElementById('live-clock').textContent = hms;
        document.getElementById('live-date').textContent = ymd;
    }
    tick();
    clockInterval = setInterval(tick, 1000);
}

// â”€â”€ æ™‚åˆ»çŠ¶æ…‹å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTimeStatus() {
    const loading = document.getElementById('status-loading');
    loading.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';

    try {
        const data = await apiGet(`${API_BASE}/time/status`);
        renderTimeStatus(data.data || data);
        loading.textContent = '';
    } catch (err) {
        loading.textContent = '';
        showAlert('danger', `æ™‚åˆ»çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
    }
}

function renderTimeStatus(d) {
    const grid = document.getElementById('time-status-grid');
    const tzEl = document.getElementById('live-tz');
    if (d.timezone) tzEl.textContent = `Timezone: ${d.timezone}`;

    const ntpStatus = d.ntp_synchronized === 'yes'
        ? '<span class="ntp-synced">âœ… åŒæœŸæ¸ˆã¿</span>'
        : '<span class="ntp-unsynced">âš ï¸ æœªåŒæœŸ</span>';

    const metrics = [
        { label: 'ğŸ• ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»', value: escapeHtml(d.system_time || 'N/A') },
        { label: 'ğŸŒ UTC æ™‚åˆ»', value: escapeHtml(d.utc_time || 'N/A') },
        { label: 'ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³', value: escapeHtml(d.timezone || 'N/A') },
        { label: 'ğŸ”„ NTP åŒæœŸ', value: ntpStatus },
        { label: 'âš™ï¸ NTP ã‚µãƒ¼ãƒ“ã‚¹', value: escapeHtml(d.ntp_service || 'N/A') },
        { label: 'ğŸ–¥ï¸ RTC æ™‚åˆ»', value: escapeHtml(d.rtc_time || 'N/A') },
    ];

    grid.innerHTML = metrics.map(m => `
        <div class="metric-item">
            <div class="metric-label">${m.label}</div>
            <div class="metric-value">${m.value}</div>
        </div>
    `).join('');
}

// â”€â”€ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¸€è¦§å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTimezones() {
    const list = document.getElementById('tz-list');
    list.innerHTML = '<div class="text-muted small p-3">èª­ã¿è¾¼ã¿ä¸­...</div>';

    try {
        const data = await apiGet(`${API_BASE}/time/timezones`);
        allTimezones = (data.data && data.data.timezones) ? data.data.timezones : [];
        renderTimezoneList(allTimezones);
    } catch (err) {
        list.innerHTML = `<div class="text-danger small p-3">å–å¾—å¤±æ•—: ${escapeHtml(err.message)}</div>`;
    }
}

function renderTimezoneList(timezones) {
    const list = document.getElementById('tz-list');
    list.innerHTML = timezones.map(tz => `
        <div class="tz-item ${tz === selectedTimezone ? 'selected' : ''}"
             onclick="selectTimezone('${escapeHtml(tz)}')">${escapeHtml(tz)}</div>
    `).join('') || '<div class="text-muted small p-3">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
}

function filterTimezones() {
    const q = document.getElementById('tz-search').value.toLowerCase();
    const filtered = allTimezones.filter(tz => tz.toLowerCase().includes(q));
    renderTimezoneList(filtered);
}

function selectTimezone(tz) {
    selectedTimezone = tz;
    document.getElementById('selected-tz-display').textContent = tz;
    document.getElementById('tz-apply-btn').disabled = false;
    // ãƒªã‚¹ãƒˆå†…é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.tz-item').forEach(el => {
        el.classList.toggle('selected', el.textContent === tz);
    });
}

// â”€â”€ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›´å®Ÿè¡Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function applyTimezone() {
    const reason = document.getElementById('tz-reason').value.trim();

    if (!selectedTimezone) {
        showAlert('warning', 'ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    if (!reason) {
        showAlert('warning', 'å¤‰æ›´ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    const btn = document.getElementById('tz-apply-btn');
    btn.disabled = true;
    btn.textContent = 'å¤‰æ›´ä¸­...';

    try {
        const result = await apiPost(`${API_BASE}/time/timezone`, {
            timezone: selectedTimezone,
            reason,
        });

        showAlert('success', `âœ… ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ <strong>${escapeHtml(selectedTimezone)}</strong> ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        // æ™‚åˆ»çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿
        await loadTimeStatus();
    } catch (err) {
        showAlert('danger', `âŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’å¤‰æ›´ã™ã‚‹';
    }
}

// â”€â”€ å…¨æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAll() {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true;
    btn.textContent = 'æ›´æ–°ä¸­...';

    loadTimeStatus().finally(() => {
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ æ›´æ–°';
    });
}

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

function showAlert(type, msg) {
    const area = document.getElementById('alert-area');
    area.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${msg}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

async function apiGet(url) {
    const token = localStorage.getItem('access_token');
    const resp = await fetch(url, {
        headers: token ? { Authorization: `Bearer ${token}` } : {},
    });
    if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: resp.statusText }));
        throw new Error(err.detail || `HTTP ${resp.status}`);
    }
    return resp.json();
}

async function apiPost(url, body) {
    const token = localStorage.getItem('access_token');
    const resp = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
        },
        body: JSON.stringify(body),
    });
    if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: resp.statusText }));
        throw new Error(err.detail || `HTTP ${resp.status}`);
    }
    return resp.json();
}
</script>
</body>
</html>
