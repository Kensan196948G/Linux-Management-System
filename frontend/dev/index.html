<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€é–‹ç™ºã€‘Linux Management System - ãƒ­ã‚°ã‚¤ãƒ³</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center;">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ -->
    <div class="card" style="max-width: 450px; width: 100%; margin: 2rem;">
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ–¥ï¸ Linuxç®¡ç†é‹ç”¨ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p style="color: var(--text-secondary);">
                <span class="env-badge dev">ã€é–‹ç™ºã€‘</span>
            </p>
        </div>

        <h2 class="card-title" style="text-align: center;">ãƒ­ã‚°ã‚¤ãƒ³</h2>

        <div id="login-alerts"></div>

        <form id="login-form">
            <div class="form-group">
                <label class="form-label" for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input type="email" class="form-input" id="email" value="operator@example.com" required autocomplete="username">
            </div>
            <div class="form-group">
                <label class="form-label" for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" class="form-input" id="password" value="operator123" required autocomplete="current-password">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">ãƒ­ã‚°ã‚¤ãƒ³</button>
        </form>

        <div style="margin-top: 1.5rem; padding: 1rem; background-color: #f1f5f9; border-radius: 6px;">
            <p style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.5rem;">é–‹ç™ºç’°å¢ƒç”¨ãƒ‡ãƒ¢ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:</p>
            <ul style="font-size: 0.875rem; color: var(--text-secondary); margin: 0; list-style: none; padding: 0;">
                <li style="padding: 0.25rem 0;">ğŸ‘ï¸ viewer@example.com / viewer123 (Viewer)</li>
                <li style="padding: 0.25rem 0;">âš™ï¸ operator@example.com / operator123 (Operator)</li>
                <li style="padding: 0.25rem 0;">ğŸ”§ admin@example.com / admin123 (Admin)</li>
            </ul>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="../js/api.js"></script>
    <script>
        // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤ï¼ˆCRITICAL BUG FIXï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            console.log('=== Login Page Initialized ===');

            // å¤ã„ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢ï¼ˆæœŸé™åˆ‡ã‚Œå¯¾ç­–ï¼‰
            // ãŸã ã—ã€ç›´å‰ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒãƒƒã‚¯ï¼‰ã¯ä¿æŒ
            const existingToken = localStorage.getItem('access_token');
            if (existingToken) {
                console.log('Found existing token, checking validity...');
                // ã™ãã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã£ã¦ããŸå ´åˆã¯ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒªã‚¢
                // ï¼ˆæœŸé™åˆ‡ã‚Œã¾ãŸã¯ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
                const lastLoginTime = sessionStorage.getItem('last_login_time');
                const now = Date.now();
                if (!lastLoginTime || (now - parseInt(lastLoginTime)) > 5000) {
                    // 5ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹ã€ã¾ãŸã¯åˆå›è¨ªå•ãªã‚‰ã‚¯ãƒªã‚¢
                    console.log('Clearing old/expired token...');
                    localStorage.removeItem('access_token');
                } else {
                    console.log('Recent login detected, keeping token');
                }
            } else {
                console.log('No existing token found');
            }

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®å‡¦ç†
            document.getElementById('login-form').addEventListener('submit', async (event) => {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const alertsEl = document.getElementById('login-alerts');
            const submitBtn = event.target.querySelector('button[type="submit"]');

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            submitBtn.disabled = true;
            submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

            try {
                console.log('Attempting login for:', email);

                // ãƒ­ã‚°ã‚¤ãƒ³
                const result = await api.login(email, password);

                console.log('Login successful:', result);

                // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
                alertsEl.innerHTML = '<div class="alert alert-success">âœ… ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç§»å‹•ã—ã¾ã™...</div>';

                // LocalStorageã¸ã®ä¿å­˜ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã€å°‘ã—å¾…æ©Ÿï¼ˆEdgeå¯¾ç­–ï¼‰
                console.log('Verifying token storage...');
                const storedToken = localStorage.getItem('access_token');
                if (!storedToken) {
                    console.error('âŒ Token not saved to localStorage!');
                    alertsEl.innerHTML = '<div class="alert alert-error">âŒ ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
                    return;
                }
                console.log('âœ… Token verified in localStorage (first 50 chars):', storedToken.substring(0, 50));

                // ãƒ­ã‚°ã‚¤ãƒ³æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒãƒƒã‚¯æ¤œçŸ¥ç”¨ï¼‰
                sessionStorage.setItem('last_login_time', Date.now().toString());
                console.log('âœ… Login timestamp saved to sessionStorage');

                // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆEdgeå¯¾ç­–ã§1.5ç§’ã«å»¶é•·ï¼‰
                setTimeout(() => {
                    console.log('Redirecting to dashboard...');
                    // Edgeå¯¾ç­–: å¼·åˆ¶çš„ã«ãƒšãƒ¼ã‚¸ã‚’å®Œå…¨ãƒªãƒ­ãƒ¼ãƒ‰
                    window.location.replace('/dev/dashboard.html');
                }, 1500);

            } catch (error) {
                console.error('Login failed:', error);
                alertsEl.innerHTML = `<div class="alert alert-error">âŒ ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message || 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼'}</div>`;

                // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
            }
        });

        // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        if (api.isAuthenticated()) {
            console.log('Already authenticated, checking token validity...');
            api.getCurrentUser().then((user) => {
                console.log('Token valid, redirecting to dashboard...', user);
                window.location.href = '/dev/dashboard.html';
            }).catch((error) => {
                // ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ãªå ´åˆã¯ã‚¯ãƒªã‚¢
                console.warn('Token invalid, clearing...', error);
                api.clearToken();
                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                window.location.reload();
            });
        } else {
            console.log('Not authenticated, showing login form');
        }
        }); // End of DOMContentLoaded
    </script>
</body>
</html>
