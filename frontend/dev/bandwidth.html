<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¯åŸŸå¹…ç›£è¦– - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 20px; margin-bottom: 16px; }
        .status-title { font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 14px; }
        .metric-val { font-size: 24px; font-weight: bold; color: #1e293b; }
        .metric-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .tbl th { font-size: 12px; color: #6b7280; font-weight: 600; }
        .tbl td { font-size: 13px; vertical-align: middle; }
        .unavail-notice { background:#fefce8; border:1px solid #fde047; border-radius:8px; padding:12px; color:#713f12; font-size:13px; }
        .iface-tab.active { background: #2563eb; color: white; border-color: #2563eb; }
        .live-meter { height: 20px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
        .live-bar-rx { height: 100%; background: #10b981; transition: width 0.5s; }
        .live-bar-tx { height: 100%; background: #3b82f6; transition: width 0.5s; }
    </style>
</head>
<body>
<div class="wrapper">
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div class="container-fluid py-4">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h1 class="h4 mb-0">ğŸ“Š å¸¯åŸŸå¹…ç›£è¦–</h1>
                    <p class="text-muted small mb-0">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¸¯åŸŸå¹…ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ»å±¥æ­´ç›£è¦–</p>
                </div>
                <div class="d-flex gap-2">
                    <select id="ifaceSelect" class="form-select form-select-sm" style="width:auto" onchange="onIfaceChange()">
                        <option value="">å…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</option>
                    </select>
                    <button class="btn btn-outline-primary btn-sm" onclick="loadAll()">ğŸ”„ æ›´æ–°</button>
                </div>
            </div>

            <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¸¯åŸŸå¹… -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="status-title mb-0">âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¸¯åŸŸå¹…</div>
                    <div class="d-flex gap-2 align-items-center">
                        <div class="form-check form-switch mb-0">
                            <input class="form-check-input" type="checkbox" id="autoRefresh">
                            <label class="form-check-label small" for="autoRefresh">è‡ªå‹•æ›´æ–° (3ç§’)</label>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadLive()">ğŸ”„</button>
                    </div>
                </div>
                <div id="liveBody">
                    <div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- ã‚µãƒãƒª -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">ğŸ“ˆ å¸¯åŸŸå¹…ã‚µãƒãƒª</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadSummary()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="summaryBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>

            <!-- å…¨IFãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">ğŸŒ å…¨IFãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadTop()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="topBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>

            <!-- æ—¥åˆ¥çµ±è¨ˆ -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">ğŸ“… æ—¥åˆ¥çµ±è¨ˆ (vnstat)</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadDaily()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="dailyBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>

            <!-- æ™‚é–“åˆ¥çµ±è¨ˆ -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">ğŸ• æ™‚é–“åˆ¥çµ±è¨ˆ (vnstat)</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadHourly()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="hourlyBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>
        </div>
    </div>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>
let autoRefreshTimer = null;
const token = () => localStorage.getItem('access_token');
const iface = () => document.getElementById('ifaceSelect').value;

async function apiFetch(path) {
    const resp = await fetch(path, { headers: { 'Authorization': 'Bearer ' + token() } });
    if (resp.status === 401 || resp.status === 403) { window.location.href = '/dev/index.html'; return null; }
    if (!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
    return resp.json();
}

function fmtBytes(b) {
    if (!b) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let i = 0;
    while (b >= 1024 && i < units.length - 1) { b /= 1024; i++; }
    return b.toFixed(1) + ' ' + units[i];
}

async function loadInterfaces() {
    try {
        const d = await apiFetch('/api/bandwidth/interfaces');
        const sel = document.getElementById('ifaceSelect');
        (d.interfaces || []).forEach(name => {
            if (name === 'lo') return;
            const opt = document.createElement('option');
            opt.value = name;
            opt.text = name;
            sel.appendChild(opt);
        });
    } catch(e) { console.warn('iface list:', e); }
}

async function loadLive() {
    const el = document.getElementById('liveBody');
    const q = iface() ? `?iface=${iface()}` : '';
    try {
        const d = await apiFetch('/api/bandwidth/live' + q);
        el.innerHTML = `
        <div class="row g-3">
            <div class="col-md-4">
                <div class="metric-label">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</div>
                <div class="metric-val" style="font-size:18px">${d.interface || '-'}</div>
            </div>
            <div class="col-md-4">
                <div class="metric-label">å—ä¿¡ (RX)</div>
                <div class="metric-val text-success">${d.rx_kbps} KB/s</div>
                <div class="live-meter mt-1"><div class="live-bar-rx" style="width:${Math.min(100, d.rx_kbps/100)}%"></div></div>
            </div>
            <div class="col-md-4">
                <div class="metric-label">é€ä¿¡ (TX)</div>
                <div class="metric-val text-primary">${d.tx_kbps} KB/s</div>
                <div class="live-meter mt-1"><div class="live-bar-tx" style="width:${Math.min(100, d.tx_kbps/100)}%"></div></div>
            </div>
        </div>
        <div class="text-muted small mt-2">æœ€çµ‚æ›´æ–°: ${d.timestamp}</div>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadSummary() {
    const el = document.getElementById('summaryBody');
    const q = iface() ? `?iface=${iface()}` : '';
    try {
        const d = await apiFetch('/api/bandwidth/summary' + q);
        if (d.status === 'unavailable') {
            el.innerHTML = `<div class="unavail-notice">âš ï¸ ${d.message || 'vnstat ãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã™'}</div>`;
            return;
        }
        if (d.rx_bytes !== null && d.rx_bytes !== undefined) {
            el.innerHTML = `
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="metric-label">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</div>
                    <div class="metric-val" style="font-size:16px">${d.interface || '-'}</div>
                </div>
                <div class="col-md-4">
                    <div class="metric-label">ç´¯ç©å—ä¿¡</div>
                    <div class="metric-val text-success">${fmtBytes(d.rx_bytes)}</div>
                </div>
                <div class="col-md-4">
                    <div class="metric-label">ç´¯ç©é€ä¿¡</div>
                    <div class="metric-val text-primary">${fmtBytes(d.tx_bytes)}</div>
                </div>
            </div>`;
        } else {
            el.innerHTML = `<pre class="small" style="max-height:200px;overflow:auto">${JSON.stringify(d.data || d, null, 2)}</pre>`;
        }
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadTop() {
    const el = document.getElementById('topBody');
    try {
        const d = await apiFetch('/api/bandwidth/top');
        if (!d.interfaces || d.interfaces.length === 0) {
            el.innerHTML = '<div class="text-muted small">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            return;
        }
        const rows = d.interfaces.map(i =>
            `<tr><td><strong>${i.interface}</strong></td><td class="text-success">${fmtBytes(i.rx_bytes)}</td><td class="text-primary">${fmtBytes(i.tx_bytes)}</td></tr>`
        ).join('');
        el.innerHTML = `<div class="table-responsive"><table class="table table-sm tbl">
            <thead><tr><th>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</th><th>ç´¯ç©å—ä¿¡</th><th>ç´¯ç©é€ä¿¡</th></tr></thead>
            <tbody>${rows}</tbody>
        </table></div>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadDaily() {
    const el = document.getElementById('dailyBody');
    const q = iface() ? `?iface=${iface()}` : '';
    try {
        const d = await apiFetch('/api/bandwidth/daily' + q);
        if (d.status === 'unavailable') {
            el.innerHTML = `<div class="unavail-notice">âš ï¸ ${d.message || 'vnstat ãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã™'}</div>`;
            return;
        }
        el.innerHTML = `<pre class="small" style="max-height:200px;overflow:auto">${JSON.stringify(d.data || {}, null, 2)}</pre>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadHourly() {
    const el = document.getElementById('hourlyBody');
    const q = iface() ? `?iface=${iface()}` : '';
    try {
        const d = await apiFetch('/api/bandwidth/hourly' + q);
        if (d.status === 'unavailable') {
            el.innerHTML = `<div class="unavail-notice">âš ï¸ ${d.message || 'vnstat ãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã™'}</div>`;
            return;
        }
        el.innerHTML = `<pre class="small" style="max-height:200px;overflow:auto">${JSON.stringify(d.data || {}, null, 2)}</pre>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

function loadAll() {
    loadLive();
    loadSummary();
    loadTop();
    loadDaily();
    loadHourly();
}

function onIfaceChange() { loadAll(); }

document.getElementById('autoRefresh').addEventListener('change', function() {
    if (this.checked) {
        autoRefreshTimer = setInterval(loadLive, 3000);
    } else {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
});

window.addEventListener('DOMContentLoaded', async () => {
    if (typeof loadSidebar === 'function') loadSidebar('bandwidth');
    await loadInterfaces();
    loadAll();
});
</script>
</body>
</html>
