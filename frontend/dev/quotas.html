<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚£ã‚¹ã‚¯ã‚¯ã‚©ãƒ¼ã‚¿ç®¡ç† - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .status-title { font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 14px; }
        .quota-table th { font-size: 12px; color: #6b7280; font-weight: 600; }
        .quota-table td { font-size: 13px; vertical-align: middle; }
        .usage-bar { width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; }
        .usage-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .usage-ok { background: #10b981; }
        .usage-warn { background: #f59e0b; }
        .usage-over { background: #ef4444; }
        .badge-ok { background-color: #d1fae5; color: #065f46; }
        .badge-warn { background-color: #fef3c7; color: #92400e; }
        .badge-over { background-color: #fee2e2; color: #991b1b; }
        .badge-unavail { background-color: #f3f4f6; color: #6b7280; }
        .form-label-sm { font-size: 13px; color: #374151; }
        .quota-set-card {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .unavailable-notice {
            background: #fefce8;
            border: 1px solid #fde047;
            border-radius: 8px;
            padding: 16px;
            color: #713f12;
        }
    </style>
</head>
<body>
<div class="wrapper">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div id="sidebar-container"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="container-fluid py-3">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-0">ãƒ‡ã‚£ã‚¹ã‚¯ã‚¯ã‚©ãƒ¼ã‚¿ç®¡ç†</h4>
                    <p class="text-muted small mb-0">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡åˆ¶é™ã‚’ç®¡ç†ã—ã¾ã™</p>
                </div>
                <div class="d-flex gap-2">
                    <select id="fsFilter" class="form-select form-select-sm" style="width:160px;">
                        <option value="">å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ </option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()">
                        <i class="bi bi-arrow-clockwise"></i> æ›´æ–°
                    </button>
                </div>
            </div>

            <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="alertArea"></div>

            <!-- ã‚¯ã‚©ãƒ¼ã‚¿æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é€šçŸ¥ -->
            <div id="unavailableNotice" class="unavailable-notice d-none">
                <strong>âš ï¸ quota ãƒ„ãƒ¼ãƒ«æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</strong>
                <p class="mb-0 mt-1 small">ãƒ‡ã‚£ã‚¹ã‚¯ã‚¯ã‚©ãƒ¼ã‚¿æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ <code>quota</code> ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã§ã™ã€‚<br>
                <code>sudo apt-get install quota</code> ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <!-- ã‚¿ãƒ– -->
            <ul class="nav nav-tabs mb-3" id="quotaTabs">
                <li class="nav-item">
                    <button class="nav-link active" data-tab="users" onclick="switchTab('users')">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-tab="report" onclick="switchTab('report')">ãƒ¬ãƒãƒ¼ãƒˆ</button>
                </li>
                <li class="nav-item" id="setTabItem">
                    <button class="nav-link" data-tab="set" onclick="switchTab('set')">ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š</button>
                </li>
            </ul>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ã‚¿ãƒ– -->
            <div id="tab-users">
                <div class="status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="status-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ä¸€è¦§</span>
                        <span id="quotaStatusBadge" class="badge badge-unavail px-2 py-1">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm quota-table">
                            <thead>
                                <tr>
                                    <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                    <th>ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ </th>
                                    <th>ä½¿ç”¨é‡</th>
                                    <th>ã‚½ãƒ•ãƒˆãƒªãƒŸãƒƒãƒˆ</th>
                                    <th>ãƒãƒ¼ãƒ‰ãƒªãƒŸãƒƒãƒˆ</th>
                                    <th>ä½¿ç”¨ç‡</th>
                                    <th>çŠ¶æ…‹</th>
                                </tr>
                            </thead>
                            <tbody id="userQuotaTable">
                                <tr><td colspan="7" class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
            <div id="tab-report" class="d-none">
                <div class="status-card">
                    <span class="status-title">ã‚¯ã‚©ãƒ¼ã‚¿ãƒ¬ãƒãƒ¼ãƒˆ</span>
                    <pre id="reportContent" class="bg-dark text-light p-3 rounded" style="font-size:12px; max-height:500px; overflow-y:auto;">èª­ã¿è¾¼ã¿ä¸­...</pre>
                </div>
            </div>

            <!-- ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®šã‚¿ãƒ– -->
            <div id="tab-set" class="d-none">
                <div class="quota-set-card">
                    <span class="status-title">ğŸ”’ ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š</span>
                    <p class="text-muted small">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—ã«ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡åˆ¶é™ã‚’è¨­å®šã—ã¾ã™ã€‚Admin/Approver æ¨©é™ãŒå¿…è¦ã§ã™ã€‚</p>
                    <form id="quotaSetForm" onsubmit="submitQuotaSet(event)">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label form-label-sm">ç¨®åˆ¥</label>
                                <select class="form-select form-select-sm" id="setType">
                                    <option value="user">ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                    <option value="group">ã‚°ãƒ«ãƒ¼ãƒ—</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm" id="setNameLabel">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                                <input type="text" class="form-control form-control-sm" id="setName" pattern="[a-zA-Z0-9._-]+" maxlength="64" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm">ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ </label>
                                <input type="text" class="form-control form-control-sm" id="setFilesystem" value="/" pattern="[/a-zA-Z0-9_.-]+" required>
                            </div>
                        </div>
                        <div class="row g-3 mt-1">
                            <div class="col-md-3">
                                <label class="form-label form-label-sm">ã‚½ãƒ•ãƒˆãƒªãƒŸãƒƒãƒˆ (KB)</label>
                                <input type="number" class="form-control form-control-sm" id="setSoftKb" min="0" value="524288" required>
                                <div class="form-text">512MB = 524288KB</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm">ãƒãƒ¼ãƒ‰ãƒªãƒŸãƒƒãƒˆ (KB)</label>
                                <input type="number" class="form-control form-control-sm" id="setHardKb" min="0" value="1048576" required>
                                <div class="form-text">1GB = 1048576KB</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm">inode ã‚½ãƒ•ãƒˆãƒªãƒŸãƒƒãƒˆ</label>
                                <input type="number" class="form-control form-control-sm" id="setIsoft" min="0" value="0">
                                <div class="form-text">0 = ç„¡åˆ¶é™</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label form-label-sm">inode ãƒãƒ¼ãƒ‰ãƒªãƒŸãƒƒãƒˆ</label>
                                <input type="number" class="form-control form-control-sm" id="setIhard" min="0" value="0">
                                <div class="form-text">0 = ç„¡åˆ¶é™</div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-sm btn-success" id="setSubmitBtn">ã‚¯ã‚©ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="resetForm()">ãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>
let currentTab = 'users';
const API_BASE = '/api';

async function getToken() {
    return localStorage.getItem('access_token') || '';
}

function showAlert(message, type = 'danger') {
    const area = document.getElementById('alertArea');
    area.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
}

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('[data-tab]').forEach(el => el.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    ['users', 'report', 'set'].forEach(t => {
        document.getElementById(`tab-${t}`).classList.toggle('d-none', t !== tab);
    });
    if (tab === 'users') loadUserQuotas();
    else if (tab === 'report') loadReport();
}

function formatBytes(kb) {
    if (kb === 0) return 'ç„¡åˆ¶é™';
    if (kb < 1024) return `${kb} KB`;
    if (kb < 1024 * 1024) return `${(kb / 1024).toFixed(1)} MB`;
    return `${(kb / 1024 / 1024).toFixed(1)} GB`;
}

async function loadUserQuotas() {
    const token = await getToken();
    const fs = document.getElementById('fsFilter').value;
    const url = fs ? `${API_BASE}/quotas/users?filesystem=${encodeURIComponent(fs)}` : `${API_BASE}/quotas/users`;
    try {
        const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await resp.json();
        const tbody = document.getElementById('userQuotaTable');
        const badge = document.getElementById('quotaStatusBadge');

        if (data.status === 'unavailable') {
            document.getElementById('unavailableNotice').classList.remove('d-none');
            badge.textContent = 'æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
            badge.className = 'badge badge-unavail px-2 py-1';
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">quota ãƒ„ãƒ¼ãƒ«ãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã™</td></tr>';
            return;
        }

        document.getElementById('unavailableNotice').classList.add('d-none');
        badge.textContent = 'æœ‰åŠ¹';
        badge.className = 'badge badge-ok px-2 py-1';

        const users = data.data?.users || [];
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">ã‚¯ã‚©ãƒ¼ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            return;
        }

        tbody.innerHTML = users.map(u => {
            const usagePercent = u.soft_limit_kb > 0 ? Math.min(100, Math.round(u.used_kb / u.soft_limit_kb * 100)) : 0;
            const barClass = usagePercent >= 100 ? 'usage-over' : usagePercent >= 80 ? 'usage-warn' : 'usage-ok';
            const statusClass = usagePercent >= 100 ? 'badge-over' : usagePercent >= 80 ? 'badge-warn' : 'badge-ok';
            const statusText = usagePercent >= 100 ? 'è¶…é' : usagePercent >= 80 ? 'è­¦å‘Š' : 'æ­£å¸¸';
            return `<tr>
                <td><strong>${u.username || '-'}</strong></td>
                <td><code>${u.filesystem || '-'}</code></td>
                <td>${formatBytes(u.used_kb || 0)}</td>
                <td>${formatBytes(u.soft_limit_kb || 0)}</td>
                <td>${formatBytes(u.hard_limit_kb || 0)}</td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <div class="usage-bar flex-grow-1"><div class="usage-bar-fill ${barClass}" style="width:${usagePercent}%"></div></div>
                        <span class="small">${usagePercent}%</span>
                    </div>
                </td>
                <td><span class="badge ${statusClass} px-2 py-1">${statusText}</span></td>
            </tr>`;
        }).join('');
    } catch (e) {
        document.getElementById('userQuotaTable').innerHTML = `<tr><td colspan="7" class="text-center text-danger py-3">ã‚¨ãƒ©ãƒ¼: ${e.message}</td></tr>`;
    }
}

async function loadReport() {
    const token = await getToken();
    const fs = document.getElementById('fsFilter').value;
    const url = fs ? `${API_BASE}/quotas/report?filesystem=${encodeURIComponent(fs)}` : `${API_BASE}/quotas/report`;
    try {
        const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await resp.json();
        const el = document.getElementById('reportContent');
        if (data.status === 'unavailable') {
            el.textContent = 'âš ï¸ quota ãƒ„ãƒ¼ãƒ«ãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã™';
        } else {
            el.textContent = data.data?.report || JSON.stringify(data, null, 2);
        }
    } catch (e) {
        document.getElementById('reportContent').textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
    }
}

async function submitQuotaSet(e) {
    e.preventDefault();
    const token = await getToken();
    const btn = document.getElementById('setSubmitBtn');
    btn.disabled = true;
    btn.textContent = 'è¨­å®šä¸­...';

    const payload = {
        type: document.getElementById('setType').value,
        name: document.getElementById('setName').value.trim(),
        filesystem: document.getElementById('setFilesystem').value.trim(),
        soft_kb: parseInt(document.getElementById('setSoftKb').value),
        hard_kb: parseInt(document.getElementById('setHardKb').value),
        isoft: parseInt(document.getElementById('setIsoft').value) || 0,
        ihard: parseInt(document.getElementById('setIhard').value) || 0,
    };

    try {
        const resp = await fetch(`${API_BASE}/quotas/set`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const data = await resp.json();
        if (resp.ok) {
            showAlert(`âœ… ã‚¯ã‚©ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ: ${payload.type} ${payload.name} (${formatBytes(payload.soft_kb)} / ${formatBytes(payload.hard_kb)})`, 'success');
        } else {
            showAlert(`âŒ ã‚¨ãƒ©ãƒ¼: ${data.detail || JSON.stringify(data)}`);
        }
    } catch (e) {
        showAlert(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'ã‚¯ã‚©ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹';
    }
}

function resetForm() {
    document.getElementById('quotaSetForm').reset();
}

document.getElementById('setType').addEventListener('change', function() {
    document.getElementById('setNameLabel').textContent = this.value === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å' : 'ã‚°ãƒ«ãƒ¼ãƒ—å';
});

document.getElementById('fsFilter').addEventListener('change', refreshAll);

async function refreshAll() {
    if (currentTab === 'users') await loadUserQuotas();
    else if (currentTab === 'report') await loadReport();
}

// æ¨©é™ãƒã‚§ãƒƒã‚¯: write:quotas ãŒãªã‘ã‚Œã°è¨­å®šã‚¿ãƒ–ã‚’éè¡¨ç¤º
async function checkPermissions() {
    const token = await getToken();
    if (!token) return;
    try {
        const resp = await fetch(`${API_BASE}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } });
        if (resp.ok) {
            const user = await resp.json();
            const perms = user.permissions || [];
            if (!perms.includes('write:quotas')) {
                document.getElementById('setTabItem').classList.add('d-none');
            }
        }
    } catch {}
}

// åˆæœŸåŒ–
(async () => {
    await checkPermissions();
    await loadUserQuotas();
})();
</script>
</body>
</html>
