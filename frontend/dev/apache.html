<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apache Webserver - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 20px; margin-bottom: 16px; }
        .status-title { font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 14px; }
        .badge-active { background: #d1fae5; color: #065f46; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .badge-inactive { background: #fee2e2; color: #991b1b; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .badge-unavail { background: #f3f4f6; color: #6b7280; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .badge-ok { background: #d1fae5; color: #065f46; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .badge-error { background: #fee2e2; color: #991b1b; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .raw-output { background: #1e293b; color: #e2e8f0; border-radius: 6px; padding: 14px; font-size: 12px; font-family: monospace; white-space: pre-wrap; max-height: 320px; overflow-y: auto; }
        .metric-val { font-size: 22px; font-weight: bold; color: #1e293b; }
        .metric-label { font-size: 12px; color: #6b7280; }
        .unavail-notice { background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 12px; color: #713f12; font-size: 13px; }
        .section-sep { border-top: 1px solid #f1f5f9; margin: 16px 0; }
        .nav-tabs .nav-link.active { color: #2563eb; font-weight: 600; border-bottom: 2px solid #2563eb; background: none; }
        .nav-tabs .nav-link { color: #6b7280; }
    </style>
</head>
<body>
<div class="wrapper">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div id="sidebar-container"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="container-fluid py-4">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h1 class="h4 mb-0">ğŸŒ Apache Webserver</h1>
                    <p class="text-muted small mb-0">Apache HTTP Server ã®çŠ¶æ…‹ãƒ»ä»®æƒ³ãƒ›ã‚¹ãƒˆãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»è¨­å®šãƒã‚§ãƒƒã‚¯</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="btnRefresh" class="btn btn-outline-primary btn-sm" onclick="loadAll()">ğŸ”„ æ›´æ–°</button>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <div class="status-card text-center">
                        <div class="metric-label mb-1">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹</div>
                        <div id="svcActive" class="metric-val mb-1">-</div>
                        <span id="badgeActive" class="badge-unavail">å–å¾—ä¸­...</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="status-card text-center">
                        <div class="metric-label mb-1">è‡ªå‹•èµ·å‹•</div>
                        <div id="svcEnabled" class="metric-val mb-1">-</div>
                        <span id="badgeEnabled" class="badge-unavail">å–å¾—ä¸­...</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="status-card text-center">
                        <div class="metric-label mb-1">è¨­å®šæ§‹æ–‡ãƒã‚§ãƒƒã‚¯</div>
                        <div id="syntaxOk" class="metric-val mb-1">-</div>
                        <span id="badgeSyntax" class="badge-unavail">å–å¾—ä¸­...</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="status-card text-center">
                        <div class="metric-label mb-1">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                        <div id="apacheVersion" class="metric-val" style="font-size:13px;">-</div>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ– -->
            <ul class="nav nav-tabs mb-3" id="apacheTabs">
                <li class="nav-item"><a class="nav-link active" href="#" onclick="switchTab('vhosts', this)">ğŸ  ä»®æƒ³ãƒ›ã‚¹ãƒˆ</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('modules', this)">ğŸ§© ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</a></li>
                <li class="nav-item"><a class="nav-link" href="#" onclick="switchTab('configcheck', this)">âœ… è¨­å®šãƒã‚§ãƒƒã‚¯</a></li>
            </ul>

            <!-- ä»®æƒ³ãƒ›ã‚¹ãƒˆ -->
            <div id="tabVhosts">
                <div class="status-card">
                    <div class="status-title">ğŸ  ä»®æƒ³ãƒ›ã‚¹ãƒˆä¸€è¦§</div>
                    <div id="vhostsContent">
                        <div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
            <div id="tabModules" style="display:none;">
                <div class="status-card">
                    <div class="status-title">ğŸ§© ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«</div>
                    <div id="modulesContent">
                        <div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- è¨­å®šãƒã‚§ãƒƒã‚¯ -->
            <div id="tabConfigcheck" style="display:none;">
                <div class="status-card">
                    <div class="status-title">âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ§‹æ–‡ãƒã‚§ãƒƒã‚¯</div>
                    <div id="configcheckContent">
                        <div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>
const API_BASE = '/api';
let authToken = localStorage.getItem('access_token') || '';

function getHeaders() {
    return { 'Authorization': 'Bearer ' + authToken, 'Content-Type': 'application/json' };
}

async function apiFetch(path) {
    const r = await fetch(API_BASE + path, { headers: getHeaders() });
    if (r.status === 403 || r.status === 401) {
        window.location.href = '/dev/index.html';
        return null;
    }
    return r.ok ? r.json() : null;
}

function switchTab(name, el) {
    document.querySelectorAll('#apacheTabs .nav-link').forEach(a => a.classList.remove('active'));
    el.classList.add('active');
    ['vhosts', 'modules', 'configcheck'].forEach(t => {
        document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)).style.display = (t === name) ? '' : 'none';
    });
    if (name === 'vhosts') loadVhosts();
    else if (name === 'modules') loadModules();
    else if (name === 'configcheck') loadConfigCheck();
    return false;
}

function renderUnavail(msg) {
    return `<div class="unavail-notice">âš ï¸ ${msg || 'Apache ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã‹ã€åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚'}</div>`;
}

function renderRaw(text) {
    if (!text) return '<div class="text-muted small">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
    return `<div class="raw-output">${escHtml(text)}</div>`;
}

function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function loadStatus() {
    const d = await apiFetch('/apache/status');
    if (!d) return;
    if (d.status === 'unavailable') {
        document.getElementById('badgeActive').outerHTML = '<span id="badgeActive" class="badge-unavail">æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>';
        document.getElementById('badgeEnabled').outerHTML = '<span id="badgeEnabled" class="badge-unavail">-</span>';
        document.getElementById('svcActive').textContent = '-';
        document.getElementById('svcEnabled').textContent = '-';
        document.getElementById('apacheVersion').textContent = '-';
        return;
    }
    const active = d.active || 'unknown';
    const enabled = d.enabled || 'unknown';
    document.getElementById('svcActive').textContent = active;
    document.getElementById('svcEnabled').textContent = enabled;
    document.getElementById('apacheVersion').textContent = d.version || '-';
    document.getElementById('badgeActive').className = active === 'active' ? 'badge-active' : 'badge-inactive';
    document.getElementById('badgeActive').textContent = active;
    document.getElementById('badgeEnabled').className = enabled === 'enabled' ? 'badge-active' : 'badge-inactive';
    document.getElementById('badgeEnabled').textContent = enabled;
}

async function loadVhosts() {
    const el = document.getElementById('vhostsContent');
    el.innerHTML = '<div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>';
    const d = await apiFetch('/apache/vhosts');
    if (!d) return;
    if (d.status === 'unavailable') { el.innerHTML = renderUnavail(d.message); return; }
    el.innerHTML = renderRaw(d.vhosts_raw);
}

async function loadModules() {
    const el = document.getElementById('modulesContent');
    el.innerHTML = '<div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>';
    const d = await apiFetch('/apache/modules');
    if (!d) return;
    if (d.status === 'unavailable') { el.innerHTML = renderUnavail(d.message); return; }
    el.innerHTML = renderRaw(d.modules_raw);
}

async function loadConfigCheck() {
    const el = document.getElementById('configcheckContent');
    el.innerHTML = '<div class="text-center text-muted py-3">èª­ã¿è¾¼ã¿ä¸­...</div>';
    const d = await apiFetch('/apache/config-check');
    if (!d) return;
    if (d.status === 'unavailable') { el.innerHTML = renderUnavail(d.message); return; }

    const ok = d.syntax_ok;
    const badge = ok
        ? '<span class="badge-ok">âœ… Syntax OK</span>'
        : '<span class="badge-error">âŒ Syntax Error</span>';

    document.getElementById('syntaxOk').textContent = ok ? 'OK' : 'ERROR';
    document.getElementById('badgeSyntax').className = ok ? 'badge-ok' : 'badge-error';
    document.getElementById('badgeSyntax').textContent = ok ? 'Syntax OK' : 'Syntax Error';

    el.innerHTML = `<div class="mb-2">${badge}</div>` + renderRaw(d.output);
}

async function loadAll() {
    await loadStatus();
    loadVhosts();
}

document.addEventListener('DOMContentLoaded', function() {
    if (!localStorage.getItem('access_token')) { window.location.href = '/dev/index.html'; return; }
    loadAll();
});
</script>
</body>
</html>
