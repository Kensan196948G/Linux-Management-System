<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áõ£Êüª„É≠„Ç∞ - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .filter-bar { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 16px; margin-bottom: 16px; }
        .log-table td, .log-table th { padding: 8px 10px; font-size: 13px; vertical-align: middle; }
        .log-table th { background: #f9fafb; font-weight: 600; color: #374151; }
        .badge-success { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-failure { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-denied { background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-default { background: #f3f4f6; color: #6b7280; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .op-badge { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .pagination-bar { display: flex; align-items: center; gap: 12px; justify-content: flex-end; padding: 12px 0; }
        .details-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 11px; color: #6b7280; font-family: monospace; }
        .export-btns { display: flex; gap: 8px; }
        .admin-only-notice { display: none; }
        #loading-indicator { color: #6b7280; font-size: 14px; }
        .error-box { background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px; margin: 16px 0; color: #991b1b; }
        .stat-card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 14px 20px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #1f2937; }
        .stat-label { font-size: 12px; color: #6b7280; }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <aside class="sidebar" id="sidebar-container"></aside>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">üìã Áõ£Êüª„É≠„Ç∞</h2>
            <div class="export-btns">
                <button class="btn btn-sm btn-outline-success" id="export-csv-btn" onclick="exportLogs('csv')" style="display:none">
                    ‚¨á CSV „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                </button>
                <button class="btn btn-sm btn-outline-primary" id="export-json-btn" onclick="exportLogs('json')" style="display:none">
                    ‚¨á JSON „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadLogs()" id="refresh-btn">
                    üîÑ Êõ¥Êñ∞
                </button>
            </div>
        </div>

        <div class="main-body">
            <!-- „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ -->
            <div class="row g-3 mb-3" id="summary-row">
                <div class="col-sm-3">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-total">-</div>
                        <div class="stat-label">Á∑è„É≠„Ç∞‰ª∂Êï∞</div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="stat-card">
                        <div class="stat-value text-success" id="stat-success">-</div>
                        <div class="stat-label">ÊàêÂäü</div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="stat-card">
                        <div class="stat-value text-danger" id="stat-failure">-</div>
                        <div class="stat-label">Â§±Êïó</div>
                    </div>
                </div>
                <div class="col-sm-3">
                    <div class="stat-card">
                        <div class="stat-value text-warning" id="stat-denied">-</div>
                        <div class="stat-label">ÊãíÂê¶</div>
                    </div>
                </div>
            </div>

            <!-- „Éï„Ç£„É´„Çø„Éº„Éê„Éº -->
            <div class="filter-bar">
                <div class="row g-2 align-items-end">
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">„É¶„Éº„Ç∂„ÉºID</label>
                        <input type="text" class="form-control form-control-sm" id="filter-user" placeholder="‰æã: admin">
                    </div>
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">Êìç‰ΩúÁ®ÆÂà•</label>
                        <select class="form-select form-select-sm" id="filter-operation">
                            <option value="">„Åô„Åπ„Å¶</option>
                            <option value="service_restart">service_restart</option>
                            <option value="service_stop">service_stop</option>
                            <option value="firewall_rules_read">firewall_rules_read</option>
                            <option value="ssh_config_read">ssh_config_read</option>
                            <option value="packages_installed_read">packages_installed_read</option>
                            <option value="log_view">log_view</option>
                            <option value="process_list">process_list</option>
                        </select>
                    </div>
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select class="form-select form-select-sm" id="filter-status">
                            <option value="">„Åô„Åπ„Å¶</option>
                            <option value="success">success</option>
                            <option value="failure">failure</option>
                            <option value="denied">denied</option>
                        </select>
                    </div>
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">ÈñãÂßãÊó•ÊôÇ</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="filter-start">
                    </div>
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">ÁµÇ‰∫ÜÊó•ÊôÇ</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="filter-end">
                    </div>
                    <div class="col-sm-2">
                        <button class="btn btn-sm btn-primary w-100" onclick="applyFilter()">üîç Ê§úÁ¥¢</button>
                    </div>
                </div>
            </div>

            <!-- „Ç®„É©„ÉºË°®Á§∫ -->
            <div id="error-container"></div>

            <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
            <div id="loading-indicator" class="text-center py-3">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                Ë™≠„ÅøËæº„Åø‰∏≠...
            </div>

            <!-- „É≠„Ç∞„ÉÜ„Éº„Éñ„É´ -->
            <div id="log-container" style="display:none">
                <div class="table-responsive">
                    <table class="table table-hover log-table">
                        <thead>
                            <tr>
                                <th>Êó•ÊôÇ</th>
                                <th>Êìç‰ΩúÁ®ÆÂà•</th>
                                <th>„É¶„Éº„Ç∂„Éº</th>
                                <th>ÂØæË±°</th>
                                <th>„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                <th>Ë©≥Á¥∞</th>
                            </tr>
                        </thead>
                        <tbody id="log-tbody"></tbody>
                    </table>
                </div>

                <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥ -->
                <div class="pagination-bar">
                    <span id="page-info" class="text-muted small"></span>
                    <button class="btn btn-sm btn-outline-secondary" id="prev-btn" onclick="changePage(-1)" disabled>‚Üê Ââç„Å∏</button>
                    <button class="btn btn-sm btn-outline-secondary" id="next-btn" onclick="changePage(1)" disabled>Ê¨°„Å∏ ‚Üí</button>
                </div>
            </div>

            <!-- Á©∫Áä∂ÊÖã -->
            <div id="empty-state" class="text-center py-5 text-muted" style="display:none">
                <p>üìã Ë°®Á§∫„Åô„Çã„É≠„Ç∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
            </div>
        </div>
    </main>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
    <script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>
    let currentPage = 1;
    const PER_PAGE = 50;
    let currentData = null;
    let isAdmin = false;

    // Ë™çË®º„ÉÅ„Çß„ÉÉ„ÇØ
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = '/login.html';
    }

    // „É≠„Éº„É´Á¢∫Ë™ç
    async function checkRole() {
        try {
            const resp = await api.getCurrentUser();
            if (resp && resp.role === 'Admin') {
                isAdmin = true;
                document.getElementById('export-csv-btn').style.display = 'inline-block';
                document.getElementById('export-json-btn').style.display = 'inline-block';
            }
            // Viewer„ÅØAPI„Åå403„ÇíËøî„Åô„Åü„ÇÅ„ÄÅ„É≠„Éº„Éâ„ÅßÁ¢∫Ë™ç
        } catch(e) {
            console.warn('Role check failed:', e);
        }
    }

    async function loadLogs() {
        currentPage = 1;
        await fetchLogs();
    }

    async function applyFilter() {
        currentPage = 1;
        await fetchLogs();
    }

    function buildParams() {
        const params = new URLSearchParams();
        params.set('page', currentPage);
        params.set('per_page', PER_PAGE);
        const user = document.getElementById('filter-user').value.trim();
        const op = document.getElementById('filter-operation').value;
        const st = document.getElementById('filter-status').value;
        const start = document.getElementById('filter-start').value;
        const end = document.getElementById('filter-end').value;
        if (user) params.set('user_id', user);
        if (op) params.set('operation', op);
        if (st) params.set('status', st);
        if (start) params.set('start_date', new Date(start).toISOString());
        if (end) params.set('end_date', new Date(end).toISOString());
        return params;
    }

    async function fetchLogs() {
        document.getElementById('loading-indicator').style.display = 'block';
        document.getElementById('log-container').style.display = 'none';
        document.getElementById('empty-state').style.display = 'none';
        document.getElementById('error-container').innerHTML = '';

        try {
            const params = buildParams();
            const resp = await fetch(`/api/audit/logs?${params.toString()}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (resp.status === 403) {
                showError('Áõ£Êüª„É≠„Ç∞„Å∏„ÅÆ„Ç¢„ÇØ„Çª„ÇπÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàViewer„É≠„Éº„É´„ÅØ„Ç¢„ÇØ„Çª„Çπ‰∏çÂèØÔºâ');
                return;
            }
            if (!resp.ok) {
                const err = await resp.json();
                showError(err.detail || '„É≠„Ç∞ÂèñÂæó„Ç®„É©„Éº');
                return;
            }

            currentData = await resp.json();
            renderLogs(currentData);
        } catch(e) {
            showError('API„Ç®„É©„Éº: ' + e.message);
        } finally {
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }

    function renderLogs(data) {
        const entries = data.entries || [];
        if (entries.length === 0) {
            document.getElementById('empty-state').style.display = 'block';
            updateStats([]);
            return;
        }

        document.getElementById('log-container').style.display = 'block';

        const tbody = document.getElementById('log-tbody');
        tbody.innerHTML = '';
        entries.forEach(entry => {
            const tr = document.createElement('tr');
            const ts = new Date(entry.timestamp).toLocaleString('ja-JP');
            const statusBadge = renderStatusBadge(entry.status);
            const detailsStr = entry.details && Object.keys(entry.details).length > 0
                ? JSON.stringify(entry.details) : '-';

            tr.innerHTML = `
                <td><span style="font-size:12px;font-family:monospace">${ts}</span></td>
                <td><span class="op-badge">${escHtml(entry.operation)}</span></td>
                <td>${escHtml(entry.user_id)}</td>
                <td>${escHtml(entry.target)}</td>
                <td>${statusBadge}</td>
                <td class="details-cell" title="${escHtml(detailsStr)}">${escHtml(detailsStr)}</td>
            `;
            tbody.appendChild(tr);
        });

        // „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥
        const pageInfo = document.getElementById('page-info');
        pageInfo.textContent = `„Éö„Éº„Ç∏ ${data.page} / ${Math.max(1, Math.ceil(data.total / PER_PAGE))} (${data.total}‰ª∂)`;
        document.getElementById('prev-btn').disabled = data.page <= 1;
        document.getElementById('next-btn').disabled = !data.has_next;

        // Áµ±Ë®àÊõ¥Êñ∞
        updateStats(entries);
        document.getElementById('stat-total').textContent = data.total;
    }

    function updateStats(entries) {
        const success = entries.filter(e => e.status === 'success').length;
        const failure = entries.filter(e => e.status === 'failure').length;
        const denied = entries.filter(e => e.status === 'denied').length;
        document.getElementById('stat-success').textContent = success;
        document.getElementById('stat-failure').textContent = failure;
        document.getElementById('stat-denied').textContent = denied;
    }

    function renderStatusBadge(st) {
        const map = { success: 'badge-success', failure: 'badge-failure', denied: 'badge-denied' };
        const cls = map[st] || 'badge-default';
        return `<span class="${cls}">${st}</span>`;
    }

    async function changePage(delta) {
        currentPage += delta;
        await fetchLogs();
    }

    async function exportLogs(format) {
        const params = buildParams();
        params.delete('page');
        params.delete('per_page');
        params.set('format', format);
        const url = `/api/audit/logs/export?${params.toString()}`;
        const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
        if (!resp.ok) {
            showError('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
            return;
        }
        const blob = await resp.blob();
        const a = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        a.href = URL.createObjectURL(blob);
        a.download = `audit_export_${ts}.${format}`;
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function showError(msg) {
        document.getElementById('error-container').innerHTML =
            `<div class="error-box">‚ö† ${escHtml(msg)}</div>`;
    }

    function escHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ÂàùÊúüÂåñ
    (async () => {
        await checkRole();
        await fetchLogs();
    })();
</script>
</body>
</html>
