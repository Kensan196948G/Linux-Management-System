<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ·å‹•ãƒ»ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ç®¡ç† - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .status-title { font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 14px; }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .metric-item {
            background: #f9fafb;
            border-radius: 6px;
            padding: 12px 16px;
        }
        .metric-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; }
        .metric-value { font-size: 15px; font-weight: bold; color: #111827; word-break: break-all; }
        .service-table th { font-size: 12px; color: #6b7280; font-weight: 600; }
        .service-table td { font-size: 13px; vertical-align: middle; }
        .badge-enabled { background-color: #d1fae5; color: #065f46; }
        .badge-disabled { background-color: #fee2e2; color: #991b1b; }
        .badge-static { background-color: #e0e7ff; color: #3730a3; }
        .badge-masked { background-color: #f3f4f6; color: #6b7280; }
        .danger-zone {
            background: #fff1f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .danger-title { font-size: 15px; font-weight: bold; color: #dc2626; margin-bottom: 12px; }
        .failed-badge { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 12px; font-size: 13px; }
        .failed-ok { background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 12px; font-size: 13px; }
        .nav-tabs .nav-link { cursor: pointer; color: #374151; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #2563eb; }
        .search-box { max-width: 260px; }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">âš¡ èµ·å‹•ãƒ»ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ç®¡ç†</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="bootup-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('status')" id="tab-status">ğŸ“Š èµ·å‹•çŠ¶æ…‹</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('services')" id="tab-services">ğŸ”§ ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('actions')" id="tab-actions">âš¡ ã‚·ã‚¹ãƒ†ãƒ æ“ä½œ</a>
                </li>
            </ul>

            <!-- â”€â”€ TAB: èµ·å‹•çŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="pane-status">
                <div class="status-card" id="bootup-status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="status-title">ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•çŠ¶æ…‹</div>
                        <span id="status-loading" class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </div>
                    <div class="metric-grid" id="status-grid">
                        <!-- JS ã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- â”€â”€ TAB: ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="pane-services" style="display:none">
                <div class="status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="status-title">ğŸ”§ èµ·å‹•æ™‚ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§</div>
                        <input
                            type="text"
                            class="form-control form-control-sm search-box"
                            id="service-search"
                            placeholder="ã‚µãƒ¼ãƒ“ã‚¹åã§çµã‚Šè¾¼ã¿..."
                            oninput="filterServices()"
                        >
                    </div>
                    <div id="services-loading" class="text-muted text-center py-4">èª­ã¿è¾¼ã¿ä¸­...</div>
                    <table class="table table-hover service-table" id="services-table" style="display:none">
                        <thead>
                            <tr>
                                <th>ã‚µãƒ¼ãƒ“ã‚¹å</th>
                                <th>çŠ¶æ…‹</th>
                                <th>ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆ</th>
                            </tr>
                        </thead>
                        <tbody id="services-tbody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- â”€â”€ TAB: ã‚·ã‚¹ãƒ†ãƒ æ“ä½œï¼ˆæ‰¿èªãƒ•ãƒ­ãƒ¼å¿…é ˆï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€ -->
            <div id="pane-actions" style="display:none">
                <!-- è­¦å‘ŠãƒãƒŠãƒ¼ -->
                <div class="alert alert-warning d-flex align-items-center mb-3" role="alert">
                    <span class="me-2" style="font-size:20px">âš ï¸</span>
                    <div>
                        <strong>é‡è¦:</strong> ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒ»å†èµ·å‹•ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å¤‰æ›´ã¯ <strong>Admin æ¨©é™ + æ‰¿èªãƒ•ãƒ­ãƒ¼</strong> ãŒå¿…è¦ã§ã™ã€‚
                        èª¤æ“ä½œã«ã‚ˆã‚Šã‚·ã‚¹ãƒ†ãƒ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒä¸èƒ½ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                    </div>
                </div>

                <!-- ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³/å†èµ·å‹• -->
                <div class="danger-zone">
                    <div class="danger-title">ğŸ”´ ã‚·ã‚¹ãƒ†ãƒ ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ / å†èµ·å‹•</div>
                    <p class="text-muted small mb-3">
                        ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å…¨ã¦ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã™ã€‚ååˆ†ã«ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small">æ“ä½œç¨®åˆ¥</label>
                            <select class="form-select form-select-sm" id="action-type">
                                <option value="shutdown">ğŸ”´ ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³</option>
                                <option value="reboot">ğŸ”„ å†èµ·å‹•</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold small">å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°</label>
                            <select class="form-select form-select-sm" id="action-delay">
                                <option value="+1">1åˆ†å¾Œ</option>
                                <option value="+5">5åˆ†å¾Œ</option>
                                <option value="+10">10åˆ†å¾Œ</option>
                                <option value="+30">30åˆ†å¾Œ</option>
                                <option value="+60">1æ™‚é–“å¾Œ</option>
                                <option value="now">ä»Šã™ã</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label fw-semibold small">å®Ÿè¡Œç†ç”±ï¼ˆå¿…é ˆï¼‰</label>
                            <input
                                type="text"
                                class="form-control form-control-sm"
                                id="action-reason"
                                placeholder="ä¾‹: å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŸã‚"
                                maxlength="500"
                            >
                        </div>
                        <div class="col-12">
                            <button
                                class="btn btn-danger btn-sm"
                                onclick="confirmSystemAction()"
                                id="action-btn"
                            >
                                âš¡ å®Ÿè¡Œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- /.main-body -->
    </main>
</div>

<!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">âš ï¸ æ“ä½œç¢ºèª</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirm-body">
                ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger btn-sm" id="confirm-ok-btn">å®Ÿè¡Œã™ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script src="../js/components.js"></script>
<script>
// ===================================================================
// Bootup/Shutdown ç®¡ç†ãƒšãƒ¼ã‚¸
// ===================================================================

const API_BASE = '/api';
let allServices = [];

// â”€â”€ åˆæœŸåŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    initSidebar();
    loadBootupStatus();
});

// â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tab) {
    ['status', 'services', 'actions'].forEach(t => {
        document.getElementById(`pane-${t}`).style.display = t === tab ? '' : 'none';
        document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    });
    if (tab === 'services' && allServices.length === 0) loadServices();
}

// â”€â”€ èµ·å‹•çŠ¶æ…‹å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBootupStatus() {
    const loading = document.getElementById('status-loading');
    loading.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';

    try {
        const data = await apiGet(`${API_BASE}/bootup/status`);
        renderBootupStatus(data.data || data);
        loading.textContent = '';
    } catch (err) {
        loading.textContent = '';
        showAlert('danger', `èµ·å‹•çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
    }
}

function renderBootupStatus(d) {
    const grid = document.getElementById('status-grid');
    const metrics = [
        { label: 'ğŸ¯ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ', value: d.default_target || 'N/A' },
        { label: 'â±ï¸ ç¨¼åƒæ™‚é–“', value: d.uptime || 'N/A' },
        { label: 'ğŸ•’ æœ€çµ‚èµ·å‹•æ™‚åˆ»', value: d.last_boot || 'N/A' },
        {
            label: 'âš ï¸ å¤±æ•—ãƒ¦ãƒ‹ãƒƒãƒˆæ•°',
            value: `<span class="${d.failed_units > 0 ? 'failed-badge' : 'failed-ok'}">${d.failed_units ?? 0} ä»¶</span>`
        },
    ];

    grid.innerHTML = metrics.map(m => `
        <div class="metric-item">
            <div class="metric-label">${m.label}</div>
            <div class="metric-value">${m.value}</div>
        </div>
    `).join('');
}

// â”€â”€ ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§å–å¾— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadServices() {
    const loading = document.getElementById('services-loading');
    const table = document.getElementById('services-table');
    loading.style.display = 'block';
    table.style.display = 'none';

    try {
        const data = await apiGet(`${API_BASE}/bootup/services`);
        allServices = (data.data && data.data.services) ? data.data.services : [];
        renderServices(allServices);
        loading.style.display = 'none';
        table.style.display = '';
    } catch (err) {
        loading.textContent = `å–å¾—å¤±æ•—: ${err.message}`;
        showAlert('danger', `ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
    }
}

function renderServices(services) {
    const tbody = document.getElementById('services-tbody');
    tbody.innerHTML = services.map(s => {
        const stateClass = {
            enabled: 'badge-enabled',
            disabled: 'badge-disabled',
            static: 'badge-static',
            masked: 'badge-masked',
        }[s.state] || 'badge-static';

        const presetClass = {
            enabled: 'badge-enabled',
            disabled: 'badge-disabled',
        }[s.vendor_preset] || 'badge-static';

        return `
            <tr>
                <td><code>${escapeHtml(s.unit || '')}</code></td>
                <td><span class="badge ${stateClass}">${escapeHtml(s.state || '')}</span></td>
                <td><span class="badge ${presetClass}">${escapeHtml(s.vendor_preset || 'N/A')}</span></td>
            </tr>
        `;
    }).join('');
}

function filterServices() {
    const q = document.getElementById('service-search').value.toLowerCase();
    const filtered = allServices.filter(s => (s.unit || '').toLowerCase().includes(q));
    renderServices(filtered);
}

// â”€â”€ ã‚·ã‚¹ãƒ†ãƒ æ“ä½œï¼ˆã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³/å†èµ·å‹•ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmSystemAction() {
    const action = document.getElementById('action-type').value;
    const delay = document.getElementById('action-delay').value;
    const reason = document.getElementById('action-reason').value.trim();

    if (!reason) {
        showAlert('warning', 'å®Ÿè¡Œç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    const actionLabel = action === 'shutdown' ? 'ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³' : 'å†èµ·å‹•';
    const delayLabel = delay === 'now' ? 'ä»Šã™ã' : `${delay.replace('+', '')}åˆ†å¾Œ`;

    document.getElementById('confirm-body').innerHTML = `
        <div class="alert alert-danger mb-0">
            <strong>âš ï¸ æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</strong><br>
            æ“ä½œ: <strong>${actionLabel}</strong><br>
            ã‚¿ã‚¤ãƒŸãƒ³ã‚°: <strong>${delayLabel}</strong><br>
            ç†ç”±: ${escapeHtml(reason)}
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    document.getElementById('confirm-ok-btn').onclick = () => {
        modal.hide();
        executeSystemAction(action, delay, reason);
    };
    modal.show();
}

async function executeSystemAction(action, delay, reason) {
    const btn = document.getElementById('action-btn');
    btn.disabled = true;
    btn.textContent = 'å®Ÿè¡Œä¸­...';

    try {
        const result = await apiPost(`${API_BASE}/bootup/action`, {
            action,
            delay,
            reason,
        });

        const label = action === 'shutdown' ? 'ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³' : 'å†èµ·å‹•';
        showAlert('success', `âœ… ã‚·ã‚¹ãƒ†ãƒ ${label}ãŒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¾ã—ãŸã€‚${result.message || ''}`);
    } catch (err) {
        showAlert('danger', `âŒ æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`);
    } finally {
        btn.disabled = false;
        btn.textContent = 'âš¡ å®Ÿè¡Œ';
    }
}

// â”€â”€ å…¨æ›´æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshAll() {
    const btn = document.getElementById('refresh-btn');
    btn.disabled = true;
    btn.textContent = 'æ›´æ–°ä¸­...';
    allServices = [];

    loadBootupStatus().finally(() => {
        btn.disabled = false;
        btn.textContent = 'ğŸ”„ æ›´æ–°';
    });
}

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

function showAlert(type, msg) {
    const area = document.getElementById('alert-area');
    area.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${msg}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

async function apiGet(url) {
    const token = localStorage.getItem('token');
    const resp = await fetch(url, {
        headers: token ? { Authorization: `Bearer ${token}` } : {},
    });
    if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: resp.statusText }));
        throw new Error(err.detail || `HTTP ${resp.status}`);
    }
    return resp.json();
}

async function apiPost(url, body) {
    const token = localStorage.getItem('token');
    const resp = await fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
        },
        body: JSON.stringify(body),
    });
    if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: resp.statusText }));
        throw new Error(err.detail || `HTTP ${resp.status}`);
    }
    return resp.json();
}
</script>
</body>
</html>
