<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBç›£è¦– - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 20px; margin-bottom: 16px; }
        .status-title { font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 14px; }
        .db-tab-btn { font-size: 14px; }
        .db-tab-btn.active { background: #2563eb; color: white; border-color: #2563eb; }
        .metric-val { font-size: 22px; font-weight: bold; color: #1e293b; }
        .metric-label { font-size: 12px; color: #6b7280; }
        .tbl th { font-size: 12px; color: #6b7280; font-weight: 600; }
        .tbl td { font-size: 13px; vertical-align: middle; }
        .badge-running { background: #d1fae5; color: #065f46; }
        .badge-stopped { background: #fee2e2; color: #991b1b; }
        .badge-unavail { background: #f3f4f6; color: #6b7280; }
        .section-sep { border-top: 1px solid #f1f5f9; margin: 16px 0; }
        .unavail-notice { background:#fefce8; border:1px solid #fde047; border-radius:8px; padding:12px; color:#713f12; font-size:13px; }
    </style>
</head>
<body>
<div class="wrapper">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div id="sidebar-container"></div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
        <div class="container-fluid py-4">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                    <h1 class="h4 mb-0">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–</h1>
                    <p class="text-muted small mb-0">MySQL / PostgreSQL ã®çŠ¶æ…‹ãƒ»ãƒ—ãƒ­ã‚»ã‚¹ãƒ»ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="btnRefresh" class="btn btn-outline-primary btn-sm" onclick="loadAll()">ğŸ”„ æ›´æ–°</button>
                </div>
            </div>

            <!-- DB ã‚¿ãƒ–é¸æŠ -->
            <div class="btn-group mb-3" role="group">
                <button type="button" class="btn btn-outline-primary db-tab-btn active" id="tabMySQL" onclick="switchDB('mysql')">ğŸ¬ MySQL</button>
                <button type="button" class="btn btn-outline-primary db-tab-btn" id="tabPostgres" onclick="switchDB('postgresql')">ğŸ˜ PostgreSQL</button>
            </div>

            <!-- çŠ¶æ…‹ã‚«ãƒ¼ãƒ‰ -->
            <div id="statusSection">
                <div class="status-card" id="statusCard">
                    <div class="status-title">DBã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹</div>
                    <div id="statusBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
                </div>
            </div>

            <!-- ãƒ—ãƒ­ã‚»ã‚¹ / ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">ãƒ—ãƒ­ã‚»ã‚¹ / ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadProcesses()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="processBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§ -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadDatabases()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="dbListBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>

            <!-- æ¥ç¶šä¸€è¦§ -->
            <div class="status-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">æ¥ç¶šä¸€è¦§</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadConnections()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="connBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>

            <!-- å¤‰æ•°ãƒ»è¨­å®š (MySQL) -->
            <div class="status-card" id="varSection">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="status-title mb-0">å¤‰æ•°ãƒ»è¨­å®š</div>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadVariables()">ğŸ”„ æ›´æ–°</button>
                </div>
                <div id="varBody"><div class="text-muted small">èª­ã¿è¾¼ã¿ä¸­...</div></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/sidebar.js"></script>
<script>
let currentDB = 'mysql';

function switchDB(db) {
    currentDB = db;
    document.getElementById('tabMySQL').classList.toggle('active', db === 'mysql');
    document.getElementById('tabPostgres').classList.toggle('active', db === 'postgresql');
    loadAll();
}

async function apiFetch(path) {
    const token = localStorage.getItem('access_token');
    const resp = await fetch(path, { headers: { 'Authorization': 'Bearer ' + token } });
    if (!resp.ok) throw new Error(resp.status + ' ' + resp.statusText);
    return resp.json();
}

function statusBadge(running, status) {
    if (status === 'unavailable') return '<span class="badge badge-unavail">åˆ©ç”¨ä¸å¯</span>';
    if (running) return '<span class="badge badge-running">ç¨¼åƒä¸­</span>';
    return '<span class="badge badge-stopped">åœæ­¢</span>';
}

async function loadStatus() {
    const el = document.getElementById('statusBody');
    try {
        const d = await apiFetch(`/api/dbmonitor/${currentDB}/status`);
        if (d.status === 'unavailable') {
            el.innerHTML = `<div class="unavail-notice">âš ï¸ ${d.message || 'DB ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ã™'}</div>`;
            return;
        }
        el.innerHTML = `
        <div class="row g-3">
            <div class="col-md-3">
                <div class="metric-label">çŠ¶æ…‹</div>
                <div>${statusBadge(d.running, d.status)}</div>
            </div>
            <div class="col-md-3">
                <div class="metric-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                <div class="metric-val" style="font-size:14px">${d.version || '-'}</div>
            </div>
            <div class="col-md-3">
                <div class="metric-label">DBã‚¿ã‚¤ãƒ—</div>
                <div class="metric-val" style="font-size:14px">${d.db_type || currentDB}</div>
            </div>
        </div>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadProcesses() {
    const el = document.getElementById('processBody');
    try {
        const d = await apiFetch(`/api/dbmonitor/${currentDB}/processes`);
        if (!d.data || d.data.length === 0) {
            el.innerHTML = '<div class="text-muted small">ãƒ—ãƒ­ã‚»ã‚¹ãªã—</div>';
            return;
        }
        const keys = Object.keys(d.data[0]);
        const header = keys.map(k => `<th>${k}</th>`).join('');
        const rows = d.data.map(row =>
            '<tr>' + keys.map(k => `<td>${row[k] ?? ''}</td>`).join('') + '</tr>'
        ).join('');
        el.innerHTML = `<div class="table-responsive"><table class="table table-sm tbl"><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table></div>
        <div class="text-muted small mt-1">åˆè¨ˆ: ${d.count} ä»¶</div>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadDatabases() {
    const el = document.getElementById('dbListBody');
    try {
        const d = await apiFetch(`/api/dbmonitor/${currentDB}/databases`);
        if (!d.data || d.data.length === 0) {
            el.innerHTML = '<div class="text-muted small">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            return;
        }
        const items = d.data.map(name => `<span class="badge bg-light text-dark border me-1 mb-1">${name}</span>`).join('');
        el.innerHTML = `<div>${items}</div><div class="text-muted small mt-1">åˆè¨ˆ: ${d.count} ä»¶</div>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadConnections() {
    const el = document.getElementById('connBody');
    try {
        const d = await apiFetch(`/api/dbmonitor/${currentDB}/connections`);
        if (!d.data || d.data.length === 0) {
            el.innerHTML = '<div class="text-muted small">æ¥ç¶šãªã—</div>';
            return;
        }
        const keys = Object.keys(d.data[0]);
        const header = keys.map(k => `<th>${k}</th>`).join('');
        const rows = d.data.map(row =>
            '<tr>' + keys.map(k => `<td>${row[k] ?? ''}</td>`).join('') + '</tr>'
        ).join('');
        el.innerHTML = `<div class="table-responsive"><table class="table table-sm tbl"><thead><tr>${header}</tr></thead><tbody>${rows}</tbody></table></div>`;
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

async function loadVariables() {
    const el = document.getElementById('varBody');
    try {
        const d = await apiFetch(`/api/dbmonitor/${currentDB}/variables`);
        if (!d.data) {
            el.innerHTML = '<div class="text-muted small">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
            return;
        }
        if (typeof d.data === 'object' && !Array.isArray(d.data)) {
            const rows = Object.entries(d.data).map(([k, v]) =>
                `<tr><td class="text-muted">${k}</td><td>${v}</td></tr>`
            ).join('');
            el.innerHTML = `<div class="table-responsive"><table class="table table-sm tbl"><thead><tr><th>å¤‰æ•°å</th><th>å€¤</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        } else {
            el.innerHTML = `<pre class="small">${JSON.stringify(d.data, null, 2)}</pre>`;
        }
    } catch(e) {
        el.innerHTML = `<div class="text-danger small">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

function loadAll() {
    loadStatus();
    loadProcesses();
    loadDatabases();
    loadConnections();
    loadVariables();
}

window.addEventListener('DOMContentLoaded', () => {
    if (typeof loadSidebar === 'function') loadSidebar('dbmonitor');
    loadAll();
});
</script>
</body>
</html>
