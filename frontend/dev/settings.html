<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±åˆè¨­å®š - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .settings-tabs {
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        .settings-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: #6c757d;
            padding: 12px 20px;
            font-weight: 500;
            cursor: pointer;
        }
        .settings-tabs .nav-link.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: none;
        }
        .settings-tabs .nav-link:hover:not(.active) {
            border-bottom-color: #b3d7ff;
            color: #495057;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        .config-table td, .config-table th { padding: 10px 14px; font-size: 13px; vertical-align: middle; }
        .config-table th { background: #f9fafb; font-weight: 600; color: #374151; width: 40%; }

        .danger-value { color: #dc3545; font-weight: bold; }
        .safe-value { color: #198754; font-weight: bold; }
        .warn-value { color: #fd7e14; font-weight: bold; }

        .danger-row { background: #fff5f5 !important; }
        .danger-badge { background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 6px; }

        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-running { background: #22c55e; }
        .status-stopped { background: #ef4444; }
        .status-unknown { background: #9ca3af; }

        .section-card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 20px; margin-bottom: 16px; }
        .section-title { font-size: 15px; font-weight: 600; color: #1f2937; margin-bottom: 14px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }

        .loading-spinner { text-align: center; padding: 30px; color: #6b7280; font-size: 14px; }
        .error-box { background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; padding: 14px; color: #991b1b; font-size: 13px; }

        .action-row { display: flex; align-items: center; gap: 10px; }
        .external-link { display: inline-flex; align-items: center; gap: 6px; background: #eff6ff; border: 1px solid #bfdbfe; color: #1d4ed8; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 14px; font-weight: 500; }
        .external-link:hover { background: #dbeafe; color: #1d4ed8; text-decoration: none; }

        .user-row td { font-size: 13px; padding: 8px 12px; }
        .role-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .role-admin { background: #dbeafe; color: #1e40af; }
        .role-viewer { background: #f3f4f6; color: #6b7280; }

        .cron-table td, .cron-table th { font-size: 12px; padding: 8px 10px; vertical-align: middle; }
        .cron-schedule { font-family: 'Courier New', monospace; background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }

        .service-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
        .service-card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 14px; background: white; }
        .service-card.running { border-left: 4px solid #22c55e; }
        .service-card.stopped { border-left: 4px solid #ef4444; }
        .service-card.unknown { border-left: 4px solid #9ca3af; }
        .service-name { font-weight: 600; font-size: 14px; color: #1f2937; margin-bottom: 4px; }
        .service-status-text { font-size: 12px; color: #6b7280; margin-bottom: 10px; }
        .btn-restart { font-size: 12px; padding: 4px 12px; }
        .restart-result { font-size: 11px; margin-top: 6px; min-height: 16px; }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar" id="sidebar-container"></aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">âš™ï¸ çµ±åˆè¨­å®š</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="reloadCurrentTab()">ğŸ”„ æ›´æ–°</button>
        </div>

        <div class="main-body">
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ -->
            <ul class="nav settings-tabs" id="settings-tab-nav">
                <li class="nav-item">
                    <a class="nav-link active" data-tab="ssh" onclick="switchTab('ssh')">ğŸ” SSHè¨­å®š</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="users" onclick="switchTab('users')">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="cron" onclick="switchTab('cron')">â° Cronã‚¸ãƒ§ãƒ–</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-tab="services" onclick="switchTab('services')">ğŸ–¥ï¸ ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†</a>
                </li>
            </ul>

            <!-- SSHè¨­å®šã‚¿ãƒ– -->
            <div class="tab-pane active" id="tab-ssh">
                <div id="ssh-content">
                    <div class="loading-spinner">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>

            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ– -->
            <div class="tab-pane" id="tab-users">
                <div id="users-content">
                    <div class="loading-spinner">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>

            <!-- Cronã‚¸ãƒ§ãƒ–ã‚¿ãƒ– -->
            <div class="tab-pane" id="tab-cron">
                <div id="cron-content">
                    <div class="loading-spinner">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>

            <!-- ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†ã‚¿ãƒ– -->
            <div class="tab-pane" id="tab-services">
                <div id="services-content">
                    <div class="loading-spinner">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
    <script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('settings')):renderSidebar('settings');</script>
<script>
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    if (!localStorage.getItem('access_token')) {
        window.location.href = '/login.html';
    }

    let activeTab = 'ssh';
    const loadedTabs = new Set();

    function switchTab(tabName) {
        activeTab = tabName;
        // ã‚¿ãƒ–ãƒªãƒ³ã‚¯ã®activeåˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.settings-tabs .nav-link').forEach(el => {
            el.classList.toggle('active', el.dataset.tab === tabName);
        });
        // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.tab-pane').forEach(el => {
            el.classList.toggle('active', el.id === 'tab-' + tabName);
        });
        // æœªãƒ­ãƒ¼ãƒ‰ãªã‚‰åˆå›ãƒ­ãƒ¼ãƒ‰
        if (!loadedTabs.has(tabName)) {
            loadTab(tabName);
        }
    }

    function reloadCurrentTab() {
        loadedTabs.delete(activeTab);
        loadTab(activeTab);
    }

    function loadTab(tabName) {
        loadedTabs.add(tabName);
        switch (tabName) {
            case 'ssh':      loadSSH();      break;
            case 'users':    loadUsers();    break;
            case 'cron':     loadCron();     break;
            case 'services': loadServices(); break;
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SSHè¨­å®šã‚¿ãƒ–
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadSSH() {
        const el = document.getElementById('ssh-content');
        el.innerHTML = spinner();
        try {
            const [configResp, statusResp] = await Promise.allSettled([
                api.get('/api/ssh/config'),
                api.get('/api/ssh/status')
            ]);

            const config = configResp.status === 'fulfilled' ? configResp.value : null;
            const status = statusResp.status === 'fulfilled' ? statusResp.value : null;

            el.innerHTML = renderSSH(config, status);
        } catch (e) {
            el.innerHTML = errorBox('SSHè¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        }
    }

    function renderSSH(config, status) {
        // å±é™ºãªè¨­å®šå€¤ã®å®šç¾©
        const dangerous = {
            PermitRootLogin: v => v && v.toLowerCase() === 'yes',
            PasswordAuthentication: v => v && v.toLowerCase() === 'yes',
            PermitEmptyPasswords: v => v && v.toLowerCase() === 'yes',
            X11Forwarding: v => v && v.toLowerCase() === 'yes',
        };
        const warn = {
            MaxAuthTries: v => v && parseInt(v) > 6,
            Port: v => v && parseInt(v) === 22,
        };

        let statusHtml = '';
        if (status) {
            const running = status.active === 'active' || status.running === true;
            statusHtml = `
            <div class="section-card">
                <div class="section-title">ğŸ”Œ SSHã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹</div>
                <table class="table config-table mb-0">
                    <tbody>
                        <tr>
                            <th>ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹</th>
                            <td>
                                <span class="status-dot ${running ? 'status-running' : 'status-stopped'}"></span>
                                ${running ? '<span class="safe-value">ç¨¼åƒä¸­</span>' : '<span class="danger-value">åœæ­¢ä¸­</span>'}
                            </td>
                        </tr>
                        ${status.version ? `<tr><th>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</th><td>${esc(status.version)}</td></tr>` : ''}
                        ${status.pid ? `<tr><th>PID</th><td>${esc(String(status.pid))}</td></tr>` : ''}
                        ${status.uptime ? `<tr><th>ç¨¼åƒæ™‚é–“</th><td>${esc(status.uptime)}</td></tr>` : ''}
                    </tbody>
                </table>
            </div>`;
        }

        let configHtml = '';
        if (config) {
            const keys = Object.keys(config);
            const rows = keys.map(key => {
                const val = config[key];
                const valStr = val !== null && val !== undefined ? String(val) : '-';
                const isDanger = dangerous[key] && dangerous[key](valStr);
                const isWarn = warn[key] && warn[key](valStr);
                let valClass = '';
                let badge = '';
                if (isDanger) { valClass = 'danger-value'; badge = '<span class="danger-badge">âš  å±é™º</span>'; }
                else if (isWarn) { valClass = 'warn-value'; badge = '<span class="danger-badge" style="background:#fef3c7;color:#92400e;">æ³¨æ„</span>'; }
                else { valClass = 'safe-value'; }
                return `<tr class="${isDanger ? 'danger-row' : ''}">
                    <th>${esc(key)}</th>
                    <td><span class="${valClass}">${esc(valStr)}</span>${badge}</td>
                </tr>`;
            }).join('');

            configHtml = `
            <div class="section-card">
                <div class="section-title">ğŸ”§ SSHè¨­å®šå€¤ (/etc/ssh/sshd_config)</div>
                ${keys.length === 0 ? '<p class="text-muted">è¨­å®šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>' : `
                <div class="mb-2 small text-muted">
                    <span style="color:#dc3545">â– </span> å±é™ºè¨­å®šã¯èµ¤ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å®‰å…¨ãªé‹ç”¨ã®ãŸã‚ã«è¦‹ç›´ã—ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
                </div>
                <table class="table config-table mb-0">
                    <tbody>${rows}</tbody>
                </table>`}
            </div>`;
        } else {
            configHtml = `<div class="section-card">${errorBox('SSHè¨­å®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚APIãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚')}</div>`;
        }

        return statusHtml + configHtml;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ–
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadUsers() {
        const el = document.getElementById('users-content');
        el.innerHTML = spinner();
        try {
            const data = await api.get('/api/users/');
            el.innerHTML = renderUsers(data);
        } catch (e) {
            // APIã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒªãƒ³ã‚¯ã¯è¡¨ç¤ºã™ã‚‹
            el.innerHTML = renderUsers(null, e.message);
        }
    }

    function renderUsers(data, errMsg) {
        const linkSection = `
        <div class="section-card">
            <div class="section-title">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒšãƒ¼ã‚¸</div>
            <p class="text-muted small mb-3">è©³ç´°ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆè¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†å°‚ç”¨ãƒšãƒ¼ã‚¸ã§è¡Œãˆã¾ã™ã€‚</p>
            <a href="users.html" class="external-link">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ã â†’</a>
        </div>`;

        if (!data) {
            return linkSection + (errMsg ? `<div class="section-card">${errorBox('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errMsg)}</div>` : '');
        }

        const users = Array.isArray(data) ? data : (data.users || []);
        const rows = users.map(u => {
            const role = u.role || u.is_admin ? 'Admin' : 'Viewer';
            const isAdmin = (u.role === 'Admin' || u.is_admin);
            return `<tr class="user-row">
                <td>${esc(u.username || u.name || '-')}</td>
                <td>${esc(u.email || '-')}</td>
                <td><span class="role-badge ${isAdmin ? 'role-admin' : 'role-viewer'}">${esc(role)}</span></td>
                <td><span class="text-muted small">${esc(u.created_at ? u.created_at.slice(0,10) : '-')}</span></td>
            </tr>`;
        }).join('');

        return linkSection + `
        <div class="section-card">
            <div class="section-title">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ (${users.length}ä»¶)</div>
            ${users.length === 0 ? '<p class="text-muted">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>' : `
            <table class="table table-hover mb-0">
                <thead>
                    <tr style="background:#f9fafb;font-size:13px;">
                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ãƒ­ãƒ¼ãƒ«</th><th>ä½œæˆæ—¥</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>`}
        </div>`;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Cronã‚¸ãƒ§ãƒ–ã‚¿ãƒ–
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadCron() {
        const el = document.getElementById('cron-content');
        el.innerHTML = spinner();
        try {
            const data = await api.get('/api/cron/');
            el.innerHTML = renderCron(data);
        } catch (e) {
            el.innerHTML = renderCron(null, e.message);
        }
    }

    function renderCron(data, errMsg) {
        const linkSection = `
        <div class="section-card">
            <div class="section-title">â° Cronã‚¸ãƒ§ãƒ–ç®¡ç†ãƒšãƒ¼ã‚¸</div>
            <p class="text-muted small mb-3">Cronã‚¸ãƒ§ãƒ–ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ã¯Cronã‚¸ãƒ§ãƒ–å°‚ç”¨ãƒšãƒ¼ã‚¸ã§è¡Œãˆã¾ã™ã€‚</p>
            <a href="cron.html" class="external-link">â° Cronã‚¸ãƒ§ãƒ–ç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ã â†’</a>
        </div>`;

        if (!data) {
            return linkSection + (errMsg ? `<div class="section-card">${errorBox('Cronã‚¸ãƒ§ãƒ–ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + errMsg)}</div>` : '');
        }

        const jobs = Array.isArray(data) ? data : (data.jobs || data.cron_jobs || []);
        const rows = jobs.map(j => `<tr>
            <td>${esc(j.user || 'root')}</td>
            <td><span class="cron-schedule">${esc(j.schedule || j.cron_expression || '-')}</span></td>
            <td style="font-family:monospace;font-size:11px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(j.command || '-')}</td>
            <td>${esc(j.description || '-')}</td>
            <td><span class="badge ${j.enabled !== false ? 'bg-success' : 'bg-secondary'}" style="font-size:10px;">${j.enabled !== false ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span></td>
        </tr>`).join('');

        return linkSection + `
        <div class="section-card">
            <div class="section-title">ğŸ“‹ Cronã‚¸ãƒ§ãƒ–ä¸€è¦§ (${jobs.length}ä»¶)</div>
            ${jobs.length === 0 ? '<p class="text-muted">Cronã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>' : `
            <div class="table-responsive">
            <table class="table table-hover cron-table mb-0">
                <thead>
                    <tr style="background:#f9fafb;">
                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</th><th>ã‚³ãƒãƒ³ãƒ‰</th><th>èª¬æ˜</th><th>çŠ¶æ…‹</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
            </div>`}
        </div>`;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ã‚µãƒ¼ãƒ“ã‚¹ç®¡ç†ã‚¿ãƒ–
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadServices() {
        const el = document.getElementById('services-content');
        el.innerHTML = spinner();
        try {
            const data = await api.get('/api/services/status');
            el.innerHTML = renderServices(data);
        } catch (e) {
            el.innerHTML = renderServices(null, e.message);
        }
    }

    function renderServices(data, errMsg) {
        if (!data) {
            return `<div class="section-card">${errorBox('ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (errMsg || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'))}</div>`;
        }

        const services = Array.isArray(data) ? data : (data.services || []);
        const cards = services.map((s, i) => {
            const running = s.status === 'active' || s.status === 'running' || s.is_running;
            const statusClass = running ? 'running' : (s.status === 'stopped' || s.status === 'inactive' ? 'stopped' : 'unknown');
            const statusLabel = running ? 'ç¨¼åƒä¸­' : (s.status || 'ä¸æ˜');
            return `
            <div class="service-card ${statusClass}" id="svc-card-${i}">
                <div class="service-name">${esc(s.name || s.service_name || s.unit || '-')}</div>
                <div class="service-status-text">
                    <span class="status-dot status-${statusClass}"></span>${esc(statusLabel)}
                    ${s.description ? ' â€” ' + esc(s.description) : ''}
                </div>
                <button class="btn btn-sm btn-outline-warning btn-restart"
                    onclick="restartService(${i}, '${esc(s.name || s.service_name || s.unit || '')}')">
                    ğŸ”„ å†èµ·å‹•
                </button>
                <div class="restart-result text-muted" id="svc-result-${i}"></div>
            </div>`;
        }).join('');

        return `
        <div class="section-card">
            <div class="section-title">ğŸ–¥ï¸ ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ (${services.length}ä»¶)
                <span class="text-muted small fw-normal ms-2">â€” å†èµ·å‹•ãƒœã‚¿ãƒ³ã¯è¨±å¯ãƒªã‚¹ãƒˆã«ç™»éŒ²æ¸ˆã¿ã®ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿æœ‰åŠ¹</span>
            </div>
            ${services.length === 0 ? '<p class="text-muted">ã‚µãƒ¼ãƒ“ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>' : `<div class="service-grid">${cards}</div>`}
        </div>`;
    }

    async function restartService(idx, serviceName) {
        const btn = document.querySelector(`#svc-card-${idx} .btn-restart`);
        const result = document.getElementById(`svc-result-${idx}`);
        if (!serviceName) return;

        btn.disabled = true;
        btn.textContent = 'å®Ÿè¡Œä¸­...';
        result.textContent = '';
        result.className = 'restart-result text-muted';

        try {
            const resp = await api.post('/api/services/restart', { service_name: serviceName });
            result.textContent = 'âœ… ' + (resp.message || 'å†èµ·å‹•ã—ã¾ã—ãŸ');
            result.className = 'restart-result text-success';
        } catch (e) {
            result.textContent = 'âŒ ' + (e.message || 'å†èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
            result.className = 'restart-result text-danger';
        } finally {
            btn.disabled = false;
            btn.textContent = 'ğŸ”„ å†èµ·å‹•';
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function spinner() {
        return `<div class="loading-spinner"><div class="spinner-border spinner-border-sm me-2" role="status"></div>èª­ã¿è¾¼ã¿ä¸­...</div>`;
    }

    function errorBox(msg) {
        return `<div class="error-box">âš ï¸ ${esc(msg)}</div>`;
    }

    function esc(str) {
        if (str === null || str === undefined) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    loadTab('ssh');
</script>
</body>
</html>
