<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBãƒ¢ãƒ‹ã‚¿ãƒ¼ - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .db-switch-bar {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 14px 20px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
        }
        .db-switch-label {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            white-space: nowrap;
        }
        .tab-nav {
            background: white;
            border-radius: 8px 8px 0 0;
            border: 1px solid #e5e7eb;
            border-bottom: none;
            padding: 0 16px;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }
        .tab-btn {
            padding: 12px 18px;
            border: none;
            background: none;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s, background 0.2s;
            white-space: nowrap;
        }
        .tab-btn:hover { color: #3b82f6; background: #f9fafb; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 600; }
        .tab-content-area {
            background: white;
            border-radius: 0 0 8px 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            min-height: 300px;
        }
        .status-card {
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .status-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .status-card-title {
            font-size: 16px;
            font-weight: bold;
            color: #111827;
        }
        .running-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }
        .running-on  { background: #d1fae5; color: #065f46; }
        .running-off { background: #fee2e2; color: #991b1b; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 12px;
        }
        .info-item {
            background: #f9fafb;
            border-radius: 6px;
            padding: 12px 16px;
        }
        .info-item-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #9ca3af;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        .info-item-value {
            font-size: 14px;
            color: #111827;
            word-break: break-all;
        }
        .table-container { overflow-x: auto; }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f3f4f6;
        }
        .loading-spinner {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            font-size: 14px;
        }
        .error-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 16px;
            color: #991b1b;
            font-size: 14px;
        }
        .empty-msg {
            text-align: center;
            padding: 32px;
            color: #9ca3af;
            font-size: 14px;
        }
        .count-badge {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            border-radius: 12px;
            padding: 1px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸ—ƒï¸ DBãƒ¢ãƒ‹ã‚¿ãƒ¼</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshCurrentTab()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- DBåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
            <div class="db-switch-bar">
                <span class="db-switch-label">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é¸æŠ:</span>
                <div class="btn-group mb-0">
                    <button class="btn btn-outline-primary active" id="btn-mysql" onclick="switchDb('mysql')">ğŸ¬ MySQL</button>
                    <button class="btn btn-outline-primary" id="btn-postgresql" onclick="switchDb('postgresql')">ğŸ˜ PostgreSQL</button>
                </div>
                <span id="db-status-indicator" class="ms-2" style="font-size:13px;color:#6b7280;"></span>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="tab-nav">
                <button class="tab-btn active" id="tab-btn-status"      onclick="showTab('status')">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</button>
                <button class="tab-btn"        id="tab-btn-processes"   onclick="showTab('processes')">âš™ï¸ ãƒ—ãƒ­ã‚»ã‚¹</button>
                <button class="tab-btn"        id="tab-btn-databases"   onclick="showTab('databases')">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</button>
                <button class="tab-btn"        id="tab-btn-connections" onclick="showTab('connections')">ğŸ”— æ¥ç¶š</button>
                <button class="tab-btn"        id="tab-btn-variables"   onclick="showTab('variables')">âš™ï¸ å¤‰æ•°</button>
            </div>

            <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="tab-content-area">
                <div id="tab-status"></div>
                <div id="tab-processes"   style="display:none"></div>
                <div id="tab-databases"   style="display:none"></div>
                <div id="tab-connections" style="display:none"></div>
                <div id="tab-variables"   style="display:none"></div>
            </div>
        </div>
    </main>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('dbmonitor')):renderSidebar('dbmonitor');</script>
<script>
// ===================================================================
// XSSé˜²æ­¢ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ===================================================================
function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// ===================================================================
// çŠ¶æ…‹ç®¡ç†
// ===================================================================
let currentDb  = 'mysql';
let currentTab = 'status';

// ===================================================================
// DBåˆ‡ã‚Šæ›¿ãˆ
// ===================================================================
function switchDb(dbType) {
    currentDb = dbType;
    document.getElementById('btn-mysql').classList.toggle('active', dbType === 'mysql');
    document.getElementById('btn-postgresql').classList.toggle('active', dbType === 'postgresql');
    // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
    showTab(currentTab);
}

// ===================================================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// ===================================================================
function showTab(tabName) {
    const tabs = ['status', 'processes', 'databases', 'connections', 'variables'];
    tabs.forEach(function(t) {
        document.getElementById('tab-' + t).style.display = (t === tabName) ? '' : 'none';
        var btn = document.getElementById('tab-btn-' + t);
        if (btn) btn.classList.toggle('active', t === tabName);
    });
    currentTab = tabName;

    switch (tabName) {
        case 'status':      loadStatus();      break;
        case 'processes':   loadProcesses();   break;
        case 'databases':   loadDatabases();   break;
        case 'connections': loadConnections(); break;
        case 'variables':   loadVariables();   break;
    }
}

function refreshCurrentTab() {
    showTab(currentTab);
}

// ===================================================================
// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° / ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼
// ===================================================================
function setTabLoading(tabName) {
    document.getElementById('tab-' + tabName).innerHTML =
        '<div class="loading-spinner">èª­ã¿è¾¼ã¿ä¸­...</div>';
}

function setTabError(tabName, msg) {
    document.getElementById('tab-' + tabName).innerHTML =
        '<div class="error-box">&#x26A0;&#xFE0F; ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(msg) + '</div>';
}

// ===================================================================
// å‹•çš„ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
// ===================================================================
function renderTable(items) {
    if (!items) {
        return '<div class="empty-msg">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }

    if (Array.isArray(items)) {
        if (items.length === 0) {
            return '<div class="empty-msg">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }
        var cols = Object.keys(items[0]);
        var headerCells = cols.map(function(c) { return '<th>' + escapeHtml(c) + '</th>'; }).join('');
        var rows = items.map(function(row) {
            var cells = cols.map(function(c) {
                return '<td>' + escapeHtml(row[c]) + '</td>';
            }).join('');
            return '<tr>' + cells + '</tr>';
        }).join('');
        return '<div class="table-container">'
            + '<table class="table table-sm table-hover mb-0">'
            + '<thead class="table-dark"><tr>' + headerCells + '</tr></thead>'
            + '<tbody>' + rows + '</tbody>'
            + '</table></div>';

    } else if (typeof items === 'object') {
        var entries = Object.entries(items);
        if (entries.length === 0) {
            return '<div class="empty-msg">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }
        var rows2 = entries.map(function(kv) {
            return '<tr>'
                + '<td class="fw-semibold" style="width:40%;white-space:nowrap">' + escapeHtml(kv[0]) + '</td>'
                + '<td>' + escapeHtml(kv[1]) + '</td>'
                + '</tr>';
        }).join('');
        return '<div class="table-container">'
            + '<table class="table table-sm table-hover mb-0">'
            + '<thead class="table-dark"><tr><th>ã‚­ãƒ¼</th><th>å€¤</th></tr></thead>'
            + '<tbody>' + rows2 + '</tbody>'
            + '</table></div>';
    }

    return '<div class="empty-msg">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
}

// ===================================================================
// ã‚¿ãƒ–1: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
// ===================================================================
async function loadStatus() {
    setTabLoading('status');
    try {
        var data = await api.getDbStatus(currentDb);
        var dbLabel = currentDb === 'mysql' ? 'ğŸ¬ MySQL' : 'ğŸ˜ PostgreSQL';
        var running = data.running;
        var badgeClass = running ? 'running-on' : 'running-off';
        var badgeText  = running ? '&#x2705; ç¨¼åƒä¸­' : '&#x274C; åœæ­¢ä¸­';

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿æ›´æ–°
        document.getElementById('db-status-indicator').innerHTML =
            '<span class="running-badge ' + badgeClass + '" style="font-size:11px;padding:2px 10px;">' + badgeText + '</span>';

        var html = '<div class="status-card">'
            + '<div class="status-card-header">'
            + '<span class="status-card-title">' + escapeHtml(dbLabel) + ' ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>'
            + '<span class="running-badge ' + badgeClass + '">' + badgeText + '</span>'
            + '</div>';

        if (data.message) {
            html += '<div class="alert alert-info py-2 mb-3" style="font-size:13px">' + escapeHtml(data.message) + '</div>';
        }

        if (data.version) {
            html += '<div class="info-grid">'
                + '<div class="info-item">'
                + '<div class="info-item-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>'
                + '<div class="info-item-value"><code>' + escapeHtml(data.version) + '</code></div>'
                + '</div>'
                + '</div>';
        }

        // è¿½åŠ ãƒ‡ãƒ¼ã‚¿ (data.data ãŒå­˜åœ¨ã™ã‚‹å ´åˆ)
        if (data.data && typeof data.data === 'object' && Object.keys(data.data).length > 0) {
            html += '<div class="section-title mt-4">è©³ç´°æƒ…å ±</div>';
            var items = data.data;
            if (Array.isArray(items)) {
                html += renderTable(items);
            } else {
                var entries = Object.entries(items);
                html += '<div class="info-grid">';
                entries.forEach(function(kv) {
                    html += '<div class="info-item">'
                        + '<div class="info-item-label">' + escapeHtml(kv[0]) + '</div>'
                        + '<div class="info-item-value">' + escapeHtml(kv[1]) + '</div>'
                        + '</div>';
                });
                html += '</div>';
            }
        }

        html += '</div>';
        document.getElementById('tab-status').innerHTML = html;

    } catch (e) {
        document.getElementById('db-status-indicator').innerHTML = '';
        setTabError('status', e.message);
    }
}

// ===================================================================
// ã‚¿ãƒ–2: ãƒ—ãƒ­ã‚»ã‚¹
// ===================================================================
async function loadProcesses() {
    setTabLoading('processes');
    try {
        var data = await api.getDbProcesses(currentDb);
        // MySQLã¯ data.processesã€PostgreSQLã¯ data.activity
        var items = (data.data && data.data.processes)
                 || (data.data && data.data.activity)
                 || data.data
                 || [];
        var count = data.count !== undefined ? data.count : (Array.isArray(items) ? items.length : 0);

        var html = '<div class="section-title">ãƒ—ãƒ­ã‚»ã‚¹ / ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ <span class="count-badge">' + escapeHtml(count) + '</span></div>';
        html += renderTable(items);
        document.getElementById('tab-processes').innerHTML = html;
    } catch (e) {
        setTabError('processes', e.message);
    }
}

// ===================================================================
// ã‚¿ãƒ–3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
// ===================================================================
async function loadDatabases() {
    setTabLoading('databases');
    try {
        var data = await api.getDbDatabases(currentDb);
        var items = data.data || [];
        var count = data.count !== undefined ? data.count : (Array.isArray(items) ? items.length : 0);

        var html = '<div class="section-title">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§ <span class="count-badge">' + escapeHtml(count) + '</span></div>';
        html += renderTable(items);
        document.getElementById('tab-databases').innerHTML = html;
    } catch (e) {
        setTabError('databases', e.message);
    }
}

// ===================================================================
// ã‚¿ãƒ–4: æ¥ç¶š
// ===================================================================
async function loadConnections() {
    setTabLoading('connections');
    try {
        var data = await api.getDbConnections(currentDb);
        var items = data.data || [];
        var count = data.count !== undefined ? data.count : (Array.isArray(items) ? items.length : 0);

        var html = '<div class="section-title">æ¥ç¶šä¸€è¦§ <span class="count-badge">' + escapeHtml(count) + '</span></div>';
        html += renderTable(items);
        document.getElementById('tab-connections').innerHTML = html;
    } catch (e) {
        setTabError('connections', e.message);
    }
}

// ===================================================================
// ã‚¿ãƒ–5: å¤‰æ•°
// ===================================================================
async function loadVariables() {
    setTabLoading('variables');
    try {
        var data = await api.getDbVariables(currentDb);
        var items = data.data || {};

        var html = '<div class="section-title">è¨­å®šå¤‰æ•°</div>';
        html += renderTable(items);
        document.getElementById('tab-variables').innerHTML = html;
    } catch (e) {
        setTabError('variables', e.message);
    }
}

// ===================================================================
// åˆæœŸåŒ–
// ===================================================================
document.addEventListener('DOMContentLoaded', function() {
    var token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html';
        return;
    }
    api.setToken(token);
    if (typeof initSidebar === 'function') initSidebar('dbmonitor');
    showTab('status');
});
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
