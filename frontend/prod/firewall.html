<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ« - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-inactive { background: #f3f4f6; color: #6b7280; }
        .status-unknown { background: #fef3c7; color: #92400e; }
        .nav-tabs .nav-link { cursor: pointer; color: #374151; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #2563eb; }
        .backend-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin-bottom: 16px;
        }
        .backend-title { font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 10px; }
        .backend-grid { display: flex; gap: 16px; flex-wrap: wrap; }
        .backend-item { display: flex; align-items: center; gap: 6px; font-size: 13px; }
        .table-compact td, .table-compact th { padding: 6px 10px; font-size: 13px; }
        code { background: #f3f4f6; padding: 2px 5px; border-radius: 3px; font-size: 12px; }
        .policy-chain {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chain-name { font-weight: bold; font-size: 14px; color: #111827; min-width: 100px; }
        .policy-accept { background: #d1fae5; color: #065f46; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .policy-drop { background: #fee2e2; color: #991b1b; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .policy-reject { background: #fef3c7; color: #92400e; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .approval-notice {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 13px;
            color: #1e40af;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸ”¥ ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ç®¡ç†</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
            <div class="backend-card" id="status-bar" style="display:none">
                <div class="backend-title">ğŸ›¡ï¸ ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çŠ¶æ…‹</div>
                <div class="backend-grid" id="status-grid"></div>
            </div>
            <div id="status-loading" class="text-center py-2 text-muted" style="font-size:13px">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª­ã¿è¾¼ã¿ä¸­...</div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="firewall-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('rules')" id="tab-rules">
                        ğŸ“‹ ãƒ«ãƒ¼ãƒ«ä¸€è¦§
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('policy')" id="tab-policy">
                        ğŸ” ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('add-rule')" id="tab-add-rule">
                        â• ãƒ«ãƒ¼ãƒ«è¿½åŠ ç”³è«‹
                    </a>
                </li>
            </ul>

            <!-- ãƒ«ãƒ¼ãƒ«ä¸€è¦§ -->
            <div id="pane-rules">
                <div id="rules-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="rules-content" style="display:none"></div>
            </div>

            <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼ -->
            <div id="pane-policy" style="display:none">
                <div id="policy-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="policy-content" style="display:none"></div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ«è¿½åŠ ç”³è«‹ -->
            <div id="pane-add-rule" style="display:none">
                <div class="approval-notice">
                    â„¹ï¸ ãƒ«ãƒ¼ãƒ«ã®è¿½åŠ ãƒ»å‰Šé™¤ã¯<strong>æ‰¿èªãƒ•ãƒ­ãƒ¼</strong>ãŒå¿…è¦ã§ã™ã€‚ç”³è«‹å¾Œã€ç®¡ç†è€…ã®æ‰¿èªã‚’çµŒã¦é©ç”¨ã•ã‚Œã¾ã™ã€‚
                </div>
                <div class="backend-card">
                    <div class="backend-title">ğŸ“ æ–°è¦ãƒ«ãƒ¼ãƒ«è¿½åŠ ç”³è«‹</div>
                    <form id="add-rule-form" onsubmit="submitAddRule(event)">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">ãƒãƒ¼ãƒˆç•ªå· <span class="text-danger">*</span></label>
                                <input type="number" class="form-control form-control-sm" id="rule-port"
                                       min="1" max="65535" placeholder="ä¾‹: 80" required>
                                <div class="form-text">1ã€œ65535</div>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ãƒ—ãƒ­ãƒˆã‚³ãƒ« <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm" id="rule-protocol" required>
                                    <option value="tcp">TCP</option>
                                    <option value="udp">UDP</option>
                                    <option value="any">ANY</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm" id="rule-action" required>
                                    <option value="allow">è¨±å¯ (allow)</option>
                                    <option value="deny">æ‹’å¦ (deny)</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label">ç”³è«‹ç†ç”± <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="rule-reason"
                                       placeholder="ä¾‹: Webã‚µãƒ¼ãƒãƒ¼å…¬é–‹ã®ãŸã‚HTTPãƒãƒ¼ãƒˆã‚’é–‹æ”¾" required maxlength="200">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-sm btn-warning" id="submit-btn">
                                ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡
                            </button>
                        </div>
                    </form>
                    <div id="add-rule-result" class="mt-3" style="display:none"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- å‰Šé™¤ç¢ºèª Modal -->
<div class="modal fade" id="deleteRuleModal" tabindex="-1" aria-labelledby="deleteRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRuleModalLabel">ãƒ«ãƒ¼ãƒ«å‰Šé™¤ç¢ºèª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
            </div>
            <div class="modal-body">
                <p>ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div id="deleteRuleDetail" class="p-2 bg-light rounded" style="font-size:13px;"></div>
                <div class="mt-2 text-danger" style="font-size:12px;">ã“ã®æ“ä½œã¯æ‰¿èªãƒ•ãƒ­ãƒ¼ã‚’çµŒã¦é©ç”¨ã•ã‚Œã¾ã™ã€‚</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-sm btn-danger" id="confirmDeleteBtn" onclick="executeDeleteRule()">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast é€šçŸ¥ -->
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080;">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header" id="toastHeader">
            <strong class="me-auto" id="toastTitle">é€šçŸ¥</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="é–‰ã˜ã‚‹"></button>
        </div>
        <div class="toast-body" id="toastBody"></div>
    </div>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('firewall')):renderSidebar('firewall');</script>
<script>
let currentTab = 'rules';

function showTab(tab) {
    ['rules', 'policy', 'add-rule'].forEach(t => {
        document.getElementById(`pane-${t}`).style.display = t === tab ? '' : 'none';
        document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    });
    currentTab = tab;
    if (tab === 'rules') loadRules();
    else if (tab === 'policy') loadPolicy();
}

function showAlert(msg, type = 'danger') {
    const toastEl = document.getElementById('liveToast');
    const toastHeader = document.getElementById('toastHeader');
    const toastTitle = document.getElementById('toastTitle');
    const toastBody = document.getElementById('toastBody');
    toastHeader.className = 'toast-header';
    if (type === 'success') {
        toastHeader.classList.add('text-bg-success');
        toastTitle.textContent = 'æˆåŠŸ';
    } else if (type === 'danger') {
        toastHeader.classList.add('text-bg-danger');
        toastTitle.textContent = 'ã‚¨ãƒ©ãƒ¼';
    } else if (type === 'warning') {
        toastHeader.classList.add('text-bg-warning');
        toastTitle.textContent = 'è­¦å‘Š';
    } else {
        toastHeader.classList.add('text-bg-info');
        toastTitle.textContent = 'æƒ…å ±';
    }
    toastBody.innerHTML = msg;
    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();
}

// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
async function loadStatus() {
    const loading = document.getElementById('status-loading');
    const bar = document.getElementById('status-bar');
    try {
        const data = await api.getFirewallStatus();
        const grid = document.getElementById('status-grid');
        const items = [
            { label: 'UFW', active: data.ufw_active },
            { label: 'firewalld', active: data.firewalld_active },
            { label: 'iptables', active: data.iptables_available },
            { label: 'nftables', active: data.nftables_available },
        ];
        grid.innerHTML = items.map(item => {
            const cls = item.active ? 'status-active' : 'status-inactive';
            const icon = item.active ? 'âœ…' : 'â¬œ';
            return `<div class="backend-item">
                <span class="status-badge ${cls}">${icon} ${item.label}</span>
            </div>`;
        }).join('');
        if (data.available_backends && data.available_backends.length > 0) {
            grid.innerHTML += `<div class="backend-item text-muted" style="font-size:12px; margin-left:8px">
                ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: <strong>${data.available_backends.join(', ')}</strong>
            </div>`;
        }
        loading.style.display = 'none';
        bar.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="text-warning" style="font-size:13px">âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

// ãƒ«ãƒ¼ãƒ«ä¸€è¦§
async function loadRules() {
    const loading = document.getElementById('rules-loading');
    const content = document.getElementById('rules-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getFirewallRules();
        if (data.message && !data.tables && !data.ruleset && !data.raw_lines) {
            content.innerHTML = `<div class="text-muted">${data.message}</div>`;
        } else if (data.raw_lines && data.raw_lines.length > 0) {
            // iptables/nftables raw output
            content.innerHTML = `
                <div class="mb-2 text-muted" style="font-size:12px">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: <strong>${data.backend || '-'}</strong></div>
                <div class="backend-card">
                    <pre style="font-size:12px; margin:0; white-space:pre-wrap;">${escapeHtml(data.raw_lines.join('\n'))}</pre>
                </div>`;
        } else if (data.ruleset) {
            // UFW style ruleset
            content.innerHTML = buildUfwRulesTable(data.ruleset, data.backend);
        } else {
            content.innerHTML = '<div class="text-muted">ãƒ«ãƒ¼ãƒ«æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

function buildUfwRulesTable(ruleset, backend) {
    if (!ruleset || ruleset.length === 0) {
        return '<div class="text-muted">ãƒ«ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
    }
    const rows = ruleset.map((rule, i) => {
        const ruleNum = rule.number || (i + 1);
        const action = (rule.action || '').toLowerCase();
        const actionClass = action === 'allow' ? 'status-active' : (action === 'deny' || action === 'reject' ? 'status-inactive' : '');
        const dest = escapeHtml(rule.to || rule.dst || '-');
        const src = escapeHtml(rule.from || rule.src || '-');
        const actionText = escapeHtml(rule.action || '-');
        const comment = escapeHtml(rule.comment || '');
        return `<tr>
            <td>${ruleNum}</td>
            <td>${dest}</td>
            <td>${src}</td>
            <td><span class="status-badge ${actionClass}">${actionText}</span></td>
            <td style="font-size:11px; color:#6b7280">${comment}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" style="font-size:11px; padding:1px 6px;"
                    data-rule-num="${ruleNum}" data-dest="${dest}" data-src="${src}" data-action="${actionText}"
                    onclick="confirmDeleteRule(Number(this.dataset.ruleNum), this.dataset.dest, this.dataset.src, this.dataset.action)">
                    å‰Šé™¤
                </button>
            </td>
        </tr>`;
    }).join('');
    return `
        <div class="mb-2 text-muted" style="font-size:12px">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: <strong>${escapeHtml(backend || '-')}</strong> / åˆè¨ˆ: ${ruleset.length} ä»¶</div>
        <table class="table table-sm table-hover table-compact">
            <thead class="table-dark">
                <tr><th>#</th><th>å®›å…ˆ</th><th>é€ä¿¡å…ƒ</th><th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th><th>æ“ä½œ</th></tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>`;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒªã‚·ãƒ¼
async function loadPolicy() {
    const loading = document.getElementById('policy-loading');
    const content = document.getElementById('policy-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getFirewallPolicy();
        const chains = data.chains || [];
        if (chains.length === 0) {
            content.innerHTML = '<div class="text-muted">ãƒãƒªã‚·ãƒ¼æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
        } else {
            content.innerHTML = `
                <div class="mb-2 text-muted" style="font-size:12px">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: <strong>${escapeHtml(data.backend || '-')}</strong></div>
                ${chains.map(c => buildPolicyCard(c)).join('')}`;
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${e.message}</div>`;
    }
}

function buildPolicyCard(chain) {
    const p = (chain.policy || '').toUpperCase();
    let policyClass = '';
    if (p === 'ACCEPT') policyClass = 'policy-accept';
    else if (p === 'DROP' || p === 'DENY') policyClass = 'policy-drop';
    else if (p === 'REJECT') policyClass = 'policy-reject';
    return `<div class="policy-chain">
        <span class="chain-name">${escapeHtml(chain.chain || '-')}</span>
        <span class="${policyClass}">${escapeHtml(p || '-')}</span>
        ${chain.table ? `<span class="text-muted" style="font-size:12px">ãƒ†ãƒ¼ãƒ–ãƒ«: ${escapeHtml(chain.table)}</span>` : ''}
    </div>`;
}

// ãƒ«ãƒ¼ãƒ«è¿½åŠ ç”³è«‹
async function submitAddRule(event) {
    event.preventDefault();
    const btn = document.getElementById('submit-btn');
    const result = document.getElementById('add-rule-result');
    const port = parseInt(document.getElementById('rule-port').value, 10);
    const protocol = document.getElementById('rule-protocol').value;
    const action = document.getElementById('rule-action').value;
    const reason = document.getElementById('rule-reason').value.trim();

    if (!port || port < 1 || port > 65535) {
        showAlert('ãƒãƒ¼ãƒˆç•ªå·ã¯ 1ã€œ65535 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    if (!reason) {
        showAlert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'é€ä¿¡ä¸­...';
    result.style.display = 'none';

    try {
        const data = await api.createFirewallRule(port, protocol, action, reason);
        if (data.status === 'pending_approval') {
            result.innerHTML = `<div class="alert alert-info">
                âœ… ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚<br>
                ç”³è«‹ID: <code>${data.request_id || '-'}</code><br>
                <small class="text-muted">${data.message || ''}</small>
            </div>`;
            document.getElementById('add-rule-form').reset();
        } else {
            result.innerHTML = `<div class="alert alert-success">âœ… ${data.message || 'ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸ'}</div>`;
        }
        result.style.display = '';
    } catch (e) {
        result.innerHTML = `<div class="alert alert-danger">âŒ ç”³è«‹å¤±æ•—: ${escapeHtml(e.message)}</div>`;
        result.style.display = '';
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡';
    }
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// ãƒ«ãƒ¼ãƒ«å‰Šé™¤
let pendingDeleteRuleNum = null;

function confirmDeleteRule(ruleNum, dest, src, action) {
    pendingDeleteRuleNum = ruleNum;
    document.getElementById('deleteRuleDetail').innerHTML =
        `<strong>ãƒ«ãƒ¼ãƒ« #${ruleNum}</strong>: å®›å…ˆ=${dest}, é€ä¿¡å…ƒ=${src}, ã‚¢ã‚¯ã‚·ãƒ§ãƒ³=${action}`;
    const modal = new bootstrap.Modal(document.getElementById('deleteRuleModal'));
    modal.show();
}

async function executeDeleteRule() {
    if (pendingDeleteRuleNum === null) return;
    const ruleNum = pendingDeleteRuleNum;
    pendingDeleteRuleNum = null;

    const modalEl = document.getElementById('deleteRuleModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();

    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;

    try {
        await api.deleteFirewallRule(ruleNum);
        showAlert(`ãƒ«ãƒ¼ãƒ« #${ruleNum} ã®å‰Šé™¤ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚`, 'success');
        loadRules();
    } catch (e) {
        showAlert(`ãƒ«ãƒ¼ãƒ« #${ruleNum} ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(e.message)}`, 'danger');
    } finally {
        btn.disabled = false;
    }
}

function refreshAll() {
    loadStatus();
    showTab(currentTab);
}

document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    if (!token) { window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html'; return; }
    api.setToken(token);
    loadStatus();
    loadRules();
});
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
