<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postfix ãƒ¡ãƒ¼ãƒ« - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 20px; margin-bottom: 16px; }
        .status-title { font-size: 16px; font-weight: bold; color: #111827; margin-bottom: 14px; }
        .badge-running { background: #d1fae5; color: #065f46; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .badge-stopped { background: #fee2e2; color: #991b1b; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .badge-unavail { background: #f3f4f6; color: #6b7280; border-radius: 4px; padding: 2px 8px; font-size: 12px; font-weight: 600; }
        .raw-output { background: #1e293b; color: #e2e8f0; border-radius: 6px; padding: 14px; font-size: 12px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .metric-val { font-size: 22px; font-weight: bold; color: #1e293b; }
        .metric-label { font-size: 12px; color: #6b7280; }
        .unavail-notice { background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 12px; color: #713f12; font-size: 13px; }
        .nav-tabs .nav-link.active { color: #2563eb; font-weight: 600; border-bottom: 2px solid #2563eb; background: none; }
        .nav-tabs .nav-link { color: #6b7280; }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">ğŸ“§ Postfix ãƒ¡ãƒ¼ãƒ«ç®¡ç†</h1>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()">ğŸ”„ æ›´æ–°</button>
        </div>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
        <div class="status-card">
            <div class="status-title">ğŸ“Š Postfix ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
            <div id="status-content"><span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span></div>
        </div>

        <!-- ã‚¿ãƒ– -->
        <ul class="nav nav-tabs mb-3" id="mainTab">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-queue">ğŸ“¬ ã‚­ãƒ¥ãƒ¼</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-queue-detail">ğŸ” ã‚­ãƒ¥ãƒ¼è©³ç´°</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-config">âš™ï¸ è¨­å®š</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-stats">ğŸ“ˆ çµ±è¨ˆ</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-logs">ğŸ“œ ãƒ­ã‚°</a></li>
        </ul>

        <div class="tab-content">
            <!-- ãƒ¡ãƒ¼ãƒ«ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ– -->
            <div class="tab-pane fade show active" id="tab-queue">
                <div class="status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="status-title">ğŸ“¬ ãƒ¡ãƒ¼ãƒ«ã‚­ãƒ¥ãƒ¼</div>
                        <button class="btn btn-sm btn-primary" onclick="loadQueue()">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="queue-content"><span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span></div>
                </div>
            </div>

            <!-- ã‚­ãƒ¥ãƒ¼è©³ç´°ã‚¿ãƒ– -->
            <div class="tab-pane fade" id="tab-queue-detail">
                <div class="status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="status-title">ğŸ” ã‚­ãƒ¥ãƒ¼è©³ç´° (postqueue -p)</div>
                        <button class="btn btn-sm btn-primary" onclick="loadQueueDetail()">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="queue-detail-content"><span class="text-muted">ã‚¿ãƒ–ã‚’é–‹ãã¨èª­ã¿è¾¼ã¿ã¾ã™...</span></div>
                </div>
            </div>

            <!-- è¨­å®šã‚¿ãƒ– -->
            <div class="tab-pane fade" id="tab-config">
                <div class="status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="status-title">âš™ï¸ æœ¬ç•ªè¨­å®š (postconf -n)</div>
                        <button class="btn btn-sm btn-primary" onclick="loadConfig()">ğŸ”„ æ›´æ–°</button>
                    </div>
                    <div id="config-content"><span class="text-muted">ã‚¿ãƒ–ã‚’é–‹ãã¨èª­ã¿è¾¼ã¿ã¾ã™...</span></div>
                </div>
            </div>

            <!-- çµ±è¨ˆã‚¿ãƒ– -->
            <div class="tab-pane fade" id="tab-stats">
                <div class="status-card">
                    <div class="status-title">ğŸ“ˆ é€å—ä¿¡çµ±è¨ˆ</div>
                    <div id="stats-content"><span class="text-muted">ã‚¿ãƒ–ã‚’é–‹ãã¨èª­ã¿è¾¼ã¿ã¾ã™...</span></div>
                </div>
            </div>

            <!-- ãƒ­ã‚°ã‚¿ãƒ– -->
            <div class="tab-pane fade" id="tab-logs">
                <div class="status-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="status-title">ğŸ“œ Postfix ãƒ­ã‚°</div>
                        <div class="d-flex gap-2 align-items-center">
                            <select id="log-lines" class="form-select form-select-sm" style="width:100px">
                                <option value="50">50è¡Œ</option>
                                <option value="100">100è¡Œ</option>
                                <option value="200">200è¡Œ</option>
                            </select>
                            <button class="btn btn-sm btn-primary" onclick="loadLogs()">ğŸ”„ æ›´æ–°</button>
                        </div>
                    </div>
                    <div id="logs-content"><span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('postfix')):renderSidebar('postfix');</script>
<script>
const API_BASE = '/api';

function getToken() {
    return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
}

function authHeaders() {
    return { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' };
}

async function apiFetch(path) {
    const resp = await fetch(API_BASE + path, { headers: authHeaders() });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    return resp.json();
}

function statusBadge(status) {
    if (status === 'running') return '<span class="badge-running">ç¨¼åƒä¸­</span>';
    if (status === 'stopped') return '<span class="badge-stopped">åœæ­¢ä¸­</span>';
    if (status === 'unavailable') return '<span class="badge-unavail">æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</span>';
    return `<span class="badge-unavail">${status || 'ä¸æ˜'}</span>`;
}

async function loadStatus() {
    const el = document.getElementById('status-content');
    try {
        const res = await apiFetch('/postfix/status');
        const d = res.data;
        if (d.status === 'unavailable') {
            el.innerHTML = '<div class="unavail-notice">âš ï¸ Postfix ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
            return;
        }
        el.innerHTML = `
        <div class="row g-3">
          <div class="col-md-3 text-center">
            <div class="metric-val">${statusBadge(d.status)}</div>
            <div class="metric-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
          </div>
          <div class="col-md-3 text-center">
            <div class="metric-val">${d.queue_count ?? 'â€”'}</div>
            <div class="metric-label">ã‚­ãƒ¥ãƒ¼ä»¶æ•°</div>
          </div>
          <div class="col-md-6">
            <div class="metric-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
            <div class="metric-val" style="font-size:14px">${d.version || 'â€”'}</div>
          </div>
        </div>`;
    } catch (e) {
        el.innerHTML = `<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    }
}

async function loadQueue() {
    const el = document.getElementById('queue-content');
    el.innerHTML = '<span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span>';
    try {
        const res = await apiFetch('/postfix/queue');
        const d = res.data;
        if (d.status === 'unavailable') {
            el.innerHTML = '<div class="unavail-notice">âš ï¸ Postfix ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
            return;
        }
        const queueText = d.queue || 'ã‚­ãƒ¥ãƒ¼ã¯ç©ºã§ã™';
        el.innerHTML = `<div class="raw-output">${escapeHtml(queueText)}</div>`;
    } catch (e) {
        el.innerHTML = `<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    }
}

async function loadQueueDetail() {
    const el = document.getElementById('queue-detail-content');
    el.innerHTML = '<span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span>';
    try {
        const res = await apiFetch('/postfix/queue-detail');
        const d = res.data;
        if (d.status === 'unavailable') {
            el.innerHTML = '<div class="unavail-notice">âš ï¸ Postfix ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
            return;
        }
        const text = d.queue_detail || '(ã‚­ãƒ¥ãƒ¼è©³ç´°ãªã—)';
        el.innerHTML = `<div class="raw-output">${escapeHtml(text)}</div>`;
    } catch (e) {
        el.innerHTML = `<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    }
}

async function loadConfig() {
    const el = document.getElementById('config-content');
    el.innerHTML = '<span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span>';
    try {
        const res = await apiFetch('/postfix/config');
        const d = res.data;
        if (d.status === 'unavailable') {
            el.innerHTML = '<div class="unavail-notice">âš ï¸ Postfix ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
            return;
        }
        const text = d.config || '(è¨­å®šãªã—)';
        el.innerHTML = `<div class="raw-output">${escapeHtml(text)}</div>`;
    } catch (e) {
        el.innerHTML = `<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    }
}

async function loadStats() {
    const el = document.getElementById('stats-content');
    el.innerHTML = '<span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span>';
    try {
        const res = await apiFetch('/postfix/stats');
        const d = res.data;
        if (d.status === 'unavailable') {
            el.innerHTML = '<div class="unavail-notice">âš ï¸ Postfix ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>';
            return;
        }
        el.innerHTML = `
        <div class="row g-3 text-center">
          <div class="col-md-4">
            <div class="metric-val text-success">${d.sent ?? 'â€”'}</div>
            <div class="metric-label">é€ä¿¡å®Œäº†</div>
          </div>
          <div class="col-md-4">
            <div class="metric-val text-primary">${d.received ?? 'â€”'}</div>
            <div class="metric-label">å—ä¿¡</div>
          </div>
          <div class="col-md-4">
            <div class="metric-val text-warning">${d.deferred ?? 'â€”'}</div>
            <div class="metric-label">é…å»¶</div>
          </div>
        </div>`;
    } catch (e) {
        el.innerHTML = `<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    }
}

async function loadLogs() {
    const el = document.getElementById('logs-content');
    const lines = document.getElementById('log-lines').value;
    el.innerHTML = '<span class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</span>';
    try {
        const res = await apiFetch(`/postfix/logs?lines=${lines}`);
        const d = res.data;
        const logText = d.logs || '(ãƒ­ã‚°ãªã—)';
        el.innerHTML = `<div class="raw-output">${escapeHtml(logText)}</div>`;
    } catch (e) {
        el.innerHTML = `<div class="text-danger">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
    }
}

function escapeHtml(str) {
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function refreshAll() {
    loadStatus();
    loadQueue();
}

document.addEventListener('DOMContentLoaded', () => {
    if (!getToken()) { window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html'; return; }
    loadStatus();
    loadQueue();
    document.querySelector('[href="#tab-queue-detail"]').addEventListener('shown.bs.tab', loadQueueDetail);
    document.querySelector('[href="#tab-config"]').addEventListener('shown.bs.tab', loadConfig);
    document.querySelector('[href="#tab-stats"]').addEventListener('shown.bs.tab', loadStats);
    document.querySelector('[href="#tab-logs"]').addEventListener('shown.bs.tab', loadLogs);
});
</script>
</body>
</html>
