<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Postfix ãƒ¡ãƒ¼ãƒ« - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .status-title {
            font-size: 16px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 14px;
        }
        .badge-running {
            background: #d1fae5;
            color: #065f46;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .badge-stopped {
            background: #fee2e2;
            color: #991b1b;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .badge-unavail {
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 20px;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        .metric-val {
            font-size: 22px;
            font-weight: bold;
            color: #1e293b;
        }
        .metric-label {
            font-size: 12px;
            color: #6b7280;
        }
        .unavail-notice {
            background: #fefce8;
            border: 1px solid #fde047;
            border-radius: 8px;
            padding: 12px;
            color: #713f12;
            font-size: 13px;
        }
        .nav-tabs .nav-link.active {
            color: #2563eb;
            font-weight: 600;
            border-bottom: 2px solid #2563eb;
            background: none;
        }
        .nav-tabs .nav-link { color: #6b7280; }
        .field-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .field-row:last-child { border-bottom: none; }
        .field-key {
            font-size: 12px;
            color: #6b7280;
            min-width: 140px;
            font-weight: 500;
        }
        .field-val {
            font-size: 13px;
            color: #1e293b;
            font-family: monospace;
        }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸ“§ Postfix ãƒ¡ãƒ¼ãƒ«ç®¡ç†</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()">ğŸ”„ æ›´æ–°</button>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="mainTab">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#tab-status">ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-queue">ğŸ“¬ ãƒ¡ãƒ¼ãƒ«ã‚­ãƒ¥ãƒ¼</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#tab-logs">ğŸ“‹ ãƒ­ã‚°</a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ãƒ– -->
                <div class="tab-pane fade show active" id="tab-status">
                    <div class="status-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="status-title">ğŸ“Š Postfix ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadStatus()">ğŸ”„ æ›´æ–°</button>
                        </div>
                        <div id="status-content">
                            <div class="text-center text-muted py-4">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¡ãƒ¼ãƒ«ã‚­ãƒ¥ãƒ¼ã‚¿ãƒ– -->
                <div class="tab-pane fade" id="tab-queue">
                    <div class="status-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="status-title">ğŸ“¬ ãƒ¡ãƒ¼ãƒ«ã‚­ãƒ¥ãƒ¼</div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadQueue()">ğŸ”„ æ›´æ–°</button>
                        </div>
                        <div id="queue-content">
                            <div class="text-center text-muted py-4">èª­ã¿è¾¼ã¿ä¸­...</div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ­ã‚°ã‚¿ãƒ– -->
                <div class="tab-pane fade" id="tab-logs">
                    <div class="status-card">
                        <div class="status-title">ğŸ“‹ Postfix ãƒ­ã‚°</div>
                        <div class="mb-2 d-flex align-items-center gap-2">
                            <select class="form-select form-select-sm" id="log-lines" style="width:auto">
                                <option value="50">50è¡Œ</option>
                                <option value="100">100è¡Œ</option>
                                <option value="200">200è¡Œ</option>
                            </select>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadLogs()">ğŸ”„ æ›´æ–°</button>
                        </div>
                        <pre id="log-content" style="background:#1a1a2e;color:#00ff88;padding:16px;border-radius:8px;max-height:500px;overflow-y:auto;font-size:12px;white-space:pre-wrap">èª­ã¿è¾¼ã¿ä¸­...</pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('postfix')):renderSidebar('postfix');</script>
<script>
function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function statusBadge(running) {
    if (running === true || running === 'running') {
        return '<span class="badge-running">&#10003; ç¨¼åƒä¸­</span>';
    }
    if (running === false || running === 'stopped') {
        return '<span class="badge-stopped">&#10007; åœæ­¢ä¸­</span>';
    }
    return '<span class="badge-unavail">ä¸æ˜</span>';
}

async function loadStatus() {
    const el = document.getElementById('status-content');
    el.innerHTML = '<div class="text-center text-muted py-4">èª­ã¿è¾¼ã¿ä¸­...</div>';
    try {
        const response = await api.getPostfixStatus();
        const data = response.data || response;

        if (data.status === 'unavailable') {
            el.innerHTML = '<div class="unavail-notice">&#9888; Postfix ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã‹ã€åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</div>';
            return;
        }

        // running ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‡¦ç†
        const running = (data.running !== undefined) ? data.running : (data.status === 'running');

        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡Œï¼ˆä¸Šéƒ¨ã‚«ãƒ¼ãƒ‰ï¼‰
        let html = '<div class="row g-3 mb-4">';
        html += `<div class="col-md-3 text-center">
                    <div class="metric-label mb-1">ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹</div>
                    <div class="metric-val mb-1">${statusBadge(running)}</div>
                 </div>`;
        if (data.queue_count !== undefined && data.queue_count !== null) {
            html += `<div class="col-md-3 text-center">
                        <div class="metric-label mb-1">ã‚­ãƒ¥ãƒ¼ä»¶æ•°</div>
                        <div class="metric-val">${escapeHtml(String(data.queue_count))}</div>
                     </div>`;
        }
        if (data.version) {
            html += `<div class="col-md-6 text-center">
                        <div class="metric-label mb-1">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</div>
                        <div class="metric-val" style="font-size:14px">${escapeHtml(String(data.version))}</div>
                     </div>`;
        }
        html += '</div>';

        // å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¸€è¦§
        const skipKeys = ['running', 'status', 'queue_count', 'version'];
        const extraKeys = Object.keys(data).filter(k => !skipKeys.includes(k));

        if (extraKeys.length > 0) {
            html += '<div class="status-title" style="font-size:14px;margin-bottom:10px;">è©³ç´°æƒ…å ±</div>';
            extraKeys.forEach(key => {
                const val = data[key];
                if (val === null || val === undefined) return;
                html += `<div class="field-row">
                            <span class="field-key">${escapeHtml(key)}</span>
                            <span class="field-val">${escapeHtml(String(val))}</span>
                         </div>`;
            });
        }

        el.innerHTML = html;
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadQueue() {
    const el = document.getElementById('queue-content');
    el.innerHTML = '<div class="text-center text-muted py-4">èª­ã¿è¾¼ã¿ä¸­...</div>';
    try {
        const response = await api.getPostfixQueue();
        const data = response.data || response;

        if (data.status === 'unavailable') {
            el.innerHTML = '<div class="unavail-notice">&#9888; Postfix ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã‹ã€åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚</div>';
            return;
        }

        const queue = data.queue || [];
        const count = data.count !== undefined ? data.count : queue.length;

        if (count === 0 || queue.length === 0) {
            el.innerHTML = '<div class="alert alert-success">&#10003; ã‚­ãƒ¥ãƒ¼ã¯ç©ºã§ã™</div>';
            return;
        }

        let html = `<p class="text-muted small mb-2">ã‚­ãƒ¥ãƒ¼ä»¶æ•°: ${escapeHtml(String(count))} ä»¶</p>`;
        html += `<div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>é€ä¿¡è€…</th>
                                <th>å—ä¿¡è€…</th>
                                <th>ã‚µã‚¤ã‚º</th>
                                <th>åˆ°ç€æ™‚åˆ»</th>
                                <th>ç†ç”±</th>
                            </tr>
                        </thead>
                        <tbody id="queue-tbody">`;

        queue.forEach(item => {
            const id = escapeHtml(String(item.id || '-'));
            const sender = escapeHtml(String(item.sender || '-'));
            const recipients = Array.isArray(item.recipients)
                ? item.recipients.map(r => escapeHtml(String(r))).join('<br>')
                : escapeHtml(String(item.recipients || '-'));
            const size = escapeHtml(String(item.size || '-'));
            const arrival = escapeHtml(String(item.arrival_time || '-'));
            const reason = escapeHtml(String(item.reason || '-'));
            html += `<tr>
                        <td><code>${id}</code></td>
                        <td>${sender}</td>
                        <td>${recipients}</td>
                        <td>${size}</td>
                        <td>${arrival}</td>
                        <td><small class="text-muted">${reason}</small></td>
                     </tr>`;
        });

        html += '</tbody></table></div>';
        el.innerHTML = html;
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning">ã‚­ãƒ¥ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadLogs() {
    const logEl = document.getElementById('log-content');
    const lines = document.getElementById('log-lines').value;
    logEl.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
    try {
        const response = await api.getPostfixLogs(parseInt(lines, 10));
        const data = response.data || response;

        if (data.status === 'unavailable') {
            logEl.textContent = '(Postfix ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒ­ã‚°ã‚’å–å¾—ã§ãã¾ã›ã‚“)';
            return;
        }

        const logs = data.logs;
        if (!logs) {
            logEl.textContent = '(ãƒ­ã‚°ãªã—)';
            return;
        }

        // logs ãŒé…åˆ—ã®å ´åˆã¯çµåˆã€æ–‡å­—åˆ—ã®å ´åˆã¯ãã®ã¾ã¾
        const logText = Array.isArray(logs) ? logs.join('\n') : String(logs);
        // <pre> å†…ã«è¡¨ç¤ºã™ã‚‹ãŸã‚ escapeHtml é©ç”¨
        logEl.textContent = logText || '(ãƒ­ã‚°ãªã—)';
    } catch (e) {
        logEl.textContent = 'ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message;
    }
}

function refreshAll() {
    loadStatus();
    loadQueue();
    // ãƒ­ã‚°ã‚¿ãƒ–ãŒè¡¨ç¤ºä¸­ãªã‚‰å†èª­è¾¼
    const logPane = document.getElementById('tab-logs');
    if (logPane && logPane.classList.contains('active')) {
        loadLogs();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html';
        return;
    }
    api.setToken(token);

    // åˆæœŸãƒ­ãƒ¼ãƒ‰
    loadStatus();
    loadQueue();

    // ãƒ­ã‚°ã‚¿ãƒ–è¡¨ç¤ºæ™‚ã«è‡ªå‹•èª­è¾¼
    document.querySelectorAll('#mainTab .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('href');
            if (target === '#tab-logs') loadLogs();
            else if (target === '#tab-queue') loadQueue();
            else if (target === '#tab-status') loadStatus();
        });
    });
});
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
