<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ダッシュボード - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .dashboard-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .last-updated {
            font-size: 12px;
            color: #6b7280;
        }

        /* サマリーカード */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            text-align: center;
            transition: box-shadow 0.2s;
        }
        .summary-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .summary-card-value {
            font-size: 32px;
            font-weight: bold;
            color: #111827;
            line-height: 1.2;
        }
        .summary-card-label {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }
        .summary-card-sub {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }
        .card-normal { background: #ffffff; }
        .card-warning { background: #fffbeb; border-color: #f59e0b; }
        .card-danger { background: #fef2f2; border-color: #ef4444; }

        /* サービス状態 */
        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 24px;
        }
        .service-item {
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .service-name { font-size: 13px; font-weight: 600; color: #374151; }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-inactive { background: #f3f4f6; color: #6b7280; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        .status-unknown { background: #fef3c7; color: #92400e; }

        /* 監査ログ */
        .audit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .audit-table th {
            background: #f9fafb;
            padding: 8px 12px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            font-weight: 600;
            color: #374151;
        }
        .audit-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f3f4f6;
            color: #4b5563;
        }
        .audit-table tr:hover { background: #f9fafb; }
        .result-success { color: #059669; font-weight: 600; }
        .result-fail { color: #dc2626; font-weight: 600; }
        .audit-link {
            display: inline-block;
            margin-top: 8px;
            font-size: 13px;
            color: #2563eb;
            text-decoration: none;
        }
        .audit-link:hover { text-decoration: underline; }

        /* ローディング */
        .section-loading {
            text-align: center;
            padding: 24px;
            color: #9ca3af;
        }
        .section-error {
            padding: 12px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            color: #991b1b;
            font-size: 13px;
        }
        .spinner-sm {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* SSE接続状態バッジ */
        .sse-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .sse-badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .sse-connected { background: #d1fae5; color: #065f46; }
        .sse-connected .sse-badge-dot { background: #059669; }
        .sse-disconnected { background: #fee2e2; color: #991b1b; }
        .sse-disconnected .sse-badge-dot { background: #dc2626; }
        .sse-connecting { background: #fef3c7; color: #92400e; }
        .sse-connecting .sse-badge-dot { background: #f59e0b; }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <div class="dashboard-header">
                <h2 id="page-title">ダッシュボード</h2>
                <div class="dashboard-header-right">
                    <span id="sse-status" class="sse-badge sse-disconnected">
                        <span class="sse-badge-dot"></span>
                        <span id="sse-status-text">未接続</span>
                    </span>
                    <span class="last-updated">最終更新: <span id="last-updated">--:--:--</span></span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()" id="refresh-btn">
                        更新
                    </button>
                </div>
            </div>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- システムサマリー（上部4カード） -->
            <div class="summary-cards" id="summary-cards">
                <div class="summary-card" id="card-cpu">
                    <div class="section-loading"><span class="spinner-sm"></span></div>
                </div>
                <div class="summary-card" id="card-memory">
                    <div class="section-loading"><span class="spinner-sm"></span></div>
                </div>
                <div class="summary-card" id="card-disk">
                    <div class="section-loading"><span class="spinner-sm"></span></div>
                </div>
                <div class="summary-card" id="card-services">
                    <div class="section-loading"><span class="spinner-sm"></span></div>
                </div>
            </div>

            <!-- リアルタイムグラフ（Chart.js SSE連携） -->
            <div class="section-title" style="margin-top: 24px;">リアルタイム監視グラフ</div>
            <div id="realtime-charts" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:24px;">
                <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;">
                    <div style="font-size:13px;font-weight:600;color:#374151;margin-bottom:8px;">CPU 使用率（過去60秒）</div>
                    <div style="position:relative;height:160px;"><canvas id="rt-cpu-line"></canvas></div>
                </div>
                <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;">
                    <div style="font-size:13px;font-weight:600;color:#374151;margin-bottom:8px;">メモリ使用率（過去60秒）</div>
                    <div style="position:relative;height:160px;"><canvas id="rt-mem-line"></canvas></div>
                </div>
                <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:16px;grid-column:1/-1;">
                    <div style="font-size:13px;font-weight:600;color:#374151;margin-bottom:8px;">ネットワーク IN/OUT（過去60秒, bytes/s）</div>
                    <div style="position:relative;height:160px;"><canvas id="rt-net-line"></canvas></div>
                </div>
            </div>

            <!-- サービス状態一覧（中段） -->
            <div class="section-title">サービス状態</div>
            <div id="services-section">
                <div class="section-loading"><span class="spinner-sm"></span> 読み込み中...</div>
            </div>

            <!-- 最近の監査ログ（下部） -->
            <div class="section-title" style="margin-top: 24px;">最近の監査ログ</div>
            <div id="audit-section">
                <div class="section-loading"><span class="spinner-sm"></span> 読み込み中...</div>
            </div>
        </div>
    </main>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('dashboard')):renderSidebar('dashboard');</script>
<script>
/** XSS防止: 全動的コンテンツに適用 */
function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
}

/** 使用率に応じたカードクラスを返す */
function getCardClass(percent) {
    if (percent >= 90) return 'card-danger';
    if (percent >= 80) return 'card-warning';
    return 'card-normal';
}

/** ステータスバッジHTML */
function getStatusBadge(status) {
    if (!status) return '<span class="status-badge status-unknown">-</span>';
    const s = status.toLowerCase();
    if (s === 'active' || s.includes('active')) return '<span class="status-badge status-active">active</span>';
    if (s === 'inactive' || s === 'stopped') return '<span class="status-badge status-inactive">inactive</span>';
    if (s === 'failed' || s === 'error') return '<span class="status-badge status-failed">failed</span>';
    return '<span class="status-badge status-unknown">' + escapeHtml(status) + '</span>';
}

/** CPUカード更新 */
function renderCpuCard(data) {
    const card = document.getElementById('card-cpu');
    if (!data) {
        card.innerHTML = '<div class="section-error">CPU情報の取得に失敗</div>';
        return;
    }
    const cpuPercent = data.cpu_percent || 0;
    card.className = 'summary-card ' + getCardClass(cpuPercent);
    card.innerHTML =
        '<div class="summary-card-value">' + escapeHtml(String(cpuPercent)) + '%</div>' +
        '<div class="summary-card-label">CPU使用率</div>' +
        '<div class="summary-card-sub">' + escapeHtml(String(data.cpu_count || '-')) + ' コア</div>';
}

/** メモリカード更新 */
function renderMemoryCard(data) {
    const card = document.getElementById('card-memory');
    if (!data) {
        card.innerHTML = '<div class="section-error">メモリ情報の取得に失敗</div>';
        return;
    }
    var memPercent = 0;
    var totalStr = '-';
    var usedStr = '-';
    if (data.virtual) {
        memPercent = data.virtual.percent || 0;
        totalStr = data.virtual.total || '-';
        usedStr = data.virtual.used || '-';
    } else {
        memPercent = data.percent || 0;
        totalStr = data.total || '-';
        usedStr = data.used || '-';
    }
    card.className = 'summary-card ' + getCardClass(memPercent);
    card.innerHTML =
        '<div class="summary-card-value">' + escapeHtml(String(memPercent)) + '%</div>' +
        '<div class="summary-card-label">メモリ使用率</div>' +
        '<div class="summary-card-sub">' + escapeHtml(String(usedStr)) + ' / ' + escapeHtml(String(totalStr)) + '</div>';
}

/** ディスクカード更新 */
function renderDiskCard(data) {
    const card = document.getElementById('card-disk');
    if (!data) {
        card.innerHTML = '<div class="section-error">ディスク情報の取得に失敗</div>';
        return;
    }
    var diskPercent = 0;
    var totalStr = '-';
    var usedStr = '-';
    if (Array.isArray(data.partitions) && data.partitions.length > 0) {
        var root = data.partitions.find(function(p) { return p.mountpoint === '/'; }) || data.partitions[0];
        diskPercent = root.percent || root.use_percent || 0;
        totalStr = root.total || root.size || '-';
        usedStr = root.used || '-';
    } else if (Array.isArray(data) && data.length > 0) {
        var root = data.find(function(p) { return p.mountpoint === '/'; }) || data[0];
        diskPercent = root.percent || root.use_percent || 0;
        totalStr = root.total || root.size || '-';
        usedStr = root.used || '-';
    } else if (data.percent !== undefined) {
        diskPercent = data.percent;
        totalStr = data.total || '-';
        usedStr = data.used || '-';
    }
    card.className = 'summary-card ' + getCardClass(diskPercent);
    card.innerHTML =
        '<div class="summary-card-value">' + escapeHtml(String(diskPercent)) + '%</div>' +
        '<div class="summary-card-label">ディスク使用率</div>' +
        '<div class="summary-card-sub">' + escapeHtml(String(usedStr)) + ' / ' + escapeHtml(String(totalStr)) + '</div>';
}

/** サービスカード更新 */
function renderServicesCard(servers) {
    const card = document.getElementById('card-services');
    if (!servers) {
        card.innerHTML = '<div class="section-error">サービス情報の取得に失敗</div>';
        return;
    }
    var list = servers.servers || servers;
    if (!Array.isArray(list)) list = [];
    var active = 0;
    list.forEach(function(s) {
        var st = (s.status || '').toLowerCase();
        if (st === 'active' || st.includes('active')) active++;
    });
    var total = list.length;
    var percent = total > 0 ? Math.round((active / total) * 100) : 0;
    card.className = 'summary-card ' + (active < total ? 'card-warning' : 'card-normal');
    card.innerHTML =
        '<div class="summary-card-value">' + escapeHtml(String(active)) + ' / ' + escapeHtml(String(total)) + '</div>' +
        '<div class="summary-card-label">稼働サービス</div>' +
        '<div class="summary-card-sub">' + escapeHtml(String(percent)) + '% 稼働中</div>';
}

/** サービス一覧描画 */
function renderServicesList(servers) {
    const section = document.getElementById('services-section');
    if (!servers) {
        section.innerHTML = '<div class="section-error">サービス情報の取得に失敗しました</div>';
        return;
    }
    var list = servers.servers || servers;
    if (!Array.isArray(list) || list.length === 0) {
        section.innerHTML = '<p style="color:#6b7280;font-size:13px;">サービス情報がありません</p>';
        return;
    }
    var html = '<div class="services-grid">';
    list.forEach(function(s) {
        html += '<div class="service-item">' +
            '<span class="service-name">' + escapeHtml(s.service || s.name || '-') + '</span>' +
            getStatusBadge(s.status) +
            '</div>';
    });
    html += '</div>';
    section.innerHTML = html;
}

/** 監査ログ描画 */
function renderAuditLogs(data) {
    const section = document.getElementById('audit-section');
    if (!data) {
        section.innerHTML = '<div class="section-error">監査ログの取得に失敗しました</div>';
        return;
    }
    var logs = data.logs || data.items || data;
    if (!Array.isArray(logs) || logs.length === 0) {
        section.innerHTML = '<p style="color:#6b7280;font-size:13px;">監査ログがありません</p>';
        return;
    }
    var html = '<div style="overflow-x:auto;"><table class="audit-table"><thead><tr>' +
        '<th>時刻</th><th>ユーザー</th><th>操作</th><th>対象</th><th>結果</th>' +
        '</tr></thead><tbody>';
    logs.forEach(function(log) {
        var ts = log.timestamp || log.created_at || '-';
        if (ts !== '-') {
            try {
                var d = new Date(ts);
                ts = d.toLocaleString('ja-JP', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
            } catch(e) { /* keep original */ }
        }
        var resultClass = '';
        var result = log.result || log.status || '-';
        if (result === 'success') resultClass = 'result-success';
        else if (result === 'fail' || result === 'error' || result === 'denied') resultClass = 'result-fail';
        html += '<tr>' +
            '<td>' + escapeHtml(ts) + '</td>' +
            '<td>' + escapeHtml(log.user || log.username || log.user_id || '-') + '</td>' +
            '<td>' + escapeHtml(log.operation || log.action || '-') + '</td>' +
            '<td>' + escapeHtml(log.target || log.resource || '-') + '</td>' +
            '<td class="' + resultClass + '">' + escapeHtml(result) + '</td>' +
            '</tr>';
    });
    html += '</tbody></table></div>';
    html += '<a href="audit.html" class="audit-link">全件表示 &rarr;</a>';
    section.innerHTML = html;
}

/** ダッシュボード全体を更新 */
async function refreshDashboard() {
    var btn = document.getElementById('refresh-btn');
    if (btn) btn.disabled = true;

    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('ja-JP');

    var [sysResult, memResult, diskResult, serverResult, auditResult] = await Promise.allSettled([
        api.getSystemStatus(),
        api.getHardwareMemory(),
        api.getHardwareDiskUsage(),
        api.getAllServerStatus(),
        api.getAuditLogs(1, 10)
    ]);

    // CPU (from system status)
    renderCpuCard(sysResult.status === 'fulfilled' ? sysResult.value : null);

    // メモリ
    renderMemoryCard(memResult.status === 'fulfilled' ? memResult.value : null);

    // ディスク
    renderDiskCard(diskResult.status === 'fulfilled' ? diskResult.value : null);

    // サービス数カード + サービス一覧
    var serverData = serverResult.status === 'fulfilled' ? serverResult.value : null;
    renderServicesCard(serverData);
    renderServicesList(serverData);

    // 監査ログ
    renderAuditLogs(auditResult.status === 'fulfilled' ? auditResult.value : null);

    if (btn) btn.disabled = false;
}

// ===================================================================
// SSE (Server-Sent Events) リアルタイム更新
// ===================================================================

var sseConnection = null;
var sseReconnectTimer = null;

/** SSE接続状態バッジを更新 */
function updateSseBadge(state) {
    var badge = document.getElementById('sse-status');
    var text = document.getElementById('sse-status-text');
    if (!badge || !text) return;
    badge.className = 'sse-badge sse-' + state;
    if (state === 'connected') text.textContent = 'Live';
    else if (state === 'connecting') text.textContent = '接続中...';
    else text.textContent = '未接続';
}

/** SSEストリームに接続 */
function connectSSE() {
    var token = localStorage.getItem('access_token');
    if (!token) return;

    // 既存接続をクローズ
    if (sseConnection) {
        sseConnection.close();
        sseConnection = null;
    }
    if (sseReconnectTimer) {
        clearTimeout(sseReconnectTimer);
        sseReconnectTimer = null;
    }

    updateSseBadge('connecting');

    var streamUrl = window.location.origin + '/api/stream/dashboard?token=' + encodeURIComponent(token);
    sseConnection = new EventSource(streamUrl);

    sseConnection.onopen = function() {
        console.log('SSE: connected');
        updateSseBadge('connected');
    };

    sseConnection.onmessage = function(event) {
        try {
            var data = JSON.parse(event.data);
            // CPU カードをリアルタイム更新
            if (data.cpu_percent !== undefined) {
                var cpuCard = document.getElementById('card-cpu');
                if (cpuCard) {
                    var cpuPercent = data.cpu_percent;
                    cpuCard.className = 'summary-card ' + getCardClass(cpuPercent);
                    cpuCard.innerHTML =
                        '<div class="summary-card-value">' + escapeHtml(String(cpuPercent)) + '%</div>' +
                        '<div class="summary-card-label">CPU使用率</div>' +
                        '<div class="summary-card-sub">Live</div>';
                }
            }
            // メモリカードをリアルタイム更新
            if (data.mem_percent !== undefined) {
                var memCard = document.getElementById('card-memory');
                if (memCard) {
                    var memPercent = data.mem_percent;
                    var memUsed = data.mem_used || '-';
                    var memTotal = data.mem_total || '-';
                    memCard.className = 'summary-card ' + getCardClass(memPercent);
                    memCard.innerHTML =
                        '<div class="summary-card-value">' + escapeHtml(String(memPercent)) + '%</div>' +
                        '<div class="summary-card-label">メモリ使用率</div>' +
                        '<div class="summary-card-sub">' + escapeHtml(String(memUsed)) + ' / ' + escapeHtml(String(memTotal)) + '</div>';
                }
            }
            // 最終更新時刻を更新
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('ja-JP');
            updateSseBadge('connected');
        } catch (e) {
            console.error('SSE: parse error', e);
        }
    };

    sseConnection.onerror = function() {
        console.warn('SSE: connection error, will retry in 5s');
        updateSseBadge('disconnected');
        if (sseConnection) {
            sseConnection.close();
            sseConnection = null;
        }
        // 5秒後に再接続
        sseReconnectTimer = setTimeout(connectSSE, 5000);
    };
}

/** SSE接続を切断 */
function disconnectSSE() {
    if (sseReconnectTimer) {
        clearTimeout(sseReconnectTimer);
        sseReconnectTimer = null;
    }
    if (sseConnection) {
        sseConnection.close();
        sseConnection = null;
    }
    updateSseBadge('disconnected');
}

/** 初期化 */
document.addEventListener('DOMContentLoaded', async function() {
    var token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html';
        return;
    }
    api.setToken(token);
    if (typeof renderSidebar === 'function') renderSidebar('dashboard');
    await refreshDashboard();

    // SSEリアルタイム更新を開始
    connectSSE();

    // SSEフォールバック: 30秒ポーリングは維持
    setInterval(refreshDashboard, 30000);
});

// ページ離脱時にSSE接続をクリーンアップ
window.addEventListener('beforeunload', disconnectSSE);
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
