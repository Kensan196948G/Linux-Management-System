<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nginx Management - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .nginx-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .nginx-card-title {
            font-size: 16px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-badge {
            font-size: 12px;
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .status-active { background: #dcfce7; color: #166534; }
        .status-inactive { background: #fee2e2; color: #991b1b; }
        .status-unknown { background: #f3f4f6; color: #374151; }
        .status-unavailable { background: #fef9c3; color: #854d0e; }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #6b7280; }
        .info-value { font-weight: 500; color: #111827; }
        .pre-content {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 6px;
            padding: 16px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .vhost-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .vhost-item:last-child { border-bottom: none; }
        .vhost-name { font-weight: 500; color: #111827; }
        .vhost-path { font-size: 12px; color: #6b7280; }
        .badge-symlink { font-size: 10px; background: #e0f2fe; color: #0369a1; padding: 1px 6px; border-radius: 8px; }
        .logs-controls { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸŒ Nginx Management</h2>
            <div>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()" id="refresh-btn">
                    ğŸ”„ æ›´æ–°
                </button>
            </div>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- Status Card -->
            <div class="nginx-card">
                <div class="nginx-card-title">
                    ğŸ“Š ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹
                    <span id="status-badge" class="status-badge status-unknown">èª­ã¿è¾¼ã¿ä¸­...</span>
                </div>
                <div id="status-content">
                    <div class="text-center py-3 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>

            <!-- Config Card -->
            <div class="nginx-card">
                <div class="nginx-card-title">âš™ï¸ è¨­å®š (nginx -T)</div>
                <div id="config-loading" class="text-center py-3 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="config-content" style="display:none">
                    <pre class="pre-content" id="config-pre"></pre>
                </div>
            </div>

            <!-- Virtual Hosts Card -->
            <div class="nginx-card">
                <div class="nginx-card-title">ğŸ–¥ï¸ ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆ (/etc/nginx/sites-enabled/)</div>
                <div id="vhosts-loading" class="text-center py-3 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="vhosts-content" style="display:none"></div>
            </div>

            <!-- Connections Card -->
            <div class="nginx-card">
                <div class="nginx-card-title">ğŸ”Œ æ¥ç¶šçŠ¶æ³</div>
                <div id="connections-loading" class="text-center py-3 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="connections-content" style="display:none">
                    <pre class="pre-content" id="connections-pre"></pre>
                </div>
            </div>

            <!-- Logs Card -->
            <div class="nginx-card">
                <div class="nginx-card-title">ğŸ“‹ ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°</div>
                <div class="logs-controls">
                    <label class="form-label mb-0 text-muted small">è¡¨ç¤ºè¡Œæ•°:</label>
                    <select class="form-select form-select-sm" id="log-lines" style="width:100px">
                        <option value="20">20è¡Œ</option>
                        <option value="50" selected>50è¡Œ</option>
                        <option value="100">100è¡Œ</option>
                        <option value="200">200è¡Œ</option>
                    </select>
                    <button class="btn btn-sm btn-outline-primary" onclick="fetchLogs()">ğŸ“¥ å–å¾—</button>
                </div>
                <div id="logs-loading" class="text-center py-3 text-muted" style="display:none">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="logs-content" style="display:none">
                    <pre class="pre-content" id="logs-pre"></pre>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>
    const API_BASE = '/api';

    function showAlert(msg, type = 'danger') {
        document.getElementById('alert-area').innerHTML =
            `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
    }

    async function apiFetch(path) {
        const token = getAuthToken();
        const res = await fetch(API_BASE + path, {
            headers: token ? { Authorization: `Bearer ${token}` } : {}
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        return res.json();
    }

    async function fetchStatus() {
        try {
            const data = await apiFetch('/nginx/status');
            const badge = document.getElementById('status-badge');
            if (data.status === 'unavailable') {
                badge.className = 'status-badge status-unavailable';
                badge.textContent = 'æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«';
                document.getElementById('status-content').innerHTML =
                    `<div class="text-warning">${data.message || 'nginx not installed'}</div>`;
                return;
            }
            const isActive = data.active === 'active';
            badge.className = `status-badge ${isActive ? 'status-active' : 'status-inactive'}`;
            badge.textContent = data.active || 'unknown';
            document.getElementById('status-content').innerHTML = `
                <div class="info-row"><span class="info-label">ã‚µãƒ¼ãƒ“ã‚¹å</span><span class="info-value">${data.service || '-'}</span></div>
                <div class="info-row"><span class="info-label">ç¨¼åƒçŠ¶æ…‹</span><span class="info-value">${data.active || '-'}</span></div>
                <div class="info-row"><span class="info-label">è‡ªå‹•èµ·å‹•</span><span class="info-value">${data.enabled || '-'}</span></div>
                <div class="info-row"><span class="info-label">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</span><span class="info-value">${data.version || '-'}</span></div>
                <div class="info-row"><span class="info-label">å–å¾—æ™‚åˆ»</span><span class="info-value">${data.timestamp || '-'}</span></div>
            `;
        } catch (e) {
            document.getElementById('status-content').innerHTML =
                `<div class="text-danger">å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
        }
    }

    async function fetchConfig() {
        document.getElementById('config-loading').style.display = '';
        document.getElementById('config-content').style.display = 'none';
        try {
            const data = await apiFetch('/nginx/config');
            document.getElementById('config-loading').style.display = 'none';
            document.getElementById('config-content').style.display = '';
            if (data.status === 'unavailable') {
                document.getElementById('config-pre').textContent = data.message || 'nginx not installed';
            } else {
                document.getElementById('config-pre').textContent = data.config || '(è¨­å®šãªã—)';
            }
        } catch (e) {
            document.getElementById('config-loading').innerHTML =
                `<div class="text-danger">å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
        }
    }

    async function fetchVhosts() {
        document.getElementById('vhosts-loading').style.display = '';
        document.getElementById('vhosts-content').style.display = 'none';
        try {
            const data = await apiFetch('/nginx/vhosts');
            document.getElementById('vhosts-loading').style.display = 'none';
            document.getElementById('vhosts-content').style.display = '';
            const vhosts = data.vhosts || [];
            if (vhosts.length === 0) {
                document.getElementById('vhosts-content').innerHTML =
                    `<div class="text-muted">${data.message || 'ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ›ã‚¹ãƒˆãªã—'}</div>`;
                return;
            }
            let html = '';
            vhosts.forEach(v => {
                html += `<div class="vhost-item">
                    <span>ğŸ“„</span>
                    <div>
                        <div class="vhost-name">${v.name}</div>
                        <div class="vhost-path">${v.path}</div>
                    </div>
                    ${v.is_symlink ? '<span class="badge-symlink">symlink</span>' : ''}
                </div>`;
            });
            document.getElementById('vhosts-content').innerHTML = html;
        } catch (e) {
            document.getElementById('vhosts-loading').innerHTML =
                `<div class="text-danger">å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
        }
    }

    async function fetchConnections() {
        document.getElementById('connections-loading').style.display = '';
        document.getElementById('connections-content').style.display = 'none';
        try {
            const data = await apiFetch('/nginx/connections');
            document.getElementById('connections-loading').style.display = 'none';
            document.getElementById('connections-content').style.display = '';
            document.getElementById('connections-pre').textContent =
                data.connections_raw || '(æ¥ç¶šãªã—)';
        } catch (e) {
            document.getElementById('connections-loading').innerHTML =
                `<div class="text-danger">å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
        }
    }

    async function fetchLogs() {
        const lines = document.getElementById('log-lines').value;
        document.getElementById('logs-loading').style.display = '';
        document.getElementById('logs-content').style.display = 'none';
        try {
            const data = await apiFetch(`/nginx/logs?lines=${lines}`);
            document.getElementById('logs-loading').style.display = 'none';
            document.getElementById('logs-content').style.display = '';
            document.getElementById('logs-pre').textContent =
                data.logs || data.message || '(ãƒ­ã‚°ãªã—)';
        } catch (e) {
            document.getElementById('logs-loading').innerHTML =
                `<div class="text-danger">å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
            document.getElementById('logs-loading').style.display = '';
        }
    }

    function refreshAll() {
        fetchStatus();
        fetchConfig();
        fetchVhosts();
        fetchConnections();
        fetchLogs();
    }

    document.addEventListener('DOMContentLoaded', () => {
        refreshAll();
    });
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
