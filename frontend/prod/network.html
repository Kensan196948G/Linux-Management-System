<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æƒ…å ± - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-up { background: #d1fae5; color: #065f46; }
        .status-down { background: #fee2e2; color: #991b1b; }
        .status-listen { background: #dbeafe; color: #1e40af; }
        .status-established { background: #d1fae5; color: #065f46; }
        .nav-tabs .nav-link { cursor: pointer; color: #374151; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #2563eb; }
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            margin-bottom: 12px;
        }
        .metric-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .metric-value { font-size: 18px; font-weight: bold; color: #111827; }
        .if-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin-bottom: 12px;
        }
        .if-name { font-size: 16px; font-weight: bold; color: #1f2937; }
        .if-addr { font-family: monospace; color: #374151; font-size: 13px; }
        .table-compact td, .table-compact th { padding: 6px 10px; font-size: 13px; }
        code { background: #f3f4f6; padding: 2px 5px; border-radius: 3px; font-size: 12px; }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆdashboard.htmlã¨å…±é€šï¼‰ -->
    <aside class="sidebar" id="sidebar-container"></aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æƒ…å ±</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <!-- ã‚¢ãƒ©ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div id="alert-area"></div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="network-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('interfaces')" id="tab-interfaces">
                        ğŸ”Œ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('connections')" id="tab-connections">
                        ğŸ”— æ¥ç¶šçŠ¶æ…‹
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('routes')" id="tab-routes">
                        ğŸ—ºï¸ ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('stats')" id="tab-stats">
                        ğŸ“Š çµ±è¨ˆ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('interfaces-detail')" id="tab-interfaces-detail">
                        ğŸ” è©³ç´°
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('dns-config')" id="tab-dns-config">
                        ğŸŒ DNSè¨­å®š
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('active-connections')" id="tab-active-connections">
                        ğŸ”— æ¥ç¶šä¸€è¦§
                    </a>
                </li>
            </ul>

            <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä¸€è¦§ -->
            <div id="pane-interfaces">
                <div id="interfaces-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="interfaces-content" style="display:none"></div>
            </div>

            <!-- æ¥ç¶šçŠ¶æ…‹ -->
            <div id="pane-connections" style="display:none">
                <div id="connections-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="connections-content" style="display:none">
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" id="conn-filter"
                               placeholder="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒãƒ¼ãƒˆãƒ»ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰" style="max-width:300px; display:inline-block"
                               oninput="filterConnections()">
                    </div>
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>çŠ¶æ…‹</th>
                                <th>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                <th>ãƒªãƒ¢ãƒ¼ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                                <th>ãƒ—ãƒ­ã‚»ã‚¹</th>
                            </tr>
                        </thead>
                        <tbody id="connections-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° -->
            <div id="pane-routes" style="display:none">
                <div id="routes-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="routes-content" style="display:none">
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>å®›å…ˆ</th>
                                <th>ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤</th>
                                <th>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</th>
                                <th>ãƒ—ãƒ­ãƒˆã‚³ãƒ«</th>
                                <th>ãƒ¡ãƒˆãƒªã‚¯ã‚¹</th>
                            </tr>
                        </thead>
                        <tbody id="routes-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- çµ±è¨ˆ -->
            <div id="pane-stats" style="display:none">
                <div id="stats-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="stats-content" style="display:none">
                    <div class="row" id="stats-cards"></div>
                </div>
            </div>

            <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è©³ç´° -->
            <div id="pane-interfaces-detail" style="display:none">
                <div id="interfaces-detail-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="interfaces-detail-content" style="display:none">
                    <pre id="interfaces-detail-pre" class="bg-light p-3 rounded" style="font-size:12px;max-height:500px;overflow:auto"></pre>
                </div>
            </div>

            <!-- DNSè¨­å®š -->
            <div id="pane-dns-config" style="display:none">
                <div id="dns-config-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="dns-config-content" style="display:none">
                    <div class="card mb-3">
                        <div class="card-header">ğŸ“„ /etc/resolv.conf</div>
                        <div class="card-body p-2">
                            <pre id="dns-resolv-pre" class="mb-0" style="font-size:12px;max-height:300px;overflow:auto"></pre>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">ğŸ“„ /etc/hosts</div>
                        <div class="card-body p-2">
                            <pre id="dns-hosts-pre" class="mb-0" style="font-size:12px;max-height:300px;overflow:auto"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šä¸€è¦§ -->
            <div id="pane-active-connections" style="display:none">
                <div id="active-connections-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="active-connections-content" style="display:none">
                    <pre id="active-connections-pre" class="bg-light p-3 rounded" style="font-size:12px;max-height:500px;overflow:auto"></pre>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="../js/env-config.js"></script>
    <script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('network')):renderSidebar('network');</script>
<script>
let allConnections = [];
let currentTab = 'interfaces';

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function showTab(tab) {
    ['interfaces', 'connections', 'routes', 'stats', 'interfaces-detail', 'dns-config', 'active-connections'].forEach(t => {
        document.getElementById(`pane-${t}`).style.display = t === tab ? '' : 'none';
        document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    });
    currentTab = tab;
    if (tab === 'interfaces') loadInterfaces();
    else if (tab === 'connections') loadConnections();
    else if (tab === 'routes') loadRoutes();
    else if (tab === 'stats') loadStats();
    else if (tab === 'interfaces-detail') loadInterfacesDetail();
    else if (tab === 'dns-config') loadDnsConfig();
    else if (tab === 'active-connections') loadActiveConnections();
}

function escapeHtml(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showAlert(msg, type = 'danger') {
    document.getElementById('alert-area').innerHTML =
        `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${msg}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
}

// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹èª­ã¿è¾¼ã¿
async function loadInterfaces() {
    const loading = document.getElementById('interfaces-loading');
    const content = document.getElementById('interfaces-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getNetworkInterfaces();
        const ifaces = data.interfaces || [];
        if (ifaces.length === 0) {
            content.innerHTML = '<p class="text-muted">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
        } else {
            content.innerHTML = ifaces.map(iface => {
                const addrs = (iface.addr_info || []).map(a =>
                    `<span class="if-addr">${a.local}/${a.prefixlen || ''} (${a.family || ''})</span>`
                ).join(' &nbsp; ');
                const state = (iface.operstate || '').toLowerCase() === 'up'
                    ? '<span class="status-badge status-up">UP</span>'
                    : '<span class="status-badge status-down">DOWN</span>';
                return `<div class="if-card">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="if-name">ğŸ”Œ ${iface.ifname || iface.name || '-'}</span>
                        ${state}
                    </div>
                    <div class="mb-1">${addrs || '<span class="text-muted">ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã—</span>'}</div>
                    <div class="text-muted" style="font-size:12px">
                        MTU: ${iface.mtu || '-'} &nbsp;|&nbsp;
                        MAC: <code>${iface.address || '-'}</code> &nbsp;|&nbsp;
                        ãƒ•ãƒ©ã‚°: ${(iface.flags || []).join(', ')}
                    </div>
                </div>`;
            }).join('');
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

// æ¥ç¶šçŠ¶æ…‹èª­ã¿è¾¼ã¿
async function loadConnections() {
    const loading = document.getElementById('connections-loading');
    const content = document.getElementById('connections-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getNetworkConnections();
        allConnections = data.connections || [];
        renderConnections(allConnections);
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

function renderConnections(conns) {
    const tbody = document.getElementById('connections-tbody');
    if (conns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">æ¥ç¶šãªã—</td></tr>';
        return;
    }
    tbody.innerHTML = conns.map(c => {
        const stateClass = c.state === 'ESTABLISHED' ? 'status-established' : 'status-listen';
        return `<tr>
            <td><span class="status-badge ${stateClass}">${c.state || '-'}</span></td>
            <td><code>${c.local_address || '-'}</code></td>
            <td><code>${c.peer_address || '-'}</code></td>
            <td style="font-size:11px;color:#6b7280">${c.process || '-'}</td>
        </tr>`;
    }).join('');
}

function filterConnections() {
    const q = document.getElementById('conn-filter').value.toLowerCase();
    const filtered = allConnections.filter(c =>
        (c.local_address || '').includes(q) ||
        (c.peer_address || '').includes(q) ||
        (c.state || '').toLowerCase().includes(q) ||
        (c.process || '').includes(q)
    );
    renderConnections(filtered);
}

// ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°èª­ã¿è¾¼ã¿
async function loadRoutes() {
    const loading = document.getElementById('routes-loading');
    const content = document.getElementById('routes-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getNetworkRoutes();
        const routes = data.routes || [];
        const tbody = document.getElementById('routes-tbody');
        if (routes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ãƒ«ãƒ¼ãƒˆãªã—</td></tr>';
        } else {
            tbody.innerHTML = routes.map(r => `<tr>
                <td><code>${r.dst || 'default'}</code></td>
                <td><code>${r.gateway || '-'}</code></td>
                <td>${r.dev || '-'}</td>
                <td>${r.protocol || '-'}</td>
                <td>${r.metric !== undefined ? r.metric : '-'}</td>
            </tr>`).join('');
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

// çµ±è¨ˆèª­ã¿è¾¼ã¿
async function loadStats() {
    const loading = document.getElementById('stats-loading');
    const content = document.getElementById('stats-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getNetworkStats();
        const stats = data.stats || [];
        const cards = document.getElementById('stats-cards');
        if (stats.length === 0) {
            cards.innerHTML = '<p class="text-muted col-12">çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ãªã—</p>';
        } else {
            cards.innerHTML = stats.map(s => {
                const rx = s.stats64?.rx || s.rx || {};
                const tx = s.stats64?.tx || s.tx || {};
                return `<div class="col-md-6 col-lg-4 mb-3">
                    <div class="metric-card">
                        <div class="if-name mb-2">ğŸ“Š ${s.ifname || s.name || '-'}</div>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-label">å—ä¿¡ (bytes)</div>
                                <div class="metric-value" style="font-size:14px">${formatBytes(rx.bytes)}</div>
                                <div class="metric-label mt-1">å—ä¿¡ãƒ‘ã‚±ãƒƒãƒˆ</div>
                                <div style="font-size:13px">${(rx.packets || 0).toLocaleString()}</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-label">é€ä¿¡ (bytes)</div>
                                <div class="metric-value" style="font-size:14px">${formatBytes(tx.bytes)}</div>
                                <div class="metric-label mt-1">é€ä¿¡ãƒ‘ã‚±ãƒƒãƒˆ</div>
                                <div style="font-size:13px">${(tx.packets || 0).toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) { bytes /= 1024; i++; }
    return `${bytes.toFixed(1)} ${units[i]}`;
}

async function loadInterfacesDetail() {
    const loading = document.getElementById('interfaces-detail-loading');
    const content = document.getElementById('interfaces-detail-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.get('/api/network/interfaces-detail');
        document.getElementById('interfaces-detail-pre').textContent =
            typeof data.interfaces === 'string' ? data.interfaces : JSON.stringify(data.interfaces, null, 2);
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadDnsConfig() {
    const loading = document.getElementById('dns-config-loading');
    const content = document.getElementById('dns-config-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.get('/api/network/dns-config');
        document.getElementById('dns-resolv-pre').textContent = data.resolv_conf || '';
        document.getElementById('dns-hosts-pre').textContent = data.hosts || '';
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadActiveConnections() {
    const loading = document.getElementById('active-connections-loading');
    const content = document.getElementById('active-connections-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.get('/api/network/active-connections');
        document.getElementById('active-connections-pre').textContent =
            typeof data.connections === 'string' ? data.connections : JSON.stringify(data.connections, null, 2);
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

function refreshAll() {
    showTab(currentTab);
}

// èªè¨¼ãƒã‚§ãƒƒã‚¯ã—ã¦åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    if (!token) { window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html'; return; }
    api.setToken(token);

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§åˆæœŸåŒ–
    if (typeof initSidebar === 'function') initSidebar('network');

    loadInterfaces();
});
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
