<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒ¼ãƒˆç®¡ç† - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active   { background: #d1fae5; color: #065f46; }
        .status-inactive { background: #f3f4f6; color: #6b7280; }
        .status-failed   { background: #fee2e2; color: #991b1b; }
        .status-enabled  { background: #d1fae5; color: #065f46; }
        .status-disabled { background: #f3f4f6; color: #6b7280; }
        .status-unknown  { background: #fef3c7; color: #92400e; }

        .nav-tabs .nav-link { cursor: pointer; color: #374151; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #2563eb; }

        .info-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin-bottom: 16px;
        }
        .info-card-title { font-size: 14px; font-weight: bold; color: #374151; margin-bottom: 12px; }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .info-item {
            background: #f9fafb;
            border-radius: 6px;
            padding: 10px 14px;
        }
        .info-label { font-size: 11px; color: #6b7280; margin-bottom: 4px; }
        .info-value { font-size: 14px; font-weight: bold; color: #111827; }

        .failed-unit-row {
            background: #fff5f5;
            border-left: 3px solid #ef4444;
        }
        .table-compact td, .table-compact th { padding: 6px 10px; font-size: 13px; }
        code { background: #f3f4f6; padding: 2px 5px; border-radius: 3px; font-size: 12px; }

        .approval-notice {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 13px;
            color: #1e40af;
            margin-bottom: 16px;
        }
        .danger-notice {
            background: #fff7ed;
            border: 1px solid #fed7aa;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 13px;
            color: #9a3412;
            margin-bottom: 16px;
        }

        .confirm-box {
            background: #fefce8;
            border: 1px solid #fde047;
            border-radius: 6px;
            padding: 12px 16px;
            margin-top: 12px;
        }
        .confirm-box-title {
            font-weight: bold;
            color: #854d0e;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .confirm-box-actions { display: flex; gap: 8px; }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸš€ ãƒ–ãƒ¼ãƒˆç®¡ç†</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="bootup-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('status')" id="tab-status">
                        ğŸ–¥ï¸ ãƒ–ãƒ¼ãƒˆçŠ¶æ…‹
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('services')" id="tab-services">
                        âš™ï¸ è‡ªå‹•èµ·å‹•ã‚µãƒ¼ãƒ“ã‚¹
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('service-op')" id="tab-service-op">
                        ğŸ”§ ã‚µãƒ¼ãƒ“ã‚¹æ“ä½œ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('system-op')" id="tab-system-op">
                        âš¡ ã‚·ã‚¹ãƒ†ãƒ æ“ä½œ
                    </a>
                </li>
            </ul>

            <!-- ã‚¿ãƒ–1: ãƒ–ãƒ¼ãƒˆçŠ¶æ…‹ -->
            <div id="pane-status">
                <div id="status-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="status-content" style="display:none"></div>
            </div>

            <!-- ã‚¿ãƒ–2: è‡ªå‹•èµ·å‹•ã‚µãƒ¼ãƒ“ã‚¹ -->
            <div id="pane-services" style="display:none">
                <div id="services-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="services-content" style="display:none"></div>
            </div>

            <!-- ã‚¿ãƒ–3: ã‚µãƒ¼ãƒ“ã‚¹æ“ä½œ -->
            <div id="pane-service-op" style="display:none">
                <div class="approval-notice">
                    â„¹ï¸ ã‚µãƒ¼ãƒ“ã‚¹ã®è‡ªå‹•èµ·å‹•æœ‰åŠ¹åŒ–ãƒ»ç„¡åŠ¹åŒ–ã¯<strong>æ‰¿èªãƒ•ãƒ­ãƒ¼</strong>ãŒå¿…è¦ã§ã™ã€‚ç”³è«‹å¾Œã€ç®¡ç†è€…ã®æ‰¿èªã‚’çµŒã¦é©ç”¨ã•ã‚Œã¾ã™ã€‚
                </div>

                <!-- æœ‰åŠ¹åŒ–ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="info-card mb-3">
                    <div class="info-card-title">âœ… è‡ªå‹•èµ·å‹•ã‚’æœ‰åŠ¹åŒ–</div>
                    <form id="enable-form" onsubmit="submitEnableDisable(event, 'enable')">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label class="form-label">å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm" id="enable-service" required>
                                    <option value="">-- ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ --</option>
                                    <option value="nginx">nginx</option>
                                    <option value="apache2">apache2</option>
                                    <option value="postgresql">postgresql</option>
                                    <option value="mysql">mysql</option>
                                    <option value="redis">redis</option>
                                    <option value="ssh">ssh</option>
                                    <option value="ufw">ufw</option>
                                    <option value="cron">cron</option>
                                    <option value="rsyslog">rsyslog</option>
                                    <option value="chrony">chrony</option>
                                    <option value="ntp">ntp</option>
                                    <option value="docker">docker</option>
                                    <option value="fail2ban">fail2ban</option>
                                </select>
                            </div>
                            <div class="col-md-7">
                                <label class="form-label">ç”³è«‹ç†ç”± <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="enable-reason"
                                       placeholder="ä¾‹: Webã‚µãƒ¼ãƒãƒ¼ã‚’è‡ªå‹•èµ·å‹•ã•ã›ã‚‹ãŸã‚" required maxlength="200">
                            </div>
                        </div>
                        <!-- ç¢ºèªUI -->
                        <div class="confirm-box mt-3" id="enable-confirm-box" style="display:none">
                            <div class="confirm-box-title">âš ï¸ ç¢ºèª: ä»¥ä¸‹ã®æ“ä½œã‚’ç”³è«‹ã—ã¾ã™</div>
                            <div class="mb-2" style="font-size:13px">
                                ã‚µãƒ¼ãƒ“ã‚¹: <strong id="enable-confirm-service"></strong> ã‚’
                                <span class="status-badge status-enabled">æœ‰åŠ¹åŒ–</span> ã™ã‚‹
                            </div>
                            <div class="mb-2" style="font-size:13px">
                                ç†ç”±: <em id="enable-confirm-reason"></em>
                            </div>
                            <div class="confirm-box-actions">
                                <button type="submit" class="btn btn-sm btn-success" id="enable-submit-btn">
                                    ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary"
                                        onclick="cancelConfirm('enable')">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                            </div>
                        </div>
                        <div class="mt-3" id="enable-preview-btn-wrap">
                            <button type="button" class="btn btn-sm btn-outline-success"
                                    onclick="showConfirm('enable')">
                                ç¢ºèªç”»é¢ã¸ â†’
                            </button>
                        </div>
                    </form>
                    <div id="enable-result" class="mt-3" style="display:none"></div>
                </div>

                <!-- ç„¡åŠ¹åŒ–ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="info-card">
                    <div class="info-card-title">ğŸš« è‡ªå‹•èµ·å‹•ã‚’ç„¡åŠ¹åŒ–</div>
                    <form id="disable-form" onsubmit="submitEnableDisable(event, 'disable')">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label class="form-label">å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm" id="disable-service" required>
                                    <option value="">-- ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠ --</option>
                                    <option value="nginx">nginx</option>
                                    <option value="apache2">apache2</option>
                                    <option value="postgresql">postgresql</option>
                                    <option value="mysql">mysql</option>
                                    <option value="redis">redis</option>
                                    <option value="ssh">ssh</option>
                                    <option value="ufw">ufw</option>
                                    <option value="cron">cron</option>
                                    <option value="rsyslog">rsyslog</option>
                                    <option value="chrony">chrony</option>
                                    <option value="ntp">ntp</option>
                                    <option value="docker">docker</option>
                                    <option value="fail2ban">fail2ban</option>
                                </select>
                            </div>
                            <div class="col-md-7">
                                <label class="form-label">ç”³è«‹ç†ç”± <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="disable-reason"
                                       placeholder="ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŸã‚ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–" required maxlength="200">
                            </div>
                        </div>
                        <!-- ç¢ºèªUI -->
                        <div class="confirm-box mt-3" id="disable-confirm-box" style="display:none">
                            <div class="confirm-box-title">âš ï¸ ç¢ºèª: ä»¥ä¸‹ã®æ“ä½œã‚’ç”³è«‹ã—ã¾ã™</div>
                            <div class="mb-2" style="font-size:13px">
                                ã‚µãƒ¼ãƒ“ã‚¹: <strong id="disable-confirm-service"></strong> ã‚’
                                <span class="status-badge status-disabled">ç„¡åŠ¹åŒ–</span> ã™ã‚‹
                            </div>
                            <div class="mb-2" style="font-size:13px">
                                ç†ç”±: <em id="disable-confirm-reason"></em>
                            </div>
                            <div class="confirm-box-actions">
                                <button type="submit" class="btn btn-sm btn-warning" id="disable-submit-btn">
                                    ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary"
                                        onclick="cancelConfirm('disable')">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                            </div>
                        </div>
                        <div class="mt-3" id="disable-preview-btn-wrap">
                            <button type="button" class="btn btn-sm btn-outline-warning"
                                    onclick="showConfirm('disable')">
                                ç¢ºèªç”»é¢ã¸ â†’
                            </button>
                        </div>
                    </form>
                    <div id="disable-result" class="mt-3" style="display:none"></div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–4: ã‚·ã‚¹ãƒ†ãƒ æ“ä½œ -->
            <div id="pane-system-op" style="display:none">
                <div class="danger-notice">
                    âš ï¸ ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒ»å†èµ·å‹•ã¯<strong>æ‰¿èªãƒ•ãƒ­ãƒ¼</strong>ãŒå¿…è¦ã§ã™ã€‚æ“ä½œå¾Œã¯æŒ‡å®šé…å»¶å¾Œã«ã‚·ã‚¹ãƒ†ãƒ ãŒåœæ­¢/å†èµ·å‹•ã—ã¾ã™ã€‚
                </div>

                <!-- ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ -->
                <div class="info-card mb-3">
                    <div class="info-card-title">â» ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ç”³è«‹</div>
                    <form id="shutdown-form" onsubmit="submitSystemAction(event, 'shutdown')">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">é…å»¶ <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm" id="shutdown-delay" required>
                                    <option value="now">ä»Šã™ã (now)</option>
                                    <option value="+1">+1 åˆ†å¾Œ</option>
                                    <option value="+2">+2 åˆ†å¾Œ</option>
                                    <option value="+5">+5 åˆ†å¾Œ</option>
                                    <option value="+10">+10 åˆ†å¾Œ</option>
                                    <option value="+30">+30 åˆ†å¾Œ</option>
                                    <option value="+60">+60 åˆ†å¾Œ</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">ç”³è«‹ç†ç”± <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="shutdown-reason"
                                       placeholder="ä¾‹: å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŸã‚" required maxlength="200">
                            </div>
                        </div>
                        <!-- ç¢ºèªUI -->
                        <div class="confirm-box mt-3" id="shutdown-confirm-box" style="display:none">
                            <div class="confirm-box-title">ğŸ”´ ç¢ºèª: ä»¥ä¸‹ã®æ“ä½œã‚’ç”³è«‹ã—ã¾ã™</div>
                            <div class="mb-2" style="font-size:13px">
                                æ“ä½œ: <span class="status-badge status-failed">ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³</span>
                                &nbsp; é…å»¶: <strong id="shutdown-confirm-delay"></strong>
                            </div>
                            <div class="mb-2" style="font-size:13px">
                                ç†ç”±: <em id="shutdown-confirm-reason"></em>
                            </div>
                            <div class="confirm-box-actions">
                                <button type="submit" class="btn btn-sm btn-danger" id="shutdown-submit-btn">
                                    ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary"
                                        onclick="cancelConfirm('shutdown')">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                            </div>
                        </div>
                        <div class="mt-3" id="shutdown-preview-btn-wrap">
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="showConfirm('shutdown')">
                                ç¢ºèªç”»é¢ã¸ â†’
                            </button>
                        </div>
                    </form>
                    <div id="shutdown-result" class="mt-3" style="display:none"></div>
                </div>

                <!-- å†èµ·å‹• -->
                <div class="info-card">
                    <div class="info-card-title">ğŸ” å†èµ·å‹•ç”³è«‹</div>
                    <form id="reboot-form" onsubmit="submitSystemAction(event, 'reboot')">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">é…å»¶ <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm" id="reboot-delay" required>
                                    <option value="now">ä»Šã™ã (now)</option>
                                    <option value="+1">+1 åˆ†å¾Œ</option>
                                    <option value="+2">+2 åˆ†å¾Œ</option>
                                    <option value="+5">+5 åˆ†å¾Œ</option>
                                    <option value="+10">+10 åˆ†å¾Œ</option>
                                    <option value="+30">+30 åˆ†å¾Œ</option>
                                    <option value="+60">+60 åˆ†å¾Œ</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">ç”³è«‹ç†ç”± <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-sm" id="reboot-reason"
                                       placeholder="ä¾‹: ã‚«ãƒ¼ãƒãƒ«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé©ç”¨ã®ãŸã‚" required maxlength="200">
                            </div>
                        </div>
                        <!-- ç¢ºèªUI -->
                        <div class="confirm-box mt-3" id="reboot-confirm-box" style="display:none">
                            <div class="confirm-box-title">ğŸŸ  ç¢ºèª: ä»¥ä¸‹ã®æ“ä½œã‚’ç”³è«‹ã—ã¾ã™</div>
                            <div class="mb-2" style="font-size:13px">
                                æ“ä½œ: <span class="status-badge status-unknown">å†èµ·å‹•</span>
                                &nbsp; é…å»¶: <strong id="reboot-confirm-delay"></strong>
                            </div>
                            <div class="mb-2" style="font-size:13px">
                                ç†ç”±: <em id="reboot-confirm-reason"></em>
                            </div>
                            <div class="confirm-box-actions">
                                <button type="submit" class="btn btn-sm btn-warning" id="reboot-submit-btn">
                                    ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary"
                                        onclick="cancelConfirm('reboot')">
                                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                                </button>
                            </div>
                        </div>
                        <div class="mt-3" id="reboot-preview-btn-wrap">
                            <button type="button" class="btn btn-sm btn-outline-warning"
                                    onclick="showConfirm('reboot')">
                                ç¢ºèªç”»é¢ã¸ â†’
                            </button>
                        </div>
                    </form>
                    <div id="reboot-result" class="mt-3" style="display:none"></div>
                </div>
            </div>

        </div><!-- /.main-body -->
    </main>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('bootup')):renderSidebar('bootup');</script>
<script>
// ===================================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ===================================================================

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function showAlert(msg, type) {
    var t = type || 'danger';
    document.getElementById('alert-area').innerHTML =
        '<div class="alert alert-' + t + ' alert-dismissible fade show" role="alert">' +
            msg +
            '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
        '</div>';
}

// ===================================================================
// ã‚¿ãƒ–åˆ¶å¾¡
// ===================================================================

var currentTab = 'status';

function showTab(tab) {
    ['status', 'services', 'service-op', 'system-op'].forEach(function(t) {
        document.getElementById('pane-' + t).style.display = t === tab ? '' : 'none';
        document.getElementById('tab-' + t).classList.toggle('active', t === tab);
    });
    currentTab = tab;
    if (tab === 'status') loadStatus();
    else if (tab === 'services') loadServices();
}

function refreshAll() {
    if (currentTab === 'status') loadStatus();
    else if (currentTab === 'services') loadServices();
    else showAlert('ç¾åœ¨ã®ã‚¿ãƒ–ã¯æ›´æ–°ãƒœã‚¿ãƒ³ä¸è¦ã§ã™ã€‚', 'info');
}

// ===================================================================
// ã‚¿ãƒ–1: ãƒ–ãƒ¼ãƒˆçŠ¶æ…‹
// ===================================================================

async function loadStatus() {
    var loading = document.getElementById('status-loading');
    var content = document.getElementById('status-content');
    loading.style.display = '';
    content.style.display = 'none';
    loading.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';

    try {
        var data = await api.getBootupStatus();
        content.innerHTML = buildStatusContent(data);
        loading.style.display = 'none';
        content.style.display = '';
    } catch (e) {
        loading.innerHTML = '<div class="alert alert-warning">å–å¾—å¤±æ•—: ' + escapeHtml(e.message) + '</div>';
    }
}

function buildStatusContent(data) {
    var defaultTarget = escapeHtml(data.default_target || '-');
    var uptime = escapeHtml(data.uptime || '-');
    var lastBoot = escapeHtml(data.last_boot || '-');
    var failedUnits = data.failed_units || [];

    var infoGrid =
        '<div class="info-card">' +
            '<div class="info-card-title">ğŸ–¥ï¸ ã‚·ã‚¹ãƒ†ãƒ ãƒ–ãƒ¼ãƒˆæƒ…å ±</div>' +
            '<div class="info-grid">' +
                '<div class="info-item">' +
                    '<div class="info-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</div>' +
                    '<div class="info-value">' + defaultTarget + '</div>' +
                '</div>' +
                '<div class="info-item">' +
                    '<div class="info-label">ç¨¼åƒæ™‚é–“</div>' +
                    '<div class="info-value">' + uptime + '</div>' +
                '</div>' +
                '<div class="info-item">' +
                    '<div class="info-label">æœ€çµ‚èµ·å‹•æ—¥æ™‚</div>' +
                    '<div class="info-value">' + lastBoot + '</div>' +
                '</div>' +
            '</div>' +
        '</div>';

    var failedSection = buildFailedUnitsSection(failedUnits);

    return infoGrid + failedSection;
}

function buildFailedUnitsSection(failedUnits) {
    if (!failedUnits || failedUnits.length === 0) {
        return '<div class="info-card">' +
                   '<div class="info-card-title">ğŸ”´ ç•°å¸¸ãƒ¦ãƒ‹ãƒƒãƒˆ</div>' +
                   '<div class="text-success" style="font-size:14px; padding: 8px 0;">âœ… ç•°å¸¸ãªã—</div>' +
               '</div>';
    }

    var rows = failedUnits.map(function(u) {
        var unit = escapeHtml(u.unit || '-');
        var activeState = escapeHtml(u.active_state || '-');
        var subState = escapeHtml(u.sub_state || '-');
        return '<tr class="failed-unit-row">' +
                   '<td><code>' + unit + '</code></td>' +
                   '<td><span class="status-badge status-failed">' + activeState + '</span></td>' +
                   '<td>' + subState + '</td>' +
               '</tr>';
    }).join('');

    return '<div class="info-card">' +
               '<div class="info-card-title">' +
                   'ğŸ”´ ç•°å¸¸ãƒ¦ãƒ‹ãƒƒãƒˆ' +
                   '<span class="badge bg-danger ms-2">' + failedUnits.length + '</span>' +
               '</div>' +
               '<table class="table table-sm table-hover table-compact">' +
                   '<thead class="table-dark">' +
                       '<tr><th>ãƒ¦ãƒ‹ãƒƒãƒˆå</th><th>çŠ¶æ…‹</th><th>ã‚µãƒ–çŠ¶æ…‹</th></tr>' +
                   '</thead>' +
                   '<tbody>' + rows + '</tbody>' +
               '</table>' +
           '</div>';
}

// ===================================================================
// ã‚¿ãƒ–2: è‡ªå‹•èµ·å‹•ã‚µãƒ¼ãƒ“ã‚¹
// ===================================================================

async function loadServices() {
    var loading = document.getElementById('services-loading');
    var content = document.getElementById('services-content');
    loading.style.display = '';
    content.style.display = 'none';
    loading.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';

    try {
        var data = await api.getBootupServices();
        var services = data.services || [];
        content.innerHTML = buildServicesTable(services);
        loading.style.display = 'none';
        content.style.display = '';
    } catch (e) {
        loading.innerHTML = '<div class="alert alert-warning">å–å¾—å¤±æ•—: ' + escapeHtml(e.message) + '</div>';
    }
}

function buildServicesTable(services) {
    if (!services || services.length === 0) {
        return '<div class="text-muted">ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
    }

    var rows = services.map(function(svc) {
        var unit = escapeHtml(svc.unit || '-');
        var state = (svc.state || '').toLowerCase();
        var vendorPreset = escapeHtml(svc.vendor_preset || '-');

        var stateClass = 'status-unknown';
        if (state === 'enabled') stateClass = 'status-enabled';
        else if (state === 'disabled') stateClass = 'status-disabled';
        else if (state === 'active') stateClass = 'status-active';
        else if (state === 'failed') stateClass = 'status-failed';
        else if (state === 'inactive') stateClass = 'status-inactive';

        var presetLower = (svc.vendor_preset || '').toLowerCase();
        var presetClass = 'status-inactive';
        if (presetLower === 'enabled') presetClass = 'status-active';

        return '<tr>' +
                   '<td><code>' + unit + '</code></td>' +
                   '<td><span class="status-badge ' + stateClass + '">' + escapeHtml(svc.state || '-') + '</span></td>' +
                   '<td><span class="status-badge ' + presetClass + '">' + vendorPreset + '</span></td>' +
               '</tr>';
    }).join('');

    return '<div class="mb-2 text-muted" style="font-size:12px">åˆè¨ˆ: ' + services.length + ' ä»¶</div>' +
           '<table class="table table-sm table-hover table-compact">' +
               '<thead class="table-dark">' +
                   '<tr><th>ãƒ¦ãƒ‹ãƒƒãƒˆå</th><th>çŠ¶æ…‹</th><th>ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ—ãƒªã‚»ãƒƒãƒˆ</th></tr>' +
               '</thead>' +
               '<tbody>' + rows + '</tbody>' +
           '</table>';
}

// ===================================================================
// ã‚¿ãƒ–3: ã‚µãƒ¼ãƒ“ã‚¹æ“ä½œï¼ˆç¢ºèªUIåˆ¶å¾¡ï¼‰
// ===================================================================

function showConfirm(type) {
    if (type === 'enable') {
        var service = document.getElementById('enable-service').value;
        var reason = document.getElementById('enable-reason').value.trim();
        if (!service) { showAlert('ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
        if (!reason) { showAlert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
        document.getElementById('enable-confirm-service').textContent = service;
        document.getElementById('enable-confirm-reason').textContent = reason;
        document.getElementById('enable-confirm-box').style.display = '';
        document.getElementById('enable-preview-btn-wrap').style.display = 'none';
    } else if (type === 'disable') {
        var service = document.getElementById('disable-service').value;
        var reason = document.getElementById('disable-reason').value.trim();
        if (!service) { showAlert('ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
        if (!reason) { showAlert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
        document.getElementById('disable-confirm-service').textContent = service;
        document.getElementById('disable-confirm-reason').textContent = reason;
        document.getElementById('disable-confirm-box').style.display = '';
        document.getElementById('disable-preview-btn-wrap').style.display = 'none';
    } else if (type === 'shutdown') {
        var delay = document.getElementById('shutdown-delay').value;
        var reason = document.getElementById('shutdown-reason').value.trim();
        if (!reason) { showAlert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
        document.getElementById('shutdown-confirm-delay').textContent = delay;
        document.getElementById('shutdown-confirm-reason').textContent = reason;
        document.getElementById('shutdown-confirm-box').style.display = '';
        document.getElementById('shutdown-preview-btn-wrap').style.display = 'none';
    } else if (type === 'reboot') {
        var delay = document.getElementById('reboot-delay').value;
        var reason = document.getElementById('reboot-reason').value.trim();
        if (!reason) { showAlert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
        document.getElementById('reboot-confirm-delay').textContent = delay;
        document.getElementById('reboot-confirm-reason').textContent = reason;
        document.getElementById('reboot-confirm-box').style.display = '';
        document.getElementById('reboot-preview-btn-wrap').style.display = 'none';
    }
}

function cancelConfirm(type) {
    document.getElementById(type + '-confirm-box').style.display = 'none';
    document.getElementById(type + '-preview-btn-wrap').style.display = '';
}

// ===================================================================
// ã‚¿ãƒ–3: ã‚µãƒ¼ãƒ“ã‚¹æœ‰åŠ¹åŒ–ãƒ»ç„¡åŠ¹åŒ–é€ä¿¡
// ===================================================================

async function submitEnableDisable(event, action) {
    event.preventDefault();
    var service = document.getElementById(action + '-service').value;
    var reason = document.getElementById(action + '-reason').value.trim();
    var submitBtn = document.getElementById(action + '-submit-btn');
    var result = document.getElementById(action + '-result');

    if (!service) { showAlert('ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
    if (!reason) { showAlert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = 'é€ä¿¡ä¸­...';
    result.style.display = 'none';

    try {
        var data;
        if (action === 'enable') {
            data = await api.enableBootupService(service, reason);
        } else {
            data = await api.disableBootupService(service, reason);
        }

        if (data.status === 'pending_approval') {
            result.innerHTML =
                '<div class="alert alert-info">' +
                    'âœ… ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ˆæ‰¿èªå¾…ã¡ï¼‰ã€‚<br>' +
                    'ç”³è«‹ID: <code>' + escapeHtml(data.request_id || '-') + '</code><br>' +
                    '<small class="text-muted">' + escapeHtml(data.message || '') + '</small>' +
                '</div>';
            document.getElementById(action + '-form').reset();
        } else {
            result.innerHTML =
                '<div class="alert alert-success">âœ… ' +
                    escapeHtml(data.message || 'ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸ') +
                '</div>';
        }
        result.style.display = '';
    } catch (e) {
        result.innerHTML =
            '<div class="alert alert-danger">ç”³è«‹å¤±æ•—: ' + escapeHtml(e.message) + '</div>';
        result.style.display = '';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡';
        cancelConfirm(action);
    }
}

// ===================================================================
// ã‚¿ãƒ–4: ã‚·ã‚¹ãƒ†ãƒ æ“ä½œé€ä¿¡ï¼ˆshutdown / rebootï¼‰
// ===================================================================

async function submitSystemAction(event, action) {
    event.preventDefault();
    var delay = document.getElementById(action + '-delay').value;
    var reason = document.getElementById(action + '-reason').value.trim();
    var submitBtn = document.getElementById(action + '-submit-btn');
    var result = document.getElementById(action + '-result');

    if (!reason) { showAlert('ç”³è«‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    submitBtn.disabled = true;
    submitBtn.textContent = 'é€ä¿¡ä¸­...';
    result.style.display = 'none';

    try {
        var data = await api.bootupAction(action, delay, reason);

        if (data.status === 'pending_approval') {
            result.innerHTML =
                '<div class="alert alert-info">' +
                    'âœ… ç”³è«‹ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸï¼ˆæ‰¿èªå¾…ã¡ï¼‰ã€‚<br>' +
                    'ç”³è«‹ID: <code>' + escapeHtml(data.request_id || '-') + '</code><br>' +
                    '<small class="text-muted">' + escapeHtml(data.message || '') + '</small>' +
                '</div>';
            document.getElementById(action + '-form').reset();
        } else {
            result.innerHTML =
                '<div class="alert alert-success">âœ… ' +
                    escapeHtml(data.message || 'ç”³è«‹ãŒå®Œäº†ã—ã¾ã—ãŸ') +
                '</div>';
        }
        result.style.display = '';
    } catch (e) {
        result.innerHTML =
            '<div class="alert alert-danger">ç”³è«‹å¤±æ•—: ' + escapeHtml(e.message) + '</div>';
        result.style.display = '';
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“¨ æ‰¿èªç”³è«‹ã‚’é€ä¿¡';
        cancelConfirm(action);
    }
}

// ===================================================================
// åˆæœŸåŒ–
// ===================================================================

document.addEventListener('DOMContentLoaded', function() {
    var token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html';
        return;
    }
    api.setToken(token);
    if (typeof initSidebar === 'function') initSidebar('bootup');
    loadStatus();
});
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
