<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚° - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link href="../vendor/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« */
        .log-table th { background: #2c3e50; color: #fff; padding: 8px 10px; font-size: 13px; position: sticky; top: 0; z-index: 10; }
        .log-table td { padding: 5px 10px; font-size: 12px; vertical-align: top; border-bottom: 1px solid #f1f5f9; }
        .log-table tr:hover { background: #f8fafc; }
        .log-table .col-ts   { width: 160px; font-family: monospace; color: #64748b; white-space: nowrap; }
        .log-table .col-lvl  { width: 80px; text-align: center; }
        .log-table .col-svc  { width: 110px; font-family: monospace; font-size: 11px; color: #4b5563; }
        .log-table .col-msg  { font-family: monospace; word-break: break-all; }

        /* ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ */
        .lvl-error   { background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; }
        .lvl-warning { background:#fef3c7; color:#92400e; border:1px solid #fcd34d; }
        .lvl-info    { background:#dbeafe; color:#1e40af; border:1px solid #93c5fd; }
        .lvl-debug   { background:#f3f4f6; color:#6b7280; border:1px solid #d1d5db; }
        .lvl-badge {
            display: inline-block; padding: 1px 7px; border-radius: 10px;
            font-size: 11px; font-weight: 700;
        }
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
        .filter-btns { display: flex; gap: 6px; flex-wrap: wrap; }
        .filter-btn {
            padding: 4px 14px; border-radius: 16px; border: 1.5px solid #d1d5db;
            background: #fff; color: #374151; font-size: 13px; cursor: pointer;
            transition: all 0.15s;
        }
        .filter-btn:hover { border-color: #6b7280; background: #f9fafb; }
        .filter-btn.active-all     { border-color:#6b7280; background:#374151; color:#fff; }
        .filter-btn.active-ERROR   { border-color:#ef4444; background:#fee2e2; color:#991b1b; }
        .filter-btn.active-WARNING { border-color:#f59e0b; background:#fef3c7; color:#92400e; }
        .filter-btn.active-INFO    { border-color:#3b82f6; background:#dbeafe; color:#1e40af; }
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ */
        .filter-bar { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:14px 16px; margin-bottom:14px; }
        /* è‡ªå‹•æ›´æ–°ãƒœã‚¿ãƒ³ */
        .auto-refresh-on { background:#d1fae5 !important; border-color:#10b981 !important; color:#065f46 !important; }
        /* ã‚¨ãƒ©ãƒ¼ãƒœãƒƒã‚¯ã‚¹ */
        .error-box { background:#fee2e2; border:1px solid #fca5a5; border-radius:8px; padding:14px 16px; color:#991b1b; margin-bottom:12px; }
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        #loading-indicator { color:#6b7280; font-size:14px; }
        /* ãƒ­ãƒ¼ãƒ‰ãƒ¢ã‚¢ãƒœã‚¿ãƒ³ */
        #load-more-btn { margin-top: 10px; }
        /* æ¤œç´¢ãƒãƒ¼ */
        .search-bar { background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:12px 16px; margin-bottom:12px; }
        /* æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .search-highlight { background:#fef08a; border-radius:2px; font-weight:700; }
        /* ã‚¨ãƒ©ãƒ¼ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .err-highlight { color:#991b1b; font-weight:700; }
        /* æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ãƒ‘ãƒãƒ« */
        .recent-errors-panel { background:#fff5f5; border:1px solid #fca5a5; border-radius:8px; padding:12px 16px; margin-top:14px; max-height:220px; overflow-y:auto; }
        .recent-errors-panel h6 { color:#991b1b; margin-bottom:8px; }
        .recent-errors-panel .err-line { font-family:monospace; font-size:11px; color:#7f1d1d; border-bottom:1px solid #fee2e2; padding:2px 0; word-break:break-all; }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- å·¦å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar" id="sidebar-container"></aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="main-header">
            <h2>ğŸ“œ ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h2>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn btn-sm btn-outline-success" id="auto-refresh-btn" onclick="toggleAutoRefresh()">
                    â± è‡ªå‹•æ›´æ–°: OFF
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="fetchLogs(true)">
                    ğŸ”„ æ›´æ–°
                </button>
                <a href="dashboard.html" class="btn btn-sm btn-outline-primary">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            </div>
        </div>

        <div class="main-body">

            <!-- æ¤œç´¢ãƒãƒ¼ (Step 25) -->
            <div class="search-bar">
                <div class="row g-2 align-items-end">
                    <div class="col-sm-4">
                        <label class="form-label form-label-sm mb-1">ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                        <input type="text" class="form-control form-control-sm" id="search-input" placeholder="ä¾‹: error, nginx, failed..." maxlength="100">
                    </div>
                    <div class="col-sm-3">
                        <label class="form-label form-label-sm mb-1">å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«</label>
                        <select class="form-select form-select-sm" id="search-file-select">
                            <option value="syslog">syslog</option>
                            <option value="auth.log">auth.log</option>
                            <option value="kern.log">kern.log</option>
                        </select>
                    </div>
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">ä»¶æ•°</label>
                        <select class="form-select form-select-sm" id="search-lines-select">
                            <option value="20">20ä»¶</option>
                            <option value="50" selected>50ä»¶</option>
                            <option value="100">100ä»¶</option>
                            <option value="200">200ä»¶</option>
                        </select>
                    </div>
                    <div class="col-sm-3">
                        <button class="btn btn-sm btn-info w-100" onclick="searchLogs()">ğŸ” ãƒ­ã‚°æ¤œç´¢</button>
                    </div>
                </div>
                <div id="search-result-container" class="mt-2" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small text-muted" id="search-result-label"></span>
                        <button class="btn btn-xs btn-outline-secondary btn-sm py-0 px-2" onclick="clearSearch()">âœ• ã‚¯ãƒªã‚¢</button>
                    </div>
                    <div id="search-result-box" class="font-monospace small" style="max-height:200px;overflow-y:auto;background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:8px;"></div>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ -->
            <div class="filter-bar">
                <div class="row g-2 align-items-end">
                    <!-- ã‚µãƒ¼ãƒ“ã‚¹é¸æŠ -->
                    <div class="col-sm-3">
                        <label class="form-label form-label-sm mb-1">ã‚µãƒ¼ãƒ“ã‚¹å</label>
                        <select class="form-select form-select-sm" id="service-select">
                            <option value="nginx">nginx</option>
                            <option value="sshd">sshd</option>
                            <option value="systemd">systemd</option>
                            <option value="apache2">apache2</option>
                            <option value="mysql">mysql</option>
                            <option value="postgresql">postgresql</option>
                            <option value="cron">cron</option>
                            <option value="kernel">kernel</option>
                            <option value="auth">auth</option>
                        </select>
                    </div>
                    <!-- å–å¾—è¡Œæ•° -->
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">å–å¾—è¡Œæ•°</label>
                        <select class="form-select form-select-sm" id="lines-select">
                            <option value="50">50è¡Œ</option>
                            <option value="100" selected>100è¡Œ</option>
                            <option value="200">200è¡Œ</option>
                            <option value="500">500è¡Œ</option>
                        </select>
                    </div>
                    <!-- é–‹å§‹æ—¥æ™‚ -->
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">é–‹å§‹æ—¥æ™‚</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="filter-start">
                    </div>
                    <!-- çµ‚äº†æ—¥æ™‚ -->
                    <div class="col-sm-2">
                        <label class="form-label form-label-sm mb-1">çµ‚äº†æ—¥æ™‚</label>
                        <input type="datetime-local" class="form-control form-control-sm" id="filter-end">
                    </div>
                    <!-- æ¤œç´¢ãƒœã‚¿ãƒ³ -->
                    <div class="col-sm-3">
                        <button class="btn btn-sm btn-primary w-100" onclick="fetchLogs(true)">ğŸ” ãƒ­ã‚°å–å¾—</button>
                    </div>
                </div>

                <!-- ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="mt-3 d-flex align-items-center gap-3 flex-wrap">
                    <span class="text-muted small fw-semibold">ãƒ¬ãƒ™ãƒ«çµã‚Šè¾¼ã¿:</span>
                    <div class="filter-btns">
                        <button class="filter-btn active-all" id="btn-ALL"     onclick="setLevelFilter('ALL')">ALL</button>
                        <button class="filter-btn"            id="btn-ERROR"   onclick="setLevelFilter('ERROR')">âŒ ERROR</button>
                        <button class="filter-btn"            id="btn-WARNING" onclick="setLevelFilter('WARNING')">âš ï¸ WARNING</button>
                        <button class="filter-btn"            id="btn-INFO"    onclick="setLevelFilter('INFO')">â„¹ï¸ INFO</button>
                    </div>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
            <div id="error-container"></div>

            <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
            <div id="loading-indicator" class="text-center py-3" style="display:none;">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>èª­ã¿è¾¼ã¿ä¸­...
            </div>

            <!-- çµ±è¨ˆè¡Œ -->
            <div id="stats-row" class="d-flex gap-3 mb-2 small text-muted" style="display:none!important;"></div>

            <!-- ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
            <div id="log-container" style="display:none;">
                <div class="table-responsive" style="max-height:560px; overflow-y:auto;">
                    <table class="table table-sm log-table">
                        <thead>
                            <tr>
                                <th class="col-ts">ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—</th>
                                <th class="col-lvl">ãƒ¬ãƒ™ãƒ«</th>
                                <th class="col-svc">ã‚µãƒ¼ãƒ“ã‚¹</th>
                                <th class="col-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</th>
                            </tr>
                        </thead>
                        <tbody id="log-tbody"></tbody>
                    </table>
                </div>
                <div class="text-center" id="load-more-area" style="display:none;">
                    <button class="btn btn-sm btn-outline-secondary" id="load-more-btn" onclick="loadMore()">
                        â• ã‚‚ã£ã¨èª­ã¿è¾¼ã‚€
                    </button>
                </div>
                <div class="text-muted small mt-1" id="log-count-label"></div>
            </div>

            <!-- ç©ºçŠ¶æ…‹ -->
            <div id="empty-state" class="text-center py-5 text-muted" style="display:none;">
                <p>ğŸ“œ è¡¨ç¤ºã™ã‚‹ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
                <p class="small">ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã¦ã€Œãƒ­ã‚°å–å¾—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
            </div>

            <!-- æœ€è¿‘ã®ã‚¨ãƒ©ãƒ¼ãƒ‘ãƒãƒ« (Step 25) -->
            <div id="recent-errors-panel" class="recent-errors-panel" style="display:none;">
                <h6>ğŸš¨ ç›´è¿‘ã®ã‚¨ãƒ©ãƒ¼</h6>
                <div id="recent-errors-body"></div>
            </div>

        </div>
    </main>
</div>

<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
<script src="../js/env-config.js"></script>
    <script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('logs')):renderSidebar('logs');</script>
<script>
'use strict';

// ===== èªè¨¼ãƒã‚§ãƒƒã‚¯ =====
const token = localStorage.getItem('access_token');
if (!token) { window.location.href = 'dashboard.html'; }

// ===== çŠ¶æ…‹ç®¡ç† =====
let allParsedLogs  = [];   // å…¨ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ­ã‚°
let filteredLogs   = [];   // ãƒ•ã‚£ãƒ«ã‚¿å¾Œãƒ­ã‚°
let displayedCount = 0;
const PAGE_SIZE    = 100;
let levelFilter    = 'ALL';
let autoRefreshTimer = null;
let currentService = '';

// ===== HTML ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— =====
function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

// ===== ãƒ­ã‚°è¡Œã®ãƒ‘ãƒ¼ã‚¹ =====
// syslog: "Mar 10 12:34:56 host svc[pid]: msg"
// journald: "2024-03-10T12:34:56+09:00 host svc[pid]: msg"
// systemd: "Mar 10 12:34:56 svc[pid]: msg"
function parseLogLine(line, serviceName) {
    let timestamp = '';
    let level     = 'INFO';
    let service   = serviceName || '';
    let message   = line;

    // ISO timestamp
    const isoMatch = line.match(/^(\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}[^\s]*)/);
    if (isoMatch) {
        timestamp = isoMatch[1];
        message   = line.slice(isoMatch[0].length).trim();
    }
    // Syslog timestamp: "Jan  1 12:34:56" or "Mar 10 12:34:56"
    else {
        const syslogMatch = line.match(/^([A-Za-z]{3}\s+\d{1,2}\s+\d{2}:\d{2}:\d{2})/);
        if (syslogMatch) {
            timestamp = syslogMatch[1];
            message   = line.slice(syslogMatch[0].length).trim();
        }
    }

    // Extract service from "hostname svc[pid]:" or "svc[pid]:"
    const svcMatch = message.match(/^[\w.-]+\s+([\w./@-]+)(?:\[\d+\])?:\s*/);
    if (svcMatch) {
        service = svcMatch[1];
        message = message.slice(svcMatch[0].length);
    } else {
        const svcMatch2 = message.match(/^([\w./@-]+)(?:\[\d+\])?:\s*/);
        if (svcMatch2) {
            service = svcMatch2[1];
            message = message.slice(svcMatch2[0].length);
        }
    }

    // Detect log level
    if (/\b(error|err|critical|crit|fatal|emerg|alert)\b/i.test(message) ||
        /\b(ERROR|CRITICAL|FATAL|EMERG)\b/.test(message)) {
        level = 'ERROR';
    } else if (/\b(warn(?:ing)?)\b/i.test(message) || /\bWARN(?:ING)?\b/.test(message)) {
        level = 'WARNING';
    } else if (/\b(debug)\b/i.test(message) || /\bDEBUG\b/.test(message)) {
        level = 'DEBUG';
    } else {
        level = 'INFO';
    }

    return { timestamp, level, service: service || serviceName, message, raw: line };
}

// ===== ãƒ¬ãƒ™ãƒ«ãƒãƒƒã‚¸ HTML =====
function levelBadge(level) {
    const cls = {
        ERROR:   'lvl-error',
        WARNING: 'lvl-warning',
        INFO:    'lvl-info',
        DEBUG:   'lvl-debug',
    }[level] || 'lvl-debug';
    return `<span class="lvl-badge ${cls}">${escapeHtml(level)}</span>`;
}

// ===== æ™‚é–“ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ =====
function matchesTimeRange(log) {
    const startStr = document.getElementById('filter-start').value;
    const endStr   = document.getElementById('filter-end').value;
    if (!startStr && !endStr) return true;
    if (!log.timestamp) return true;
    try {
        const ts = new Date(log.timestamp);
        if (startStr && ts < new Date(startStr)) return false;
        if (endStr   && ts > new Date(endStr))   return false;
    } catch(e) { return true; }
    return true;
}

// ===== ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ =====
function applyFilters() {
    filteredLogs = allParsedLogs.filter(log => {
        if (levelFilter !== 'ALL' && log.level !== levelFilter) return false;
        if (!matchesTimeRange(log)) return false;
        return true;
    });
    displayedCount = 0;
    renderLogs();
}

// ===== ãƒ­ã‚°è¡Œæç”» =====
function renderLogs() {
    const tbody    = document.getElementById('log-tbody');
    const logCont  = document.getElementById('log-container');
    const empty    = document.getElementById('empty-state');
    const countLbl = document.getElementById('log-count-label');
    const moreArea = document.getElementById('load-more-area');

    if (filteredLogs.length === 0) {
        logCont.style.display = 'none';
        empty.style.display   = 'block';
        return;
    }

    logCont.style.display = 'block';
    empty.style.display   = 'none';

    const slice   = filteredLogs.slice(displayedCount, displayedCount + PAGE_SIZE);
    const isReset = displayedCount === 0;
    if (isReset) tbody.innerHTML = '';

    const frag = document.createDocumentFragment();
    slice.forEach(log => {
        const tr = document.createElement('tr');

        const tdTs = document.createElement('td');
        tdTs.className = 'col-ts';
        tdTs.textContent = log.timestamp || 'â€”';
        tr.appendChild(tdTs);

        const tdLvl = document.createElement('td');
        tdLvl.className = 'col-lvl';
        tdLvl.innerHTML = levelBadge(log.level);
        tr.appendChild(tdLvl);

        const tdSvc = document.createElement('td');
        tdSvc.className = 'col-svc';
        tdSvc.textContent = log.service || 'â€”';
        tr.appendChild(tdSvc);

        const tdMsg = document.createElement('td');
        tdMsg.className = 'col-msg';
        tdMsg.textContent = log.message;
        tr.appendChild(tdMsg);

        frag.appendChild(tr);
    });
    tbody.appendChild(frag);

    displayedCount += slice.length;
    const total = filteredLogs.length;
    countLbl.textContent = `è¡¨ç¤º: ${displayedCount} / ${total} ä»¶`;
    moreArea.style.display = displayedCount < total ? 'block' : 'none';
}

// ===== ã‚‚ã£ã¨èª­ã¿è¾¼ã‚€ =====
function loadMore() { renderLogs(); }

// ===== ãƒ­ã‚°å–å¾— =====
async function fetchLogs(resetDisplay) {
    const serviceName = document.getElementById('service-select').value;
    const lines       = parseInt(document.getElementById('lines-select').value, 10);
    if (!serviceName) { showError('ã‚µãƒ¼ãƒ“ã‚¹åã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }

    currentService = serviceName;
    clearError();
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('log-container').style.display     = 'none';
    document.getElementById('empty-state').style.display       = 'none';

    try {
        const data = await api.getLogs(serviceName, lines);
        const rawLines = data.logs || [];

        allParsedLogs = rawLines.map(line => parseLogLine(line, serviceName));

        if (resetDisplay) {
            displayedCount = 0;
        }
        applyFilters();

    } catch (err) {
        showError(`ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(err.message)}`);
    } finally {
        document.getElementById('loading-indicator').style.display = 'none';
    }
}

// ===== ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆ =====
function setLevelFilter(level) {
    levelFilter = level;
    ['ALL','ERROR','WARNING','INFO'].forEach(l => {
        const btn = document.getElementById('btn-' + l);
        if (!btn) return;
        btn.className = 'filter-btn' + (l === level ? ` active-${l}` : '');
    });
    applyFilters();
}

// ===== è‡ªå‹•æ›´æ–° =====
function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        btn.textContent = 'â± è‡ªå‹•æ›´æ–°: OFF';
        btn.classList.remove('auto-refresh-on');
    } else {
        autoRefreshTimer = setInterval(() => fetchLogs(true), 10000);
        btn.textContent = 'â± è‡ªå‹•æ›´æ–°: ON (10ç§’)';
        btn.classList.add('auto-refresh-on');
        fetchLogs(true);
    }
}

// ===== ã‚¨ãƒ©ãƒ¼è¡¨ç¤º =====
function showError(msg) {
    const c = document.getElementById('error-container');
    c.innerHTML = `<div class="error-box">âš ï¸ ${escapeHtml(msg)}</div>`;
}
function clearError() {
    document.getElementById('error-container').innerHTML = '';
}

// ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
function logout() {
    localStorage.removeItem('access_token');
    window.location.href = 'dashboard.html';
}

// ===== ãƒ­ã‚°æ¤œç´¢ (Step 25) =====
async function searchLogs() {
    const q     = document.getElementById('search-input').value.trim();
    const file  = document.getElementById('search-file-select').value;
    const lines = document.getElementById('search-lines-select').value;
    const resCont = document.getElementById('search-result-container');
    const resBox  = document.getElementById('search-result-box');
    const resLbl  = document.getElementById('search-result-label');
    if (!q) { return; }
    resBox.innerHTML = '<span class="text-muted">æ¤œç´¢ä¸­...</span>';
    resCont.style.display = 'block';
    try {
        const resp = await fetch(
            `${window.location.origin}/api/logs/search?q=${encodeURIComponent(q)}&file=${encodeURIComponent(file)}&lines=${lines}`,
            { headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` } }
        );
        if (resp.status === 401) { window.location.href = 'dashboard.html'; return; }
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            resBox.innerHTML = `<span class="text-danger">ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.detail || resp.status)}</span>`;
            resLbl.textContent = 'æ¤œç´¢å¤±æ•—';
            return;
        }
        const data = await resp.json();
        const results = data.results || [];
        resLbl.textContent = `"${escapeHtml(q)}" â€” ${results.length} ä»¶`;
        if (results.length === 0) {
            resBox.innerHTML = '<span class="text-muted">çµæœãªã—</span>';
            return;
        }
        const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
        resBox.innerHTML = results.map(line => {
            const escaped = escapeHtml(line);
            const highlighted = escaped.replace(re, m => `<mark class="search-highlight">${escapeHtml(m)}</mark>`);
            const errClass = /error|critical|fatal/i.test(line) ? ' err-highlight' : '';
            return `<div class="py-1 border-bottom${errClass}">${highlighted}</div>`;
        }).join('');
    } catch (e) {
        resBox.innerHTML = `<span class="text-danger">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${escapeHtml(e.message)}</span>`;
    }
}

function clearSearch() {
    document.getElementById('search-result-container').style.display = 'none';
    document.getElementById('search-input').value = '';
}

// ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å‹•çš„å–å¾—ã—ã¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
async function loadLogFiles() {
    try {
        const resp = await fetch(
            `${window.location.origin}/api/logs/files`,
            { headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` } }
        );
        if (!resp.ok) return;
        const data = await resp.json();
        const files = (data.files || []).map(f => f.replace(/.*\//, ''));
        const sel = document.getElementById('search-file-select');
        const current = sel.value;
        sel.innerHTML = '';
        const unique = [...new Set(['syslog', 'auth.log', 'kern.log', ...files])];
        unique.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f; opt.textContent = f;
            if (f === current) opt.selected = true;
            sel.appendChild(opt);
        });
    } catch (e) { /* ignore */ }
}

// ç›´è¿‘ã‚¨ãƒ©ãƒ¼ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
async function loadRecentErrors() {
    const panel = document.getElementById('recent-errors-panel');
    const body  = document.getElementById('recent-errors-body');
    try {
        const resp = await fetch(
            `${window.location.origin}/api/logs/recent-errors`,
            { headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` } }
        );
        if (!resp.ok) return;
        const data = await resp.json();
        const errors = data.errors || [];
        if (errors.length === 0) return;
        panel.style.display = 'block';
        body.innerHTML = errors.map(line => `<div class="err-line">${escapeHtml(line)}</div>`).join('');
    } catch (e) { /* ignore */ }
}

// Enterã‚­ãƒ¼ã§æ¤œç´¢
document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && document.activeElement && document.activeElement.id === 'search-input') {
        searchLogs();
    }
});

// ===== åˆæœŸåŒ– =====
document.addEventListener('DOMContentLoaded', () => {
    if (typeof restoreAccordionState === 'function') {
        restoreAccordionState();
    }
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
    if (typeof api !== 'undefined') {
        api.request('GET', '/api/auth/me').then(data => {
            const u = data.user || data;
            const nameEl  = document.getElementById('user-menu-username');
            const roleEl  = document.getElementById('user-menu-role');
            const emailEl = document.getElementById('user-menu-email');
            if (nameEl)  nameEl.textContent  = u.username || '-';
            if (roleEl)  roleEl.textContent  = u.role     || '-';
            if (emailEl) emailEl.textContent = u.email    || '-';
        }).catch(() => {});
    }
    // Step 25: ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨ç›´è¿‘ã‚¨ãƒ©ãƒ¼ã‚’éåŒæœŸã§å–å¾—
    loadLogFiles();
    loadRecentErrors();
});
</script>
</body>
</html>
