<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Configuration - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .config-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .dark-mode .config-card {
            background: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }
        .dark-mode body, .dark-mode .main-content {
            background: #0f172a;
            color: #e2e8f0;
        }
        .dark-mode .config-row {
            border-bottom-color: #334155;
        }
        .dark-mode .config-label {
            color: #94a3b8;
        }
        .config-card-title {
            font-size: 15px;
            font-weight: bold;
            color: #111827;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dark-mode .config-card-title { color: #f1f5f9; }
        .config-row {
            display: flex;
            justify-content: space-between;
            padding: 7px 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        .config-row:last-child { border-bottom: none; }
        .config-label { color: #6b7280; min-width: 160px; }
        .config-value { font-weight: 500; text-align: right; word-break: break-all; }
        .module-table { font-size: 13px; }
        .loading-placeholder { color: #9ca3af; font-size: 13px; }
        #theme-toggle-btn {
            position: fixed;
            top: 16px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2>âš™ï¸ System Configuration</h2>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshAll()" id="refresh-btn">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-sm btn-outline-secondary" id="theme-toggle-btn" onclick="toggleTheme()">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
            </div>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <div class="row g-3">
                <!-- ãƒ›ã‚¹ãƒˆå -->
                <div class="col-md-6">
                    <div class="config-card">
                        <div class="config-card-title">ğŸ–¥ï¸ ãƒ›ã‚¹ãƒˆå</div>
                        <div id="hostname-content"><div class="loading-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div></div>
                    </div>
                </div>

                <!-- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ -->
                <div class="col-md-6">
                    <div class="config-card">
                        <div class="config-card-title">ğŸ• ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³</div>
                        <div id="timezone-content"><div class="loading-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div></div>
                    </div>
                </div>

                <!-- ãƒ­ã‚±ãƒ¼ãƒ« -->
                <div class="col-md-6">
                    <div class="config-card">
                        <div class="config-card-title">ğŸŒ ãƒ­ã‚±ãƒ¼ãƒ«</div>
                        <div id="locale-content"><div class="loading-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div></div>
                    </div>
                </div>

                <!-- ã‚«ãƒ¼ãƒãƒ« -->
                <div class="col-md-6">
                    <div class="config-card">
                        <div class="config-card-title">ğŸ§ ã‚«ãƒ¼ãƒãƒ«</div>
                        <div id="kernel-content"><div class="loading-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div></div>
                    </div>
                </div>

                <!-- ç¨¼åƒæ™‚é–“ -->
                <div class="col-md-6">
                    <div class="config-card">
                        <div class="config-card-title">â±ï¸ ç¨¼åƒæ™‚é–“</div>
                        <div id="uptime-content"><div class="loading-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div></div>
                    </div>
                </div>

                <!-- ã‚«ãƒ¼ãƒãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
                <div class="col-12">
                    <div class="config-card">
                        <div class="config-card-title">ğŸ“¦ ã‚«ãƒ¼ãƒãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (lsmod)</div>
                        <div id="modules-content"><div class="loading-placeholder">èª­ã¿è¾¼ã¿ä¸­...</div></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>
function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function row(label, value) {
    return `<div class="config-row"><span class="config-label">${escapeHtml(label)}</span><span class="config-value">${value !== undefined && value !== null ? escapeHtml(String(value)) : 'â€”'}</span></div>`;
}

async function loadHostname() {
    const el = document.getElementById('hostname-content');
    try {
        const d = await api.get('/api/sysconfig/hostname');
        el.innerHTML = row('ãƒ›ã‚¹ãƒˆå', d.hostname) + row('FQDN', d.fqdn) + row('çŸ­ç¸®å', d.short);
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning py-2 mb-0">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadTimezone() {
    const el = document.getElementById('timezone-content');
    try {
        const d = await api.get('/api/sysconfig/timezone');
        el.innerHTML = row('ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³', d.timezone) + row('/etc/timezone', d.timezone_file) + row('NTP æœ‰åŠ¹', d.ntp_enabled) + row('ãƒ­ãƒ¼ã‚«ãƒ« RTC', d.local_rtc);
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning py-2 mb-0">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadLocale() {
    const el = document.getElementById('locale-content');
    try {
        const d = await api.get('/api/sysconfig/locale');
        el.innerHTML = row('LANG', d.lang) + row('LC_CTYPE', d.lc_ctype) + row('LC_MESSAGES', d.lc_messages) + row('æ–‡å­—ã‚³ãƒ¼ãƒ‰', d.charmap);
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning py-2 mb-0">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadKernel() {
    const el = document.getElementById('kernel-content');
    try {
        const d = await api.get('/api/sysconfig/kernel');
        el.innerHTML = row('ã‚«ãƒ¼ãƒãƒ«å', d.kernel_name) + row('ãƒªãƒªãƒ¼ã‚¹', d.kernel_release) + row('ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£', d.machine) + row('uname -a', d.uname);
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning py-2 mb-0">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadUptime() {
    const el = document.getElementById('uptime-content');
    try {
        const d = await api.get('/api/sysconfig/uptime');
        const secNum = parseFloat(d.uptime_seconds);
        let uptimeHuman = d.uptime_seconds;
        if (!isNaN(secNum)) {
            const days = Math.floor(secNum / 86400);
            const hrs = Math.floor((secNum % 86400) / 3600);
            const mins = Math.floor((secNum % 3600) / 60);
            uptimeHuman = `${days}æ—¥ ${hrs}æ™‚é–“ ${mins}åˆ†`;
        }
        el.innerHTML = row('ç¨¼åƒæ™‚é–“', uptimeHuman) + row('Load 1åˆ†', d.load_1min) + row('Load 5åˆ†', d.load_5min) + row('Load 15åˆ†', d.load_15min);
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning py-2 mb-0">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadModules() {
    const el = document.getElementById('modules-content');
    try {
        const d = await api.get('/api/sysconfig/modules');
        const mods = d.modules || [];
        if (mods.length === 0) {
            el.innerHTML = '<div class="text-muted">ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
            return;
        }
        const rows = mods.map(m =>
            `<tr><td>${escapeHtml(m.name)}</td><td>${escapeHtml(m.size)}</td><td>${escapeHtml(m.used)}</td></tr>`
        ).join('');
        el.innerHTML = `<div class="table-responsive"><table class="table table-sm module-table mb-0">
            <thead><tr><th>ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å</th><th>ã‚µã‚¤ã‚º</th><th>ä½¿ç”¨æ•°</th></tr></thead>
            <tbody>${rows}</tbody>
        </table></div>`;
    } catch (e) {
        el.innerHTML = `<div class="alert alert-warning py-2 mb-0">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

function refreshAll() {
    loadHostname(); loadTimezone(); loadLocale(); loadKernel(); loadUptime(); loadModules();
}

function toggleTheme() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    document.getElementById('theme-toggle-btn').textContent = isDark ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆ' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯';
}

function applyTheme() {
    const theme = localStorage.getItem('theme');
    if (theme === 'dark') {
        document.body.classList.add('dark-mode');
        document.getElementById('theme-toggle-btn').textContent = 'â˜€ï¸ ãƒ©ã‚¤ãƒˆ';
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    if (!token) { window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html'; return; }
    api.setToken(token);
    if (typeof initSidebar === 'function') initSidebar('sysconfig');
    applyTheme();
    refreshAll();
});
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
