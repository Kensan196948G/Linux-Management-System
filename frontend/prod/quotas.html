<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ã‚£ã‚¹ã‚¯ã‚¯ã‚©ãƒ¼ã‚¿ - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab-nav {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }
        .tab-btn {
            padding: 8px 18px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            border-radius: 4px 4px 0 0;
            transition: color 0.15s, border-color 0.15s, background 0.15s;
        }
        .tab-btn:hover { background: #f3f4f6; color: #111827; }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            font-weight: 600;
            background: #eff6ff;
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .quota-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
        }
        .quota-card h5 {
            font-size: 15px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 14px;
        }
        .fs-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .fs-item code {
            font-size: 12px;
            color: #1d4ed8;
            background: #dbeafe;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .pill {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        .pill-enabled { background: #d1fae5; color: #065f46; }
        .pill-disabled { background: #fee2e2; color: #991b1b; }

        .users-table-wrap { overflow-x: auto; }

        .quota-form-card {
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            max-width: 640px;
        }
        .quota-form-card h5 {
            font-size: 15px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 20px;
        }
        .section-note {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
    </style>
</head>
<body>
<div class="app-layout">
    <aside class="sidebar" id="sidebar-container"></aside>

    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯ã‚¯ã‚©ãƒ¼ã‚¿</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshCurrentTab()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <div id="alert-area"></div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="status" onclick="switchTab('status')">ğŸ“Š ã‚¯ã‚©ãƒ¼ã‚¿çŠ¶æ…‹</button>
                <button class="tab-btn" data-tab="users" onclick="switchTab('users')">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿</button>
                <button class="tab-btn" data-tab="quota-alerts" onclick="switchTab('quota-alerts')">âš ï¸ ã‚¢ãƒ©ãƒ¼ãƒˆ</button>
                <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">âš™ï¸ ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š</button>
            </div>

            <!-- ã‚¿ãƒ–1: ã‚¯ã‚©ãƒ¼ã‚¿çŠ¶æ…‹ -->
            <div class="tab-panel active" id="tab-status">
                <div id="status-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="status-content" style="display:none"></div>
            </div>

            <!-- ã‚¿ãƒ–2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿ -->
            <div class="tab-panel" id="tab-users">
                <div id="users-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="users-content" style="display:none">
                    <div class="quota-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¯ã‚©ãƒ¼ã‚¿ä½¿ç”¨é‡</h5>
                            <a href="#" class="btn btn-sm btn-outline-success" onclick="downloadCSV(event)">â¬‡ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>
                        </div>
                        <div class="users-table-wrap">
                            <table class="table table-sm table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th>
                                        <th>FS</th>
                                        <th>ä½¿ç”¨é‡</th>
                                        <th>ã‚½ãƒ•ãƒˆåˆ¶é™</th>
                                        <th>ãƒãƒ¼ãƒ‰åˆ¶é™</th>
                                        <th>ä½¿ç”¨ç‡</th>
                                        <th>çŒ¶äºˆæœŸé–“</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–: ã‚¢ãƒ©ãƒ¼ãƒˆ -->
            <div class="tab-panel" id="tab-quota-alerts">
                <div class="quota-card">
                    <h5>âš ï¸ ã‚¯ã‚©ãƒ¼ã‚¿ã‚¢ãƒ©ãƒ¼ãƒˆ</h5>
                    <p class="text-muted small">ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒé–¾å€¤ã‚’è¶…ãˆãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <label for="alertThresholdProd" class="form-label mb-0 fw-semibold">è­¦å‘Šé–¾å€¤:</label>
                        <input type="range" id="alertThresholdProd" class="form-range" min="1" max="100" value="80" style="width:200px" oninput="document.getElementById('thresholdValueProd').textContent=this.value+'%'">
                        <span id="thresholdValueProd" class="badge bg-warning text-dark fs-6">80%</span>
                        <button class="btn btn-sm btn-warning" onclick="loadQuotaAlerts()">ãƒã‚§ãƒƒã‚¯</button>
                    </div>
                    <div id="alerts-result-prod">
                        <p class="text-muted">ã€Œãƒã‚§ãƒƒã‚¯ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- ã‚¿ãƒ–3: ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š -->
            <div class="tab-panel" id="tab-settings">
                <div class="quota-form-card">
                    <h5>âš™ï¸ ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š</h5>
                    <div class="alert alert-info mb-4" style="font-size:13px">
                        â„¹ï¸ ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®šã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚æ‰¿èªãƒ•ãƒ­ãƒ¼ãŒæœ‰åŠ¹ãªå ´åˆã€ç®¡ç†è€…ã®æ‰¿èªå¾Œã«åæ˜ ã•ã‚Œã¾ã™ã€‚
                    </div>
                    <form id="quota-form">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">ç¨®åˆ¥</label>
                            <select class="form-select" id="quota-type">
                                <option value="user">ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                                <option value="group">ã‚°ãƒ«ãƒ¼ãƒ—</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">åå‰</label>
                            <input class="form-control" id="quota-name" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ã‚°ãƒ«ãƒ¼ãƒ—å">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ </label>
                            <input class="form-control" id="quota-fs" value="/" placeholder="/home ãªã©">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">ã‚½ãƒ•ãƒˆåˆ¶é™ (KB)</label>
                                <input class="form-control" id="quota-soft" type="number" min="0" placeholder="ä¾‹: 1048576 (1GB)">
                                <div class="section-note">è¶…éã—ã¦ã‚‚çŒ¶äºˆæœŸé–“å†…ã¯æ›¸ãè¾¼ã¿å¯èƒ½</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">ãƒãƒ¼ãƒ‰åˆ¶é™ (KB)</label>
                                <input class="form-control" id="quota-hard" type="number" min="0" placeholder="ä¾‹: 2097152 (2GB)">
                                <div class="section-note">çµ¶å¯¾ä¸Šé™ã€‚ã“ã‚Œä»¥ä¸Šã¯æ›¸ãè¾¼ã¿ä¸å¯</div>
                            </div>
                        </div>
                        <div id="form-alert-area"></div>
                        <button type="submit" class="btn btn-primary">ğŸ’¾ ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š</button>
                    </form>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('quotas')):renderSidebar('quotas');</script>
<script>
// ===================================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ===================================================================

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function formatKB(kb) {
    if (!kb) return '0 KB';
    if (kb >= 1024 * 1024) return (kb / 1024 / 1024).toFixed(1) + ' GB';
    if (kb >= 1024) return (kb / 1024).toFixed(1) + ' MB';
    return kb + ' KB';
}

function usageBar(used, soft, hard) {
    const limit = hard || soft || 0;
    if (!limit) return '<span class="text-muted">ç„¡åˆ¶é™</span>';
    const pct = Math.min(100, Math.round(used / limit * 100));
    const color = pct >= 90 ? 'danger' : pct >= 75 ? 'warning' : 'success';
    return `<div class="progress" style="height:18px;min-width:120px">
        <div class="progress-bar bg-${color}" style="width:${pct}%">${pct}%</div>
    </div>`;
}

function showAlert(message, type, areaId) {
    const area = document.getElementById(areaId || 'alert-area');
    if (!area) return;
    area.innerHTML = `<div class="alert alert-${escapeHtml(type)} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    setTimeout(() => { area.innerHTML = ''; }, 6000);
}

// ===================================================================
// ã‚¿ãƒ–ç®¡ç†
// ===================================================================

let currentTab = 'status';
const tabLoaded = { status: false, users: false, settings: true };

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));

    const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    const panel = document.getElementById(`tab-${tabName}`);
    if (btn) btn.classList.add('active');
    if (panel) panel.classList.add('active');

    currentTab = tabName;

    if (!tabLoaded[tabName]) {
        if (tabName === 'status') loadStatus();
        if (tabName === 'users') loadUsers();
    }
}

function refreshCurrentTab() {
    tabLoaded[currentTab] = false;
    if (currentTab === 'status') {
        document.getElementById('status-content').style.display = 'none';
        document.getElementById('status-loading').style.display = '';
        loadStatus();
    } else if (currentTab === 'users') {
        document.getElementById('users-content').style.display = 'none';
        document.getElementById('users-loading').style.display = '';
        loadUsers();
    }
}

// ===================================================================
// ã‚¿ãƒ–1: ã‚¯ã‚©ãƒ¼ã‚¿çŠ¶æ…‹
// ===================================================================

async function loadStatus() {
    const loading = document.getElementById('status-loading');
    const content = document.getElementById('status-content');
    loading.style.display = '';
    content.style.display = 'none';

    try {
        const resp = await api.getQuotasStatus();
        const data = resp.data || resp;
        const quotaEnabled = data.quota_enabled;
        const filesystems = data.filesystems || [];

        let html = '';

        // quota_enabled ãŒ false ã®å ´åˆã®è­¦å‘ŠãƒãƒŠãƒ¼
        if (!quotaEnabled) {
            html += `<div class="alert alert-warning">âš ï¸ ã‚¯ã‚©ãƒ¼ã‚¿æ©Ÿèƒ½ãŒç„¡åŠ¹ã§ã™ã€‚edquota ã¾ãŸã¯ setquota ã‚³ãƒãƒ³ãƒ‰ã§æœ‰åŠ¹åŒ–ãŒå¿…è¦ã§ã™ã€‚</div>`;
        } else {
            html += `<div class="alert alert-success">âœ… ã‚¯ã‚©ãƒ¼ã‚¿æ©Ÿèƒ½ãŒæœ‰åŠ¹ã§ã™ã€‚</div>`;
        }

        // å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰
        html += `<div class="quota-card">
            <h5>ğŸ“Š ã‚¯ã‚©ãƒ¼ã‚¿å…¨ä½“çŠ¶æ…‹</h5>
            <div class="d-flex align-items-center gap-3 mb-3">
                <div>
                    <span class="fw-semibold">ã‚¯ã‚©ãƒ¼ã‚¿æ©Ÿèƒ½:</span>
                    <span class="pill ${quotaEnabled ? 'pill-enabled' : 'pill-disabled'} ms-2">
                        ${quotaEnabled ? 'âœ… æœ‰åŠ¹' : 'âŒ ç„¡åŠ¹'}
                    </span>
                </div>
                <div class="text-muted" style="font-size:13px">
                    ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æ•°: <strong>${filesystems.length}</strong>
                </div>
            </div>`;

        if (filesystems.length > 0) {
            html += `<h5 style="font-size:14px;color:#6b7280;margin-bottom:10px">ğŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§</h5>`;
            filesystems.forEach(fs => {
                const fsPath = escapeHtml(fs.path || fs.filesystem || fs.device || String(fs));
                const fsType = escapeHtml(fs.type || '');
                const fsQuota = fs.quota_enabled !== undefined
                    ? `<span class="pill ${fs.quota_enabled ? 'pill-enabled' : 'pill-disabled'}">${fs.quota_enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</span>`
                    : '';
                const fsSize = fs.size ? `<span class="text-muted" style="margin-left:auto;font-size:12px">å®¹é‡: ${escapeHtml(String(fs.size))}</span>` : '';
                html += `<div class="fs-item">
                    ğŸ“‚ <code>${fsPath}</code>
                    ${fsType ? `<span class="text-muted">(${fsType})</span>` : ''}
                    ${fsQuota}
                    ${fsSize}
                </div>`;
            });
        } else {
            html += `<p class="text-muted" style="font-size:13px">ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
        }

        html += `</div>`;

        content.innerHTML = html;
        loading.style.display = 'none';
        content.style.display = '';
        tabLoaded['status'] = true;
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">
            ã‚¯ã‚©ãƒ¼ã‚¿çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(e.message)}
        </div>`;
    }
}

// ===================================================================
// ã‚¿ãƒ–2: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿
// ===================================================================

async function loadUsers() {
    const loading = document.getElementById('users-loading');
    const content = document.getElementById('users-content');
    loading.style.display = '';
    content.style.display = 'none';

    try {
        const resp = await api.getQuotaUsers();
        const data = resp.data || resp;
        const users = data.users || [];

        const tbody = document.getElementById('users-tbody');

        if (users.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®šã®ã‚ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>`;
        } else {
            tbody.innerHTML = users.map(u => {
                const used = u.used_kb || 0;
                const soft = u.soft_kb || 0;
                const hard = u.hard_kb || 0;
                const grace = u.grace || '-';

                return `<tr>
                    <td><strong>${escapeHtml(u.username || '-')}</strong></td>
                    <td><code>${escapeHtml(u.filesystem || '-')}</code></td>
                    <td>${escapeHtml(formatKB(used))}</td>
                    <td>${soft ? escapeHtml(formatKB(soft)) : '<span class="text-muted">-</span>'}</td>
                    <td>${hard ? escapeHtml(formatKB(hard)) : '<span class="text-muted">-</span>'}</td>
                    <td>${usageBar(used, soft, hard)}</td>
                    <td>${escapeHtml(String(grace))}</td>
                </tr>`;
            }).join('');
        }

        loading.style.display = 'none';
        content.style.display = '';
        tabLoaded['users'] = true;
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">
            ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚©ãƒ¼ã‚¿æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${escapeHtml(e.message)}
        </div>`;
    }
}

// ===================================================================
// åˆæœŸåŒ–
// ===================================================================

document.addEventListener('DOMContentLoaded', () => {
    // èªè¨¼ãƒã‚§ãƒƒã‚¯
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html';
        return;
    }
    api.setToken(token);

    // åˆæœŸã‚¿ãƒ–èª­ã¿è¾¼ã¿
    loadStatus();

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('quota-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('quota-name').value.trim();
        const filesystem = document.getElementById('quota-fs').value.trim();

        if (!name) {
            showAlert('âŒ åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger', 'form-alert-area');
            return;
        }
        if (!filesystem) {
            showAlert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'danger', 'form-alert-area');
            return;
        }

        const payload = {
            type: document.getElementById('quota-type').value,
            name: name,
            filesystem: filesystem,
            soft_kb: parseInt(document.getElementById('quota-soft').value) || 0,
            hard_kb: parseInt(document.getElementById('quota-hard').value) || 0,
            isoft: 0,
            ihard: 0
        };

        const submitBtn = document.querySelector('#quota-form button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'é€ä¿¡ä¸­...';

        try {
            const result = await api.post('/api/quotas/set', payload);
            showAlert(`âœ… ${escapeHtml(result.message || 'ã‚¯ã‚©ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¾ã—ãŸ')}`, 'success', 'form-alert-area');
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ãƒ–ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ¬¡å›åˆ‡ã‚Šæ›¿ãˆæ™‚ã«å†å–å¾—ï¼‰
            tabLoaded['users'] = false;
        } catch (err) {
            showAlert(`âŒ ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.message)}`, 'danger', 'form-alert-area');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ğŸ’¾ ã‚¯ã‚©ãƒ¼ã‚¿è¨­å®š';
        }
    });
});
</script>
<script>
// CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¨ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½
async function downloadCSV(e) {
    e.preventDefault();
    try {
        const resp = await fetch('/api/quotas/export/csv', {
            headers: api.token ? { 'Authorization': `Bearer ${api.token}` } : {}
        });
        if (!resp.ok) { showAlert('âŒ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼', 'danger'); return; }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'quota_report.csv'; a.click();
        URL.revokeObjectURL(url);
    } catch (err) {
        showAlert(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.message)}`, 'danger');
    }
}

async function loadQuotaAlerts() {
    const threshold = document.getElementById('alertThresholdProd')?.value || 80;
    const container = document.getElementById('alerts-result-prod');
    try {
        const resp = await fetch(`/api/quotas/alerts?threshold=${threshold}`, {
            headers: api.token ? { 'Authorization': `Bearer ${api.token}` } : {}
        });
        const data = await resp.json();
        if (!resp.ok) { container.innerHTML = `<div class="alert alert-danger">${escapeHtml(data.detail || 'ã‚¨ãƒ©ãƒ¼')}</div>`; return; }
        const alerts = data.alerts || [];
        if (alerts.length === 0) {
            container.innerHTML = `<div class="alert alert-success">âœ… ä½¿ç”¨ç‡ ${threshold}% è¶…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</div>`;
            return;
        }
        let rows = alerts.map(a => `<tr>
            <td>${escapeHtml(a.username)}</td>
            <td>${escapeHtml(a.filesystem || '-')}</td>
            <td>${a.used_kb} KB</td>
            <td>${a.limit_kb} KB</td>
            <td><span class="badge ${a.usage_percent >= 90 ? 'bg-danger' : 'bg-warning text-dark'}">${a.usage_percent}%</span></td>
        </tr>`).join('');
        container.innerHTML = `
            <div class="alert alert-warning">âš ï¸ ${alerts.length} ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½¿ç”¨ç‡ ${threshold}% ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚</div>
            <table class="table table-sm table-hover">
                <thead class="table-dark"><tr><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>FS</th><th>ä½¿ç”¨é‡</th><th>ãƒªãƒŸãƒƒãƒˆ</th><th>ä½¿ç”¨ç‡</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
    } catch (err) {
        container.innerHTML = `<div class="alert alert-danger">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${escapeHtml(err.message)}</div>`;
    }
}
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
