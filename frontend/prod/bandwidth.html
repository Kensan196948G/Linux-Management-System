<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∏ØÂüüÂπÖ„É¢„Éã„Çø„Éº - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link { cursor: pointer; color: #374151; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #2563eb; }
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            margin-bottom: 12px;
        }
        .metric-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .metric-value { font-size: 22px; font-weight: bold; color: #111827; }
        .table-compact td, .table-compact th { padding: 6px 10px; font-size: 13px; }

        /* „É©„Ç§„Éñ„Ç´„Éº„Éâ */
        .live-cards {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        .live-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .live-card.rx { border-top: 4px solid #10b981; }
        .live-card.tx { border-top: 4px solid #3b82f6; }
        .live-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .live-value {
            font-size: 36px;
            font-weight: bold;
            color: #111827;
            line-height: 1.1;
        }
        .live-unit {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }
        .live-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #d1d5db;
            margin-right: 6px;
            vertical-align: middle;
            transition: background 0.3s;
        }
        .live-status.active { background: #10b981; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%,100% { opacity: 1; }
            50%      { opacity: 0.4; }
        }
        .live-ts { font-size: 11px; color: #9ca3af; margin-top: 8px; }

        /* „Éà„ÉÉ„Éó„É©„É≥„Ç≠„É≥„Ç∞ */
        .rank-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .rank-1 { background: #f59e0b; }
        .rank-2 { background: #9ca3af; }
        .rank-3 { background: #b45309; }
        .rank-other { background: #d1d5db; color: #374151; }

        .iface-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .iface-selector label { font-weight: 600; color: #374151; margin: 0; white-space: nowrap; }
        .iface-selector select { min-width: 200px; }

        .source-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .source-vnstat  { background: #d1fae5; color: #065f46; }
        .source-fallback { background: #fef3c7; color: #92400e; }

        .summary-cards {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .summary-card {
            flex: 1;
            min-width: 180px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 16px 20px;
        }
        .summary-card.rx-card { border-left: 4px solid #10b981; }
        .summary-card.tx-card { border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
    <aside class="sidebar" id="sidebar-container"></aside>

    <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">üì° Â∏ØÂüüÂπÖ„É¢„Éã„Çø„Éº</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshCurrentTab()" id="refresh-btn">
                üîÑ Êõ¥Êñ∞
            </button>
        </div>

        <div class="main-body">
            <!-- „Ç¢„É©„Éº„Éà„Ç®„É™„Ç¢ -->
            <div id="alert-area"></div>

            <!-- „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„ÇπÈÅ∏Êäû -->
            <div class="iface-selector">
                <label for="iface-select">üîå „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ:</label>
                <select class="form-select form-select-sm" id="iface-select" onchange="onIfaceChange()">
                    <option value="">„Åô„Åπ„Å¶ / „Éá„Éï„Ç©„É´„Éà</option>
                </select>
                <span id="iface-loading" class="text-muted" style="font-size:13px; display:none">Ë™≠„ÅøËæº„Åø‰∏≠...</span>
            </div>

            <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
            <ul class="nav nav-tabs mb-3" id="bandwidth-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('summary')" id="tab-summary">
                        üìä „Çµ„Éû„É™„Éº
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('live')" id="tab-live">
                        <span class="live-status" id="live-indicator"></span>„É©„Ç§„Éñ
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('daily')" id="tab-daily">
                        üìÖ Êó•Ê¨°
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('top')" id="tab-top">
                        üèÜ „Éà„ÉÉ„Éó
                    </a>
                </li>
            </ul>

            <!-- „Çµ„Éû„É™„Éº„Çø„Éñ -->
            <div id="pane-summary">
                <div id="summary-loading" class="text-center py-4 text-muted">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                <div id="summary-content" style="display:none">
                    <div class="summary-cards">
                        <div class="summary-card rx-card">
                            <div class="metric-label">‚Üì ÂêàË®àÂèó‰ø°</div>
                            <div class="metric-value" id="summary-rx">-</div>
                        </div>
                        <div class="summary-card tx-card">
                            <div class="metric-label">‚Üë ÂêàË®àÈÄÅ‰ø°</div>
                            <div class="metric-value" id="summary-tx">-</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span style="font-size:13px;color:#6b7280">„Éá„Éº„Çø„ÇΩ„Éº„Çπ:</span>
                        <span id="summary-source" class="source-badge">-</span>
                    </div>
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>È†ÖÁõÆ</th>
                                <th>Âèó‰ø°</th>
                                <th>ÈÄÅ‰ø°</th>
                            </tr>
                        </thead>
                        <tbody id="summary-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- „É©„Ç§„Éñ„Çø„Éñ -->
            <div id="pane-live" style="display:none">
                <div id="live-loading" class="text-center py-4 text-muted">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                <div id="live-content" style="display:none">
                    <div class="live-cards">
                        <div class="live-card rx">
                            <div class="live-label">‚Üì Âèó‰ø°</div>
                            <div class="live-value" id="live-rx">-</div>
                            <div class="live-unit">kbps</div>
                        </div>
                        <div class="live-card tx">
                            <div class="live-label">‚Üë ÈÄÅ‰ø°</div>
                            <div class="live-value" id="live-tx">-</div>
                            <div class="live-unit">kbps</div>
                        </div>
                    </div>
                    <div class="live-ts" id="live-ts">ÊúÄÁµÇÊõ¥Êñ∞: -</div>
                    <div class="mt-3 p-3" style="background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb;">
                        <div class="row">
                            <div class="col-6 col-md-3 mb-2">
                                <div class="metric-label">Âèó‰ø° (bps)</div>
                                <div style="font-size:14px;font-weight:600;color:#111827" id="live-rx-bps">-</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="metric-label">ÈÄÅ‰ø° (bps)</div>
                                <div style="font-size:14px;font-weight:600;color:#111827" id="live-tx-bps">-</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="metric-label">„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ</div>
                                <div style="font-size:14px;font-weight:600;color:#111827" id="live-iface-name">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Êó•Ê¨°„Çø„Éñ -->
            <div id="pane-daily" style="display:none">
                <div id="daily-loading" class="text-center py-4 text-muted">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                <div id="daily-content" style="display:none">
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>Êó•‰ªò</th>
                                <th>‚Üì Âèó‰ø°</th>
                                <th>‚Üë ÈÄÅ‰ø°</th>
                                <th>ÂêàË®à</th>
                            </tr>
                        </thead>
                        <tbody id="daily-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- „Éà„ÉÉ„Éó„Çø„Éñ -->
            <div id="pane-top" style="display:none">
                <div id="top-loading" class="text-center py-4 text-muted">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                <div id="top-content" style="display:none">
                    <p class="text-muted" style="font-size:13px">
                        ‚Äª „Éà„ÉÉ„ÉóË°®Á§∫„ÅØ„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„ÇπÈÅ∏Êäû„Å´Èñ¢„Çè„Çâ„ÅöÂÖ®„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÇíË°®Á§∫„Åó„Åæ„Åô
                    </p>
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>È†Ü‰Ωç</th>
                                <th>„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ</th>
                                <th>‚Üì Âèó‰ø°</th>
                                <th>‚Üë ÈÄÅ‰ø°</th>
                                <th>ÂêàË®à</th>
                            </tr>
                        </thead>
                        <tbody id="top-tbody"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('bandwidth')):renderSidebar('bandwidth');</script>
<script>
// ===================================================================
// Áä∂ÊÖãÁÆ°ÁêÜ
// ===================================================================
let currentTab = 'summary';
let selectedIface = '';
let liveTimer = null;

// ===================================================================
// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
// ===================================================================

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) { bytes /= 1024; i++; }
    return `${bytes.toFixed(1)} ${units[i]}`;
}

function showAlert(msg, type = 'danger') {
    document.getElementById('alert-area').innerHTML =
        `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${escapeHtml(msg)}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
}

function formatTimestamp(ts) {
    if (!ts) return '-';
    try {
        return new Date(ts).toLocaleTimeString('ja-JP');
    } catch (e) {
        return escapeHtml(String(ts));
    }
}

// ===================================================================
// „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„ÇπÈÅ∏Êäû
// ===================================================================

async function loadInterfaces() {
    const loadingSpan = document.getElementById('iface-loading');
    loadingSpan.style.display = '';
    try {
        const data = await api.getBandwidthInterfaces();
        const ifaces = data.interfaces || [];
        const sel = document.getElementById('iface-select');
        ifaces.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
        });
    } catch (e) {
        console.warn('„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ‰∏ÄË¶ßÂèñÂæóÂ§±Êïó:', e.message);
    } finally {
        loadingSpan.style.display = 'none';
    }
}

function onIfaceChange() {
    selectedIface = document.getElementById('iface-select').value;
    stopLive();
    refreshCurrentTab();
}

// ===================================================================
// „Çø„ÉñÁÆ°ÁêÜ
// ===================================================================

function showTab(tab) {
    const tabs = ['summary', 'live', 'daily', 'top'];
    tabs.forEach(t => {
        document.getElementById(`pane-${t}`).style.display = t === tab ? '' : 'none';
        document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    });

    // „É©„Ç§„Éñ„Çø„Éñ„ÇíÈõ¢„Çå„Åü„Çâ„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢
    if (currentTab === 'live' && tab !== 'live') {
        stopLive();
    }

    currentTab = tab;

    if (tab === 'summary') loadSummary();
    else if (tab === 'live') startLive();
    else if (tab === 'daily') loadDaily();
    else if (tab === 'top') loadTop();
}

function refreshCurrentTab() {
    showTab(currentTab);
}

// ===================================================================
// „É©„Ç§„ÉñÊõ¥Êñ∞
// ===================================================================

function startLive() {
    const loading = document.getElementById('live-loading');
    const content = document.getElementById('live-content');
    loading.style.display = '';
    content.style.display = 'none';

    // ÂàùÂõûÂç≥ÊôÇÂèñÂæó
    fetchLive().then(() => {
        loading.style.display = 'none';
        content.style.display = '';
    }).catch(e => {
        loading.innerHTML = `<div class="alert alert-warning">ÂèñÂæóÂ§±Êïó: ${escapeHtml(e.message)}</div>`;
    });

    // „Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºÊúâÂäπÂåñ
    document.getElementById('live-indicator').classList.add('active');

    // 2Áßí„Åä„Åç„Å´Êõ¥Êñ∞
    liveTimer = setInterval(() => {
        fetchLive().catch(e => console.warn('„É©„Ç§„ÉñÊõ¥Êñ∞Â§±Êïó:', e.message));
    }, 2000);
}

function stopLive() {
    if (liveTimer) {
        clearInterval(liveTimer);
        liveTimer = null;
    }
    document.getElementById('live-indicator').classList.remove('active');
}

async function fetchLive() {
    const data = await api.getBandwidthLive(selectedIface);
    const rxKbps = data.rx_kbps != null ? Number(data.rx_kbps).toFixed(1) : '-';
    const txKbps = data.tx_kbps != null ? Number(data.tx_kbps).toFixed(1) : '-';
    const rxBps  = data.rx_bps  != null ? Number(data.rx_bps).toLocaleString() : '-';
    const txBps  = data.tx_bps  != null ? Number(data.tx_bps).toLocaleString() : '-';

    document.getElementById('live-rx').textContent = rxKbps;
    document.getElementById('live-tx').textContent = txKbps;
    document.getElementById('live-rx-bps').textContent = rxBps !== '-' ? rxBps + ' bps' : '-';
    document.getElementById('live-tx-bps').textContent = txBps !== '-' ? txBps + ' bps' : '-';
    document.getElementById('live-iface-name').textContent = escapeHtml(data.interface || selectedIface || 'all');
    document.getElementById('live-ts').textContent = 'ÊúÄÁµÇÊõ¥Êñ∞: ' + formatTimestamp(data.timestamp);
}

// ===================================================================
// „Çµ„Éû„É™„Éº„Çø„Éñ
// ===================================================================

async function loadSummary() {
    const loading = document.getElementById('summary-loading');
    const content = document.getElementById('summary-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getBandwidthSummary();

        // ÂêàË®à„Ç´„Éº„Éâ
        document.getElementById('summary-rx').textContent = formatBytes(data.rx_bytes);
        document.getElementById('summary-tx').textContent = formatBytes(data.tx_bytes);

        // „ÇΩ„Éº„Çπ„Éê„ÉÉ„Ç∏
        const srcEl = document.getElementById('summary-source');
        const src = data.source || 'unknown';
        srcEl.textContent = escapeHtml(src);
        srcEl.className = 'source-badge ' + (src === 'vnstat' ? 'source-vnstat' : 'source-fallback');

        // „Éá„Éº„Çø„ÉÜ„Éº„Éñ„É´
        const rows = data.data || [];
        const tbody = document.getElementById('summary-tbody');
        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">„Éá„Éº„Çø„Å™„Åó</td></tr>';
        } else {
            tbody.innerHTML = rows.map((row, i) => {
                const rx = row.rx != null ? formatBytes(row.rx) : '-';
                const tx = row.tx != null ? formatBytes(row.tx) : '-';
                const total = (row.rx != null && row.tx != null)
                    ? formatBytes(row.rx + row.tx) : '-';
                const label = escapeHtml(
                    row.date || row.hour || row.month || row.year || row.label || String(i + 1)
                );
                return `<tr>
                    <td>${i + 1}</td>
                    <td>${label}</td>
                    <td><span style="color:#065f46">&#x2193; ${rx}</span></td>
                    <td><span style="color:#1e40af">&#x2191; ${tx}</span></td>
                </tr>`;
            }).join('');
        }

        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">ÂèñÂæóÂ§±Êïó: ${escapeHtml(e.message)}</div>`;
    }
}

// ===================================================================
// Êó•Ê¨°„Çø„Éñ
// ===================================================================

async function loadDaily() {
    const loading = document.getElementById('daily-loading');
    const content = document.getElementById('daily-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getBandwidthDaily(selectedIface);
        const rows = data.data || [];
        const tbody = document.getElementById('daily-tbody');
        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">„Éá„Éº„Çø„Å™„Åó</td></tr>';
        } else {
            tbody.innerHTML = rows.map(row => {
                const date  = escapeHtml(row.date || '-');
                const rx    = row.rx != null ? formatBytes(row.rx) : '-';
                const tx    = row.tx != null ? formatBytes(row.tx) : '-';
                const total = (row.rx != null && row.tx != null)
                    ? formatBytes(row.rx + row.tx) : '-';
                return `<tr>
                    <td>${date}</td>
                    <td><span style="color:#065f46">&#x2193; ${rx}</span></td>
                    <td><span style="color:#1e40af">&#x2191; ${tx}</span></td>
                    <td>${total}</td>
                </tr>`;
            }).join('');
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">ÂèñÂæóÂ§±Êïó: ${escapeHtml(e.message)}</div>`;
    }
}

// ===================================================================
// „Éà„ÉÉ„Éó„Çø„Éñ
// ===================================================================

async function loadTop() {
    const loading = document.getElementById('top-loading');
    const content = document.getElementById('top-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getBandwidthTop();
        const ifaces = data.interfaces || [];
        const tbody = document.getElementById('top-tbody');
        if (ifaces.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">„Éá„Éº„Çø„Å™„Åó</td></tr>';
        } else {
            tbody.innerHTML = ifaces.map((iface, i) => {
                const rank = i + 1;
                const badgeClass = rank <= 3 ? `rank-${rank}` : 'rank-other';
                const name  = escapeHtml(iface.name || '-');
                const rx    = iface.rx_bytes != null ? formatBytes(iface.rx_bytes) : '-';
                const tx    = iface.tx_bytes != null ? formatBytes(iface.tx_bytes) : '-';
                const total = (iface.rx_bytes != null && iface.tx_bytes != null)
                    ? formatBytes(iface.rx_bytes + iface.tx_bytes) : '-';
                return `<tr>
                    <td><span class="rank-badge ${badgeClass}">${rank}</span></td>
                    <td><strong>${name}</strong></td>
                    <td><span style="color:#065f46">&#x2193; ${rx}</span></td>
                    <td><span style="color:#1e40af">&#x2191; ${tx}</span></td>
                    <td>${total}</td>
                </tr>`;
            }).join('');
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">ÂèñÂæóÂ§±Êïó: ${escapeHtml(e.message)}</div>`;
    }
}

// ===================================================================
// „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
// ===================================================================

window.addEventListener('beforeunload', stopLive);

// ===================================================================
// ÂàùÊúüÂåñ
// ===================================================================

document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html';
        return;
    }
    api.setToken(token);

    // „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ‰∏ÄË¶ß„Çí„É≠„Éº„Éâ
    await loadInterfaces();

    // „Çµ„Ç§„Éâ„Éê„ÉºÂàùÊúüÂåñ
    if (typeof initSidebar === 'function') initSidebar('bandwidth');

    // ÂàùÊúü„Çø„ÉñÔºà„Çµ„Éû„É™„ÉºÔºâ„Çí„É≠„Éº„Éâ
    loadSummary();
});
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
