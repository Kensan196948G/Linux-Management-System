<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¯åŸŸå¹…ãƒ¢ãƒ‹ã‚¿ãƒ¼ - Linux Management System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/sidebar.css">
    <link href="../vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <style>
        .nav-tabs .nav-link { cursor: pointer; color: #374151; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #2563eb; }
        .metric-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            margin-bottom: 12px;
        }
        .metric-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
        .metric-value { font-size: 22px; font-weight: bold; color: #111827; }
        .table-compact td, .table-compact th { padding: 6px 10px; font-size: 13px; }

        /* ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ */
        .live-cards {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        .live-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 24px;
            text-align: center;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .live-card.rx { border-top: 4px solid #10b981; }
        .live-card.tx { border-top: 4px solid #3b82f6; }
        .live-label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        .live-value {
            font-size: 36px;
            font-weight: bold;
            color: #111827;
            line-height: 1.1;
        }
        .live-unit {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }
        .live-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #d1d5db;
            margin-right: 6px;
            vertical-align: middle;
            transition: background 0.3s;
        }
        .live-status.active { background: #10b981; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%,100% { opacity: 1; }
            50%      { opacity: 0.4; }
        }
        .live-ts { font-size: 11px; color: #9ca3af; margin-top: 8px; }

        /* ãƒˆãƒƒãƒ—ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .rank-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .rank-1 { background: #f59e0b; }
        .rank-2 { background: #9ca3af; }
        .rank-3 { background: #b45309; }
        .rank-other { background: #d1d5db; color: #374151; }

        .iface-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        .iface-selector label { font-weight: 600; color: #374151; margin: 0; white-space: nowrap; }
        .iface-selector select { min-width: 200px; }

        .source-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .source-vnstat  { background: #d1fae5; color: #065f46; }
        .source-fallback { background: #fef3c7; color: #92400e; }

        .summary-cards {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .summary-card {
            flex: 1;
            min-width: 180px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 16px 20px;
        }
        .summary-card.rx-card { border-left: 4px solid #10b981; }
        .summary-card.tx-card { border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
<div class="app-layout">
    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <aside class="sidebar" id="sidebar-container"></aside>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="main-content">
        <div class="main-header">
            <h2 id="page-title">ğŸ“¡ å¸¯åŸŸå¹…ãƒ¢ãƒ‹ã‚¿ãƒ¼</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="refreshCurrentTab()" id="refresh-btn">
                ğŸ”„ æ›´æ–°
            </button>
        </div>

        <div class="main-body">
            <!-- ã‚¢ãƒ©ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div id="alert-area"></div>

            <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹é¸æŠ -->
            <div class="iface-selector">
                <label for="iface-select">ğŸ”Œ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹:</label>
                <select class="form-select form-select-sm" id="iface-select" onchange="onIfaceChange()">
                    <option value="">ã™ã¹ã¦ / ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                </select>
                <span id="iface-loading" class="text-muted" style="font-size:13px; display:none">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>

            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <ul class="nav nav-tabs mb-3" id="bandwidth-tabs">
                <li class="nav-item">
                    <a class="nav-link active" onclick="showTab('summary')" id="tab-summary">
                        ğŸ“Š ã‚µãƒãƒªãƒ¼
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('live')" id="tab-live">
                        <span class="live-status" id="live-indicator"></span>ãƒ©ã‚¤ãƒ–
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('daily')" id="tab-daily">
                        ğŸ“… æ—¥æ¬¡
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('top')" id="tab-top">
                        ğŸ† ãƒˆãƒƒãƒ—
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('monthly')" id="tab-monthly">
                        ğŸ“† æœˆæ¬¡
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('history')" id="tab-history">
                        ğŸ“Š å±¥æ­´
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" onclick="showTab('alert-config')" id="tab-alert-config">
                        ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆ
                    </a>
                </li>
            </ul>

            <!-- ã‚µãƒãƒªãƒ¼ã‚¿ãƒ– -->
            <div id="pane-summary">
                <div id="summary-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="summary-content" style="display:none">
                    <div class="summary-cards">
                        <div class="summary-card rx-card">
                            <div class="metric-label">â†“ åˆè¨ˆå—ä¿¡</div>
                            <div class="metric-value" id="summary-rx">-</div>
                        </div>
                        <div class="summary-card tx-card">
                            <div class="metric-label">â†‘ åˆè¨ˆé€ä¿¡</div>
                            <div class="metric-value" id="summary-tx">-</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span style="font-size:13px;color:#6b7280">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹:</span>
                        <span id="summary-source" class="source-badge">-</span>
                    </div>
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>é …ç›®</th>
                                <th>å—ä¿¡</th>
                                <th>é€ä¿¡</th>
                            </tr>
                        </thead>
                        <tbody id="summary-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ãƒ©ã‚¤ãƒ–ã‚¿ãƒ– -->
            <div id="pane-live" style="display:none">
                <div id="live-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="live-content" style="display:none">
                    <div class="live-cards">
                        <div class="live-card rx">
                            <div class="live-label">â†“ å—ä¿¡</div>
                            <div class="live-value" id="live-rx">-</div>
                            <div class="live-unit">kbps</div>
                        </div>
                        <div class="live-card tx">
                            <div class="live-label">â†‘ é€ä¿¡</div>
                            <div class="live-value" id="live-tx">-</div>
                            <div class="live-unit">kbps</div>
                        </div>
                    </div>
                    <div class="live-ts" id="live-ts">æœ€çµ‚æ›´æ–°: -</div>
                    <div class="mt-3 p-3" style="background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb;">
                        <div class="row">
                            <div class="col-6 col-md-3 mb-2">
                                <div class="metric-label">å—ä¿¡ (bps)</div>
                                <div style="font-size:14px;font-weight:600;color:#111827" id="live-rx-bps">-</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="metric-label">é€ä¿¡ (bps)</div>
                                <div style="font-size:14px;font-weight:600;color:#111827" id="live-tx-bps">-</div>
                            </div>
                            <div class="col-6 col-md-3 mb-2">
                                <div class="metric-label">ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</div>
                                <div style="font-size:14px;font-weight:600;color:#111827" id="live-iface-name">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¥æ¬¡ã‚¿ãƒ– -->
            <div id="pane-daily" style="display:none">
                <div id="daily-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="daily-content" style="display:none">
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>â†“ å—ä¿¡</th>
                                <th>â†‘ é€ä¿¡</th>
                                <th>åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="daily-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- ãƒˆãƒƒãƒ—ã‚¿ãƒ– -->
            <div id="pane-top" style="display:none">
                <div id="top-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="top-content" style="display:none">
                    <p class="text-muted" style="font-size:13px">
                        â€» ãƒˆãƒƒãƒ—è¡¨ç¤ºã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹é¸æŠã«é–¢ã‚ã‚‰ãšå…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’è¡¨ç¤ºã—ã¾ã™
                    </p>
                    <table class="table table-sm table-hover table-compact">
                        <thead class="table-dark">
                            <tr>
                                <th>é †ä½</th>
                                <th>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹</th>
                                <th>â†“ å—ä¿¡</th>
                                <th>â†‘ é€ä¿¡</th>
                                <th>åˆè¨ˆ</th>
                            </tr>
                        </thead>
                        <tbody id="top-tbody"></tbody>
                    </table>
                </div>

            <!-- æœˆæ¬¡çµ±è¨ˆã‚¿ãƒ– -->
            <div id="pane-monthly" style="display:none">
                <div id="monthly-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="monthly-content" style="display:none">
                    <pre id="monthly-data" class="small" style="max-height:300px;overflow-y:auto"></pre>
                </div>
            </div>

            <!-- å±¥æ­´ã‚¿ãƒ– -->
            <div id="pane-history" style="display:none">
                <div id="history-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="history-content" style="display:none">
                    <pre id="history-data" class="small" style="max-height:300px;overflow-y:auto"></pre>
                </div>
            </div>

            <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚¿ãƒ– -->
            <div id="pane-alert-config" style="display:none">
                <div id="alert-config-loading" class="text-center py-4 text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="alert-config-content" style="display:none">
                    <table class="table table-sm table-compact">
                        <tbody id="alert-config-tbody"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>
</div>

<script src="../js/env-config.js"></script>
<script src="../js/api.js"></script>
<script src="../js/sidebar.js"></script>
<script>document.readyState==='loading'?document.addEventListener('DOMContentLoaded',()=>renderSidebar('bandwidth')):renderSidebar('bandwidth');</script>
<script>
// ===================================================================
// çŠ¶æ…‹ç®¡ç†
// ===================================================================
let currentTab = 'summary';
let selectedIface = '';
let liveTimer = null;

// ===================================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ===================================================================

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) { bytes /= 1024; i++; }
    return `${bytes.toFixed(1)} ${units[i]}`;
}

function showAlert(msg, type = 'danger') {
    document.getElementById('alert-area').innerHTML =
        `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${escapeHtml(msg)}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
}

function formatTimestamp(ts) {
    if (!ts) return '-';
    try {
        return new Date(ts).toLocaleTimeString('ja-JP');
    } catch (e) {
        return escapeHtml(String(ts));
    }
}

// ===================================================================
// ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹é¸æŠ
// ===================================================================

async function loadInterfaces() {
    const loadingSpan = document.getElementById('iface-loading');
    loadingSpan.style.display = '';
    try {
        const data = await api.getBandwidthInterfaces();
        const ifaces = data.interfaces || [];
        const sel = document.getElementById('iface-select');
        ifaces.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            sel.appendChild(opt);
        });
    } catch (e) {
        console.warn('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä¸€è¦§å–å¾—å¤±æ•—:', e.message);
    } finally {
        loadingSpan.style.display = 'none';
    }
}

function onIfaceChange() {
    selectedIface = document.getElementById('iface-select').value;
    stopLive();
    refreshCurrentTab();
}

// ===================================================================
// ã‚¿ãƒ–ç®¡ç†
// ===================================================================

function showTab(tab) {
    const tabs = ['summary', 'live', 'daily', 'top', 'monthly', 'history', 'alert-config'];
    tabs.forEach(t => {
        document.getElementById(`pane-${t}`).style.display = t === tab ? '' : 'none';
        document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    });

    // ãƒ©ã‚¤ãƒ–ã‚¿ãƒ–ã‚’é›¢ã‚ŒãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
    if (currentTab === 'live' && tab !== 'live') {
        stopLive();
    }

    currentTab = tab;

    if (tab === 'summary') loadSummary();
    else if (tab === 'live') startLive();
    else if (tab === 'daily') loadDaily();
    else if (tab === 'top') loadTop();
    else if (tab === 'monthly') loadMonthly();
    else if (tab === 'history') loadHistory();
    else if (tab === 'alert-config') loadAlertConfig();
}

function refreshCurrentTab() {
    showTab(currentTab);
}

// ===================================================================
// ãƒ©ã‚¤ãƒ–æ›´æ–°
// ===================================================================

function startLive() {
    const loading = document.getElementById('live-loading');
    const content = document.getElementById('live-content');
    loading.style.display = '';
    content.style.display = 'none';

    // åˆå›å³æ™‚å–å¾—
    fetchLive().then(() => {
        loading.style.display = 'none';
        content.style.display = '';
    }).catch(e => {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    });

    // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æœ‰åŠ¹åŒ–
    document.getElementById('live-indicator').classList.add('active');

    // 2ç§’ãŠãã«æ›´æ–°
    liveTimer = setInterval(() => {
        fetchLive().catch(e => console.warn('ãƒ©ã‚¤ãƒ–æ›´æ–°å¤±æ•—:', e.message));
    }, 2000);
}

function stopLive() {
    if (liveTimer) {
        clearInterval(liveTimer);
        liveTimer = null;
    }
    document.getElementById('live-indicator').classList.remove('active');
}

async function fetchLive() {
    const data = await api.getBandwidthLive(selectedIface);
    const rxKbps = data.rx_kbps != null ? Number(data.rx_kbps).toFixed(1) : '-';
    const txKbps = data.tx_kbps != null ? Number(data.tx_kbps).toFixed(1) : '-';
    const rxBps  = data.rx_bps  != null ? Number(data.rx_bps).toLocaleString() : '-';
    const txBps  = data.tx_bps  != null ? Number(data.tx_bps).toLocaleString() : '-';

    document.getElementById('live-rx').textContent = rxKbps;
    document.getElementById('live-tx').textContent = txKbps;
    document.getElementById('live-rx-bps').textContent = rxBps !== '-' ? rxBps + ' bps' : '-';
    document.getElementById('live-tx-bps').textContent = txBps !== '-' ? txBps + ' bps' : '-';
    document.getElementById('live-iface-name').textContent = escapeHtml(data.interface || selectedIface || 'all');
    document.getElementById('live-ts').textContent = 'æœ€çµ‚æ›´æ–°: ' + formatTimestamp(data.timestamp);
}

// ===================================================================
// ã‚µãƒãƒªãƒ¼ã‚¿ãƒ–
// ===================================================================

async function loadSummary() {
    const loading = document.getElementById('summary-loading');
    const content = document.getElementById('summary-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getBandwidthSummary();

        // åˆè¨ˆã‚«ãƒ¼ãƒ‰
        document.getElementById('summary-rx').textContent = formatBytes(data.rx_bytes);
        document.getElementById('summary-tx').textContent = formatBytes(data.tx_bytes);

        // ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚¸
        const srcEl = document.getElementById('summary-source');
        const src = data.source || 'unknown';
        srcEl.textContent = escapeHtml(src);
        srcEl.className = 'source-badge ' + (src === 'vnstat' ? 'source-vnstat' : 'source-fallback');

        // ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
        const rows = data.data || [];
        const tbody = document.getElementById('summary-tbody');
        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
        } else {
            tbody.innerHTML = rows.map((row, i) => {
                const rx = row.rx != null ? formatBytes(row.rx) : '-';
                const tx = row.tx != null ? formatBytes(row.tx) : '-';
                const total = (row.rx != null && row.tx != null)
                    ? formatBytes(row.rx + row.tx) : '-';
                const label = escapeHtml(
                    row.date || row.hour || row.month || row.year || row.label || String(i + 1)
                );
                return `<tr>
                    <td>${i + 1}</td>
                    <td>${label}</td>
                    <td><span style="color:#065f46">&#x2193; ${rx}</span></td>
                    <td><span style="color:#1e40af">&#x2191; ${tx}</span></td>
                </tr>`;
            }).join('');
        }

        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

// ===================================================================
// æ—¥æ¬¡ã‚¿ãƒ–
// ===================================================================

async function loadDaily() {
    const loading = document.getElementById('daily-loading');
    const content = document.getElementById('daily-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getBandwidthDaily(selectedIface);
        const rows = data.data || [];
        const tbody = document.getElementById('daily-tbody');
        if (rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
        } else {
            tbody.innerHTML = rows.map(row => {
                const date  = escapeHtml(row.date || '-');
                const rx    = row.rx != null ? formatBytes(row.rx) : '-';
                const tx    = row.tx != null ? formatBytes(row.tx) : '-';
                const total = (row.rx != null && row.tx != null)
                    ? formatBytes(row.rx + row.tx) : '-';
                return `<tr>
                    <td>${date}</td>
                    <td><span style="color:#065f46">&#x2193; ${rx}</span></td>
                    <td><span style="color:#1e40af">&#x2191; ${tx}</span></td>
                    <td>${total}</td>
                </tr>`;
            }).join('');
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

// ===================================================================
// ãƒˆãƒƒãƒ—ã‚¿ãƒ–
// ===================================================================

async function loadTop() {
    const loading = document.getElementById('top-loading');
    const content = document.getElementById('top-content');
    loading.style.display = ''; content.style.display = 'none';
    try {
        const data = await api.getBandwidthTop();
        const ifaces = data.interfaces || [];
        const tbody = document.getElementById('top-tbody');
        if (ifaces.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
        } else {
            tbody.innerHTML = ifaces.map((iface, i) => {
                const rank = i + 1;
                const badgeClass = rank <= 3 ? `rank-${rank}` : 'rank-other';
                const name  = escapeHtml(iface.name || '-');
                const rx    = iface.rx_bytes != null ? formatBytes(iface.rx_bytes) : '-';
                const tx    = iface.tx_bytes != null ? formatBytes(iface.tx_bytes) : '-';
                const total = (iface.rx_bytes != null && iface.tx_bytes != null)
                    ? formatBytes(iface.rx_bytes + iface.tx_bytes) : '-';
                return `<tr>
                    <td><span class="rank-badge ${badgeClass}">${rank}</span></td>
                    <td><strong>${name}</strong></td>
                    <td><span style="color:#065f46">&#x2193; ${rx}</span></td>
                    <td><span style="color:#1e40af">&#x2191; ${tx}</span></td>
                    <td>${total}</td>
                </tr>`;
            }).join('');
        }
        loading.style.display = 'none'; content.style.display = '';
    } catch (e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

// ===================================================================
// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
// ===================================================================

window.addEventListener('beforeunload', stopLive);

// ===================================================================
// åˆæœŸåŒ–
// ===================================================================

document.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('access_token');
    if (!token) {
        window.location.href = window.location.pathname.replace(/[^/]*$/, '') + 'index.html';
        return;
    }
    api.setToken(token);

    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ä¸€è¦§ã‚’ãƒ­ãƒ¼ãƒ‰
    await loadInterfaces();

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆæœŸåŒ–
    if (typeof initSidebar === 'function') initSidebar('bandwidth');

    // åˆæœŸã‚¿ãƒ–ï¼ˆã‚µãƒãƒªãƒ¼ï¼‰ã‚’ãƒ­ãƒ¼ãƒ‰
    loadSummary();
});

async function loadMonthly() {
    const loading = document.getElementById('monthly-loading');
    const content = document.getElementById('monthly-content');
    loading.style.display = '';
    content.style.display = 'none';
    try {
        const iface = selectedIface ? `?interface=${encodeURIComponent(selectedIface)}` : '';
        const data = await api.get(`/api/bandwidth/monthly${iface}`);
        document.getElementById('monthly-data').textContent = JSON.stringify(data.data || data, null, 2);
        loading.style.display = 'none';
        content.style.display = '';
    } catch(e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadHistory() {
    const loading = document.getElementById('history-loading');
    const content = document.getElementById('history-content');
    loading.style.display = '';
    content.style.display = 'none';
    try {
        const iface = selectedIface ? `?interface=${encodeURIComponent(selectedIface)}` : '';
        const data = await api.get(`/api/bandwidth/history${iface}`);
        document.getElementById('history-data').textContent = JSON.stringify(data.data || data, null, 2);
        loading.style.display = 'none';
        content.style.display = '';
    } catch(e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}

async function loadAlertConfig() {
    const loading = document.getElementById('alert-config-loading');
    const content = document.getElementById('alert-config-content');
    loading.style.display = '';
    content.style.display = 'none';
    try {
        const data = await api.get('/api/bandwidth/alert-config');
        const tbody = document.getElementById('alert-config-tbody');
        tbody.innerHTML = `
            <tr><th>é–¾å€¤ (GB)</th><td>${escapeHtml(data.threshold_gb)}</td></tr>
            <tr><th>é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«</th><td>${data.alert_email ? escapeHtml(data.alert_email) : '<span class="text-muted">æœªè¨­å®š</span>'}</td></tr>
            <tr><th>æœ‰åŠ¹</th><td>${data.enabled ? '<span class="badge bg-success">æœ‰åŠ¹</span>' : '<span class="badge bg-secondary">ç„¡åŠ¹</span>'}</td></tr>`;
        loading.style.display = 'none';
        content.style.display = '';
    } catch(e) {
        loading.innerHTML = `<div class="alert alert-warning">å–å¾—å¤±æ•—: ${escapeHtml(e.message)}</div>`;
    }
}
</script>
<script src="../vendor/bootstrap/bootstrap.bundle.min.js"></script>
</body>
</html>
