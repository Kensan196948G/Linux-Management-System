# テスト仕様書

**文書番号**: WEBUI-TST-001
**バージョン**: 1.0
**作成日**: 2026-02-25
**対象システム**: Linux管理 WebUI サンプルシステム

---

## 1. テスト方針

### 1.1 テスト戦略

本システムはセキュリティ・安全性が最優先であるため、以下の順序でテストを実施する。

```
ユニットテスト → 統合テスト → E2Eテスト → セキュリティテスト → 受入テスト
```

### 1.2 テスト種別と目的

| テスト種別 | 目的 | ツール |
|----------|------|--------|
| ユニットテスト | 個別関数・クラスの動作確認 | pytest |
| 統合テスト | API・DB・ラッパー連携確認 | pytest + httpx |
| E2Eテスト | ブラウザ操作フロー確認 | Playwright |
| セキュリティテスト | 脆弱性・インジェクション確認 | OWASP ZAP / 手動 |
| パフォーマンステスト | 応答時間・スループット確認 | Locust |
| 受入テスト | 要件充足確認 | 手動（ユーザー） |

### 1.3 合格基準

| 種別 | 合格基準 |
|------|---------|
| ユニットテスト | カバレッジ 80% 以上 |
| 統合テスト | 全APIエンドポイントの正常・異常系テスト完了 |
| E2Eテスト | 主要ユースケース 100% 成功 |
| セキュリティテスト | Critical/High 脆弱性ゼロ |
| パフォーマンステスト | 非機能要件の全項目を満たすこと |

---

## 2. ユニットテスト仕様

### 2.1 バリデーション関数テスト

**対象**: `backend/utils/validators.py`

| テストID | テスト内容 | 入力 | 期待結果 |
|---------|-----------|------|---------|
| UT-VAL-001 | 正常なサービス名 | `"nginx"` | OK |
| UT-VAL-002 | 正常なサービス名（記号含む） | `"my-app_v2"` | OK |
| UT-VAL-003 | 禁止文字（セミコロン） | `"nginx;rm -rf /"` | ValidationError |
| UT-VAL-004 | 禁止文字（パイプ） | `"nginx|bash"` | ValidationError |
| UT-VAL-005 | 禁止文字（バッククォート） | `` "nginx`id`" `` | ValidationError |
| UT-VAL-006 | 禁止文字（ドルサイン） | `"$(bash)"` | ValidationError |
| UT-VAL-007 | 空文字 | `""` | ValidationError |
| UT-VAL-008 | 過長文字列（129文字） | `"a" * 129` | ValidationError |
| UT-VAL-009 | allowlist外サービス | `"unknown-svc"` | PermissionError |

### 2.2 認証ロジックテスト

**対象**: `backend/core/security.py`

| テストID | テスト内容 | 期待結果 |
|---------|-----------|---------|
| UT-AUTH-001 | 正常なJWTトークン検証 | ユーザー情報返却 |
| UT-AUTH-002 | 改ざんされたJWTトークン | JWTError |
| UT-AUTH-003 | 有効期限切れトークン | TokenExpiredError |
| UT-AUTH-004 | 無効なシグネチャ | JWTError |
| UT-AUTH-005 | bcryptパスワード検証（正常） | True |
| UT-AUTH-006 | bcryptパスワード検証（誤り） | False |
| UT-AUTH-007 | ロール権限チェック（十分） | OK |
| UT-AUTH-008 | ロール権限チェック（不足） | PermissionError |

---

## 3. 統合テスト仕様（API テスト）

### 3.1 認証APIテスト

| テストID | エンドポイント | シナリオ | 期待HTTPステータス |
|---------|--------------|---------|-----------------|
| INT-AUTH-001 | POST /auth/login | 正常ログイン | 200 |
| INT-AUTH-002 | POST /auth/login | 誤パスワード | 401 |
| INT-AUTH-003 | POST /auth/login | 存在しないユーザー | 401 |
| INT-AUTH-004 | POST /auth/login | 5回連続失敗後 | 401（ロック） |
| INT-AUTH-005 | POST /auth/login | MFA必須ユーザー・コードなし | 401 |
| INT-AUTH-006 | POST /auth/login | MFA必須ユーザー・正常コード | 200 |
| INT-AUTH-007 | POST /auth/logout | 正常ログアウト | 200 |
| INT-AUTH-008 | POST /auth/refresh | 正常リフレッシュ | 200 |
| INT-AUTH-009 | POST /auth/refresh | 無効なリフレッシュトークン | 401 |

### 3.2 サービス操作APIテスト

| テストID | エンドポイント | ロール | シナリオ | 期待 |
|---------|--------------|--------|---------|------|
| INT-SVC-001 | GET /services | viewer | 一覧取得 | 200 |
| INT-SVC-002 | GET /services/{name} | viewer | 詳細取得 | 200 |
| INT-SVC-003 | POST /services/{name}/action | operator | restart（allowlist内） | 202 |
| INT-SVC-004 | POST /services/{name}/action | viewer | restart（権限なし） | 403 |
| INT-SVC-005 | POST /services/{name}/action | operator | 存在しないサービス | 404 |
| INT-SVC-006 | POST /services/{name}/action | operator | allowlist外サービス | 403 |
| INT-SVC-007 | POST /services/{name}/action | operator | stop（承認なし） | 403 |
| INT-SVC-008 | POST /services/{name}/action | approver | stop（承認あり） | 202 |
| INT-SVC-009 | POST /services/{name}/action | - | 認証なし | 401 |
| INT-SVC-010 | POST /services/{name}/action | operator | サービス名にセミコロン | 422 |

### 3.3 コマンドインジェクションテスト（最重要）

| テストID | 入力値 | 期待結果 |
|---------|--------|---------|
| INT-INJ-001 | `nginx; rm -rf /` | 422（バリデーションエラー） |
| INT-INJ-002 | `nginx && id` | 422 |
| INT-INJ-003 | `nginx\|bash` | 422 |
| INT-INJ-004 | `$(cat /etc/passwd)` | 422 |
| INT-INJ-005 | `` `id` `` | 422 |
| INT-INJ-006 | `../../etc/passwd` | 422 |
| INT-INJ-007 | `nginx\n/bin/bash` | 422 |

---

## 4. E2Eテスト仕様

### 4.1 ユースケース E2E テスト

**UC-E2E-001: 通常ログインとダッシュボード閲覧**
```
1. /login にアクセス
2. ユーザー名・パスワードを入力してログイン
3. ダッシュボードが表示される
4. CPU/メモリ/ディスクのリソース情報が表示されている
5. サービス状態サマリーが表示されている
期待: 全ステップ成功
```

**UC-E2E-002: Operatorによるサービス再起動**
```
1. Operator ロールでログイン
2. サービス管理画面を開く
3. nginx の「再起動」ボタンをクリック
4. 確認ダイアログが表示される
5. 確認フィールドに "nginx" を入力
6. 「実行する」ボタンをクリック
7. 処理中表示が出る
8. 成功トースト通知が表示される
9. 監査ログに操作が記録されている
期待: 全ステップ成功・監査ログ確認
```

**UC-E2E-003: Viewerによるサービス操作（権限なし）**
```
1. Viewer ロールでログイン
2. サービス管理画面を開く
3. 「再起動」ボタンが非表示であることを確認
期待: 操作ボタンが表示されない
```

**UC-E2E-004: 承認フロー**
```
1. Operator でログイン
2. サービス停止を申請
3. 承認者にメール通知が届く（モック確認）
4. Approver でログイン
5. 承認申請一覧に申請が表示されている
6. 申請を承認する
7. Operator でログイン
8. 承認トークンを使って停止操作を実行
期待: 全ステップ成功
```

---

## 5. セキュリティテスト仕様

### 5.1 認証セキュリティテスト

| テストID | テスト内容 | 合格基準 |
|---------|-----------|---------|
| SEC-001 | ブルートフォース攻撃 | 5回失敗後ロック |
| SEC-002 | パスワードリスト攻撃 | レートリミットで遮断 |
| SEC-003 | JWTトークン改ざん | 401で拒否 |
| SEC-004 | 期限切れトークン使用 | 401で拒否 |
| SEC-005 | セッション固定攻撃 | ログイン時にトークン再発行 |

### 5.2 インジェクションテスト

| テストID | テスト内容 | 合格基準 |
|---------|-----------|---------|
| SEC-010 | OSコマンドインジェクション | 全入力で拒否 |
| SEC-011 | SQLインジェクション | ORM使用で安全 |
| SEC-012 | XSS（反射型） | CSP + エスケープで防止 |
| SEC-013 | XSS（格納型） | 出力時エスケープで防止 |
| SEC-014 | CSRF | CSRFトークンで防止 |
| SEC-015 | パストラバーサル | バリデーションで防止 |

---

## 6. パフォーマンステスト仕様

### 6.1 負荷テストシナリオ

| シナリオ | 仮想ユーザー数 | 継続時間 | 合格基準 |
|---------|-------------|---------|---------|
| 通常負荷 | 10ユーザー | 10分 | 全応答 2秒以内 |
| ピーク負荷 | 20ユーザー | 5分 | 全応答 5秒以内 |
| ダッシュボード更新 | 20ユーザー | 10分 | エラーレート 0% |
| ログ検索同時実行 | 5ユーザー | 5分 | 10秒以内 |

---

## 7. テスト環境

| 環境 | 用途 | データ |
|------|------|--------|
| ローカル開発環境 | ユニット・統合テスト | テストデータ |
| CI環境（GitHub Actions） | 自動テスト | テストデータ |
| ステージング環境 | E2E・受入テスト | 本番相当データ |
| 本番環境 | 受入テストのみ | 本番データ |

---

*本文書はLinux管理WebUIサンプルシステムのテスト仕様を定めるものである。*
