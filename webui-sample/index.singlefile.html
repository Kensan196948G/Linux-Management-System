<!DOCTYPE html>
<!-- Generated file: do not edit manually. Source: index.html + styles.css + app.js + js/* (2026-02-24T11:43:10.565Z) -->
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="lms-api-base-url" content="/api">
  <meta name="lms-api-mode" content="auto">
  <title>Linux Management System WebUI Sample</title>
  <meta name="description" content="Linux管理WebUIの詳細サンプル（HTML + JavaScript + CSS）">
  <style>
:root {
  --bg: #f6fbff;
  --panel: rgba(255, 255, 255, 0.9);
  --panel-solid: #ffffff;
  --line: #d7e5ee;
  --line-strong: #bdd3df;
  --text: #173042;
  --muted: #5f798b;
  --shadow: 0 12px 40px rgba(25, 75, 95, 0.12);
  --radius: 18px;
  --sky: #3b82f6;
  --sky-2: #7cc3ff;
  --mint: #16c79a;
  --amber: #f4b740;
  --coral: #ff6b5d;
  --indigo: #5169f6;
  --danger: #e5484d;
  --success: #1fa971;
  --warning: #d98a00;
  --soft-blue: #e8f2ff;
  --soft-green: #e9fbf4;
  --soft-amber: #fff6df;
  --soft-coral: #ffeceb;
}

* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; }
body {
  font-family: "M PLUS 1p", "Yu Gothic UI", "Hiragino Sans", Meiryo, sans-serif;
  color: var(--text);
  background: var(--bg);
  line-height: 1.5;
}
code, .mono { font-family: "JetBrains Mono", "Cascadia Code", Consolas, monospace; }
button, input, select, textarea {
  font: inherit;
  color: inherit;
}
button { cursor: pointer; border: 0; background: none; }
input, select, textarea {
  width: 100%;
  border: 1px solid var(--line);
  background: #fff;
  border-radius: 12px;
  padding: 10px 12px;
}
textarea { resize: vertical; min-height: 84px; }
input:focus, select:focus, textarea:focus, button:focus-visible {
  outline: 2px solid rgba(59, 130, 246, 0.35);
  outline-offset: 2px;
}

.ambient-bg {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: -1;
}
.orb {
  position: absolute;
  border-radius: 999px;
  filter: blur(14px);
  opacity: 0.6;
}
.orb-a { width: 340px; height: 340px; left: -80px; top: -40px; background: radial-gradient(circle, #9fe7ff 0%, #dff6ff 65%, transparent 72%); }
.orb-b { width: 420px; height: 420px; right: -120px; top: 80px; background: radial-gradient(circle, #ffe7a5 0%, #fff6d7 62%, transparent 73%); }
.orb-c { width: 360px; height: 360px; left: 28%; bottom: -120px; background: radial-gradient(circle, #b7ffd8 0%, #e5fff2 62%, transparent 74%); }
.mesh {
  position: absolute;
  inset: 0;
  background:
    radial-gradient(rgba(59, 130, 246, 0.06) 1px, transparent 1px) 0 0/20px 20px,
    linear-gradient(180deg, rgba(255,255,255,0.8), rgba(246,251,255,0.95));
}

.hidden { display: none !important; }
.lock-scroll { overflow: hidden; }

.app { min-height: 100vh; }
.eyebrow {
  margin: 0 0 6px;
  font-size: 12px;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: var(--muted);
}
.muted { color: var(--muted); }
.small { font-size: 12px; }

.login-screen {
  min-height: 100vh;
  display: grid;
  place-items: center;
  padding: 24px;
}
.login-panel {
  width: min(820px, 100%);
  display: grid;
  grid-template-columns: 1.1fr 1fr;
  gap: 18px;
  background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.85));
  border: 1px solid rgba(188, 214, 228, 0.8);
  border-radius: 24px;
  box-shadow: var(--shadow);
  padding: 20px;
  backdrop-filter: blur(8px);
}
.login-brand {
  border-radius: 18px;
  padding: 20px;
  background:
    radial-gradient(circle at 15% 10%, rgba(123, 210, 255, 0.35), transparent 48%),
    radial-gradient(circle at 88% 12%, rgba(255, 208, 106, 0.28), transparent 48%),
    radial-gradient(circle at 72% 78%, rgba(22, 199, 154, 0.18), transparent 46%),
    #f7fbff;
  border: 1px solid #e3eef5;
}
.login-brand h1 { margin: 0 0 10px; font-size: clamp(24px, 3vw, 34px); line-height: 1.2; }
.login-form {
  display: grid;
  gap: 12px;
  align-content: start;
  background: #fff;
  border-radius: 18px;
  padding: 18px;
  border: 1px solid #e7eef3;
}
.login-form label { display: grid; gap: 6px; font-size: 14px; }
.inline-note {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
  padding: 8px 10px;
  border-radius: 12px;
  background: #f5f9fd;
  border: 1px solid #e2ebf1;
  font-size: 13px;
}
.note-chip {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 44px;
  padding: 2px 8px;
  border-radius: 999px;
  background: #e7f1ff;
  color: #235acb;
  font-weight: 700;
  font-size: 12px;
}

.shell {
  display: grid;
  grid-template-columns: 320px 1fr;
  min-height: 100vh;
  padding: 14px;
  gap: 14px;
}
.sidebar {
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
  border: 1px solid rgba(188, 214, 228, .85);
  border-radius: 20px;
  box-shadow: var(--shadow);
  display: grid;
  grid-template-rows: auto auto 1fr auto;
  gap: 12px;
  padding: 14px;
  max-height: calc(100vh - 28px);
  position: sticky;
  top: 14px;
}
.sidebar-header { display: flex; align-items: center; gap: 8px; }
.sidebar-header h2 { margin: 0; font-size: 20px; }
.sidebar-user {
  background: linear-gradient(180deg, #f8fbff, #f2f8ff);
  border: 1px solid #e0ebf3;
  border-radius: 16px;
  padding: 10px;
  display: grid;
  gap: 8px;
}
.user-avatar { display: flex; align-items: center; gap: 10px; }
.avatar-icon {
  width: 36px; height: 36px;
  display: grid; place-items: center;
  border-radius: 999px;
  background: linear-gradient(135deg, #d7ebff, #f4fbff);
  border: 1px solid #c9e0f0;
  font-size: 18px;
}
.user-name { font-weight: 700; }
.user-email { font-size: 12px; color: var(--muted); }

.sidebar-nav { overflow: auto; padding-right: 4px; display: grid; gap: 10px; }
.menu-group { display: grid; gap: 8px; }
.menu-group-title { font-size: 12px; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; padding: 0 4px; }
.menu-item, .submenu-item, .accordion-header {
  width: 100%;
  text-align: left;
  border-radius: 12px;
  border: 1px solid transparent;
}
.menu-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px;
  background: #fff;
}
.menu-item.active {
  background: linear-gradient(180deg, #eef5ff, #edf8ff);
  border-color: #cfe0f1;
  font-weight: 700;
}
.menu-item-icon { width: 20px; text-align: center; }

.accordion {
  background: rgba(255,255,255,0.6);
  border: 1px solid #e3edf4;
  border-radius: 14px;
  overflow: hidden;
}
.accordion-header {
  padding: 10px 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: rgba(255,255,255,0.75);
}
.accordion-title { display: flex; gap: 8px; align-items: center; font-weight: 700; }
.accordion-panel { display: grid; gap: 4px; padding: 6px; }
.accordion:not(.expanded) .accordion-panel { display: none; }
.submenu-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 8px 10px;
  background: #fff;
}
.submenu-item.active { border-color: #cfe0f1; background: #f0f7ff; }
.submenu-item.disabled { opacity: .6; cursor: not-allowed; }
.submenu-item.critical { border-color: #ffd8d8; background: #fff3f3; }
.submenu-item-name { font-size: 13px; }
.submenu-item-badge {
  font-size: 11px;
  padding: 2px 7px;
  border-radius: 999px;
  border: 1px solid #d6e4ed;
  background: #f7fbff;
  color: var(--muted);
}
.badge-success { background: #ebfbf4; border-color: #cdeedd; color: #177d57; }
.badge-muted { background: #f2f5f7; border-color: #e0e7ec; color: #6f8595; }
.badge-outline { background: #fff; }
.badge-danger { background: #fff0f0; border-color: #f2c2c2; color: #ae2a2f; }

.sidebar-footer { display: grid; gap: 8px; }
.footer-pill {
  border-radius: 12px;
  border: 1px solid #e3edf4;
  background: #f7fbff;
  padding: 10px;
  display: grid;
  gap: 2px;
  font-size: 13px;
}
.footer-pill small { color: var(--muted); }

.main {
  min-width: 0;
  display: grid;
  grid-template-rows: auto 1fr;
  gap: 12px;
}
.topbar {
  background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86));
  border: 1px solid rgba(188,214,228,.85);
  border-radius: 18px;
  box-shadow: var(--shadow);
  padding: 12px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
}
.topbar-left { display: flex; align-items: center; gap: 10px; min-width: 0; }
.breadcrumb { color: var(--muted); font-size: 12px; }
.breadcrumb .sep { color: #9db2c0; }
.page-title { margin: 2px 0 0; font-size: 22px; }
.topbar-right { display: flex; align-items: center; gap: 8px; }
.live-clock {
  font-size: 13px;
  color: var(--muted);
  border: 1px solid #e1ebf2;
  background: #f8fbff;
  padding: 8px 10px;
  border-radius: 12px;
}

.page-surface {
  background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.83));
  border: 1px solid rgba(188,214,228,.82);
  border-radius: 20px;
  box-shadow: var(--shadow);
  padding: 16px;
  min-width: 0;
}
.page-stack { display: grid; gap: 18px; }
.module-section { display: grid; gap: 14px; scroll-margin-top: 90px; }

.grid { display: grid; gap: 14px; }
.cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
.cols-12 { grid-template-columns: repeat(12, minmax(0, 1fr)); }
.span-4 { grid-column: span 4; }
.span-5 { grid-column: span 5; }
.span-7 { grid-column: span 7; }
.span-8 { grid-column: span 8; }
.span-12 { grid-column: 1 / -1; }

.card {
  background: var(--panel);
  border: 1px solid rgba(215,229,238,.95);
  border-radius: var(--radius);
  box-shadow: 0 8px 28px rgba(25,75,95,.08);
  padding: 14px;
  min-width: 0;
}
.card.inset { background: rgba(255,255,255,.78); box-shadow: none; }
.hero-card {
  display: grid;
  grid-template-columns: 1.4fr 1fr;
  gap: 14px;
  background:
    radial-gradient(circle at 12% 14%, rgba(124,195,255,.18), transparent 48%),
    radial-gradient(circle at 92% 14%, rgba(244,183,64,.17), transparent 44%),
    radial-gradient(circle at 74% 78%, rgba(22,199,154,.12), transparent 44%),
    var(--panel);
}
.hero-card h2 { margin: 0 0 8px; font-size: clamp(22px, 2.2vw, 30px); line-height: 1.2; }
.hero-status { display: grid; align-content: start; gap: 8px; }
.status-chip {
  border: 1px solid #d7e7f2;
  background: #fbfdff;
  border-radius: 12px;
  padding: 9px 10px;
  font-size: 13px;
}
.banner-card { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: start; }
.banner-icon {
  width: 44px; height: 44px;
  display: grid; place-items: center;
  border-radius: 14px;
  background: linear-gradient(135deg, #e9f4ff, #fff9e8);
  border: 1px solid #d7e7f2;
  font-size: 22px;
}

.card-header { display: flex; justify-content: space-between; align-items: start; gap: 10px; margin-bottom: 10px; }
.card-header h2, .card-header h3, .card-header h4 { margin: 0; }

.kpi-card .kpi-label { color: var(--muted); font-size: 13px; }
.kpi-card .kpi-value { font-size: 26px; font-weight: 800; margin: 2px 0 6px; line-height: 1.1; }
.kpi-card .kpi-meta { color: var(--muted); font-size: 12px; margin-top: 6px; }
.progress { height: 8px; border-radius: 999px; background: #eaf1f6; overflow: hidden; border: 1px solid #dce7ef; }
.progress-fill { height: 100%; background: linear-gradient(90deg, var(--sky), var(--sky-2)); }
.progress-fill.mint { background: linear-gradient(90deg, #12b886, #4fe0b5); }
.progress-fill.amber { background: linear-gradient(90deg, #ecaa27, #f6c45d); }
.progress-fill.coral { background: linear-gradient(90deg, #f45d56, #ff8e80); }

.metric-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
.metric-grid.two { grid-template-columns: repeat(2, minmax(0,1fr)); }
.metric-tile {
  border: 1px solid #e2ecf3;
  background: #fbfdff;
  border-radius: 14px;
  padding: 10px;
}
.metric-title { color: var(--muted); font-size: 12px; }
.metric-big { font-size: 22px; font-weight: 800; line-height: 1.15; margin-top: 2px; }
.metric-foot { color: var(--muted); font-size: 12px; margin-top: 3px; }

.chips-row { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
.chip {
  display: inline-flex; align-items: center; justify-content: center;
  gap: 4px;
  border-radius: 999px;
  border: 1px solid #d8e6ef;
  background: #f8fbfe;
  padding: 2px 8px;
  font-size: 12px;
}
.chip-outline { background: #fff; }
.chip-success { background: var(--soft-green); border-color: #cfeede; color: #146f50; }
.chip-warning { background: var(--soft-amber); border-color: #f0dea9; color: #8a5b00; }
.chip-danger { background: var(--soft-coral); border-color: #f3c3c0; color: #a73334; }
.chip-muted { background: #f2f5f8; border-color: #e0e8ee; color: #6c8494; }
.chip-risk { font-weight: 700; }
.chip-low { background: #eefcf5; border-color: #cfeedd; color: #177b56; }
.chip-medium { background: #fff8e7; border-color: #f0e0af; color: #8c6400; }
.chip-high { background: #fff1e8; border-color: #f3d0be; color: #ad4b26; }
.chip-critical { background: #ffecec; border-color: #f4c0c0; color: #a02b2b; }

.table-wrap { overflow: auto; }
.table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 0; }
.table th, .table td { border-bottom: 1px solid #e7eef3; padding: 8px 8px; text-align: left; vertical-align: top; }
.table thead th { font-size: 12px; color: var(--muted); background: rgba(247,251,255,.9); position: sticky; top: 0; z-index: 1; }
.table.compact th, .table.compact td { padding: 6px 7px; font-size: 12px; }
.truncate-cell { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.list-stack { display: grid; gap: 8px; }
.list-item {
  width: 100%;
  text-align: left;
  border: 1px solid #e2edf4;
  background: #fbfdff;
  border-radius: 14px;
  padding: 10px;
}
.list-item:hover { background: #f3f9ff; }
.list-item-row { display: flex; justify-content: space-between; gap: 8px; }

.controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: end; }
.grid-controls > label { display: grid; gap: 6px; min-width: 150px; font-size: 13px; }
.grid-controls > label.grow { flex: 1; min-width: 240px; }
.process-controls > label { min-width: 120px; }

.tabs { display: flex; gap: 6px; flex-wrap: wrap; }
.tab {
  border-radius: 12px;
  border: 1px solid #d8e6ef;
  background: #f8fbff;
  padding: 8px 10px;
  font-size: 13px;
}
.tab.active { background: #edf5ff; border-color: #c9ddf1; font-weight: 700; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }

.stack-tight { display: grid; gap: 10px; }
.stack-split { display: grid; gap: 12px; }
.subhead { font-size: 12px; color: var(--muted); font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .06em; }
.subpanel {
  border: 1px solid #e2edf4;
  background: #fbfdff;
  border-radius: 14px;
  padding: 10px;
}
.subpanel h4 { margin: 0 0 8px; font-size: 14px; }

.terminal {
  background: #102133;
  color: #d5ecff;
  border-radius: 14px;
  border: 1px solid #183954;
  padding: 10px;
  font-size: 12px;
  font-family: "JetBrains Mono", Consolas, monospace;
  display: grid;
  gap: 4px;
}
.terminal.tall { min-height: 160px; max-height: 280px; overflow: auto; }
.terminal mark { background: rgba(255, 220, 97, 0.35); color: #fff2b1; border-radius: 3px; padding: 0 2px; }

.detail-card { display: grid; gap: 10px; }
.detail-title-row { display: flex; justify-content: space-between; gap: 8px; align-items: start; }
.detail-title-row h4 { margin: 0; }
.detail-block {
  border: 1px solid #e6eef4;
  background: #fbfdff;
  border-radius: 12px;
  padding: 10px;
}
.detail-label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
.detail-block pre {
  margin: 0;
  font-size: 12px;
  white-space: pre-wrap;
  background: #f5f9fd;
  border: 1px solid #e4edf4;
  padding: 8px;
  border-radius: 8px;
}
.kv-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
.kv-grid > div {
  border: 1px solid #e6eef4;
  background: #fbfdff;
  border-radius: 12px;
  padding: 8px;
  display: grid;
  gap: 2px;
}
.kv-grid > div > span { font-size: 12px; color: var(--muted); }
.kv-grid > div > strong { font-size: 16px; }

.rule-list { display: grid; gap: 8px; }
.rule-item {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  border-bottom: 1px dashed #e0ebf1;
  padding-bottom: 6px;
}
.rule-item:last-child { border-bottom: 0; padding-bottom: 0; }
.rule-item code { font-size: 12px; text-align: right; }

.command-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
.command-card {
  border: 1px solid #e4edf4;
  background: #fbfdff;
  border-radius: 14px;
  padding: 10px;
  display: grid;
  gap: 8px;
}
.command-card-head { display: flex; justify-content: space-between; gap: 8px; align-items: start; }
.command-card p { margin: 0; font-size: 13px; }
.command-card code { white-space: pre-wrap; font-size: 12px; }

.timeline { display: grid; gap: 10px; }
.timeline.compact { gap: 8px; }
.timeline-item { display: grid; grid-template-columns: 12px 1fr; gap: 8px; align-items: start; }
.timeline-dot {
  width: 12px; height: 12px; border-radius: 999px; margin-top: 4px;
  background: #b5c7d6;
  box-shadow: 0 0 0 3px rgba(181,199,214,.2);
}
.timeline-dot.info { background: #6ea6ff; box-shadow: 0 0 0 3px rgba(110,166,255,.22); }
.timeline-dot.success { background: #27c68a; box-shadow: 0 0 0 3px rgba(39,198,138,.2); }
.timeline-dot.warning { background: #f3b63f; box-shadow: 0 0 0 3px rgba(243,182,63,.2); }
.timeline-dot.critical, .timeline-dot.high { background: #f46a5e; box-shadow: 0 0 0 3px rgba(244,106,94,.18); }
.timeline-title { font-size: 13px; font-weight: 700; }
.timeline-text, .timeline-meta { font-size: 12px; color: var(--muted); }

.sev-tag { font-size: 10px; border-radius: 999px; padding: 2px 6px; border: 1px solid #dbe8f1; background: #f7fbff; }
.sev-critical { color: #b22e2e; background: #fff0f0; border-color: #f0c2c2; }
.sev-high { color: #8b4d00; background: #fff7e7; border-color: #f0dfb5; }

.preview-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 8px; }
.preview-grid > div {
  border: 1px solid #e6eef4;
  background: #fbfdff;
  border-radius: 12px;
  padding: 8px;
  display: grid;
  gap: 4px;
}
.preview-grid > div > span { font-size: 12px; color: var(--muted); }
.preview-grid > div pre { margin: 0; font-size: 12px; white-space: pre-wrap; }
.preview-grid > div.span-2 { grid-column: span 2; }

.plain-list { margin: 0; padding-left: 18px; display: grid; gap: 4px; }
.legend-row { margin-top: 6px; }
.link-button { text-align: left; color: inherit; padding: 0; }
.link-button:hover { text-decoration: underline; }
.inline-actions { display: flex; gap: 6px; flex-wrap: wrap; }
.hero-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
.card-split { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
.bar-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.bar-line { display: grid; gap: 4px; }
.bar-line-top { display: flex; justify-content: space-between; gap: 8px; font-size: 12px; }

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  border-radius: 12px;
  border: 1px solid #d4e4ef;
  background: #fff;
  padding: 9px 12px;
  min-height: 38px;
}
.btn:hover:not(:disabled) { background: #f6fbff; }
.btn:disabled { opacity: .55; cursor: not-allowed; }
.btn-primary {
  border-color: #b6d2f6;
  background: linear-gradient(180deg, #ecf4ff, #dfeeff);
  color: #1f5ecf;
  font-weight: 700;
}
.btn-soft { background: #f7fbff; }
.btn-danger-soft { background: #fff4f4; border-color: #f0d3d3; color: #b03b3f; }
.btn-success-soft { background: #eefcf5; border-color: #cdeedd; color: #137f59; }
.btn-block { width: 100%; }
.btn-mini { min-height: 28px; padding: 4px 8px; border-radius: 9px; font-size: 12px; }

.icon-btn {
  width: 34px; height: 34px;
  display: grid; place-items: center;
  border-radius: 10px;
  border: 1px solid #d7e5ee;
  background: #fff;
}
.mobile-only { display: none; }

.modal-layer { position: fixed; inset: 0; display: none; z-index: 40; }
.modal-layer.active { display: block; }
.modal-backdrop {
  position: absolute; inset: 0;
  background: rgba(16, 33, 51, 0.35);
  display: grid; place-items: center;
  padding: 20px;
}
.modal-panel {
  width: min(760px, 100%);
  max-height: min(90vh, 900px);
  overflow: auto;
  background: #fff;
  border: 1px solid #d7e5ee;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(16, 33, 51, 0.25);
}
.modal-panel.modal-sm { width: min(460px, 100%); }
.modal-panel.modal-lg { width: min(920px, 100%); }
.modal-header, .modal-actions { padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
.modal-header { border-bottom: 1px solid #e7eef4; }
.modal-actions { border-top: 1px solid #e7eef4; justify-content: flex-end; }
.modal-title { margin: 0; font-size: 18px; }
.modal-body { padding: 16px; display: grid; gap: 12px; }

.form-grid { display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: 10px; }
.form-grid > label { display: grid; gap: 6px; font-size: 13px; }
.compact-form > label { min-width: 0; }
.form-grid .span-2 { grid-column: span 2; }
.form-actions { display: flex; justify-content: flex-end; gap: 8px; }
.form-message { margin: 0; min-height: 18px; font-size: 12px; color: var(--muted); }
.form-message.error { color: #b33238; }
.form-message.success { color: #147855; }
.form-message.info { color: #356bc8; }

.toast-stack {
  position: fixed;
  right: 14px;
  bottom: 14px;
  z-index: 50;
  display: grid;
  gap: 8px;
}
.toast {
  min-width: 240px;
  max-width: 380px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  border-radius: 14px;
  border: 1px solid #d7e5ee;
  background: #fff;
  padding: 10px 12px;
  box-shadow: 0 10px 30px rgba(16, 33, 51, 0.16);
  transform: translateY(6px);
  opacity: 0;
  transition: opacity .18s ease, transform .18s ease;
}
.toast.show { opacity: 1; transform: translateY(0); }
.toast-success { border-color: #cceede; background: #f2fdf7; }
.toast-warning { border-color: #f0deb0; background: #fffaf0; }
.toast-error { border-color: #f0c4c4; background: #fff4f4; }
.toast-info { border-color: #d3e4f5; background: #f5faff; }

@media (max-width: 1200px) {
  .cols-12 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
  .span-7, .span-8, .span-5, .span-4 { grid-column: span 6; }
  .cols-4 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .hero-card { grid-template-columns: 1fr; }
  .banner-card { grid-template-columns: auto 1fr; }
  .banner-card .hero-actions { grid-column: 1 / -1; }
  .card-split, .bar-panels { grid-template-columns: 1fr; }
}

@media (max-width: 1024px) {
  .shell { grid-template-columns: 1fr; padding: 10px; }
  .sidebar {
    position: fixed;
    top: 10px;
    left: 10px;
    bottom: 10px;
    width: min(340px, calc(100vw - 20px));
    max-height: none;
    z-index: 30;
    transform: translateX(-110%);
    transition: transform .2s ease;
  }
  .sidebar.open { transform: translateX(0); }
  .sidebar-backdrop {
    position: fixed; inset: 0;
    background: rgba(16, 33, 51, .28);
    z-index: 25;
  }
  .mobile-only { display: inline-grid; }
  .topbar { position: sticky; top: 10px; z-index: 10; }
}

@media (max-width: 720px) {
  .login-panel { grid-template-columns: 1fr; }
  .page-surface { padding: 12px; }
  .cols-4 { grid-template-columns: 1fr; }
  .form-grid { grid-template-columns: 1fr; }
  .form-grid .span-2 { grid-column: auto; }
  .grid-controls > label, .grid-controls > label.grow { min-width: 100%; }
  .topbar { flex-wrap: wrap; align-items: start; }
  .topbar-right { width: 100%; justify-content: space-between; }
  .preview-grid { grid-template-columns: 1fr; }
  .preview-grid > div.span-2 { grid-column: auto; }
  .modal-header, .modal-actions { padding: 12px; }
  .modal-body { padding: 12px; }
}

@media (prefers-reduced-motion: reduce) {
  * { scroll-behavior: auto !important; }
  .toast, .sidebar { transition: none !important; }
}

</style>
</head>
<body>
  <script>
window.__WEBUI_CONFIG__ = window.__WEBUI_CONFIG__ || {};
</script>
<div class="ambient-bg" aria-hidden="true">
    <div class="orb orb-a"></div>
    <div class="orb orb-b"></div>
    <div class="orb orb-c"></div>
    <div class="mesh"></div>
  </div>

  <div class="app" id="app">
    <section class="login-screen" id="loginScreen" aria-labelledby="loginTitle">
      <div class="login-panel">
        <div class="login-brand">
          <p class="eyebrow">Linux Management System</p>
          <h1 id="loginTitle">安全な Linux 管理 WebUI サンプル</h1>
          <p class="muted">
            docs要件（認証・承認・監査・allowlist）を反映した、明るい雰囲気の静的WebUIサンプルです。
          </p>
        </div>

        <form id="loginForm" class="login-form" novalidate>
          <label>
            <span>メールアドレス</span>
            <input type="email" id="loginEmail" value="admin@example.com" autocomplete="username" required>
          </label>

          <label>
            <span>パスワード</span>
            <input type="password" id="loginPassword" value="Admin#1234" autocomplete="current-password" required>
          </label>

          <label>
            <span>ロール（モック）</span>
            <select id="loginRole">
              <option value="Admin">Admin</option>
              <option value="Approver">Approver</option>
              <option value="Operator">Operator</option>
              <option value="Viewer">Viewer</option>
            </select>
          </label>

          <div class="inline-note">
            <span class="note-chip">JWT</span>
            <span>トークンは `localStorage` に保存（サンプル）。有効期限は 30分として模擬します。</span>
          </div>

          <button type="submit" class="btn btn-primary btn-block">ログインして開始</button>
          <p class="form-message" id="loginMessage" role="status" aria-live="polite"></p>
        </form>
      </div>
    </section>

    <div class="shell hidden" id="shell">
      <aside class="sidebar" id="sidebar" aria-label="サイドメニュー">
        <div class="sidebar-header">
          <button class="icon-btn mobile-only" id="sidebarCloseBtn" aria-label="メニューを閉じる">✕</button>
          <div>
            <p class="eyebrow">Linux管理運用</p>
            <h2>Control Center</h2>
          </div>
        </div>

        <div class="sidebar-user" id="sidebarUserCard">
          <div class="user-avatar">
            <span class="avatar-icon" aria-hidden="true">👤</span>
            <div>
              <div class="user-name" id="sidebarUsername">-</div>
              <div class="user-email" id="sidebarEmail">-</div>
            </div>
          </div>
          <div class="role-badge" id="sidebarRoleBadge">-</div>
        </div>

        <nav class="sidebar-nav" id="sidebarNav">
          <div class="menu-group">
            <div class="menu-group-title">トップ</div>
            <button class="menu-item active" data-scroll-target="sec-dashboard">
              <span class="menu-item-icon">📊</span>
              <span class="menu-item-label">ダッシュボード</span>
            </button>
          </div>

          <div class="menu-group">
            <div class="menu-group-title">カテゴリ（8）</div>

            <section class="accordion expanded">
              <button class="accordion-header" data-accordion-toggle aria-expanded="true">
                <span class="accordion-title"><span>⚙️</span><span>Linux管理システム</span></span>
                <span class="accordion-chevron">▾</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">システム設定</span><span class="submenu-item-badge badge-muted">計画中</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">システムユーザー</span><span class="submenu-item-badge badge-muted">計画中</span></button>
                <button class="submenu-item" data-scroll-target="sec-services"><span class="submenu-item-name">システムサーバー</span><span class="submenu-item-badge badge-success">実装済み</span></button>
                <button class="submenu-item" data-scroll-target="sec-audit"><span class="submenu-item-name">システム操作ログ</span><span class="submenu-item-badge badge-success">実装済み</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">システムテーマ</span><span class="submenu-item-badge badge-muted">計画中</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">システムモジュール</span><span class="submenu-item-badge badge-muted">計画中</span></button>
              </div>
            </section>

            <section class="accordion expanded">
              <button class="accordion-header" data-accordion-toggle aria-expanded="true">
                <span class="accordion-title"><span>💻</span><span>システム</span></span>
                <span class="accordion-chevron">▾</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">起動・シャットダウン</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">ディスク・ネットワークFS</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">ディスククォータ</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item" data-scroll-target="sec-systeminfo"><span class="submenu-item-name">ローカルディスク</span><span class="submenu-item-badge badge-success">実装済み</span></button>
                <button class="submenu-item" data-scroll-target="sec-users"><span class="submenu-item-name">ユーザー・グループ</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">ソフトウェアパッケージ更新</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item" data-scroll-target="sec-cron"><span class="submenu-item-name">Cronジョブ</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item" data-scroll-target="sec-processes"><span class="submenu-item-name">実行中プロセス</span><span class="submenu-item-badge badge-success">実装済み</span></button>
              </div>
            </section>

            <section class="accordion">
              <button class="accordion-header" data-accordion-toggle aria-expanded="false">
                <span class="accordion-title"><span>📜</span><span>システムログ</span></span>
                <span class="accordion-chevron">▸</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item" data-scroll-target="sec-logs"><span class="submenu-item-name">システムログ</span><span class="submenu-item-badge badge-success">実装済み</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">カーネルメッセージ</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">認証ログ</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">アプリケーションログ</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
              </div>
            </section>

            <section class="accordion">
              <button class="accordion-header" data-accordion-toggle aria-expanded="false">
                <span class="accordion-title"><span>🖥️</span><span>サーバー</span></span>
                <span class="accordion-chevron">▸</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">Apache Webサーバー</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">BIND DNSサーバー</span><span class="submenu-item-badge badge-outline">v0.4</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">Postfix / Sendmail</span><span class="submenu-item-badge badge-outline">v0.4</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">MySQL / MariaDB</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">PostgreSQL</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">SSHサーバー</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
              </div>
            </section>

            <section class="accordion">
              <button class="accordion-header" data-accordion-toggle aria-expanded="false">
                <span class="accordion-title"><span>🌐</span><span>ネットワーク</span></span>
                <span class="accordion-chevron">▸</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item" data-scroll-target="sec-approvals"><span class="submenu-item-name">Linuxファイアウォール</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">ネットワーク設定</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">ルーティング・ゲートウェイ</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">ネットワーク統計</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">帯域幅モニタリング</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
              </div>
            </section>

            <section class="accordion">
              <button class="accordion-header" data-accordion-toggle aria-expanded="false">
                <span class="accordion-title"><span>🔧</span><span>ハードウェア</span></span>
                <span class="accordion-chevron">▸</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item" data-scroll-target="sec-systeminfo"><span class="submenu-item-name">ローカルディスクパーティション</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
                <button class="submenu-item" data-scroll-target="sec-systeminfo"><span class="submenu-item-name">システム時刻</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">SMARTドライブ状態</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">センサー (lm-sensors)</span><span class="submenu-item-badge badge-outline">サンプル</span></button>
              </div>
            </section>

            <section class="accordion">
              <button class="accordion-header" data-accordion-toggle aria-expanded="false">
                <span class="accordion-title"><span>🔗</span><span>クラスタ/ツール</span></span>
                <span class="accordion-chevron">▸</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">クラスタSSH</span><span class="submenu-item-badge badge-outline">v0.5</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">クラスタCronジョブ</span><span class="submenu-item-badge badge-outline">v0.5</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">クラスタユーザー</span><span class="submenu-item-badge badge-outline">v0.5</span></button>
                <button class="submenu-item disabled critical" disabled><span class="submenu-item-name">コマンドシェル</span><span class="submenu-item-badge badge-danger">禁止</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">ファイルマネージャー</span><span class="submenu-item-badge badge-outline">v0.4</span></button>
              </div>
            </section>

            <section class="accordion expanded">
              <button class="accordion-header" data-accordion-toggle aria-expanded="true">
                <span class="accordion-title"><span>⚡</span><span>システム設定</span></span>
                <span class="accordion-chevron">▾</span>
              </button>
              <div class="accordion-panel">
                <button class="submenu-item" data-scroll-target="sec-users"><span class="submenu-item-name">ユーザー管理</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
                <button class="submenu-item" data-scroll-target="sec-settings-security"><span class="submenu-item-name">セキュリティ設定</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item" data-scroll-target="sec-settings-audit"><span class="submenu-item-name">監査ログ設定</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
                <button class="submenu-item disabled" disabled><span class="submenu-item-name">通知設定</span><span class="submenu-item-badge badge-outline">v0.3</span></button>
                <button class="submenu-item" data-scroll-target="sec-systeminfo"><span class="submenu-item-name">システム情報</span><span class="submenu-item-badge badge-success">実装済み</span></button>
                <button class="submenu-item" data-scroll-target="sec-about"><span class="submenu-item-name">ライセンス情報</span><span class="submenu-item-badge badge-outline">v0.2</span></button>
              </div>
            </section>
          </div>
        </nav>

        <div class="sidebar-footer">
          <div class="footer-pill">
            <span>🌐 日本語 UI</span>
            <small>menu-i18n準拠</small>
          </div>
          <button class="btn btn-soft btn-block" id="logoutBtn">ログアウト</button>
        </div>
      </aside>

      <div class="sidebar-backdrop hidden" id="sidebarBackdrop" aria-hidden="true"></div>

      <main class="main">
        <header class="topbar">
          <div class="topbar-left">
            <button class="icon-btn mobile-only" id="sidebarOpenBtn" aria-label="メニューを開く">☰</button>
            <div>
              <div class="breadcrumb" id="breadcrumb"></div>
              <h1 class="page-title" id="pageTitle">ダッシュボード</h1>
            </div>
          </div>
          <div class="topbar-right">
            <div class="live-clock" id="liveClock">--:--:--</div>
            <button class="btn btn-soft" id="refreshPageBtn">再描画</button>
          </div>
        </header>

        <section class="page-surface" id="pageContent" tabindex="-1">
          <div class="page-stack">
            <section class="module-section" id="sec-dashboard" data-page-label="ダッシュボード" data-breadcrumb="Home / ダッシュボード">
              <div class="card hero-card">
                <div class="hero-copy">
                  <p class="eyebrow">Webmin思想 + 安全設計（docs反映）</p>
                  <h2>明るい運用ダッシュボード / 承認・監査・allowlist を中心に設計</h2>
                  <p class="muted">
                    `要件定義書_詳細設計仕様書.md`、`api-reference.md`、`approval-workflow-design.md`、`cron-jobs-design.md`、
                    `users-groups-design.md`、セキュリティ/テスト報告を踏まえた詳細サンプルです。
                  </p>
                  <div class="hero-actions">
                    <button class="btn btn-primary" data-scroll-target="sec-approvals">承認センターへ</button>
                    <button class="btn btn-soft" data-scroll-target="sec-processes">実行中プロセス</button>
                    <button class="btn btn-soft" data-scroll-target="sec-cron">Cronジョブ管理</button>
                  </div>
                </div>
                <div class="hero-status">
                  <div class="status-chip">JWT 30分 / localStorage（サンプル）</div>
                  <div class="status-chip">root常駐禁止 / sudo wrapper 経由</div>
                  <div class="status-chip">承認履歴: HMAC署名（設計準拠）</div>
                  <div class="status-chip">Cron: allowlist + 最小5分 + 最大10件/ユーザー</div>
                </div>
              </div>

              <div class="grid cols-4">
                <article class="card kpi-card">
                  <div class="kpi-label">CPU 使用率</div>
                  <div class="kpi-value" id="cpuUsageValue">23.5%</div>
                  <div class="progress"><div class="progress-fill" id="cpuUsageBar" style="width:23.5%"></div></div>
                  <div class="kpi-meta">8 cores / `read:status`</div>
                </article>
                <article class="card kpi-card">
                  <div class="kpi-label">メモリ使用率</div>
                  <div class="kpi-value" id="memUsageValue">43.8%</div>
                  <div class="progress"><div class="progress-fill mint" id="memUsageBar" style="width:43.8%"></div></div>
                  <div class="kpi-meta">14,336MB / 32,768MB</div>
                </article>
                <article class="card kpi-card">
                  <div class="kpi-label">ディスク使用率</div>
                  <div class="kpi-value">45.7%</div>
                  <div class="progress"><div class="progress-fill amber" style="width:45.7%"></div></div>
                  <div class="kpi-meta">556GB free / uptime 12d+</div>
                </article>
                <article class="card kpi-card">
                  <div class="kpi-label">承認待ち / Services / Cron</div>
                  <div class="kpi-value"><span id="pendingCountValue">2</span> / 5 / 3</div>
                  <div class="chips-row">
                    <span class="chip chip-warning">pending 2</span>
                    <span class="chip chip-success">active 5</span>
                  </div>
                  <div class="kpi-meta">approval / services / cron 統合ビュー</div>
                </article>
              </div>

              <div class="grid cols-12">
                <article class="card span-7">
                  <div class="card-header">
                    <h3>運用サマリー</h3>
                    <button class="btn btn-mini btn-soft" data-scroll-target="sec-systeminfo">詳細</button>
                  </div>
                  <div class="metric-grid">
                    <div class="metric-tile">
                      <div class="metric-title">実行中プロセス</div>
                      <div class="metric-big" id="procTotalValue">7</div>
                      <div class="metric-foot">R:1 / S:6 / Z:0</div>
                    </div>
                    <div class="metric-tile">
                      <div class="metric-title">トップCPU</div>
                      <div class="metric-big">postgres</div>
                      <div class="metric-foot" id="topCpuValue">12.8%</div>
                    </div>
                    <div class="metric-tile">
                      <div class="metric-title">docs精査対象</div>
                      <div class="metric-big">47</div>
                      <div class="metric-foot">security docs: 13</div>
                    </div>
                    <div class="metric-tile">
                      <div class="metric-title">OpenAPI docs note</div>
                      <div class="metric-big">api-reference優先</div>
                      <div class="metric-foot">`openapi.json` は要確認</div>
                    </div>
                  </div>
                  <table class="table compact">
                    <thead><tr><th>NIC</th><th>IP</th><th>RX</th><th>TX</th><th>Status</th></tr></thead>
                    <tbody>
                      <tr><td>eth0</td><td>10.0.2.15</td><td>28.1 Mbps</td><td>12.4 Mbps</td><td><span class="chip chip-success">UP</span></td></tr>
                      <tr><td>eth1</td><td>192.168.10.21</td><td>0.8 Mbps</td><td>1.2 Mbps</td><td><span class="chip chip-success">UP</span></td></tr>
                    </tbody>
                  </table>
                </article>

                <article class="card span-5">
                  <div class="card-header">
                    <h3>承認待ちリクエスト</h3>
                    <button class="btn btn-mini btn-soft" data-scroll-target="sec-approvals">承認センター</button>
                  </div>
                  <div class="list-stack">
                    <button class="list-item" data-approval-select="apr-1001">
                      <div class="list-item-row"><strong>ユーザーアカウント追加</strong><span class="chip chip-risk chip-high">HIGH</span></div>
                      <div class="list-item-row muted small"><span>operator</span><span>23.0h 残</span></div>
                      <div class="list-item-row">新規プロジェクトメンバーのアカウント作成</div>
                    </button>
                    <button class="list-item" data-approval-select="apr-1002">
                      <div class="list-item-row"><strong>Cronジョブ追加</strong><span class="chip chip-risk chip-high">HIGH</span></div>
                      <div class="list-item-row muted small"><span>operator</span><span>21.0h 残</span></div>
                      <div class="list-item-row">夜間バックアップジョブの追加</div>
                    </button>
                  </div>
                </article>
              </div>

              <div class="grid cols-12">
                <article class="card span-7">
                  <div class="card-header">
                    <h3>API カタログ（docs反映）</h3>
                    <button class="btn btn-mini btn-soft" data-scroll-target="sec-about">docsメモ</button>
                  </div>
                  <table class="table compact">
                    <thead><tr><th>Method</th><th>Path</th><th>Permission</th><th>Module</th></tr></thead>
                    <tbody>
                      <tr><td><span class="method-pill method-post">POST</span></td><td class="mono">/api/auth/login</td><td class="mono">public</td><td>Auth</td></tr>
                      <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/system/status</td><td class="mono">read:status</td><td>System</td></tr>
                      <tr><td><span class="method-pill method-post">POST</span></td><td class="mono">/api/services/restart</td><td class="mono">execute:service_restart</td><td>Services</td></tr>
                      <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/v1/processes</td><td class="mono">read:processes</td><td>Processes</td></tr>
                      <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/cron</td><td class="mono">read:cron</td><td>Cron</td></tr>
                      <tr><td><span class="method-pill method-post">POST</span></td><td class="mono">/api/approval/request</td><td class="mono">request:approval</td><td>Approval</td></tr>
                    </tbody>
                  </table>
                </article>

                <article class="card span-5">
                  <div class="card-header">
                    <h3>UI品質の学習ポイント（テスト報告）</h3>
                  </div>
                  <div class="timeline">
                    <div class="timeline-item"><div class="timeline-dot critical"></div><div><div class="timeline-title"><span class="sev-tag sev-critical">CRITICAL</span> DOMContentLoaded漏れでログイン不可</div><div class="timeline-text">フォーム初期化をDOM読込後に実行</div></div></div>
                    <div class="timeline-item"><div class="timeline-dot critical"></div><div><div class="timeline-title"><span class="sev-tag sev-critical">CRITICAL</span> baseURL相対参照でAPI全404</div><div class="timeline-text">`window.location.origin` に統一</div></div></div>
                    <div class="timeline-item"><div class="timeline-dot high"></div><div><div class="timeline-title"><span class="sev-tag sev-high">HIGH</span> Processesフィールド名不一致</div><div class="timeline-text">`stat/start/rss` に整合</div></div></div>
                    <div class="timeline-item"><div class="timeline-dot high"></div><div><div class="timeline-title"><span class="sev-tag sev-high">HIGH</span> `filter_user` パラメータ不一致</div><div class="timeline-text">JavaScript側のクエリキー修正</div></div></div>
                  </div>
                </article>
              </div>
            </section>

            <section class="module-section" id="sec-services" data-page-label="システムサーバー" data-breadcrumb="Home / Linux管理システム / システムサーバー">
              <div class="card banner-card">
                <div class="banner-icon">⚙️</div>
                <div>
                  <h2>サービス管理（systemd / allowlist）</h2>
                  <p>
                    `api-reference.md` / `service-management.md` 準拠。再起動は allowlist（nginx / postgresql / redis）のみ。
                    停止は原則禁止で、`service_stop` 承認リクエストとして扱います。
                  </p>
                </div>
                <div class="hero-actions">
                  <button class="btn btn-primary" data-open-modal="service-stop">停止申請サンプル</button>
                  <button class="btn btn-soft" data-scroll-target="sec-approvals">承認センター</button>
                </div>
              </div>

              <div class="grid cols-12">
                <article class="card span-8">
                  <div class="card-header">
                    <h3>サービス一覧</h3>
                    <div class="chips-row">
                      <span class="chip chip-outline">allowlist: nginx</span>
                      <span class="chip chip-outline">postgresql</span>
                      <span class="chip chip-outline">redis</span>
                    </div>
                  </div>
                  <table class="table" id="cronTable">
                    <thead><tr><th>Service</th><th>Status</th><th>Enabled</th><th>CPU</th><th>Memory</th><th>Actions</th></tr></thead>
                    <tbody>
                      <tr data-service-row="nginx">
                        <td><button class="link-button" data-service-select="nginx"><strong>Nginx Web Server</strong><br><span class="muted small mono">nginx</span></button></td>
                        <td><span class="chip chip-success service-status-chip" data-service-status="nginx">active</span></td>
                        <td><span class="chip chip-success">enabled</span></td>
                        <td data-service-cpu="nginx">5.2%</td>
                        <td>182MB</td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-service-restart="nginx">再起動</button><button class="btn btn-mini btn-danger-soft" data-open-modal="service-stop" data-service-name="nginx">停止申請</button></div></td>
                      </tr>
                      <tr data-service-row="postgresql">
                        <td><button class="link-button" data-service-select="postgresql"><strong>PostgreSQL</strong><br><span class="muted small mono">postgresql</span></button></td>
                        <td><span class="chip chip-success service-status-chip" data-service-status="postgresql">active</span></td>
                        <td><span class="chip chip-success">enabled</span></td>
                        <td data-service-cpu="postgresql">8.9%</td>
                        <td>1,530MB</td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-service-restart="postgresql">再起動</button><button class="btn btn-mini btn-danger-soft" data-open-modal="service-stop" data-service-name="postgresql">停止申請</button></div></td>
                      </tr>
                      <tr data-service-row="redis">
                        <td><button class="link-button" data-service-select="redis"><strong>Redis</strong><br><span class="muted small mono">redis</span></button></td>
                        <td><span class="chip chip-success service-status-chip" data-service-status="redis">active</span></td>
                        <td><span class="chip chip-success">enabled</span></td>
                        <td data-service-cpu="redis">1.3%</td>
                        <td>96MB</td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-service-restart="redis">再起動</button><button class="btn btn-mini btn-danger-soft" data-open-modal="service-stop" data-service-name="redis">停止申請</button></div></td>
                      </tr>
                      <tr>
                        <td><button class="link-button" data-service-select="linux-management-prod"><strong>Linux Management API</strong><br><span class="muted small mono">linux-management-prod</span></button></td>
                        <td><span class="chip chip-success service-status-chip" data-service-status="linux-management-prod">active</span></td>
                        <td><span class="chip chip-success">enabled</span></td>
                        <td data-service-cpu="linux-management-prod">2.6%</td>
                        <td>242MB</td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" disabled>再起動</button><button class="btn btn-mini btn-danger-soft" data-open-modal="service-stop" data-service-name="linux-management-prod">停止申請</button></div></td>
                      </tr>
                      <tr>
                        <td><button class="link-button" data-service-select="sshd"><strong>SSH Server</strong><br><span class="muted small mono">sshd</span></button></td>
                        <td><span class="chip chip-success service-status-chip" data-service-status="sshd">active</span></td>
                        <td><span class="chip chip-success">enabled</span></td>
                        <td data-service-cpu="sshd">0.2%</td>
                        <td>32MB</td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" disabled>再起動</button><button class="btn btn-mini btn-danger-soft" data-open-modal="service-stop" data-service-name="sshd">停止申請</button></div></td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="inline-note"><span class="note-chip">RBAC</span><span>Viewer は参照のみ、Operator 以上が `execute:service_restart`、危険操作は承認フローへ。</span></div>
                </article>

                <article class="card span-4">
                  <div class="card-header">
                    <h3>ログプレビュー</h3>
                    <button class="btn btn-mini btn-soft" data-scroll-target="sec-logs">ログ画面へ</button>
                  </div>
                  <div class="stack-tight">
                    <div>
                      <div><strong id="servicePreviewTitle">Nginx Web Server</strong></div>
                      <div class="muted small mono" id="servicePreviewName">nginx</div>
                    </div>
                    <div class="terminal" id="serviceLogPreview">
                      <div>Feb 24 09:12:20 nginx: Reloading configuration...</div>
                      <div>Feb 24 09:12:21 nginx: Configuration reloaded</div>
                      <div>Feb 24 10:15:13 nginx: GET /api/system/status 200</div>
                    </div>
                    <div class="rule-list">
                      <div class="rule-item"><span>Validation</span><code>^[a-zA-Z0-9_-]+$</code></div>
                      <div class="rule-item"><span>Allowlist</span><code>nginx, postgresql, redis</code></div>
                      <div class="rule-item"><span>Audit</span><code>attempt → success/denied/failure</code></div>
                    </div>
                  </div>
                </article>
              </div>
            </section>

            <section class="module-section" id="sec-processes" data-page-label="実行中プロセス" data-breadcrumb="Home / システム / 実行中プロセス">
              <div class="card">
                <div class="card-header">
                  <div>
                    <h2>実行中プロセス（Running Processes）</h2>
                    <p class="muted">`processes-module-requirements.md` / `processes-module-design.md` / `processes-security-checklist.md` を反映した参照専用UIサンプル。</p>
                  </div>
                  <div class="inline-actions">
                    <button class="btn btn-soft" id="procRefreshBtn">再取得</button>
                    <button class="btn btn-primary" id="procAutoBtn" data-proc-auto="off">▶ Auto-refresh (5s)</button>
                  </div>
                </div>
                <div class="controls grid-controls process-controls">
                  <label>sort_by
                    <select id="procSort">
                      <option value="cpu">cpu</option>
                      <option value="mem">mem</option>
                      <option value="pid">pid</option>
                      <option value="time">time</option>
                    </select>
                  </label>
                  <label>filter_user
                    <select id="procUser">
                      <option value="">全ユーザー</option>
                      <option value="adminui">adminui</option>
                      <option value="www-data">www-data</option>
                      <option value="postgres">postgres</option>
                      <option value="redis">redis</option>
                      <option value="root">root</option>
                    </select>
                  </label>
                  <label>min_cpu
                    <input id="procMinCpu" type="number" min="0" max="100" step="0.1" value="0">
                  </label>
                  <label>min_mem
                    <input id="procMinMem" type="number" min="0" max="100" step="0.1" value="0">
                  </label>
                  <label>limit
                    <input id="procLimit" type="number" min="1" max="1000" step="1" value="100">
                  </label>
                </div>
                <div class="chips-row">
                  <span class="chip chip-outline">クエリキー: <code>filter_user</code>（docs整合）</span>
                  <span class="chip chip-outline">権限: <code>read:processes</code></span>
                  <span class="chip chip-outline">参照専用 / v0.3以降で kill は承認前提</span>
                </div>
              </div>

              <div class="grid cols-4">
                <article class="card kpi-card"><div class="kpi-label">総プロセス数</div><div class="kpi-value" id="procKpiTotal">7</div><div class="kpi-meta">filtered result</div></article>
                <article class="card kpi-card"><div class="kpi-label">CPU合計</div><div class="kpi-value" id="procKpiCpu">29.3%</div><div class="progress"><div class="progress-fill coral" id="procCpuBar" style="width:29.3%"></div></div><div class="kpi-meta">top: postgres</div></article>
                <article class="card kpi-card"><div class="kpi-label">Memory合計</div><div class="kpi-value" id="procKpiMem">25.8%</div><div class="progress"><div class="progress-fill mint" id="procMemBar" style="width:25.8%"></div></div><div class="kpi-meta">RSS集計(概算)</div></article>
                <article class="card kpi-card"><div class="kpi-label">状態</div><div class="kpi-value" id="procKpiStates">R:1 / S:6</div><div class="kpi-meta">Z:0 / T:0</div></article>
              </div>

              <div class="grid cols-12">
                <article class="card span-8">
                  <div class="card-header"><h3>プロセス一覧</h3><div class="muted small" id="procRowsMeta">7 件表示</div></div>
                  <div class="table-wrap">
                    <table class="table table-sticky" id="procTable">
                      <thead><tr><th>PID</th><th>User</th><th>CPU%</th><th>MEM%</th><th>VSZ</th><th>RSS</th><th>STAT</th><th>START</th><th>TIME</th><th>Command</th></tr></thead>
                      <tbody>
                        <tr data-proc-row data-user="postgres" data-cpu="12.8" data-mem="18.5" data-pid="1008"><td class="mono">1008</td><td>postgres</td><td data-proc-cpu>12.8</td><td data-proc-mem>18.5</td><td>2,890,100</td><td>1,560,240</td><td><span class="chip chip-outline mono">S</span></td><td class="mono">Feb24</td><td class="mono">01:12:11</td><td class="mono truncate-cell">/usr/lib/postgresql/16/bin/postgres -D /var/lib/postgresql/16/main</td></tr>
                        <tr data-proc-row data-user="www-data" data-cpu="7.2" data-mem="2.9" data-pid="1002"><td class="mono">1002</td><td>www-data</td><td data-proc-cpu>7.2</td><td data-proc-mem>2.9</td><td>242,500</td><td>142,120</td><td><span class="chip chip-outline mono">S</span></td><td class="mono">09:20</td><td class="mono">00:15:03</td><td class="mono truncate-cell">nginx: worker process</td></tr>
                        <tr data-proc-row data-user="adminui" data-cpu="4.6" data-mem="1.8" data-pid="1004"><td class="mono">1004</td><td>adminui</td><td data-proc-cpu>4.6</td><td data-proc-mem>1.8</td><td>398,120</td><td>248,320</td><td><span class="chip chip-outline mono">S</span></td><td class="mono">08:12</td><td class="mono">00:55:22</td><td class="mono truncate-cell">python3 -m uvicorn backend.main:app --port 5012</td></tr>
                        <tr data-proc-row data-user="redis" data-cpu="2.1" data-mem="1.1" data-pid="1003"><td class="mono">1003</td><td>redis</td><td data-proc-cpu>2.1</td><td data-proc-mem>1.1</td><td>130,212</td><td>98,212</td><td><span class="chip chip-outline mono">S</span></td><td class="mono">Feb23</td><td class="mono">02:01:45</td><td class="mono truncate-cell">/usr/bin/redis-server 127.0.0.1:6379</td></tr>
                        <tr data-proc-row data-user="adminui" data-cpu="1.3" data-mem="0.8" data-pid="1010"><td class="mono">1010</td><td>adminui</td><td data-proc-cpu>1.3</td><td data-proc-mem>0.8</td><td>220,420</td><td>114,220</td><td><span class="chip chip-outline mono">S</span></td><td class="mono">09:55</td><td class="mono">00:08:02</td><td class="mono truncate-cell">python3 scheduler.py --poll approval</td></tr>
                        <tr data-proc-row data-user="root" data-cpu="0.4" data-mem="0.2" data-pid="1006"><td class="mono">1006</td><td>root</td><td data-proc-cpu>0.4</td><td data-proc-mem>0.2</td><td>22,012</td><td>12,004</td><td><span class="chip chip-outline mono">Ss</span></td><td class="mono">Feb22</td><td class="mono">00:01:11</td><td class="mono truncate-cell">/sbin/agetty tty1 linux</td></tr>
                        <tr data-proc-row data-user="www-data" data-cpu="0.9" data-mem="0.5" data-pid="1012"><td class="mono">1012</td><td>www-data</td><td data-proc-cpu>0.9</td><td data-proc-mem>0.5</td><td>210,000</td><td>73,120</td><td><span class="chip chip-outline mono">S</span></td><td class="mono">09:59</td><td class="mono">00:05:41</td><td class="mono truncate-cell">nginx: worker process</td></tr>
                      </tbody>
                    </table>
                  </div>
                </article>

                <article class="card span-4">
                  <div class="card-header"><h3>プロセス詳細</h3><div class="muted small">PROC-002</div></div>
                  <div class="detail-card" id="procDetailCard">
                    <div class="detail-title-row"><div><h4 id="procDetailName">postgres</h4><div class="muted small mono" id="procDetailId">1008 / postgres</div></div><span class="chip chip-outline mono" id="procDetailStat">S</span></div>
                    <div class="kv-grid">
                      <div><span>CPU%</span><strong id="procDetailCpu">12.8</strong></div>
                      <div><span>MEM%</span><strong id="procDetailMem">18.5</strong></div>
                      <div><span>PPID</span><strong>1</strong></div>
                      <div><span>Threads</span><strong>1</strong></div>
                      <div><span>Open Files</span><strong>28</strong></div>
                      <div><span>Connections</span><strong>0</strong></div>
                    </div>
                    <div class="detail-block"><div class="detail-label">状態説明</div><div id="procDetailStateText">Sleeping</div></div>
                    <div class="detail-block"><div class="detail-label">CWD</div><code id="procDetailCwd">/var/lib/postgresql</code></div>
                    <div class="detail-block"><div class="detail-label">Command</div><code id="procDetailCmd">/usr/lib/postgresql/16/bin/postgres -D /var/lib/postgresql/16/main</code></div>
                    <div class="inline-note"><span class="note-chip">整合性</span><span>フィールド名は wrapper/API 仕様に合わせて `stat/start/rss` を表示。</span></div>
                  </div>
                </article>
              </div>
            </section>

            <section class="module-section" id="sec-cron" data-page-label="Cronジョブ" data-breadcrumb="Home / システム / Cronジョブ">
              <div class="card banner-card">
                <div class="banner-icon">⏱️</div>
                <div>
                  <h2>Cron Jobs 管理（承認フロー統合）</h2>
                  <p>`cron-jobs-design.md` / `cron-allowlist-policy.md` 準拠。追加・削除・有効/無効切替は承認リクエストとして作成します。</p>
                </div>
                <div class="hero-actions">
                  <button class="btn btn-primary" data-open-modal="cron-add">+ Add Cron Job</button>
                  <button class="btn btn-soft" data-scroll-target="sec-approvals">承認センター</button>
                </div>
              </div>

              <div class="grid cols-4">
                <article class="card kpi-card"><div class="kpi-label">Jobs / User</div><div class="kpi-value">3 / 10</div><div class="progress"><div class="progress-fill" style="width:30%"></div></div><div class="kpi-meta">最大10件/ユーザー</div></article>
                <article class="card kpi-card"><div class="kpi-label">最小実行間隔</div><div class="kpi-value">5分</div><div class="kpi-meta">`* * * * *` は拒否</div></article>
                <article class="card kpi-card"><div class="kpi-label">allowlistコマンド</div><div class="kpi-value">9</div><div class="kpi-meta">LOW/MEDIUM/HIGH分類</div></article>
                <article class="card kpi-card"><div class="kpi-label">System Pending上限</div><div class="kpi-value">50</div><div class="kpi-meta">設計値</div></article>
              </div>

              <div class="grid cols-12">
                <article class="card span-7">
                  <div class="card-header"><h3>Cronジョブ一覧</h3><div class="chips-row"><span class="chip chip-outline">GET /api/cron</span><span class="chip chip-outline">max_allowed: 10</span></div></div>
                  <table class="table">
                    <thead><tr><th>ID</th><th>Owner</th><th>Schedule</th><th>Command</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody>
                      <tr data-cron-id="cron_001">
                        <td class="mono">cron_001</td><td>adminui</td>
                        <td><div class="mono">0 2 * * *</div><div class="muted small">Every day at 2:00</div></td>
                        <td><div class="mono">/usr/bin/rsync</div><div class="muted small truncate-cell">-avz /data /backup/data</div></td>
                        <td><span class="chip chip-success" data-cron-status>Active</span></td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-cron-toggle="cron_001">[T]</button><button class="btn btn-mini btn-danger-soft" data-open-modal="cron-delete" data-cron-id="cron_001">[D]</button></div></td>
                      </tr>
                      <tr data-cron-id="cron_002">
                        <td class="mono">cron_002</td><td>adminui</td>
                        <td><div class="mono">*/10 * * * *</div><div class="muted small">Every 10 minutes</div></td>
                        <td><div class="mono">/usr/local/bin/healthcheck.sh</div><div class="muted small truncate-cell">-</div></td>
                        <td><span class="chip chip-success" data-cron-status>Active</span></td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-cron-toggle="cron_002">[T]</button><button class="btn btn-mini btn-danger-soft" data-open-modal="cron-delete" data-cron-id="cron_002">[D]</button></div></td>
                      </tr>
                      <tr data-cron-id="cron_003">
                        <td class="mono">cron_003</td><td>deploy</td>
                        <td><div class="mono">0 0 1 * *</div><div class="muted small">First day of month</div></td>
                        <td><div class="mono">/usr/bin/tar</div><div class="muted small truncate-cell">-czf /backup/monthly/app.tar.gz /opt/app/releases</div></td>
                        <td><span class="chip chip-muted" data-cron-status>Disabled</span></td>
                        <td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-cron-toggle="cron_003">[T]</button><button class="btn btn-mini btn-danger-soft" data-open-modal="cron-delete" data-cron-id="cron_003">[D]</button></div></td>
                      </tr>
                    </tbody>
                  </table>
                  <div class="legend-row muted small">[T] = Toggle（有効/無効切替申請） / [D] = Delete（削除申請）</div>
                </article>

                <article class="card span-5">
                  <div class="card-header"><h3>プリセット / セキュリティルール</h3></div>
                  <div class="stack-split">
                    <div>
                      <div class="subhead">Preset</div>
                      <table class="table compact">
                        <thead><tr><th>プリセット</th><th>Cron式</th><th>説明</th></tr></thead>
                        <tbody>
                          <tr><td>Every 5 minutes</td><td class="mono">*/5 * * * *</td><td>5分ごと</td></tr>
                          <tr><td>Every hour</td><td class="mono">0 * * * *</td><td>毎時0分</td></tr>
                          <tr><td>Every day at 2:00</td><td class="mono">0 2 * * *</td><td>毎日2:00</td></tr>
                          <tr><td>Every Monday at 3:00</td><td class="mono">0 3 * * 1</td><td>毎週月曜3:00</td></tr>
                          <tr><td>First day of month</td><td class="mono">0 0 1 * *</td><td>毎月1日0:00</td></tr>
                        </tbody>
                      </table>
                    </div>
                    <div>
                      <div class="subhead">主な拒否条件</div>
                      <ul class="plain-list">
                        <li>allowlist外コマンドは拒否（`COMMAND_NOT_ALLOWED`）</li>
                        <li>毎分実行禁止（最小間隔 5分）</li>
                        <li>引数内の禁止文字 `; | & $ ( )` 等を拒否</li>
                        <li>root など禁止ユーザーの cron 操作を拒否</li>
                        <li>機密情報パターン検出時は承認画面に警告表示</li>
                      </ul>
                    </div>
                  </div>
                </article>
              </div>

              <article class="card">
                <div class="card-header"><h3>コマンド allowlist カタログ（抜粋）</h3></div>
                <div class="command-grid">
                  <div class="command-card"><div class="command-card-head"><code>/usr/bin/rsync</code><span class="chip chip-risk chip-low">LOW</span></div><p>ファイル同期・バックアップ</p><div class="rule-list"><div class="rule-item"><span>forbidden</span><code>--delete, -e</code></div><div class="rule-item"><span>max args</span><code>20</code></div></div></div>
                  <div class="command-card"><div class="command-card-head"><code>/usr/bin/find</code><span class="chip chip-risk chip-medium">MEDIUM</span></div><p>ファイル検索・クリーンアップ</p><div class="rule-list"><div class="rule-item"><span>forbidden</span><code>-exec, -delete</code></div><div class="rule-item"><span>max args</span><code>15</code></div></div></div>
                  <div class="command-card"><div class="command-card-head"><code>/usr/bin/python3</code><span class="chip chip-risk chip-high">HIGH</span></div><p>承認済みスクリプト実行</p><div class="rule-list"><div class="rule-item"><span>forbidden</span><code>-c, -m</code></div><div class="rule-item"><span>allowed path</span><code>/opt/adminui/scripts/</code></div></div></div>
                </div>
              </article>
            </section>

            <section class="module-section" id="sec-users" data-page-label="ユーザー・グループ" data-breadcrumb="Home / システム / ユーザー・グループ">
              <div class="card">
                <div class="card-header">
                  <div>
                    <h2>Users & Groups Management</h2>
                    <p class="muted">`users-groups-design.md` / `users-groups-allowlist-policy.md` / `users-groups-threat-analysis.md` 準拠。Write操作は承認リクエストとして作成。</p>
                  </div>
                  <div class="inline-actions">
                    <button class="btn btn-primary" data-open-modal="user-add">+ Add User (Approval)</button>
                    <button class="btn btn-soft" data-scroll-target="sec-approvals">承認センター</button>
                  </div>
                </div>
                <div class="tabs" role="tablist" aria-label="Users tabs">
                  <button class="tab active" data-tab-group="users" data-tab-id="users-list" role="tab" aria-selected="true">Users</button>
                  <button class="tab" data-tab-group="users" data-tab-id="groups-list" role="tab" aria-selected="false">Groups</button>
                </div>
                <div class="controls grid-controls">
                  <label class="grow">Search <input id="usersSearch" type="search" placeholder="kensan, /home, /bin/bash..."></label>
                  <label>Status
                    <select id="usersStatus">
                      <option value="all">All</option>
                      <option value="active">Active</option>
                      <option value="locked">Locked</option>
                    </select>
                  </label>
                  <label class="grow">Group Search <input id="groupsSearch" type="search" placeholder="developers, ops..."></label>
                </div>
              </div>

              <div class="grid cols-12">
                <article class="card span-8 tab-panel active" data-tab-panel="users-list">
                  <div class="card-header"><h3>Users</h3><div class="muted small">UID >= 1000 のみ表示</div></div>
                  <table class="table" id="usersTable">
                    <thead><tr><th>Username</th><th>UID</th><th>Groups</th><th>Home</th><th>Shell</th><th>Status</th><th>Last Login</th><th>Action</th></tr></thead>
                    <tbody>
                      <tr data-user-row data-user-name="kensan" data-user-status="active" data-user-groups="users developers"><td><strong>kensan</strong></td><td class="mono">1000</td><td><span class="chip chip-outline">users</span> <span class="chip chip-outline">developers</span></td><td class="mono">/home/kensan</td><td class="mono">/bin/bash</td><td><span class="chip chip-success">Active</span></td><td>02/24 12:10:00</td><td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-quick-approval="user_passwd" data-target-name="kensan">PW変更申請</button><button class="btn btn-mini btn-danger-soft" data-quick-approval="user_delete" data-target-name="kensan">削除申請</button></div></td></tr>
                      <tr data-user-row data-user-name="deploy" data-user-status="active" data-user-groups="users ops"><td><strong>deploy</strong></td><td class="mono">1001</td><td><span class="chip chip-outline">users</span> <span class="chip chip-outline">ops</span></td><td class="mono">/home/deploy</td><td class="mono">/usr/sbin/nologin</td><td><span class="chip chip-success">Active</span></td><td>02/24 16:03:00</td><td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-quick-approval="user_passwd" data-target-name="deploy">PW変更申請</button><button class="btn btn-mini btn-danger-soft" data-quick-approval="user_delete" data-target-name="deploy">削除申請</button></div></td></tr>
                      <tr data-user-row data-user-name="batchapp" data-user-status="active" data-user-groups="users analytics"><td><strong>batchapp</strong></td><td class="mono">1002</td><td><span class="chip chip-outline">users</span> <span class="chip chip-outline">analytics</span></td><td class="mono">/home/batchapp</td><td class="mono">/bin/bash</td><td><span class="chip chip-success">Active</span></td><td>02/23 18:30:00</td><td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-quick-approval="user_passwd" data-target-name="batchapp">PW変更申請</button><button class="btn btn-mini btn-danger-soft" data-quick-approval="user_delete" data-target-name="batchapp">削除申請</button></div></td></tr>
                      <tr data-user-row data-user-name="tempstaff" data-user-status="locked" data-user-groups="users"><td><strong>tempstaff</strong></td><td class="mono">1003</td><td><span class="chip chip-outline">users</span></td><td class="mono">/home/tempstaff</td><td class="mono">/bin/false</td><td><span class="chip chip-muted">Locked</span></td><td>02/21 10:01:00</td><td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-quick-approval="user_passwd" data-target-name="tempstaff">PW変更申請</button><button class="btn btn-mini btn-danger-soft" data-quick-approval="user_delete" data-target-name="tempstaff">削除申請</button></div></td></tr>
                    </tbody>
                  </table>
                </article>

                <article class="card span-8 tab-panel" data-tab-panel="groups-list">
                  <div class="card-header"><h3>Groups</h3><div class="muted small">GID >= 1000 のみ表示</div></div>
                  <table class="table" id="groupsTable">
                    <thead><tr><th>Group</th><th>GID</th><th>Members</th><th>Risk</th><th>Action</th></tr></thead>
                    <tbody>
                      <tr data-group-row data-group-name="users"><td><strong>users</strong></td><td class="mono">1000</td><td><span class="chip chip-outline">kensan</span> <span class="chip chip-outline">deploy</span> <span class="chip chip-outline">batchapp</span> <span class="chip chip-outline">tempstaff</span></td><td><span class="chip chip-risk chip-low">LOW</span></td><td><button class="btn btn-mini btn-soft" data-quick-approval="group_modify" data-target-name="users">メンバー変更申請</button></td></tr>
                      <tr data-group-row data-group-name="developers"><td><strong>developers</strong></td><td class="mono">1001</td><td><span class="chip chip-outline">kensan</span></td><td><span class="chip chip-risk chip-medium">MEDIUM</span></td><td><button class="btn btn-mini btn-soft" data-quick-approval="group_modify" data-target-name="developers">メンバー変更申請</button></td></tr>
                      <tr data-group-row data-group-name="ops"><td><strong>ops</strong></td><td class="mono">1002</td><td><span class="chip chip-outline">deploy</span></td><td><span class="chip chip-risk chip-medium">MEDIUM</span></td><td><button class="btn btn-mini btn-soft" data-quick-approval="group_modify" data-target-name="ops">メンバー変更申請</button></td></tr>
                      <tr data-group-row data-group-name="legacyops"><td><strong>legacyops</strong></td><td class="mono">1012</td><td><span class="muted">No members</span></td><td><span class="chip chip-risk chip-high">HIGH</span></td><td><button class="btn btn-mini btn-danger-soft" data-quick-approval="group_delete" data-target-name="legacyops">削除申請</button></td></tr>
                    </tbody>
                  </table>
                </article>

                <aside class="card span-4">
                  <div class="card-header"><h3>入力・権限・承認ルール</h3></div>
                  <div class="stack-tight">
                    <div class="subpanel">
                      <h4>Username / Group Pattern</h4>
                      <code>^[a-z_][a-z0-9_-]{0,31}$</code>
                      <p class="muted small">Frontend / API(Pydantic) / Wrapper の多重検証。</p>
                    </div>
                    <div class="subpanel">
                      <h4>禁止グループ（抜粋）</h4>
                      <div class="chips-row">
                        <span class="chip chip-danger">root</span><span class="chip chip-danger">sudo</span><span class="chip chip-danger">wheel</span><span class="chip chip-danger">docker</span><span class="chip chip-danger">lxd</span><span class="chip chip-danger">shadow</span>
                      </div>
                      <p class="muted small">Privilege Escalation 対策。変更には人間承認。</p>
                    </div>
                    <div class="subpanel">
                      <h4>Allowed Shells</h4>
                      <ul class="plain-list mono">
                        <li>/bin/bash</li><li>/bin/sh</li><li>/usr/bin/zsh</li><li>/usr/sbin/nologin</li><li>/bin/false</li>
                      </ul>
                    </div>
                    <div class="subpanel">
                      <h4>Rate Limits（抜粋）</h4>
                      <div class="rule-list">
                        <div class="rule-item"><span>GET /api/users</span><code>30/min</code></div>
                        <div class="rule-item"><span>POST /api/users</span><code>5/min</code></div>
                        <div class="rule-item"><span>DELETE /api/users/{uid}</span><code>3/min</code></div>
                        <div class="rule-item"><span>pending_requests_per_user</span><code>10</code></div>
                      </div>
                    </div>
                  </div>
                </aside>
              </div>
            </section>

            <section class="module-section" id="sec-approvals" data-page-label="承認センター" data-breadcrumb="Home / 承認センター">
              <div class="card">
                <div class="card-header">
                  <div>
                    <h2>承認センター（Approval Workflow）</h2>
                    <p class="muted">`approval-workflow-design.md` / `approval-api-spec.md` / `database/approval-schema.sql` 準拠。状態遷移・自己承認禁止・HMAC履歴を表示。</p>
                  </div>
                  <div class="chips-row">
                    <span class="chip chip-outline">自己承認禁止</span>
                    <span class="chip chip-outline">HMAC署名履歴</span>
                    <span class="chip chip-outline">Admin: history/export/stats</span>
                  </div>
                </div>
                <div class="tabs" role="tablist" aria-label="Approvals tabs">
                  <button class="tab active" data-tab-group="approvals" data-tab-id="ap-pending">承認待ち</button>
                  <button class="tab" data-tab-group="approvals" data-tab-id="ap-my">自分の申請</button>
                  <button class="tab" data-tab-group="approvals" data-tab-id="ap-create">承認リクエスト</button>
                  <button class="tab" data-tab-group="approvals" data-tab-id="ap-history">承認履歴</button>
                  <button class="tab" data-tab-group="approvals" data-tab-id="ap-policies">承認ポリシー</button>
                  <button class="tab" data-tab-group="approvals" data-tab-id="ap-stats">統計</button>
                </div>
              </div>

              <div class="grid cols-12">
                <article class="card span-8 tab-panel active" data-tab-panel="ap-pending">
                  <div class="card-header"><h3>承認待ち一覧</h3><div class="muted small">Approver/Admin 向け</div></div>
                  <div class="controls grid-controls">
                    <label>種別
                      <select id="approvalPendingType">
                        <option value="all">全種別</option>
                        <option value="user_add">user_add</option>
                        <option value="cron_add">cron_add</option>
                      </select>
                    </label>
                    <label>申請者
                      <select id="approvalPendingRequester">
                        <option value="all">全申請者</option>
                        <option value="operator">operator</option>
                      </select>
                    </label>
                    <div class="inline-note grow"><span class="note-chip">制約</span><span>Approver/Adminのみ閲覧。自己承認は禁止。</span></div>
                  </div>
                  <table class="table" id="approvalPendingTable">
                    <thead><tr><th>ID</th><th>種別</th><th>申請者</th><th>リスク</th><th>理由</th><th>期限</th><th>状態</th><th>操作</th></tr></thead>
                    <tbody>
                      <tr data-approval-row data-approval-id="apr-1001" data-approval-type="user_add" data-approval-requester="operator" data-approval-status="pending"><td class="mono">apr-1001</td><td>ユーザーアカウント追加</td><td>operator</td><td><span class="chip chip-risk chip-high">HIGH</span></td><td>新規プロジェクトメンバーのアカウント作成</td><td>23.0h 残</td><td><span class="chip chip-warning approval-status-chip">pending</span></td><td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-approval-select="apr-1001">詳細</button><button class="btn btn-mini btn-success-soft" data-open-modal="approval-action" data-approval-op="approve" data-approval-id="apr-1001">承認</button><button class="btn btn-mini btn-danger-soft" data-open-modal="approval-action" data-approval-op="reject" data-approval-id="apr-1001">拒否</button></div></td></tr>
                      <tr data-approval-row data-approval-id="apr-1002" data-approval-type="cron_add" data-approval-requester="operator" data-approval-status="pending"><td class="mono">apr-1002</td><td>Cronジョブ追加</td><td>operator</td><td><span class="chip chip-risk chip-high">HIGH</span></td><td>夜間バックアップジョブの追加</td><td>21.0h 残</td><td><span class="chip chip-warning approval-status-chip">pending</span></td><td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-approval-select="apr-1002">詳細</button><button class="btn btn-mini btn-success-soft" data-open-modal="approval-action" data-approval-op="approve" data-approval-id="apr-1002">承認</button><button class="btn btn-mini btn-danger-soft" data-open-modal="approval-action" data-approval-op="reject" data-approval-id="apr-1002">拒否</button></div></td></tr>
                    </tbody>
                  </table>
                </article>

                <article class="card span-8 tab-panel" data-tab-panel="ap-my">
                  <div class="card-header"><h3>自分の申請一覧</h3><div class="muted small">GET /api/approval/my-requests</div></div>
                  <div class="controls grid-controls">
                    <label>ステータス
                      <select id="approvalMyStatus">
                        <option value="all">全て</option>
                        <option value="pending">pending</option>
                        <option value="approved">approved</option>
                        <option value="rejected">rejected</option>
                        <option value="executed">executed</option>
                        <option value="expired">expired</option>
                      </select>
                    </label>
                  </div>
                  <table class="table" id="approvalMyTable">
                    <thead><tr><th>ID</th><th>種別</th><th>状態</th><th>理由</th><th>作成</th><th>操作</th></tr></thead>
                    <tbody>
                      <tr data-my-approval-row data-approval-status="pending"><td class="mono">apr-1001</td><td>user_add</td><td><span class="chip chip-warning">pending</span></td><td>新規プロジェクトメンバーのアカウント作成</td><td>02/24 17:00</td><td><button class="btn btn-mini btn-danger-soft" data-open-modal="approval-action" data-approval-op="cancel" data-approval-id="apr-1001">キャンセル</button></td></tr>
                      <tr data-my-approval-row data-approval-status="pending"><td class="mono">apr-1002</td><td>cron_add</td><td><span class="chip chip-warning">pending</span></td><td>夜間バックアップジョブの追加</td><td>02/24 15:00</td><td><button class="btn btn-mini btn-danger-soft" data-open-modal="approval-action" data-approval-op="cancel" data-approval-id="apr-1002">キャンセル</button></td></tr>
                      <tr data-my-approval-row data-approval-status="rejected"><td class="mono">apr-1004</td><td>group_delete</td><td><span class="chip chip-danger">rejected</span></td><td>legacyops を削除</td><td>02/23 12:00</td><td><button class="btn btn-mini btn-soft" data-approval-select="apr-1004">詳細</button></td></tr>
                    </tbody>
                  </table>
                </article>

                <article class="card span-8 tab-panel" data-tab-panel="ap-create">
                  <div class="card-header"><h3>承認リクエスト作成</h3></div>
                  <form class="form-grid" id="approvalDraftForm" data-form="approval-draft">
                    <label><span>操作種別</span>
                      <select id="approvalDraftType">
                        <option value="user_add">ユーザーアカウント追加 (user_add)</option>
                        <option value="user_delete">ユーザーアカウント削除 (user_delete)</option>
                        <option value="group_add">グループ追加 (group_add)</option>
                        <option value="cron_add">Cronジョブ追加 (cron_add)</option>
                        <option value="cron_modify">Cronジョブ変更 (cron_modify)</option>
                        <option value="service_stop">サービス停止 (service_stop)</option>
                        <option value="firewall_modify">ファイアウォール変更 (firewall_modify)</option>
                      </select>
                    </label>
                    <div class="subpanel span-2">
                      <h4>操作パラメータ（サンプル）</h4>
                      <div class="form-grid compact-form" id="approvalDraftFields">
                        <label><span>username</span><input type="text" data-approval-field="username" value="newuser"></label>
                        <label><span>group</span><input type="text" data-approval-field="group" value="developers"></label>
                        <label><span>home</span><input type="text" data-approval-field="home" value="/home/newuser"></label>
                        <label><span>shell</span><input type="text" data-approval-field="shell" value="/bin/bash"></label>
                      </div>
                    </div>
                    <label class="span-2"><span>申請理由（1-1000文字）</span><textarea id="approvalDraftReason" rows="4">新規運用作業のため承認を依頼します。</textarea></label>
                    <div class="subpanel span-2">
                      <h4>プレビュー</h4>
                      <div class="preview-grid">
                        <div><span>request_type</span><code id="approvalPreviewType">user_add</code></div>
                        <div><span>risk_level</span><span id="approvalPreviewRisk" class="chip chip-risk chip-high">HIGH</span></div>
                        <div><span>approver_roles</span><code id="approvalPreviewRoles">Approver, Admin</code></div>
                        <div><span>timeout</span><code id="approvalPreviewTimeout">24h</code></div>
                        <div class="span-2"><span>payload</span><pre id="approvalPreviewPayload">{"username":"newuser","group":"developers","home":"/home/newuser","shell":"/bin/bash"}</pre></div>
                      </div>
                    </div>
                    <div class="form-actions span-2">
                      <button class="btn btn-soft" type="button" data-approval-draft-reset>テンプレート再読込</button>
                      <button class="btn btn-primary" type="submit">承認リクエスト送信</button>
                    </div>
                  </form>
                </article>

                <article class="card span-8 tab-panel" data-tab-panel="ap-history">
                  <div class="card-header"><h3>承認履歴</h3><div class="inline-actions"><button class="btn btn-mini btn-soft" data-export="csv">CSV Export</button><button class="btn btn-mini btn-soft" data-export="json">JSON Export</button></div></div>
                  <div class="controls grid-controls">
                    <label>集計期間
                      <select id="approvalPeriod"><option value="7d">7d</option><option value="30d" selected>30d</option><option value="90d">90d</option><option value="365d">365d</option></select>
                    </label>
                    <label>結果
                      <select id="approvalHistoryStatus"><option value="all">全結果</option><option value="approved">approved</option><option value="rejected">rejected</option><option value="executed">executed</option><option value="expired">expired</option></select>
                    </label>
                  </div>
                  <table class="table" id="approvalHistoryTable">
                    <thead><tr><th>日時</th><th>種別</th><th>申請者</th><th>承認者</th><th>結果</th><th>操作</th></tr></thead>
                    <tbody>
                      <tr data-history-row data-history-status="approved"><td>02/24 10:00</td><td>service_stop</td><td>approver1</td><td>admin</td><td><span class="chip chip-success">approved</span></td><td><button class="btn btn-mini btn-soft" data-approval-select="apr-1003">詳細</button></td></tr>
                      <tr data-history-row data-history-status="rejected"><td>02/23 12:00</td><td>group_delete</td><td>operator</td><td>admin</td><td><span class="chip chip-danger">rejected</span></td><td><button class="btn btn-mini btn-soft" data-approval-select="apr-1004">詳細</button></td></tr>
                      <tr data-history-row data-history-status="executed"><td>02/22 20:00</td><td>cron_modify</td><td>operator2</td><td>approver1</td><td><span class="chip chip-success">executed</span></td><td><button class="btn btn-mini btn-soft" data-approval-select="apr-1005">詳細</button></td></tr>
                      <tr data-history-row data-history-status="expired"><td>02/21 08:00</td><td>firewall_modify</td><td>operator</td><td>-</td><td><span class="chip chip-muted">expired</span></td><td><button class="btn btn-mini btn-soft" data-approval-select="apr-1006">詳細</button></td></tr>
                    </tbody>
                  </table>
                </article>

                <article class="card span-8 tab-panel" data-tab-panel="ap-policies">
                  <div class="card-header"><h3>承認ポリシー一覧</h3><div class="muted small">GET /api/approval/policies</div></div>
                  <table class="table compact">
                    <thead><tr><th>operation_type</th><th>説明</th><th>Risk</th><th>Approver</th><th>Timeout</th></tr></thead>
                    <tbody>
                      <tr><td class="mono">user_add</td><td>ユーザーアカウント追加</td><td><span class="chip chip-risk chip-high">HIGH</span></td><td><span class="chip chip-outline">Approver</span> <span class="chip chip-outline">Admin</span></td><td>24h</td></tr>
                      <tr><td class="mono">user_delete</td><td>ユーザーアカウント削除</td><td><span class="chip chip-risk chip-critical">CRITICAL</span></td><td><span class="chip chip-outline">Admin</span></td><td>12h</td></tr>
                      <tr><td class="mono">cron_add</td><td>Cronジョブ追加</td><td><span class="chip chip-risk chip-high">HIGH</span></td><td><span class="chip chip-outline">Approver</span> <span class="chip chip-outline">Admin</span></td><td>24h</td></tr>
                      <tr><td class="mono">service_stop</td><td>サービス停止</td><td><span class="chip chip-risk chip-critical">CRITICAL</span></td><td><span class="chip chip-outline">Admin</span></td><td>12h</td></tr>
                    </tbody>
                  </table>
                </article>

                <article class="card span-8 tab-panel" data-tab-panel="ap-stats">
                  <div class="card-header"><h3>承認統計（30d）</h3><div class="muted small">GET /api/approval/stats / Admin only</div></div>
                  <div class="metric-grid">
                    <div class="metric-tile"><div class="metric-title">総リクエスト</div><div class="metric-big">45</div></div>
                    <div class="metric-tile"><div class="metric-title">Pending</div><div class="metric-big">5</div></div>
                    <div class="metric-tile"><div class="metric-title">Approval Rate</div><div class="metric-big">75.8%</div></div>
                    <div class="metric-tile"><div class="metric-title">平均承認時間</div><div class="metric-big">4.2h</div></div>
                  </div>
                  <div class="bar-panels">
                    <div class="subpanel">
                      <h4>by_type</h4>
                      <div class="bar-line"><div class="bar-line-top"><span>user_add</span><strong>15</strong></div><div class="progress"><div class="progress-fill" style="width:100%"></div></div></div>
                      <div class="bar-line"><div class="bar-line-top"><span>cron_add</span><strong>10</strong></div><div class="progress"><div class="progress-fill" style="width:66%"></div></div></div>
                      <div class="bar-line"><div class="bar-line-top"><span>cron_modify</span><strong>8</strong></div><div class="progress"><div class="progress-fill" style="width:53%"></div></div></div>
                      <div class="bar-line"><div class="bar-line-top"><span>service_stop</span><strong>7</strong></div><div class="progress"><div class="progress-fill" style="width:46%"></div></div></div>
                    </div>
                    <div class="subpanel">
                      <h4>by_risk_level</h4>
                      <div class="bar-line"><div class="bar-line-top"><span>HIGH</span><strong>30</strong></div><div class="progress"><div class="progress-fill" style="width:100%"></div></div></div>
                      <div class="bar-line"><div class="bar-line-top"><span>MEDIUM</span><strong>10</strong></div><div class="progress"><div class="progress-fill" style="width:33%"></div></div></div>
                      <div class="bar-line"><div class="bar-line-top"><span>CRITICAL</span><strong>5</strong></div><div class="progress"><div class="progress-fill" style="width:16%"></div></div></div>
                    </div>
                  </div>
                </article>

                <aside class="card span-4">
                  <div class="card-header"><h3>承認詳細</h3><div class="muted small">GET /api/approval/{id}</div></div>
                  <div class="detail-card" id="approvalDetailCard">
                    <div class="detail-title-row"><div><h4 id="approvalDetailTitle">ユーザーアカウント追加</h4><div class="muted small mono" id="approvalDetailId">apr-1001</div></div><span id="approvalDetailStatus" class="chip chip-warning">pending</span></div>
                    <div class="chips-row"><span id="approvalDetailRisk" class="chip chip-risk chip-high">HIGH</span><span class="chip chip-outline" id="approvalDetailRequesterRole">Operator</span><span class="chip chip-outline">signature_valid: true</span></div>
                    <div class="detail-block"><div class="detail-label">申請者</div><div id="approvalDetailRequester">operator (user_002)</div></div>
                    <div class="detail-block"><div class="detail-label">申請理由</div><div id="approvalDetailReason">新規プロジェクトメンバーのアカウント作成</div></div>
                    <div class="detail-block"><div class="detail-label">Payload</div><pre id="approvalDetailPayload">{"username":"newuser","group":"developers","home":"/home/newuser","shell":"/bin/bash"}</pre></div>
                    <div class="detail-block"><div class="detail-label">履歴（approval_history / HMAC）</div>
                      <div class="timeline compact" id="approvalDetailTimeline">
                        <div class="timeline-item"><div class="timeline-dot info"></div><div><div class="timeline-title">created / operator (Operator)</div><div class="timeline-text">02/24 17:00:00</div></div></div>
                      </div>
                    </div>
                  </div>
                </aside>
              </div>
            </section>

            <section class="module-section" id="sec-logs" data-page-label="システムログ" data-breadcrumb="Home / システムログ / システムログ">
              <div class="card">
                <div class="card-header">
                  <h2>システムログ閲覧（journalctl相当）</h2>
                  <div class="chips-row">
                    <span class="chip chip-outline">権限: <code>read:logs</code></span>
                    <span class="chip chip-outline">lines: 1..1000</span>
                    <span class="chip chip-outline">service_name regex</span>
                  </div>
                </div>
                <div class="controls grid-controls">
                  <label>サービス
                    <select id="logsService">
                      <option value="nginx">nginx</option>
                      <option value="postgresql">postgresql</option>
                      <option value="redis">redis</option>
                      <option value="linux-management-prod">linux-management-prod</option>
                      <option value="sshd">sshd</option>
                    </select>
                  </label>
                  <label>取得行数
                    <select id="logsLines">
                      <option value="50">50</option>
                      <option value="100" selected>100</option>
                      <option value="250">250</option>
                      <option value="500">500</option>
                      <option value="1000">1000</option>
                    </select>
                  </label>
                  <label class="grow">検索 <input id="logsQ" type="search" placeholder="error, denied, nginx..."></label>
                </div>
                <div class="terminal tall" id="logsTerminal">
                  <div>Feb 24 09:12:20 nginx: Reloading configuration...</div>
                  <div>Feb 24 09:12:21 nginx: Configuration reloaded</div>
                  <div>Feb 24 10:15:13 nginx: GET /api/system/status 200</div>
                </div>
              </div>
            </section>

            <section class="module-section" id="sec-audit" data-page-label="システム操作ログ" data-breadcrumb="Home / Linux管理システム / システム操作ログ">
              <div class="card">
                <div class="card-header">
                  <h2>監査ログ（System Actions Log）</h2>
                  <div class="inline-actions">
                    <button class="btn btn-soft" data-export="csv">CSV Export</button>
                    <button class="btn btn-soft" data-export="json">JSON Export</button>
                  </div>
                </div>
                <div class="inline-note"><span class="note-chip">Audit</span><span>誰が・いつ・何を・結果（attempt/success/denied/failure）を記録。承認系は `approval_id` と紐付け。</span></div>
                <div class="controls grid-controls">
                  <label>Operation
                    <select id="auditOp">
                      <option value="all">all</option>
                      <option value="login">login</option>
                      <option value="system_status_view">system_status_view</option>
                      <option value="process_list">process_list</option>
                      <option value="service_restart">service_restart</option>
                      <option value="user_add_request">user_add_request</option>
                      <option value="approval_execute">approval_execute</option>
                    </select>
                  </label>
                  <label>Status
                    <select id="auditStatus">
                      <option value="all">all</option>
                      <option value="attempt">attempt</option>
                      <option value="success">success</option>
                      <option value="denied">denied</option>
                      <option value="failure">failure</option>
                      <option value="pending">pending</option>
                    </select>
                  </label>
                  <label class="grow">Search <input id="auditQ" type="search" placeholder="nginx, approval, denied..."></label>
                </div>
                <table class="table compact" id="auditTable">
                  <thead><tr><th>Timestamp</th><th>Operation</th><th>User</th><th>Role</th><th>Target</th><th>Status</th><th>Details</th></tr></thead>
                  <tbody>
                    <tr data-audit-row data-op="login" data-status="success"><td>02/24 17:20:00</td><td class="mono">login</td><td>admin</td><td><span class="chip chip-outline">Admin</span></td><td>session</td><td><span class="chip chip-success">success</span></td><td class="mono small">{"ip":"10.0.2.15"}</td></tr>
                    <tr data-audit-row data-op="system_status_view" data-status="success"><td>02/24 17:25:00</td><td class="mono">system_status_view</td><td>admin</td><td><span class="chip chip-outline">Admin</span></td><td>system</td><td><span class="chip chip-success">success</span></td><td class="mono small">{"module":"dashboard"}</td></tr>
                    <tr data-audit-row data-op="process_list" data-status="success"><td>02/24 17:28:00</td><td class="mono">process_list</td><td>admin</td><td><span class="chip chip-outline">Admin</span></td><td>system</td><td><span class="chip chip-success">success</span></td><td class="mono small">{"sort_by":"cpu","returned":7}</td></tr>
                    <tr data-audit-row data-op="service_restart" data-status="attempt"><td>02/24 17:32:00</td><td class="mono">service_restart</td><td>operator</td><td><span class="chip chip-outline">Operator</span></td><td>nginx</td><td><span class="chip chip-warning">attempt</span></td><td class="mono small">{"before":"active"}</td></tr>
                    <tr data-audit-row data-op="service_restart" data-status="denied"><td>02/24 17:32:01</td><td class="mono">service_restart</td><td>operator</td><td><span class="chip chip-outline">Operator</span></td><td>linux-management-prod</td><td><span class="chip chip-danger">denied</span></td><td class="mono small">{"reason":"allowlist外"}</td></tr>
                    <tr data-audit-row data-op="user_add_request" data-status="pending"><td>02/24 17:40:00</td><td class="mono">user_add_request</td><td>operator</td><td><span class="chip chip-outline">Operator</span></td><td>apr-1001</td><td><span class="chip chip-warning">pending</span></td><td class="mono small">{"request_type":"user_add"}</td></tr>
                    <tr data-audit-row data-op="approval_execute" data-status="success"><td>02/24 17:45:00</td><td class="mono">approval_execute</td><td>approver1</td><td><span class="chip chip-outline">Approver</span></td><td>apr-1005</td><td><span class="chip chip-success">success</span></td><td class="mono small">{"action":"approve"}</td></tr>
                    <tr data-audit-row data-op="injection_attempt" data-status="denied"><td>02/24 17:50:00</td><td class="mono">injection_attempt</td><td>operator</td><td><span class="chip chip-outline">Operator</span></td><td>cron.arguments</td><td><span class="chip chip-danger">denied</span></td><td class="mono small">{"detected":";"}</td></tr>
                  </tbody>
                </table>
                <div class="card-split">
                  <div class="subpanel">
                    <h4>必須フィールド（Users & Groups policy反映）</h4>
                    <ul class="plain-list mono"><li>timestamp</li><li>operation</li><li>user_id / username / role</li><li>source_ip</li><li>status</li></ul>
                  </div>
                  <div class="subpanel">
                    <h4>絶対に記録しない項目</h4>
                    <div class="chips-row"><span class="chip chip-danger">password</span><span class="chip chip-danger">password_hash</span><span class="chip chip-danger">token</span><span class="chip chip-danger">session_id</span></div>
                  </div>
                </div>
              </div>
            </section>

            <section class="module-section" id="sec-settings-security" data-page-label="セキュリティ設定" data-breadcrumb="Home / システム設定 / セキュリティ設定">
              <div class="card">
                <div class="card-header"><h2>セキュリティ設定（Policy View / Sample）</h2><div class="chips-row"><span class="chip chip-risk chip-high">HIGH</span><span class="chip chip-warning">変更は人間承認</span></div></div>
                <p class="muted">実設定の編集ではなく、docs で定義されたセキュリティ方針を確認するためのサンプル画面です。</p>
                <div class="grid cols-4">
                  <article class="card inset">
                    <div class="card-header"><h3>Global Principles</h3></div>
                    <ul class="plain-list"><li>Allowlist First</li><li>Deny by Default</li><li>shell=True 禁止 / 配列渡し</li><li>root常駐禁止 / sudo最小化</li><li>監査証跡必須</li></ul>
                  </article>
                  <article class="card inset">
                    <div class="card-header"><h3>Processes Module</h3></div>
                    <div class="rule-list"><div class="rule-item"><span>Risk</span><code>LOW</code></div><div class="rule-item"><span>Permission</span><code>read:processes</code></div><div class="rule-item"><span>PID Range</span><code>1..999999</code></div><div class="rule-item"><span>Timeout</span><code>10s</code></div></div>
                  </article>
                  <article class="card inset">
                    <div class="card-header"><h3>Users & Groups</h3></div>
                    <div class="rule-list"><div class="rule-item"><span>Pattern</span><code>^[a-z_][a-z0-9_-]{0,31}$</code></div><div class="rule-item"><span>UID/GID</span><code>1000..59999</code></div><div class="rule-item"><span>Password</span><code>8-128 + complexity</code></div><div class="rule-item"><span>Writes</span><code>approval required</code></div></div>
                  </article>
                  <article class="card inset">
                    <div class="card-header"><h3>Cron Jobs</h3></div>
                    <div class="rule-list"><div class="rule-item"><span>Allowlist Commands</span><code>9</code></div><div class="rule-item"><span>Min Interval</span><code>5 minutes</code></div><div class="rule-item"><span>Max Jobs/User</span><code>10</code></div><div class="rule-item"><span>Args Security</span><code>forbidden chars</code></div></div>
                  </article>
                </div>
              </div>
            </section>

            <section class="module-section" id="sec-settings-audit" data-page-label="監査ログ設定" data-breadcrumb="Home / システム設定 / 監査ログ設定">
              <div class="grid cols-12">
                <article class="card span-7">
                  <div class="card-header"><h2>監査ログ設定（Sample UI）</h2><button class="btn btn-primary" data-action="settings-save">設定を保存（モック）</button></div>
                  <form class="form-grid">
                    <label><span>保存期間（日）</span><input type="number" min="7" max="3650" value="365"></label>
                    <label><span>エクスポート形式</span><select><option>CSV + JSON</option><option>CSV only</option><option>JSON only</option></select></label>
                    <label><span>高リスク操作通知</span><select><option>有効（メール + Slack）</option><option>有効（メールのみ）</option><option>無効</option></select></label>
                    <label><span>HMAC署名検証バッチ</span><select><option>5分ごと</option><option>15分ごと</option><option>1時間ごと</option></select></label>
                    <label class="span-2"><span>サニタイズ除外リスト（閲覧専用）</span><textarea rows="3" readonly>password, password_hash, token, session_id</textarea></label>
                  </form>
                </article>
                <article class="card span-5">
                  <div class="card-header"><h3>運用メモ</h3></div>
                  <div class="timeline">
                    <div class="timeline-item"><div class="timeline-dot info"></div><div><div class="timeline-title">追記専用・改ざん防止</div><div class="timeline-text">approval_history は DELETE / UPDATE 禁止想定（アプリ層で強制）</div></div></div>
                    <div class="timeline-item"><div class="timeline-dot warning"></div><div><div class="timeline-title">人間承認が必要な変更</div><div class="timeline-text">保管期間短縮、通知無効化、署名検証緩和、sudoers変更</div></div></div>
                    <div class="timeline-item"><div class="timeline-dot success"></div><div><div class="timeline-title">監査イベント例</div><div class="timeline-text">user_add_request / cron_modify_execute / injection_attempt</div></div></div>
                  </div>
                </article>
              </div>
            </section>

            <section class="module-section" id="sec-systeminfo" data-page-label="システム情報" data-breadcrumb="Home / システム設定 / システム情報">
              <div class="grid cols-12">
                <article class="card span-8">
                  <div class="card-header"><h2>システム情報 / 運用設定サマリー</h2><div class="chips-row"><span class="chip chip-success">systemd managed</span><span class="chip chip-success">svc-adminui non-root</span></div></div>
                  <div class="detail-card">
                    <div class="kv-grid">
                      <div><span>Service User</span><strong>svc-adminui</strong></div>
                      <div><span>Root常駐</span><strong>禁止</strong></div>
                      <div><span>sudoers思想</span><strong>adminui-* wrapper only</strong></div>
                      <div><span>API Auth</span><strong>JWT Bearer</strong></div>
                      <div><span>開発 service</span><strong>linux-management-dev.service</strong></div>
                      <div><span>本番 service</span><strong>linux-management-prod.service</strong></div>
                    </div>
                    <div class="detail-block">
                      <div class="detail-label">service-management.md 反映項目</div>
                      <ul class="plain-list">
                        <li>起動・停止・再起動・状態確認・ログ確認（journalctl）</li>
                        <li>自動起動 enable/disable</li>
                        <li>本番準備: service user / wrappers / sudoers / .env 配置</li>
                        <li>監視: journald log rotation, resource usage</li>
                      </ul>
                    </div>
                  </div>
                </article>
                <article class="card span-4">
                  <div class="card-header"><h3>ストレージ / ハードウェア概況</h3></div>
                  <div class="subpanel">
                    <h4>Disk</h4>
                    <div class="metric-big">468 / 1024 GB</div>
                    <div class="progress"><div class="progress-fill amber" style="width:45.7%"></div></div>
                  </div>
                  <div class="subpanel">
                    <h4>Local Disk（sample）</h4>
                    <ul class="plain-list mono"><li>/ : 180GB / 300GB (60%)</li><li>/var : 120GB / 250GB (48%)</li><li>/backup : 168GB / 474GB (35%)</li></ul>
                  </div>
                  <div class="subpanel">
                    <h4>System Time</h4>
                    <div class="mono" id="systemTimeLabel">--</div>
                  </div>
                </article>
              </div>

              <article class="card">
                <div class="card-header"><h3>sudo / wrapper 設計ポリシー（要件定義・sudoers-config・service-management 反映）</h3></div>
                <div class="command-grid">
                  <div class="command-card"><div class="command-card-head"><strong>直接コマンド禁止</strong></div><p>sudoers では wrapper のみ許可</p><code>svc-adminui ALL=(root) NOPASSWD: /usr/local/sbin/adminui-*</code></div>
                  <div class="command-card"><div class="command-card-head"><strong>入力検証</strong></div><p>API + Service + Wrapper の多重防御</p><code>regex / allowlist / forbidden chars</code></div>
                  <div class="command-card"><div class="command-card-head"><strong>実行記録</strong></div><p>実行前後の監査証跡</p><code>attempt → success / denied / failure</code></div>
                  <div class="command-card"><div class="command-card-head"><strong>人間承認必須</strong></div><p>sudoers変更・危険操作追加・allowlist緩和</p><code>docs各所で明記</code></div>
                </div>
              </article>
            </section>

            <section class="module-section" id="sec-about" data-page-label="ライセンス情報" data-breadcrumb="Home / システム設定 / ライセンス情報">
              <div class="grid cols-12">
                <article class="card span-7">
                  <div class="card-header"><h2>About / License（サンプル）</h2><div class="chips-row"><span class="chip chip-outline">WebUI Sample v0.1</span><span class="chip chip-outline">HTML + CSS + JS</span></div></div>
                  <div class="detail-card">
                    <div class="detail-block"><div class="detail-label">目的</div><div>docs 群（要件・API・設計・セキュリティ・テスト報告）を反映した詳細なWebUIサンプルの提示。</div></div>
                    <div class="detail-block"><div class="detail-label">反映済みモジュール</div><div>Dashboard / Services / Logs / Processes / Cron / Users & Groups / Approval / Audit / Settings / System Information</div></div>
                    <div class="detail-block"><div class="detail-label">docs棚卸しメモ</div><ul class="plain-list"><li>docs 配下: 47ファイル（うち Markdown 43）</li><li>セキュリティ関連 docs: 13ファイル</li><li>`openapi.json` はこの環境でパース確認が必要（本サンプルは `api-reference.md` 優先反映）</li></ul></div>
                  </div>
                </article>
                <article class="card span-5">
                  <div class="card-header"><h3>docs 棚卸しサマリー</h3></div>
                  <div class="metric-grid two">
                    <div class="metric-tile"><div class="metric-title">総ファイル数</div><div class="metric-big">47</div></div>
                    <div class="metric-tile"><div class="metric-title">Security Docs</div><div class="metric-big">13</div></div>
                  </div>
                  <table class="table compact">
                    <thead><tr><th>カテゴリ</th><th>件数</th><th>概要</th></tr></thead>
                    <tbody>
                      <tr><td>要件・全体設計</td><td>4</td><td>README / 要件定義 / 開発環境 / セッション</td></tr>
                      <tr><td>API・データ仕様</td><td>6</td><td>api-reference / approval-api / openapi / schema</td></tr>
                      <tr><td>モジュール設計</td><td>8</td><td>approval / cron / processes / users-groups</td></tr>
                      <tr><td>セキュリティ</td><td>13</td><td>脅威分析 / ポリシー / review</td></tr>
                      <tr><td>WebUI・テスト・検証</td><td>16</td><td>login/e2e/menu/v0.3/test reports</td></tr>
                    </tbody>
                  </table>
                </article>
              </div>

              <article class="card">
                <div class="card-header"><h3>主要APIエンドポイント（サンプル内参照用）</h3></div>
                <table class="table compact">
                  <thead><tr><th>Method</th><th>Path</th><th>Module</th><th>Permission</th><th>Notes</th></tr></thead>
                  <tbody>
                    <tr><td><span class="method-pill method-post">POST</span></td><td class="mono">/api/auth/login</td><td>Auth</td><td class="mono">public</td><td>JWT取得</td></tr>
                    <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/auth/me</td><td>Auth</td><td class="mono">authenticated</td><td>現在ユーザー情報</td></tr>
                    <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/system/status</td><td>System</td><td class="mono">read:status</td><td>CPU/Memory/Disk</td></tr>
                    <tr><td><span class="method-pill method-post">POST</span></td><td class="mono">/api/services/restart</td><td>Services</td><td class="mono">execute:service_restart</td><td>allowlist再起動</td></tr>
                    <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/logs/{service_name}</td><td>Logs</td><td class="mono">read:logs</td><td>lines=1..1000</td></tr>
                    <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/v1/processes</td><td>Processes</td><td class="mono">read:processes</td><td>sort/filter/limit</td></tr>
                    <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/cron</td><td>Cron</td><td class="mono">read:cron</td><td>自分のジョブ一覧</td></tr>
                    <tr><td><span class="method-pill method-post">POST</span></td><td class="mono">/api/users</td><td>Users</td><td class="mono">write:users</td><td>承認申請作成</td></tr>
                    <tr><td><span class="method-pill method-post">POST</span></td><td class="mono">/api/approval/request</td><td>Approval</td><td class="mono">request:approval</td><td>承認申請作成</td></tr>
                    <tr><td><span class="method-pill method-get">GET</span></td><td class="mono">/api/approval/stats</td><td>Approval</td><td class="mono">view:approval_stats</td><td>Adminのみ</td></tr>
                  </tbody>
                </table>
              </article>
            </section>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div class="modal-layer" id="modalLayer" aria-live="polite"></div>
  <div class="toast-stack" id="toastStack" aria-live="polite" aria-atomic="true"></div>

  <template id="cronAddTemplate">
    <div class="modal-backdrop" data-close-modal="true">
      <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="cronAddTitle">
        <form data-form="cron-add">
          <div class="modal-header">
            <h3 class="modal-title" id="cronAddTitle">Add Cron Job (Approval Request)</h3>
            <button type="button" class="icon-btn" data-close-modal="true" aria-label="閉じる">✕</button>
          </div>
          <div class="modal-body">
            <div class="form-grid compact-form">
              <label><span>Preset</span>
                <select name="preset" id="cronPresetSelect">
                  <option value="*/5 * * * *">Every 5 minutes</option>
                  <option value="0 * * * *">Every hour</option>
                  <option value="0 2 * * *" selected>Every day at 2:00</option>
                  <option value="0 3 * * 1">Every Monday at 3:00</option>
                  <option value="0 0 1 * *">First day of month</option>
                </select>
              </label>
              <label><span>Schedule (Cron)</span><input type="text" name="schedule" value="0 2 * * *" required></label>
              <label class="span-2"><span>Command (allowlist only)</span>
                <select name="command" required>
                  <option>/usr/bin/rsync</option>
                  <option>/usr/local/bin/healthcheck.sh</option>
                  <option>/usr/bin/find</option>
                  <option>/usr/bin/tar</option>
                  <option>/usr/bin/gzip</option>
                  <option>/usr/bin/curl</option>
                  <option>/usr/bin/wget</option>
                  <option>/usr/bin/python3</option>
                  <option>/usr/bin/node</option>
                </select>
              </label>
              <label class="span-2"><span>Arguments</span><input type="text" name="arguments" value="-avz /data /backup/data" maxlength="512"></label>
              <label class="span-2"><span>Comment</span><input type="text" name="comment" value="Daily data backup" maxlength="256"></label>
              <label class="span-2"><span>Reason *</span><textarea name="reason" rows="3" minlength="10" maxlength="500" required>Nightly backup of application data</textarea></label>
            </div>
            <div class="inline-note"><span class="note-chip">Policy</span><span>毎分実行禁止 / allowlist外コマンド拒否 / 引数の禁止文字検査 / 承認フロー必須</span></div>
            <p class="form-message" data-modal-message></p>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-soft" data-close-modal="true">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit Approval Request</button>
          </div>
        </form>
      </div>
    </div>
  </template>

  <template id="userAddTemplate">
    <div class="modal-backdrop" data-close-modal="true">
      <div class="modal-panel modal-lg" role="dialog" aria-modal="true" aria-labelledby="userAddTitle">
        <form data-form="user-add">
          <div class="modal-header">
            <h3 class="modal-title" id="userAddTitle">Add User - Approval Request</h3>
            <button type="button" class="icon-btn" data-close-modal="true" aria-label="閉じる">✕</button>
          </div>
          <div class="modal-body">
            <div class="form-grid compact-form">
              <label><span>Username</span><input name="username" type="text" pattern="[a-z_][a-z0-9_-]{0,31}" value="newuser" required></label>
              <label><span>Shell</span>
                <select name="shell">
                  <option>/bin/bash</option><option>/bin/sh</option><option>/usr/bin/zsh</option><option>/usr/sbin/nologin</option><option>/bin/false</option>
                </select>
              </label>
              <label><span>Password</span><input name="password" type="password" value="Strong#Pass123" required></label>
              <label><span>Confirm</span><input name="confirm" type="password" value="Strong#Pass123" required></label>
              <label class="span-2"><span>Groups (comma separated)</span><input name="groups" type="text" value="users,developers"></label>
              <label class="span-2"><span>Home Directory</span><input name="home" type="text" value="/home/newuser"></label>
              <label class="span-2"><span>Reason *</span><textarea name="reason" rows="3" minlength="10" maxlength="500" required>新規プロジェクトメンバーのため作成</textarea></label>
            </div>
            <div class="subpanel">
              <h4>Password Policy Checklist</h4>
              <ul class="plain-list"><li>8-128文字</li><li>大文字 / 小文字 / 数字 / 記号を各1文字以上</li><li>username を含まない</li><li>common password denylist 回避</li></ul>
            </div>
            <p class="form-message" data-modal-message></p>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-soft" data-close-modal="true">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit Approval Request</button>
          </div>
        </form>
      </div>
    </div>
  </template>

  <template id="approvalActionTemplate">
    <div class="modal-backdrop" data-close-modal="true">
      <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="approvalActionTitle">
        <form data-form="approval-action">
          <div class="modal-header">
            <h3 class="modal-title" id="approvalActionTitle">承認操作</h3>
            <button type="button" class="icon-btn" data-close-modal="true" aria-label="閉じる">✕</button>
          </div>
          <div class="modal-body">
            <div class="subpanel">
              <div class="rule-list">
                <div class="rule-item"><span>ID</span><code data-approval-modal-id>apr-1001</code></div>
                <div class="rule-item"><span>Operation</span><code data-approval-modal-op>approve</code></div>
              </div>
            </div>
            <label>
              <span data-approval-modal-label>コメント</span>
              <textarea name="message" rows="4" placeholder="確認しました。" data-approval-modal-textarea></textarea>
            </label>
            <p class="form-message" data-modal-message></p>
            <input type="hidden" name="approvalId">
            <input type="hidden" name="op">
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-soft" data-close-modal="true">キャンセル</button>
            <button type="submit" class="btn btn-primary" data-approval-modal-submit>実行</button>
          </div>
        </form>
      </div>
    </div>
  </template>

  <template id="serviceStopTemplate">
    <div class="modal-backdrop" data-close-modal="true">
      <div class="modal-panel modal-sm" role="dialog" aria-modal="true" aria-labelledby="serviceStopTitle">
        <form data-form="service-stop">
          <div class="modal-header">
            <h3 class="modal-title" id="serviceStopTitle">サービス停止申請</h3>
            <button type="button" class="icon-btn" data-close-modal="true" aria-label="閉じる">✕</button>
          </div>
          <div class="modal-body">
            <label><span>Service</span><input name="service" value="nginx" readonly></label>
            <label><span>Reason *</span><textarea name="reason" rows="3" minlength="10" maxlength="500" required>メンテナンス作業のためサービス停止を申請します。</textarea></label>
            <p class="form-message" data-modal-message></p>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-soft" data-close-modal="true">キャンセル</button>
            <button type="submit" class="btn btn-primary">承認リクエスト送信</button>
          </div>
        </form>
      </div>
    </div>
  </template>

  <template id="confirmTemplate">
    <div class="modal-backdrop" data-close-modal="true">
      <div class="modal-panel modal-sm" role="dialog" aria-modal="true">
        <div class="modal-header">
          <h3 class="modal-title">確認</h3>
          <button class="icon-btn" data-close-modal="true" aria-label="閉じる">✕</button>
        </div>
        <div class="modal-body">
          <p id="confirmMessage">操作を実行しますか？</p>
        </div>
        <div class="modal-actions">
          <button class="btn btn-soft" data-close-modal="true">キャンセル</button>
          <button class="btn btn-primary" id="confirmOkBtn">実行</button>
        </div>
      </div>
    </div>
  </template>
<script>
window.__WEBUI_CONFIG__ = window.__WEBUI_CONFIG__ || {};

/* --- js/config.js --- */
const APP_KEYS = {
  session: "lms.webui.sample.session",
  apiBaseUrl: "lms.webui.sample.apiBaseUrl",
  apiMode: "lms.webui.sample.apiMode",
};
const DEFAULTS = {
  apiBaseUrl: "/api",
  apiMode: "auto", // auto | live | mock
  timeoutMs: 10000,
};

function readMetaContent(name) {
  if (typeof document === "undefined") return "";
  return document.querySelector(`meta[name="${name}"]`)?.getAttribute("content") || "";
}

function readWindowConfig() {
  if (typeof window === "undefined") return {};
  const cfg = window.__WEBUI_CONFIG__ || window.__LMS_WEBUI_CONFIG__;
  return (cfg && typeof cfg === "object") ? cfg : {};
}
function resolveApiBaseUrl() {
  const url = new URL(window.location.href);
  const query = url.searchParams.get("apiBaseUrl") || url.searchParams.get("api");
  const winCfg = readWindowConfig();
  const meta = readMetaContent("lms-api-base-url");
  const stored = localStorage.getItem(APP_KEYS.apiBaseUrl);
  const raw = query || winCfg.apiBaseUrl || meta || stored || DEFAULTS.apiBaseUrl;
  const normalized = String(raw).trim().replace(/\/+$/, "");
  return normalized || DEFAULTS.apiBaseUrl;
}
function resolveApiMode() {
  const url = new URL(window.location.href);
  const query = url.searchParams.get("apiMode");
  const winCfg = readWindowConfig();
  const meta = readMetaContent("lms-api-mode");
  const stored = localStorage.getItem(APP_KEYS.apiMode);
  const mode = String(query || winCfg.apiMode || meta || stored || DEFAULTS.apiMode).toLowerCase();
  return ["auto", "live", "mock"].includes(mode) ? mode : DEFAULTS.apiMode;
}
function persistApiSettings({ baseUrl, mode } = {}) {
  if (baseUrl) localStorage.setItem(APP_KEYS.apiBaseUrl, String(baseUrl).trim().replace(/\/+$/, ""));
  if (mode && ["auto", "live", "mock"].includes(mode)) localStorage.setItem(APP_KEYS.apiMode, mode);
}


/* --- js/api/client.js --- */
class ApiError extends Error {
  constructor(message, options = {}) {
    super(message);
    this.name = "ApiError";
    this.status = options.status ?? 0;
    this.code = options.code || "API_ERROR";
    this.detail = options.detail;
    this.payload = options.payload;
    this.url = options.url;
    this.method = options.method;
    this.retryable = Boolean(options.retryable);
  }
}
function createApiClient({ baseUrl, timeoutMs = 10000, getToken }) {
  async function request(path, options = {}) {
    const method = (options.method || "GET").toUpperCase();
    const timeout = options.timeoutMs || timeoutMs;
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeout);
    const headers = new Headers(options.headers || {});
    if (!headers.has("Accept")) headers.set("Accept", "application/json");
    const token = typeof getToken === "function" ? getToken() : null;
    if (token && !headers.has("Authorization")) headers.set("Authorization", `Bearer ${token}`);
    let body = options.body;
    if (body && typeof body === "object" && !(body instanceof FormData) && !(body instanceof Blob) && !(body instanceof ArrayBuffer)) {
      if (!headers.has("Content-Type")) headers.set("Content-Type", "application/json");
      body = JSON.stringify(body);
    }

    const url = path.startsWith("http") ? path : `${baseUrl}${path.startsWith("/") ? "" : "/"}${path}`;
    try {
      const res = await fetch(url, { ...options, method, headers, body, signal: controller.signal });
      clearTimeout(timer);
      const text = await res.text();
      let data = null;
      if (text) {
        try { data = JSON.parse(text); } catch { data = text; }
      }
      if (!res.ok) {
        throw new ApiError(extractErrorMessage(data, res.statusText), {
          status: res.status,
          detail: data?.detail || data?.message || null,
          payload: data,
          url,
          method,
          code: classifyStatusCode(res.status),
          retryable: res.status >= 500,
        });
      }
      return { ok: true, status: res.status, data, headers: res.headers };
    } catch (err) {
      clearTimeout(timer);
      if (err instanceof ApiError) throw err;
      if (err?.name === "AbortError") {
        throw new ApiError(`Request timeout (${timeout}ms)`, { code: "TIMEOUT", url, method, retryable: true });
      }
      throw new ApiError(err?.message || "Network error", { code: "NETWORK_ERROR", url, method, retryable: true });
    }
  }

  return { request };
}
function extractErrorMessage(payload, fallback) {
  if (!payload) return fallback || "Request failed";
  if (typeof payload === "string") return payload;
  if (typeof payload.detail === "string") return payload.detail;
  if (typeof payload.message === "string") return payload.message;
  if (Array.isArray(payload.detail) && payload.detail.length) {
    const first = payload.detail[0];
    if (first?.msg) return first.msg;
  }
  return fallback || "Request failed";
}
function mapValidationErrors(payload) {
  const items = Array.isArray(payload?.detail) ? payload.detail : [];
  return items.map((item) => ({
    field: Array.isArray(item.loc) ? item.loc.slice(1).join(".") : "",
    message: item.msg || "Validation error",
    type: item.type || "",
  }));
}

function classifyStatusCode(status) {
  if (status === 400 || status === 422) return "VALIDATION_ERROR";
  if (status === 401) return "UNAUTHORIZED";
  if (status === 403) return "FORBIDDEN";
  if (status === 404) return "NOT_FOUND";
  if (status === 409) return "CONFLICT";
  if (status >= 500) return "SERVER_ERROR";
  return "HTTP_ERROR";
}


/* --- js/api/endpoints.js --- */
function qp(params = {}) {
  const usp = new URLSearchParams();
  Object.entries(params).forEach(([k, v]) => {
    if (v === undefined || v === null || v === "") return;
    usp.set(k, String(v));
  });
  const s = usp.toString();
  return s ? `?${s}` : "";
}
function createApi(client) {
  return {
    auth: {
      login(payload) { return client.request("/auth/login", { method: "POST", body: payload }); },
      me() { return client.request("/auth/me"); },
      logout() { return client.request("/auth/logout", { method: "POST" }); },
    },
    system: {
      status() { return client.request("/system/status"); },
    },
    services: {
      list() { return client.request("/services"); }, // may not exist yet; caller should fallback
      restart(service_name) { return client.request("/services/restart", { method: "POST", body: { service_name } }); },
    },
    logs: {
      get(service_name, params = {}) { return client.request(`/logs/${encodeURIComponent(service_name)}${qp(params)}`); },
    },
    processes: {
      list(params = {}) { return client.request(`/v1/processes${qp(params)}`); },
    },
    cron: {
      list(params = {}) { return client.request(`/cron${qp(params)}`); },
      create(payload) { return client.request("/cron", { method: "POST", body: payload }); },
      delete(jobId, reason) { return client.request(`/cron/${encodeURIComponent(jobId)}${qp({ reason })}`, { method: "DELETE" }); },
      toggle(jobId, payload) { return client.request(`/cron/${encodeURIComponent(jobId)}`, { method: "PATCH", body: payload }); },
    },
    users: {
      list() { return client.request("/users"); },
      detail(uid) { return client.request(`/users/${encodeURIComponent(uid)}`); },
      create(payload) { return client.request("/users", { method: "POST", body: payload }); },
      delete(uid, payload = {}) { return client.request(`/users/${encodeURIComponent(uid)}`, { method: "DELETE", body: payload }); },
      changePassword(uid, payload) { return client.request(`/users/${encodeURIComponent(uid)}/password`, { method: "PUT", body: payload }); },
      listGroups() { return client.request("/groups"); },
      createGroup(payload) { return client.request("/groups", { method: "POST", body: payload }); },
      deleteGroup(gid, payload = {}) { return client.request(`/groups/${encodeURIComponent(gid)}`, { method: "DELETE", body: payload }); },
      updateGroupMembers(gid, payload) { return client.request(`/groups/${encodeURIComponent(gid)}/members`, { method: "PUT", body: payload }); },
    },
    approvals: {
      create(payload) { return client.request("/approval/request", { method: "POST", body: payload }); },
      pending(params = {}) { return client.request(`/approval/pending${qp(params)}`); },
      myRequests(params = {}) { return client.request(`/approval/my-requests${qp(params)}`); },
      detail(id) { return client.request(`/approval/${encodeURIComponent(id)}`); },
      approve(id, payload = {}) { return client.request(`/approval/${encodeURIComponent(id)}/approve`, { method: "POST", body: payload }); },
      reject(id, payload) { return client.request(`/approval/${encodeURIComponent(id)}/reject`, { method: "POST", body: payload }); },
      cancel(id, payload = {}) { return client.request(`/approval/${encodeURIComponent(id)}/cancel`, { method: "POST", body: payload }); },
      execute(id, payload = {}) { return client.request(`/approval/${encodeURIComponent(id)}/execute`, { method: "POST", body: payload }); },
      history(params = {}) { return client.request(`/approval/history${qp(params)}`); },
      policies() { return client.request("/approval/policies"); },
      stats(params = {}) { return client.request(`/approval/stats${qp(params)}`); },
    },
  };
}


/* --- js/api/index.js --- */
function createApiFacade({ getToken, onNetworkState } = {}) {
  const settings = {
    baseUrl: resolveApiBaseUrl(),
    mode: resolveApiMode(),
    timeoutMs: DEFAULTS.timeoutMs,
  };

  const client = createApiClient({
    baseUrl: settings.baseUrl,
    timeoutMs: settings.timeoutMs,
    getToken,
  });
  const api = createApi(client);

  async function tryLive(fn, { fallback = null, op = "api" } = {}) {
    if (settings.mode === "mock") return { live: false, data: fallback, error: null };
    try {
      const result = await fn();
      onNetworkState?.({ ok: true, op, mode: "live" });
      return { live: true, data: result?.data ?? result, error: null, meta: result };
    } catch (error) {
      if (!(error instanceof ApiError)) throw error;
      onNetworkState?.({ ok: false, op, mode: "live", error });
      if (settings.mode === "live") throw error;
      return { live: false, data: fallback, error };
    }
  }

  function setMode(mode) {
    if (!["auto", "live", "mock"].includes(mode)) return;
    settings.mode = mode;
    persistApiSettings({ mode });
  }

  function setBaseUrl(baseUrl) {
    settings.baseUrl = String(baseUrl || "").trim().replace(/\/+$/, "") || DEFAULTS.apiBaseUrl;
    persistApiSettings({ baseUrl: settings.baseUrl });
  }

  return {
    api,
    settings,
    tryLive,
    setMode,
    setBaseUrl,
  };
}


/* --- js/store.js --- */
function createUiStore() {
  const ui = {
    filters: {
      processes: { sort_by: "cpu", filter_user: "", min_cpu: 0, min_mem: 0, limit: 100 },
      approvals: { pending: {}, my: {}, history: { period: "30d" } },
      cron: {},
      users: {},
      logs: {},
    },
    selected: {
      processId: null,
      approvalId: null,
      service: "nginx",
    },
    modal: {
      name: null,
      payload: null,
    },
  };

  return {
    getSession() {
      try { return JSON.parse(localStorage.getItem(APP_KEYS.session) || "null"); } catch { return null; }
    },
    setSession(session) {
      localStorage.setItem(APP_KEYS.session, JSON.stringify(session));
    },
    clearSession() {
      localStorage.removeItem(APP_KEYS.session);
    },
    ui,
  };
}


/* --- js/modules/processes.js --- */
function buildProcessesQuery(filters) {
  return {
    sort_by: filters.sort_by || "cpu",
    filter_user: filters.filter_user || undefined,
    min_cpu: Number(filters.min_cpu || 0) || 0,
    min_mem: Number(filters.min_mem || 0) || 0,
    limit: Number(filters.limit || 100) || 100,
  };
}
function normalizeProcessesResponse(payload) {
  const root = payload?.data ?? payload ?? {};
  const list = root.processes || root.items || root.data || [];
  const rows = Array.isArray(list) ? list.map(normalizeProcessRow).filter(Boolean) : [];
  return {
    status: root.status || "success",
    sort_by: root.sort_by || "cpu",
    total_processes: Number(root.total_processes ?? root.total ?? rows.length),
    returned_processes: Number(root.returned_processes ?? rows.length),
    filters: root.filters || {
      user: root.filter_user || null,
      min_cpu: root.min_cpu ?? 0,
      min_mem: root.min_mem ?? 0,
    },
    processes: rows,
    timestamp: root.timestamp || new Date().toISOString(),
  };
}
function normalizeProcessRow(row) {
  if (!row || typeof row !== "object") return null;
  const pid = Number(row.pid ?? row.process_id ?? 0);
  if (!Number.isFinite(pid) || pid <= 0) return null;
  return {
    pid,
    user: String(row.user ?? row.username ?? "unknown"),
    cpu_percent: toNumber(row.cpu_percent ?? row.cpu ?? row.cpuUsage ?? 0),
    mem_percent: toNumber(row.mem_percent ?? row.mem ?? row.memory ?? 0),
    vsz: toNumber(row.vsz ?? row.virtual_size ?? 0, true),
    rss: toNumber(row.rss ?? row.resident_size ?? 0, true),
    tty: String(row.tty ?? "?"),
    stat: String(row.stat ?? row.state ?? "S"),
    start: String(row.start ?? row.started ?? row.start_time ?? ""),
    time: String(row.time ?? row.cpu_time ?? "00:00:00"),
    command: String(row.command ?? row.cmd ?? row.name ?? ""),
  };
}

function toNumber(v, integer = false) {
  const n = Number(v);
  if (!Number.isFinite(n)) return 0;
  return integer ? Math.trunc(n) : n;
}


/* --- js/modules/approvals.js --- */
function normalizeApprovalStatus(value) {
  const v = String(value || "").toLowerCase();
  const known = ["pending", "approved", "rejected", "expired", "executed", "execution_failed", "cancelled"];
  return known.includes(v) ? v : "pending";
}
function normalizeApprovalRisk(value) {
  const v = String(value || "").toUpperCase();
  return ["LOW", "MEDIUM", "HIGH", "CRITICAL"].includes(v) ? v : "MEDIUM";
}
function normalizeApprovalListPayload(payload, mode = "pending") {
  const root = payload?.data ?? payload ?? {};
  const source = root.requests || root.items || root.data || [];
  const requests = Array.isArray(source) ? source.map((r) => normalizeApprovalListItem(r, mode)).filter(Boolean) : [];
  return {
    status: root.status || "success",
    total: Number(root.total ?? requests.length),
    page: Number(root.page ?? 1),
    per_page: Number(root.per_page ?? (requests.length || 20)),
    requests,
  };
}
function normalizeApprovalListItem(item, mode = "pending") {
  if (!item || typeof item !== "object") return null;
  const id = String(item.id || item.request_id || "");
  if (!id) return null;
  return {
    id,
    request_type: String(item.request_type || item.operation_type || "unknown"),
    request_type_description: String(item.request_type_description || item.description || item.request_type || ""),
    risk_level: normalizeApprovalRisk(item.risk_level || item.risk || "MEDIUM"),
    requester_id: String(item.requester_id || ""),
    requester_name: String(item.requester_name || item.requester || ""),
    reason: String(item.reason || ""),
    status: normalizeApprovalStatus(item.status || (mode === "pending" ? "pending" : "")),
    created_at: item.created_at || null,
    expires_at: item.expires_at || null,
    remaining_hours: Number(item.remaining_hours ?? 0),
    payload_summary: String(item.payload_summary || ""),
    approved_by_name: item.approved_by_name ?? null,
    approved_at: item.approved_at ?? null,
    rejection_reason: item.rejection_reason ?? null,
  };
}
function normalizeApprovalDetailPayload(payload) {
  const root = payload?.data ?? payload ?? {};
  const req = root.request || root.data || root;
  if (!req || typeof req !== "object") return null;
  return {
    id: String(req.id || req.request_id || ""),
    request_type: String(req.request_type || "unknown"),
    request_type_description: String(req.request_type_description || req.request_type || ""),
    risk_level: normalizeApprovalRisk(req.risk_level || req.risk || "MEDIUM"),
    requester_id: String(req.requester_id || ""),
    requester_name: String(req.requester_name || req.requester || ""),
    request_payload: req.request_payload || req.payload || {},
    reason: String(req.reason || ""),
    status: normalizeApprovalStatus(req.status),
    created_at: req.created_at || null,
    expires_at: req.expires_at || null,
    approved_by: req.approved_by || null,
    approved_by_name: req.approved_by_name || null,
    approved_at: req.approved_at || null,
    rejection_reason: req.rejection_reason || null,
    execution_result: req.execution_result || null,
    executed_at: req.executed_at || null,
    history: Array.isArray(req.history) ? req.history : [],
  };
}
function normalizeApprovalActionResponse(payload, fallbackStatus) {
  const root = payload?.data ?? payload ?? {};
  return {
    status: root.status || "success",
    message: root.message || "",
    request_id: root.request_id || root.id || "",
    next_status: normalizeApprovalStatus(root.status_value || fallbackStatus || "pending"),
    raw: root,
  };
}


/* --- js/modules/cron.js --- */
function normalizeCronListPayload(payload) {
  const root = payload?.data ?? payload ?? {};
  const jobs = Array.isArray(root.jobs) ? root.jobs : [];
  return {
    status: root.status || "success",
    user: root.user || null,
    total_count: Number(root.total_count ?? jobs.length),
    max_allowed: Number(root.max_allowed ?? 10),
    jobs: jobs.map((job) => ({
      id: String(job.id || ""),
      owner: String(job.user || job.owner || root.user || ""),
      schedule: String(job.schedule || ""),
      schedule_human: String(job.schedule_human || ""),
      command: String(job.command || ""),
      arguments: String(job.arguments || ""),
      enabled: Boolean(job.enabled),
      created_at: job.created_at || null,
      created_by: job.created_by || null,
    })).filter((j) => j.id),
  };
}
function normalizeApprovalPendingResponse(payload) {
  const root = payload?.data ?? payload ?? {};
  return {
    status: String(root.status || ""),
    request_id: String(root.request_id || root.approval_id || ""),
    message: String(root.message || ""),
  };
}


/* --- js/modules/users.js --- */
function normalizeUsersListPayload(payload) {
  const root = payload?.data ?? payload ?? {};
  const users = Array.isArray(root.users) ? root.users : [];
  return {
    status: root.status || "success",
    total_count: Number(root.total_count ?? users.length),
    users: users.map((u) => ({
      username: String(u.username || ""),
      uid: Number(u.uid ?? 0),
      gid: Number(u.gid ?? 0),
      gecos: String(u.gecos || ""),
      home: String(u.home || u.home_dir || ""),
      shell: String(u.shell || ""),
      groups: Array.isArray(u.groups) ? u.groups.map(String) : [],
      locked: Boolean(u.locked),
      last_login: u.last_login || null,
    })).filter((u) => u.username),
    timestamp: root.timestamp || null,
  };
}
function normalizeGroupsListPayload(payload) {
  const root = payload?.data ?? payload ?? {};
  const groups = Array.isArray(root.groups) ? root.groups : [];
  return {
    status: root.status || "success",
    total_count: Number(root.total_count ?? groups.length),
    groups: groups.map((g) => ({
      group: String(g.group || g.name || ""),
      gid: Number(g.gid ?? 0),
      members: Array.isArray(g.members) ? g.members.map(String) : [],
      risk: String(g.risk || "LOW").toUpperCase(),
    })).filter((g) => g.group),
    timestamp: root.timestamp || null,
  };
}


/* --- js/modules/services.js --- */
function normalizeLogsPayload(payload) {
  const root = payload?.data ?? payload ?? {};
  const lines = root.logs || root.lines || root.entries || [];
  return {
    status: root.status || "success",
    service_name: root.service_name || root.service || null,
    line_count: Number(root.line_count ?? lines.length),
    logs: Array.isArray(lines) ? lines.map(String) : [],
    timestamp: root.timestamp || null,
  };
}
function normalizeServiceRestartPayload(payload) {
  const root = payload?.data ?? payload ?? {};
  return {
    status: root.status || "success",
    service_name: root.service_name || null,
    previous_status: root.previous_status || null,
    current_status: root.current_status || root.status_value || null,
    message: root.message || "",
    timestamp: root.timestamp || null,
  };
}


/* --- js/modules/validation.js --- */
function validateUsername(value) {
  return /^[a-z_][a-z0-9_-]{0,31}$/.test(String(value || ""));
}
function validateCronSchedule(value) {
  const s = String(value || "").trim();
  return s.length > 0 && s.length <= 50 && /^[\d*\/,\-\s]+$/.test(s) && s !== "* * * * *";
}
function validateCronArguments(value) {
  return !/[;|&$()]/.test(String(value || ""));
}
function validateStrongPassword(password, username = "") {
  const p = String(password || "");
  if (p.length < 8 || p.length > 128) return false;
  if (username && p.toLowerCase().includes(String(username).toLowerCase())) return false;
  if (!/[a-z]/.test(p) || !/[A-Z]/.test(p) || !/[0-9]/.test(p) || !/[^A-Za-z0-9]/.test(p)) return false;
  return !["password", "admin123", "qwerty", "12345678"].some((w) => p.toLowerCase().includes(w));
}
function explainApiError(err) {
  if (!err) return { message: "Unknown error", details: [] };
  if (err.code === "VALIDATION_ERROR" && err.payload) {
    const details = mapValidationErrors(err.payload);
    return {
      message: details.length ? details.map((d) => `${d.field || "input"}: ${d.message}`).join(" / ") : (err.message || "Validation error"),
      details,
    };
  }
  return { message: err.message || "Request failed", details: [] };
}


const normalizeCronApprovalPending = normalizeApprovalPendingResponse;


/* --- app.js --- */
(() => {
  "use strict";

  const SESSION_KEY = APP_KEYS.session;
  const SESSION_TTL = 30 * 60 * 1000;
  const PROC_AUTO_MS = 5000;
  const RESTART_ALLOW = new Set(["nginx", "postgresql", "redis"]);
  const CRON_ALLOW = new Set([
    "/usr/bin/rsync", "/usr/local/bin/healthcheck.sh", "/usr/bin/find",
    "/usr/bin/tar", "/usr/bin/gzip", "/usr/bin/curl", "/usr/bin/wget",
    "/usr/bin/python3", "/usr/bin/node",
  ]);
  const FORBIDDEN_GROUPS = new Set(["root", "sudo", "wheel", "docker", "lxd", "shadow"]);
  const ALLOWED_SHELLS = new Set(["/bin/bash", "/bin/sh", "/usr/bin/zsh", "/usr/sbin/nologin", "/bin/false"]);
  const APPROVAL_META = {
    user_add: { label: "ユーザーアカウント追加", risk: "HIGH", roles: "Approver, Admin", timeout: "24h" },
    user_delete: { label: "ユーザーアカウント削除", risk: "CRITICAL", roles: "Admin", timeout: "12h" },
    user_passwd: { label: "ユーザーパスワード変更", risk: "HIGH", roles: "Approver, Admin", timeout: "24h" },
    group_modify: { label: "グループメンバー変更", risk: "MEDIUM", roles: "Approver, Admin", timeout: "24h" },
    group_delete: { label: "グループ削除", risk: "HIGH", roles: "Admin", timeout: "12h" },
    cron_add: { label: "Cronジョブ追加", risk: "HIGH", roles: "Approver, Admin", timeout: "24h" },
    cron_modify: { label: "Cronジョブ変更", risk: "HIGH", roles: "Approver, Admin", timeout: "24h" },
    service_stop: { label: "サービス停止", risk: "CRITICAL", roles: "Admin", timeout: "12h" },
    firewall_modify: { label: "ファイアウォール変更", risk: "CRITICAL", roles: "Admin", timeout: "12h" },
  };

  const dom = {};
  const state = {
    session: null,
    activeSection: "sec-dashboard",
    procAuto: null,
    clock: null,
    sessionWatch: null,
    scrollTicking: false,
    selectedPid: null,
    selectedService: "nginx",
    services: {},
    approvals: {},
    nextApprovalId: 1007,
    confirmFn: null,
    apiNoticeShown: false,
    api: null,
    store: createUiStore(),
  };

  document.addEventListener("DOMContentLoaded", init);

  function init() {
    window.__LMS_WEBUI_BOOTED__ = true;
    cacheDom();
    seedState();
    initApi();
    bindBaseEvents();
    initAccordions();
    initTabs();
    initClock();
    restoreSession();
    refreshAll(false);
    activateSection(state.activeSection, false);
  }

  function initApi() {
    state.api = createApiFacade({
      getToken: () => state.session?.token || state.session?.access_token || state.session?.accessToken || null,
      onNetworkState: ({ ok, op, error }) => {
        if (ok) return;
        if (state.apiNoticeShown) return;
        state.apiNoticeShown = true;
        toast(`API接続失敗 (${op})。モック表示を継続します。`, "warning", 3600);
        if (error) console.warn("[webui-sample]", op, error);
      },
    });
  }

  function cacheDom() {
    [
      "loginScreen", "shell", "loginForm", "loginEmail", "loginPassword", "loginRole", "loginMessage",
      "logoutBtn", "sidebar", "sidebarBackdrop", "sidebarOpenBtn", "sidebarCloseBtn", "sidebarNav",
      "sidebarUsername", "sidebarEmail", "sidebarRoleBadge", "breadcrumb", "pageTitle", "liveClock",
      "refreshPageBtn", "pageContent", "systemTimeLabel", "modalLayer", "toastStack",
      "cpuUsageValue", "cpuUsageBar", "memUsageValue", "memUsageBar", "pendingCountValue", "procTotalValue",
      "topCpuValue", "procRefreshBtn", "procAutoBtn", "procSort", "procUser", "procMinCpu", "procMinMem",
      "procLimit", "procTable", "procRowsMeta", "procKpiTotal", "procKpiCpu", "procKpiMem", "procKpiStates",
      "procCpuBar", "procMemBar", "procDetailName", "procDetailId", "procDetailStat", "procDetailCpu",
      "procDetailMem", "procDetailStateText", "procDetailCwd", "procDetailCmd",
      "servicePreviewTitle", "servicePreviewName", "serviceLogPreview",
      "logsService", "logsLines", "logsQ", "logsTerminal",
      "usersSearch", "usersStatus", "groupsSearch", "usersTable", "groupsTable",
      "approvalPendingType", "approvalPendingRequester", "approvalPendingTable",
      "approvalMyStatus", "approvalMyTable", "approvalDraftForm", "approvalDraftType", "approvalDraftReason",
      "approvalDraftFields", "approvalPreviewType", "approvalPreviewRisk", "approvalPreviewRoles",
      "approvalPreviewTimeout", "approvalPreviewPayload", "approvalPeriod", "approvalHistoryStatus",
      "approvalHistoryTable", "approvalDetailTitle", "approvalDetailId", "approvalDetailStatus",
      "approvalDetailRisk", "approvalDetailRequesterRole", "approvalDetailRequester", "approvalDetailReason",
      "approvalDetailPayload", "approvalDetailTimeline", "auditOp", "auditStatus", "auditQ", "auditTable", "cronTable"
    ].forEach((id) => { dom[id] = byId(id); });
  }

  function seedState() {
    state.services = {
      nginx: { title: "Nginx Web Server", logs: [
        "Feb 24 09:12:20 nginx: Reloading configuration...",
        "Feb 24 09:12:21 nginx: Configuration reloaded",
        "Feb 24 10:15:13 nginx: GET /api/system/status 200",
        "Feb 24 10:22:33 nginx: GET /api/v1/processes 200",
      ]},
      postgresql: { title: "PostgreSQL", logs: [
        "Feb 24 09:00:01 postgresql: checkpoint complete",
        "Feb 24 09:10:11 postgresql: connection authorized user=adminui",
        "Feb 24 10:14:50 postgresql: autovacuum launcher started",
      ]},
      redis: { title: "Redis", logs: [
        "Feb 24 08:55:20 redis: Background saving started",
        "Feb 24 08:55:21 redis: DB saved on disk",
        "Feb 24 10:04:51 redis: Expired 42 keys",
      ]},
      "linux-management-prod": { title: "Linux Management API", logs: [
        "Feb 24 09:01:00 api: startup complete on :5012",
        "Feb 24 09:28:02 api: processes.list returned=7",
        "Feb 24 09:40:33 api: approval.request created id=apr-1002",
      ]},
      sshd: { title: "SSH Server", logs: [
        "Feb 24 08:32:22 sshd: Accepted publickey for kensan",
        "Feb 24 08:58:45 sshd: Failed password for invalid user test",
      ]},
    };

    state.approvals = {
      "apr-1001": mkApproval("apr-1001", "user_add", "operator", "Operator", "pending", "新規プロジェクトメンバーのアカウント作成",
        { username: "newuser", group: "developers", home: "/home/newuser", shell: "/bin/bash" }, "02/24 17:00:00"),
      "apr-1002": mkApproval("apr-1002", "cron_add", "operator", "Operator", "pending", "夜間バックアップジョブの追加",
        { schedule: "0 2 * * *", command: "/usr/bin/rsync", arguments: "-avz /data /backup/data" }, "02/24 15:00:00"),
      "apr-1003": mkApproval("apr-1003", "service_stop", "approver1", "Approver", "approved", "メンテナンスのため nginx 停止",
        { service: "nginx" }, "02/24 09:30:00", [{ tone: "success", title: "approved / admin (Admin)", time: "02/24 10:00:00" }]),
      "apr-1004": mkApproval("apr-1004", "group_delete", "operator", "Operator", "rejected", "legacyops を削除",
        { group: "legacyops" }, "02/23 10:15:00", [{ tone: "warning", title: "rejected / admin (Admin)", time: "02/23 12:00:00" }]),
      "apr-1005": mkApproval("apr-1005", "cron_modify", "operator2", "Operator", "executed", "ヘルスチェック間隔の調整",
        { cron_id: "cron_002", schedule: "*/10 * * * *" }, "02/22 19:20:00", [
          { tone: "success", title: "approved / approver1 (Approver)", time: "02/22 19:45:00" },
          { tone: "success", title: "executed / system", time: "02/22 20:00:00" },
        ]),
      "apr-1006": mkApproval("apr-1006", "firewall_modify", "operator", "Operator", "expired", "一時的なFWルール変更",
        { rule: "allow tcp/8443 from 10.0.10.0/24" }, "02/20 20:00:00", [{ tone: "warning", title: "expired / system", time: "02/21 08:00:00" }]),
    };
  }

  function mkApproval(id, type, requester, role, status, reason, payload, createdAt, extraTimeline) {
    return {
      id, type, requester, requesterRole: role, status,
      risk: (APPROVAL_META[type] || APPROVAL_META.user_add).risk,
      reason, payload,
      timeline: [{ tone: "info", title: `created / ${requester} (${role})`, time: createdAt }].concat(extraTimeline || []),
    };
  }

  function bindBaseEvents() {
    dom.loginForm?.addEventListener("submit", loginSubmit);
    dom.logoutBtn?.addEventListener("click", () => logout("ログアウトしました。"));
    dom.sidebarOpenBtn?.addEventListener("click", () => setSidebar(true));
    dom.sidebarCloseBtn?.addEventListener("click", () => setSidebar(false));
    dom.sidebarBackdrop?.addEventListener("click", () => setSidebar(false));
    dom.refreshPageBtn?.addEventListener("click", () => refreshAll(true));
    document.addEventListener("click", onClick);
    document.addEventListener("input", onInput);
    document.addEventListener("change", onChange);
    document.addEventListener("submit", onSubmit);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && dom.modalLayer?.classList.contains("active")) closeModal();
    });
    window.addEventListener("scroll", onScroll, { passive: true });
  }

  function restoreSession() {
    try {
      const s = state.store.getSession();
      if (!s) return loggedOut();
      if (!s || !s.expiresAt || Date.now() >= s.expiresAt) return loggedOut("セッションの有効期限が切れました。");
      state.session = s;
      loggedIn();
    } catch {
      loggedOut("保存セッションの読み込みに失敗しました。");
    }
  }

  async function loginSubmit(e) {
    e.preventDefault();
    const email = (dom.loginEmail?.value || "").trim();
    const pw = dom.loginPassword?.value || "";
    const role = dom.loginRole?.value || "Admin";
    if (!email.includes("@")) return setMsg(dom.loginMessage, "メールアドレスを確認してください。", "error");
    if (pw.length < 8) return setMsg(dom.loginMessage, "パスワードは8文字以上で入力してください。", "error");
    setMsg(dom.loginMessage, "ログイン中...", "info");

    let sessionFromApi = null;
    try {
      const live = await state.api.tryLive(
        () => state.api.api.auth.login({ email, password: pw }),
        { op: "auth.login" }
      );
      if (live.live && live.data) {
        const token = live.data.access_token || live.data.token || live.data.jwt;
        sessionFromApi = {
          email: live.data.email || email,
          username: live.data.username || email.split("@")[0],
          role: roleLabel(live.data.role || role),
          token,
          access_token: token,
          user_id: live.data.user_id || live.data.id || null,
          expiresAt: Date.now() + SESSION_TTL,
        };
        // Best effort refresh from /auth/me for permissions/profile
        if (token) {
          state.session = sessionFromApi;
          const me = await state.api.tryLive(() => state.api.api.auth.me(), { op: "auth.me" });
          if (me.live && me.data) {
            sessionFromApi = {
              ...sessionFromApi,
              email: me.data.email || sessionFromApi.email,
              username: me.data.username || sessionFromApi.username,
              role: roleLabel(me.data.role || sessionFromApi.role),
              permissions: me.data.permissions || sessionFromApi.permissions,
              user_id: me.data.user_id || sessionFromApi.user_id,
            };
          }
        }
      }
    } catch (err) {
      const info = explainApiError(err);
      setMsg(dom.loginMessage, info.message, "error");
      if (state.api.settings.mode === "live") return;
    }

    state.session = sessionFromApi || {
      email,
      username: email.split("@")[0],
      role,
      token: `mock.${Date.now()}.${Math.random().toString(36).slice(2, 8)}`,
      expiresAt: Date.now() + SESSION_TTL,
      mock: true,
    };
    state.store.setSession(state.session);
    loggedIn();
    setMsg(dom.loginMessage, "", "");
    toast(`ログイン: ${state.session.username} (${state.session.role})${sessionFromApi ? "" : " (mock)"}`, "success");
  }

  function loggedIn() {
    dom.loginScreen?.classList.add("hidden");
    dom.shell?.classList.remove("hidden");
    if (dom.sidebarUsername) dom.sidebarUsername.textContent = state.session?.username || "-";
    if (dom.sidebarEmail) dom.sidebarEmail.textContent = state.session?.email || "-";
    if (dom.sidebarRoleBadge) dom.sidebarRoleBadge.textContent = state.session?.role || "-";
    setMsg(dom.loginMessage, "", "");
    updateClocks();
    void hydrateLiveData();
  }

  function loggedOut(msg) {
    state.store.clearSession();
    state.session = null;
    dom.shell?.classList.add("hidden");
    dom.loginScreen?.classList.remove("hidden");
    setSidebar(false);
    if (state.procAuto) { clearInterval(state.procAuto); state.procAuto = null; }
    if (dom.procAutoBtn) { dom.procAutoBtn.dataset.procAuto = "off"; dom.procAutoBtn.textContent = "▶ Auto-refresh (5s)"; }
    if (msg) setMsg(dom.loginMessage, msg, "warning");
  }

  function logout(msg) {
    if (state.session && state.api) {
      void state.api.tryLive(() => state.api.api.auth.logout(), { op: "auth.logout" }).catch(() => {});
    }
    loggedOut();
    if (msg) toast(msg, "info");
  }

  async function hydrateLiveData() {
    await Promise.allSettled([
      refreshProcesses(false),
      renderLogs(),
      loadCronFromApi(),
      loadUsersFromApi(),
      refreshApprovalsFromApi(),
    ]);
  }

  function initClock() {
    updateClocks();
    state.clock = setInterval(updateClocks, 1000);
    state.sessionWatch = setInterval(() => {
      if (state.session && Date.now() >= state.session.expiresAt) logout("セッションの有効期限（30分）が切れました。");
    }, 15000);
  }

  function updateClocks() {
    const d = new Date();
    if (dom.liveClock) dom.liveClock.textContent = d.toLocaleTimeString("ja-JP", { hour12: false });
    if (dom.systemTimeLabel) dom.systemTimeLabel.textContent = d.toLocaleString("ja-JP", {
      year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false
    });
  }

  function initAccordions() {
    qsa("[data-accordion-toggle]").forEach((btn) => syncAccordion(btn.closest(".accordion"), btn));
  }

  function syncAccordion(acc, btn) {
    const ex = !!acc?.classList.contains("expanded");
    btn?.setAttribute("aria-expanded", String(ex));
    const chev = btn?.querySelector(".accordion-chevron");
    if (chev) chev.textContent = ex ? "▾" : "▸";
  }

  function initTabs() {
    qsa(".tab.active[data-tab-group]").forEach((b) => activateTab(b.dataset.tabGroup, b.dataset.tabId, false));
  }

  function activateTab(group, id, focus = true) {
    const tabs = qsa(`.tab[data-tab-group="${escSel(group)}"]`);
    const ids = tabs.map((t) => t.dataset.tabId);
    tabs.forEach((t) => {
      const on = t.dataset.tabId === id;
      t.classList.toggle("active", on);
      t.setAttribute("aria-selected", String(on));
      if (on && focus) t.focus({ preventScroll: true });
    });
    qsa("[data-tab-panel]").forEach((p) => {
      if (ids.includes(p.dataset.tabPanel)) p.classList.toggle("active", p.dataset.tabPanel === id);
    });
  }

  function activateSection(id, doScroll) {
    const sec = byId(id);
    if (!sec) return;
    state.activeSection = id;
    if (dom.pageTitle) dom.pageTitle.textContent = sec.dataset.pageLabel || "ページ";
    if (dom.breadcrumb) dom.breadcrumb.textContent = sec.dataset.breadcrumb || "Home";
    qsa(".menu-item, .submenu-item").forEach((b) => b.classList.toggle("active", b.dataset.scrollTarget === id));
    if (doScroll) sec.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  function setSidebar(open) {
    dom.sidebar?.classList.toggle("open", !!open);
    dom.sidebarBackdrop?.classList.toggle("hidden", !open);
  }

  function onScroll() {
    if (state.scrollTicking) return;
    state.scrollTicking = true;
    requestAnimationFrame(() => {
      state.scrollTicking = false;
      let best = null, score = Infinity;
      qsa(".module-section[id]").forEach((sec) => {
        const s = Math.abs(sec.getBoundingClientRect().top - 140);
        if (s < score) { score = s; best = sec; }
      });
      if (best && best.id !== state.activeSection) activateSection(best.id, false);
    });
  }

  function refreshAll(withToast) {
    updateClocks();
    if (typeof refreshProcesses === "function") void refreshProcesses(false);
    if (typeof renderServicePreview === "function") renderServicePreview(state.selectedService);
    if (typeof renderLogs === "function") void renderLogs();
    if (typeof loadCronFromApi === "function") void loadCronFromApi();
    if (typeof loadUsersFromApi === "function") void loadUsersFromApi();
    if (typeof filterAudit === "function") filterAudit();
    if (typeof filterUsersGroups === "function") filterUsersGroups();
    if (typeof syncApprovalUI === "function") syncApprovalUI();
    if (typeof refreshApprovalsFromApi === "function") void refreshApprovalsFromApi();
    if (withToast) toast(`画面を再描画しました（${state.api?.settings?.mode || "mock"}）`, "info");
  }

  function onClick(e) {}
  function onInput(e) {}
  function onChange(e) {}
  function onSubmit(e) {}

  function byId(id) { return document.getElementById(id); }
  function qsa(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }
  function txt(el, v) { if (el) el.textContent = v; }
  function fmtInt(v) {
    const n = Number(v);
    return Number.isFinite(n) ? n.toLocaleString("en-US") : "0";
  }
  function setMsg(el, msg, tone) {
    if (!el) return;
    el.textContent = msg || "";
    el.classList.remove("msg-success", "msg-error", "msg-warning", "msg-info");
    if (tone) el.classList.add(`msg-${tone}`);
  }
  function clamp(n, min, max) { return Math.min(max, Math.max(min, n)); }
  function rand(min, max) { return Math.random() * (max - min) + min; }
  function parseHms(s) {
    const p = String(s || "").split(":").map(Number);
    if (p.some(Number.isNaN)) return 0;
    return p.length === 3 ? p[0] * 3600 + p[1] * 60 + p[2] : p.length === 2 ? p[0] * 60 + p[1] : (p[0] || 0);
  }
  function nowShort() {
    return new Date().toLocaleString("ja-JP", { month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", hour12: false });
  }
  function nowLong() {
    return new Date().toLocaleString("ja-JP", { month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false });
  }
  function isoToUi(v) {
    if (!v) return "-";
    const d = new Date(v);
    return Number.isNaN(d.getTime()) ? String(v) : d.toLocaleString("ja-JP", { month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit", hour12: false });
  }
  function escSel(v) { return window.CSS?.escape ? CSS.escape(v || "") : String(v || "").replace(/["\\]/g, "\\$&"); }
  function escHtml(v) {
    return String(v).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#39;");
  }
  function roleLabel(v) {
    const m = { admin: "Admin", approver: "Approver", operator: "Operator", viewer: "Viewer" };
    return m[String(v || "").toLowerCase()] || (v || "Operator");
  }
  function getProcRows() { return qsa("tr[data-proc-row]", dom.procTable); }

  async function refreshProcesses(jitter = true) {
    if (!dom.procTable) return;
    if (state.session && state.api) {
      const query = buildProcessesQuery({
        sort_by: dom.procSort?.value || "cpu",
        filter_user: dom.procUser?.value || "",
        min_cpu: +dom.procMinCpu?.value || 0,
        min_mem: +dom.procMinMem?.value || 0,
        limit: clamp(parseInt(dom.procLimit?.value || "100", 10), 1, 1000),
      });
      try {
        const live = await state.api.tryLive(
          () => state.api.api.processes.list(query),
          { op: "processes.list" }
        );
        if (live.live && live.data) {
          try {
            const normalized = normalizeProcessesResponse(live.data);
            renderProcessesTableFromApi(normalized);
            return;
          } catch (err) {
            console.warn("[webui-sample] processes adapter fallback", err);
          }
        }
      } catch (err) {
        if (state.api.settings.mode === "live") toast(explainApiError(err).message, "error");
      }
    }

    const rows = getProcRows();
    if (jitter) {
      rows.forEach((r) => {
        const c = clamp((+r.dataset.cpu || 0) + rand(-1.2, 1.5), 0, 95);
        const m = clamp((+r.dataset.mem || 0) + rand(-0.6, 0.8), 0, 95);
        r.dataset.cpu = c.toFixed(1);
        r.dataset.mem = m.toFixed(1);
        const cCell = r.querySelector("[data-proc-cpu]");
        const mCell = r.querySelector("[data-proc-mem]");
        if (cCell) cCell.textContent = c.toFixed(1);
        if (mCell) mCell.textContent = m.toFixed(1);
      });
    }

    const sort = dom.procSort?.value || "cpu";
    const user = dom.procUser?.value || "";
    const minCpu = +dom.procMinCpu?.value || 0;
    const minMem = +dom.procMinMem?.value || 0;
    const limit = clamp(parseInt(dom.procLimit?.value || "100", 10), 1, 1000);
    if (dom.procLimit) dom.procLimit.value = String(limit);

    const body = dom.procTable.tBodies[0];
    const list = rows.filter((r) => {
      if (user && r.dataset.user !== user) return false;
      if ((+r.dataset.cpu || 0) < minCpu) return false;
      if ((+r.dataset.mem || 0) < minMem) return false;
      return true;
    });

    list.sort((a, b) => {
      if (sort === "mem") return (+b.dataset.mem || 0) - (+a.dataset.mem || 0);
      if (sort === "pid") return (+a.dataset.pid || 0) - (+b.dataset.pid || 0);
      if (sort === "time") return parseHms(b.cells[8]?.textContent) - parseHms(a.cells[8]?.textContent);
      return (+b.dataset.cpu || 0) - (+a.dataset.cpu || 0);
    });

    const shown = list.slice(0, limit);
    shown.forEach((r) => body.appendChild(r));
    rows.forEach((r) => r.classList.add("hidden"));
    shown.forEach((r) => r.classList.remove("hidden"));

    let cpu = 0, mem = 0;
    const st = { R: 0, S: 0, Z: 0, T: 0 };
    shown.forEach((r) => {
      cpu += +r.dataset.cpu || 0;
      mem += +r.dataset.mem || 0;
      const s = (r.cells[6]?.textContent || "").trim();
      const k = s.startsWith("R") ? "R" : s.startsWith("Z") ? "Z" : s.startsWith("T") ? "T" : "S";
      st[k] += 1;
    });
    const top = shown[0];
    txt(dom.procRowsMeta, `${shown.length} 件表示`);
    txt(dom.procKpiTotal, String(shown.length));
    txt(dom.procKpiCpu, `${cpu.toFixed(1)}%`);
    txt(dom.procKpiMem, `${mem.toFixed(1)}%`);
    txt(dom.procKpiStates, `R:${st.R} / S:${st.S}`);
    if (dom.procCpuBar) dom.procCpuBar.style.width = `${clamp(cpu, 0, 100).toFixed(1)}%`;
    if (dom.procMemBar) dom.procMemBar.style.width = `${clamp(mem, 0, 100).toFixed(1)}%`;
    txt(dom.procTotalValue, String(shown.length));
    txt(dom.topCpuValue, `${(+top?.dataset.cpu || 0).toFixed(1)}%`);

    const selected = shown.find((r) => r.dataset.pid === state.selectedPid) || shown[0];
    if (selected) selectProcess(selected);

    const dashCpu = clamp(cpu + rand(-2, 2), 1, 98);
    const dashMem = clamp(mem + rand(-3, 3) + 18, 10, 98);
    txt(dom.cpuUsageValue, `${dashCpu.toFixed(1)}%`);
    txt(dom.memUsageValue, `${dashMem.toFixed(1)}%`);
    if (dom.cpuUsageBar) dom.cpuUsageBar.style.width = `${dashCpu.toFixed(1)}%`;
    if (dom.memUsageBar) dom.memUsageBar.style.width = `${dashMem.toFixed(1)}%`;
  }

  function renderProcessesTableFromApi(data) {
    const body = dom.procTable?.tBodies?.[0];
    if (!body) return;
    const rows = Array.isArray(data?.processes) ? data.processes : [];
    body.innerHTML = "";
    const frag = document.createDocumentFragment();
    rows.forEach((p) => {
      const tr = document.createElement("tr");
      tr.dataset.procRow = "";
      tr.dataset.user = p.user;
      tr.dataset.cpu = Number(p.cpu_percent || 0).toFixed(1);
      tr.dataset.mem = Number(p.mem_percent || 0).toFixed(1);
      tr.dataset.pid = String(p.pid);
      tr.innerHTML =
        `<td class="mono">${escHtml(p.pid)}</td>` +
        `<td>${escHtml(p.user)}</td>` +
        `<td data-proc-cpu>${Number(p.cpu_percent || 0).toFixed(1)}</td>` +
        `<td data-proc-mem>${Number(p.mem_percent || 0).toFixed(1)}</td>` +
        `<td>${fmtInt(p.vsz)}</td>` +
        `<td>${fmtInt(p.rss)}</td>` +
        `<td><span class="chip chip-outline mono">${escHtml(p.stat || "S")}</span></td>` +
        `<td class="mono">${escHtml(p.start || "")}</td>` +
        `<td class="mono">${escHtml(p.time || "00:00:00")}</td>` +
        `<td class="mono truncate-cell">${escHtml(p.command || "")}</td>`;
      frag.appendChild(tr);
    });
    body.appendChild(frag);

    const cpu = rows.reduce((s, p) => s + Number(p.cpu_percent || 0), 0);
    const mem = rows.reduce((s, p) => s + Number(p.mem_percent || 0), 0);
    const states = { R: 0, S: 0, Z: 0, T: 0 };
    rows.forEach((p) => {
      const st = String(p.stat || "");
      const k = st.startsWith("R") ? "R" : st.startsWith("Z") ? "Z" : st.startsWith("T") ? "T" : "S";
      states[k] += 1;
    });
    txt(dom.procRowsMeta, `${rows.length} 件表示`);
    txt(dom.procKpiTotal, String(rows.length));
    txt(dom.procKpiCpu, `${cpu.toFixed(1)}%`);
    txt(dom.procKpiMem, `${mem.toFixed(1)}%`);
    txt(dom.procKpiStates, `R:${states.R} / S:${states.S}`);
    if (dom.procCpuBar) dom.procCpuBar.style.width = `${clamp(cpu, 0, 100).toFixed(1)}%`;
    if (dom.procMemBar) dom.procMemBar.style.width = `${clamp(mem, 0, 100).toFixed(1)}%`;
    txt(dom.procTotalValue, String(rows.length));
    txt(dom.topCpuValue, `${Number(rows[0]?.cpu_percent || 0).toFixed(1)}%`);
    const rowEls = getProcRows();
    if (rowEls[0]) selectProcess(rowEls.find((r) => r.dataset.pid === state.selectedPid) || rowEls[0]);
    const dashCpu = clamp(cpu + rand(-1.5, 1.5), 1, 98);
    const dashMem = clamp(mem + rand(-2.0, 2.0) + 18, 10, 98);
    txt(dom.cpuUsageValue, `${dashCpu.toFixed(1)}%`);
    txt(dom.memUsageValue, `${dashMem.toFixed(1)}%`);
    if (dom.cpuUsageBar) dom.cpuUsageBar.style.width = `${dashCpu.toFixed(1)}%`;
    if (dom.memUsageBar) dom.memUsageBar.style.width = `${dashMem.toFixed(1)}%`;
  }

  function selectProcess(row) {
    state.selectedPid = row.dataset.pid || null;
    getProcRows().forEach((r) => {
      r.style.outline = "";
      r.removeAttribute("aria-selected");
    });
    row.style.outline = "2px solid #b7d7f7";
    row.style.outlineOffset = "-2px";
    row.setAttribute("aria-selected", "true");
    const cmd = (row.cells[9]?.textContent || "").trim();
    const user = row.dataset.user || "";
    const stat = (row.cells[6]?.textContent || "").trim();
    txt(dom.procDetailName, procName(cmd, user));
    txt(dom.procDetailId, `${row.dataset.pid || "-"} / ${user}`);
    txt(dom.procDetailStat, stat);
    txt(dom.procDetailCpu, (+row.dataset.cpu || 0).toFixed(1));
    txt(dom.procDetailMem, (+row.dataset.mem || 0).toFixed(1));
    txt(dom.procDetailStateText, stat.startsWith("R") ? "Running" : stat.startsWith("Z") ? "Zombie" : stat.startsWith("T") ? "Stopped/Traced" : "Sleeping");
    txt(dom.procDetailCwd, procCwd(cmd, user));
    txt(dom.procDetailCmd, cmd);
  }

  function procName(cmd, user) {
    if (cmd.includes("postgres")) return "postgres";
    if (cmd.includes("redis")) return "redis";
    if (cmd.includes("nginx")) return "nginx";
    return (cmd.split(" ")[0].split("/").pop() || user || "-");
  }

  function procCwd(cmd, user) {
    if (cmd.includes("postgres")) return "/var/lib/postgresql";
    if (cmd.includes("uvicorn")) return "/opt/linux-management";
    if (cmd.includes("scheduler.py")) return "/opt/linux-management/jobs";
    if (cmd.includes("nginx")) return "/var/www";
    if (user === "root") return "/root";
    return `/home/${user || "user"}`;
  }

  function renderServicePreview(name = state.selectedService) {
    if (!state.services[name]) name = "nginx";
    state.selectedService = name;
    const svc = state.services[name];
    txt(dom.servicePreviewTitle, svc.title);
    txt(dom.servicePreviewName, name);
    renderTerminal(dom.serviceLogPreview, svc.logs.slice(-6));
    qsa("[data-service-select]").forEach((b) => {
      const on = b.dataset.serviceSelect === name;
      b.style.outline = on ? "2px solid #d8e8fb" : "";
      b.style.outlineOffset = on ? "2px" : "";
    });
  }

  async function restartService(name) {
    const chip = document.querySelector(`[data-service-status="${escSel(name)}"]`);
    if (!RESTART_ALLOW.has(name)) {
      statusChip(chip, "denied");
      addSvcLog(name, `${name}: restart denied (allowlist)`);
      toast(`再起動拒否: ${name} は allowlist 外です。`, "error");
      setTimeout(() => statusChip(chip, "active"), 1200);
      void renderLogs();
      renderServicePreview(name);
      return;
    }

    // Try live API first, fallback to mock behavior
    if (state.session && state.api) {
      statusChip(chip, "restarting");
      try {
        const live = await state.api.tryLive(
          () => state.api.api.services.restart(name),
          { op: "services.restart" }
        );
        if (live.live && live.data) {
          const normalized = normalizeServiceRestartPayload(live.data);
          statusChip(chip, normalized.current_status || "active");
          addSvcLog(name, `${name}: ${normalized.message || "restart completed"}`);
          toast(normalized.message || `${name} を再起動しました。`, "success");
          void renderLogs();
          renderServicePreview(name);
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") {
          statusChip(chip, "active");
          toast(explainApiError(err).message, "error");
          return;
        }
      }
    }

    statusChip(chip, "restarting");
    addSvcLog(name, `${name}: restart requested`);
    toast(`${name} を再起動しました（モック）。`, "success");
    setTimeout(() => {
      statusChip(chip, "active");
      addSvcLog(name, `${name}: restart completed`);
      const cpuCell = document.querySelector(`[data-service-cpu="${escSel(name)}"]`);
      if (cpuCell) {
        const v = clamp((+String(cpuCell.textContent).replace("%", "") || 0) + rand(0.2, 1.8), 0, 99);
        cpuCell.textContent = `${v.toFixed(1)}%`;
      }
      void renderLogs();
      renderServicePreview(name);
    }, 900);
  }

  function addSvcLog(name, line) {
    const t = new Date().toLocaleTimeString("ja-JP", { hour12: false });
    const entry = `Feb 24 ${t} ${line}`;
    if (state.services[name]) {
      state.services[name].logs.push(entry);
      if (state.services[name].logs.length > 200) state.services[name].logs.shift();
    }
    if (name !== "linux-management-prod" && state.services["linux-management-prod"]) {
      state.services["linux-management-prod"].logs.push(`Feb 24 ${t} api: ${line}`);
    }
  }

  async function renderLogs() {
    const svc = dom.logsService?.value || state.selectedService || "nginx";
    const max = clamp(parseInt(dom.logsLines?.value || "100", 10), 1, 1000);
    const q = (dom.logsQ?.value || "").trim().toLowerCase();
    if (state.session && state.api) {
      try {
        const live = await state.api.tryLive(
          () => state.api.api.logs.get(svc, { lines: max, q: q || undefined }),
          { op: "logs.get" }
        );
        if (live.live && live.data) {
          const normalized = normalizeLogsPayload(live.data);
          const lines = (normalized.logs || []).filter((l) => !q || l.toLowerCase().includes(q)).slice(-max);
          renderTerminal(dom.logsTerminal, lines.length ? lines : ["(no log lines matched filters)"]);
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") toast(explainApiError(err).message, "error");
      }
    }
    const src = [...(state.services[svc]?.logs || [])];
    const lines = src.filter((l) => !q || l.toLowerCase().includes(q)).slice(-max);
    renderTerminal(dom.logsTerminal, lines.length ? lines : ["(no log lines matched filters)"]);
  }

  function filterAudit() {
    const op = dom.auditOp?.value || "all";
    const st = dom.auditStatus?.value || "all";
    const q = (dom.auditQ?.value || "").trim().toLowerCase();
    qsa("tr[data-audit-row]", dom.auditTable).forEach((r) => {
      const ok = (op === "all" || r.dataset.op === op)
        && (st === "all" || r.dataset.status === st)
        && (!q || (r.textContent || "").toLowerCase().includes(q));
      r.classList.toggle("hidden", !ok);
    });
  }

  function filterUsersGroups() {
    const uq = (dom.usersSearch?.value || "").trim().toLowerCase();
    const us = dom.usersStatus?.value || "all";
    const gq = (dom.groupsSearch?.value || "").trim().toLowerCase();
    qsa("tr[data-user-row]", dom.usersTable).forEach((r) => {
      const ok = (!uq || (r.textContent || "").toLowerCase().includes(uq))
        && (us === "all" || r.dataset.userStatus === us);
      r.classList.toggle("hidden", !ok);
    });
    qsa("tr[data-group-row]", dom.groupsTable).forEach((r) => {
      const t = (r.textContent || "").toLowerCase();
      const ok = !gq || t.includes(gq) || (r.dataset.groupName || "").toLowerCase().includes(gq);
      r.classList.toggle("hidden", !ok);
    });
  }

  async function loadCronFromApi() {
    if (!state.session || !state.api || !dom.cronTable) return;
    try {
      const live = await state.api.tryLive(() => state.api.api.cron.list(), { op: "cron.list" });
      if (!live.live || !live.data) return;
      try {
        const normalized = normalizeCronListPayload(live.data);
        renderCronTableFromApi(normalized);
      } catch (err) {
        console.warn("[webui-sample] cron adapter fallback", err);
      }
    } catch (err) {
      if (state.api.settings.mode === "live") toast(explainApiError(err).message, "error");
    }
  }

  function renderCronTableFromApi(data) {
    const body = dom.cronTable?.tBodies?.[0];
    if (!body) return;
    const jobs = data.jobs || [];
    body.innerHTML = "";
    const frag = document.createDocumentFragment();
    jobs.forEach((job) => {
      const tr = document.createElement("tr");
      tr.dataset.cronId = job.id;
      tr.innerHTML =
        `<td class="mono">${escHtml(job.id)}</td>` +
        `<td>${escHtml(job.owner || "")}</td>` +
        `<td><div class="mono">${escHtml(job.schedule)}</div><div class="muted small">${escHtml(job.schedule_human || "")}</div></td>` +
        `<td><div class="mono">${escHtml(job.command)}</div><div class="muted small truncate-cell">${escHtml(job.arguments || "-")}</div></td>` +
        `<td><span class="chip ${job.enabled ? "chip-success" : "chip-muted"}" data-cron-status>${job.enabled ? "Active" : "Disabled"}</span></td>` +
        `<td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-cron-toggle="${escHtml(job.id)}">[T]</button><button class="btn btn-mini btn-danger-soft" data-open-modal="cron-delete" data-cron-id="${escHtml(job.id)}">[D]</button></div></td>`;
      frag.appendChild(tr);
    });
    body.appendChild(frag);
  }

  async function loadUsersFromApi() {
    if (!state.session || !state.api) return;
    const [usersRes, groupsRes] = await Promise.allSettled([
      state.api.tryLive(() => state.api.api.users.list(), { op: "users.list" }),
      state.api.tryLive(() => state.api.api.users.listGroups(), { op: "groups.list" }),
    ]);
    if (usersRes.status === "fulfilled" && usersRes.value.live && usersRes.value.data) {
      try { renderUsersTableFromApi(normalizeUsersListPayload(usersRes.value.data)); } catch (err) { console.warn(err); }
    }
    if (groupsRes.status === "fulfilled" && groupsRes.value.live && groupsRes.value.data) {
      try { renderGroupsTableFromApi(normalizeGroupsListPayload(groupsRes.value.data)); } catch (err) { console.warn(err); }
    }
    if (state.api.settings.mode === "live") {
      if (usersRes.status === "rejected") toast(explainApiError(usersRes.reason).message, "error");
      if (groupsRes.status === "rejected") toast(explainApiError(groupsRes.reason).message, "error");
    }
    filterUsersGroups();
  }

  function renderUsersTableFromApi(data) {
    const body = dom.usersTable?.tBodies?.[0];
    if (!body) return;
    const users = data.users || [];
    body.innerHTML = "";
    const frag = document.createDocumentFragment();
    users.forEach((u) => {
      const tr = document.createElement("tr");
      tr.dataset.userRow = "";
      tr.dataset.userName = u.username;
      tr.dataset.userStatus = u.locked ? "locked" : "active";
      tr.dataset.userGroups = (u.groups || []).join(" ");
      tr.innerHTML =
        `<td><strong>${escHtml(u.username)}</strong></td>` +
        `<td class="mono">${escHtml(u.uid)}</td>` +
        `<td>${(u.groups || []).map((g) => `<span class="chip chip-outline">${escHtml(g)}</span>`).join(" ") || '<span class="muted">-</span>'}</td>` +
        `<td class="mono">${escHtml(u.home || "")}</td>` +
        `<td class="mono">${escHtml(u.shell || "")}</td>` +
        `<td><span class="chip ${u.locked ? "chip-muted" : "chip-success"}">${u.locked ? "Locked" : "Active"}</span></td>` +
        `<td>${escHtml(u.last_login || "-")}</td>` +
        `<td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-quick-approval="user_passwd" data-target-name="${escHtml(u.username)}">PW変更申請</button><button class="btn btn-mini btn-danger-soft" data-quick-approval="user_delete" data-target-name="${escHtml(u.username)}">削除申請</button></div></td>`;
      frag.appendChild(tr);
    });
    body.appendChild(frag);
  }

  function renderGroupsTableFromApi(data) {
    const body = dom.groupsTable?.tBodies?.[0];
    if (!body) return;
    const groups = data.groups || [];
    body.innerHTML = "";
    const frag = document.createDocumentFragment();
    groups.forEach((g) => {
      const tr = document.createElement("tr");
      tr.dataset.groupRow = "";
      tr.dataset.groupName = g.group;
      const riskClass = g.risk === "CRITICAL" ? "chip-critical" : g.risk === "HIGH" ? "chip-high" : g.risk === "MEDIUM" ? "chip-medium" : "chip-low";
      const action = g.members?.length
        ? `<button class="btn btn-mini btn-soft" data-quick-approval="group_modify" data-target-name="${escHtml(g.group)}">メンバー変更申請</button>`
        : `<button class="btn btn-mini btn-danger-soft" data-quick-approval="group_delete" data-target-name="${escHtml(g.group)}">削除申請</button>`;
      tr.innerHTML =
        `<td><strong>${escHtml(g.group)}</strong></td>` +
        `<td class="mono">${escHtml(g.gid)}</td>` +
        `<td>${(g.members || []).length ? g.members.map((m) => `<span class="chip chip-outline">${escHtml(m)}</span>`).join(" ") : '<span class="muted">No members</span>'}</td>` +
        `<td><span class="chip chip-risk ${riskClass}">${escHtml(g.risk || "LOW")}</span></td>` +
        `<td>${action}</td>`;
      frag.appendChild(tr);
    });
    body.appendChild(frag);
  }

  function renderTerminal(el, lines) {
    if (!el) return;
    el.innerHTML = "";
    const f = document.createDocumentFragment();
    (lines || []).forEach((l) => {
      const d = document.createElement("div");
      d.textContent = l;
      f.appendChild(d);
    });
    el.appendChild(f);
  }

  function statusChip(el, status) {
    if (!el) return;
    const s = String(status || "").toLowerCase();
    el.textContent = s;
    el.classList.remove("chip-success", "chip-warning", "chip-danger", "chip-muted", "chip-outline");
    if (["active", "approved", "executed", "success"].includes(s)) el.classList.add("chip-success");
    else if (["pending", "attempt", "restarting"].includes(s)) el.classList.add("chip-warning");
    else if (["rejected", "denied", "failure", "execution_failed"].includes(s)) el.classList.add("chip-danger");
    else if (["expired", "cancelled", "disabled"].includes(s)) el.classList.add("chip-muted");
    else el.classList.add("chip-outline");
  }

  function riskChip(el, risk) {
    if (!el) return;
    const r = String(risk || "MEDIUM").toUpperCase();
    el.textContent = r;
    el.className = "chip chip-risk";
    el.classList.add(r === "CRITICAL" ? "chip-critical" : r === "HIGH" ? "chip-high" : r === "MEDIUM" ? "chip-medium" : "chip-low");
  }

  function toast(msg, tone = "info", ms = 2600) {
    if (!dom.toastStack) return;
    const n = document.createElement("div");
    n.className = `toast toast-${tone}`;
    n.textContent = msg;
    dom.toastStack.appendChild(n);
    requestAnimationFrame(() => n.classList.add("show"));
    setTimeout(() => { n.classList.remove("show"); setTimeout(() => n.remove(), 220); }, ms);
  }
  function onClick(e) {
    const t = e.target;
    const accBtn = t.closest("[data-accordion-toggle]");
    if (accBtn) {
      e.preventDefault();
      const acc = accBtn.closest(".accordion");
      acc?.classList.toggle("expanded");
      syncAccordion(acc, accBtn);
      return;
    }

    const tab = t.closest(".tab[data-tab-group][data-tab-id]");
    if (tab) {
      e.preventDefault();
      activateTab(tab.dataset.tabGroup, tab.dataset.tabId);
      return;
    }

    const draftReset = t.closest("[data-approval-draft-reset]");
    if (draftReset) {
      e.preventDefault();
      openDraftReset();
      toast("承認リクエストのテンプレートを再読込しました。", "info");
      return;
    }

    const nav = t.closest("[data-scroll-target]");
    if (nav) {
      e.preventDefault();
      activateSection(nav.dataset.scrollTarget, true);
      if (window.innerWidth <= 1024) setSidebar(false);
      return;
    }

    const open = t.closest("[data-open-modal]");
    if (open && !open.disabled) {
      e.preventDefault();
      openModalByName(open.dataset.openModal, open);
      return;
    }

    if (dom.modalLayer?.classList.contains("active")) {
      const close = t.closest("[data-close-modal]");
      if (close) { e.preventDefault(); closeModal(); return; }
      const ok = t.closest("#confirmOkBtn");
      if (ok) {
        e.preventDefault();
        const fn = state.confirmFn;
        closeModal();
        state.confirmFn = null;
        if (typeof fn === "function") fn();
        return;
      }
    }

    const svcSel = t.closest("[data-service-select]");
    if (svcSel) {
      e.preventDefault();
      renderServicePreview(svcSel.dataset.serviceSelect);
      if (dom.logsService) dom.logsService.value = svcSel.dataset.serviceSelect;
      void renderLogs();
      return;
    }

    const svcRestart = t.closest("[data-service-restart]");
    if (svcRestart) { e.preventDefault(); void restartService(svcRestart.dataset.serviceRestart); return; }

    const procBtn = t.closest("#procRefreshBtn");
    if (procBtn) { e.preventDefault(); void refreshProcesses(true); toast("プロセス一覧を再取得しました。", "info"); return; }

    const autoBtn = t.closest("#procAutoBtn");
    if (autoBtn) {
      e.preventDefault();
      const on = autoBtn.dataset.procAuto !== "on";
      if (state.procAuto) { clearInterval(state.procAuto); state.procAuto = null; }
      if (on) {
        state.procAuto = setInterval(() => state.session && void refreshProcesses(true), PROC_AUTO_MS);
        autoBtn.dataset.procAuto = "on";
        autoBtn.textContent = "■ Auto-refresh (5s)";
        toast("プロセス自動更新を開始しました。", "info");
      } else {
        autoBtn.dataset.procAuto = "off";
        autoBtn.textContent = "▶ Auto-refresh (5s)";
        toast("プロセス自動更新を停止しました。", "warning");
      }
      return;
    }

    const pRow = t.closest("tr[data-proc-row]");
    if (pRow && dom.procTable?.contains(pRow)) { selectProcess(pRow); return; }

    const apSel = t.closest("[data-approval-select]");
    if (apSel) {
      e.preventDefault();
      selectApproval(apSel.dataset.approvalSelect);
      if (!apSel.closest("#sec-approvals")) activateSection("sec-approvals", true);
      return;
    }

    const cronToggle = t.closest("[data-cron-toggle]");
    if (cronToggle) {
      e.preventDefault();
      const id = cronToggle.dataset.cronToggle;
      openConfirm(`Cronジョブ ${id} の有効/無効切替申請を作成しますか？`, () => {
        void submitCronToggleRequest(id, cronToggle.closest("tr"));
      });
      return;
    }

    const quick = t.closest("[data-quick-approval]");
    if (quick) {
      e.preventDefault();
      const typ = quick.dataset.quickApproval || "user_add";
      const target = quick.dataset.targetName || "";
      if ([...dom.approvalDraftType.options].some((o) => o.value === typ)) {
        dom.approvalDraftType.value = typ;
        applyDraftDefaults();
        if (target) qsa("[data-approval-field]", dom.approvalDraftFields).forEach((i) => {
          if (typ.startsWith("user_") && i.dataset.approvalField === "username") i.value = target;
          if (typ.startsWith("group_") && i.dataset.approvalField === "group") i.value = target;
        });
        if (dom.approvalDraftReason) dom.approvalDraftReason.value = `${(APPROVAL_META[typ] || { label: typ }).label} のため ${target} を対象に申請します。`;
        renderDraftPreview();
        activateTab("approvals", "ap-create", false);
        activateSection("sec-approvals", true);
      } else {
        const rec = createApproval({ type: typ, reason: `${(APPROVAL_META[typ] || { label: typ }).label} 申請: ${target}`, payload: typ.startsWith("group_") ? { group: target } : { username: target } });
        addApprovalRows(rec);
        syncApprovalUI();
        activateSection("sec-approvals", true);
        toast(`クイック申請を作成しました: ${rec.id}`, "success");
      }
      return;
    }

    const exp = t.closest("[data-export]");
    if (exp) { e.preventDefault(); toast(`エクスポート（${exp.dataset.export.toUpperCase()}）を開始（モック）`, "info"); return; }
    const save = t.closest("[data-action='settings-save']");
    if (save) { e.preventDefault(); toast("監査ログ設定を保存しました（モック）。", "success"); return; }
  }

  function onInput(e) {
    const id = e.target.id;
    if (["procMinCpu", "procMinMem", "procLimit"].includes(id)) return refreshProcesses(false);
    if (["usersSearch", "groupsSearch"].includes(id)) return filterUsersGroups();
    if (["logsQ"].includes(id)) return renderLogs();
    if (["auditQ"].includes(id)) return filterAudit();
    if (e.target.closest("#approvalDraftFields") || id === "approvalDraftReason") return renderDraftPreview();
  }

  function onChange(e) {
    const id = e.target.id;
    if (["procSort", "procUser", "procMinCpu", "procMinMem", "procLimit"].includes(id)) return refreshProcesses(false);
    if (["logsService", "logsLines"].includes(id)) return renderLogs();
    if (["usersStatus"].includes(id)) return filterUsersGroups();
    if (["auditOp", "auditStatus"].includes(id)) return filterAudit();
    if (["approvalPendingType", "approvalPendingRequester", "approvalMyStatus", "approvalHistoryStatus", "approvalPeriod"].includes(id)) {
      syncApprovalUI(id === "approvalPeriod");
      void refreshApprovalsFromApi();
      return;
    }
    if (id === "approvalDraftType") { applyDraftDefaults(); renderDraftPreview(); return; }
    if (id === "cronPresetSelect") {
      const f = e.target.closest("form");
      const inp = f?.querySelector('input[name="schedule"]');
      if (inp) inp.value = e.target.value;
    }
  }

  function onSubmit(e) {
    const form = e.target;
    if (!(form instanceof HTMLFormElement)) return;
    if (form.id === "loginForm") return;
    const kind = form.dataset.form;
    if (!kind) return;
    e.preventDefault();
    if (kind === "approval-draft") return void submitDraft(form);
    if (kind === "cron-add") return void submitCronAdd(form);
    if (kind === "user-add") return void submitUserAdd(form);
    if (kind === "service-stop") return void submitServiceStop(form);
    if (kind === "approval-action") return void submitApprovalAction(form);
  }

  async function refreshApprovalsFromApi() {
    if (!state.session || !state.api) return;
    const pendingParams = {};
    if ((dom.approvalPendingType?.value || "all") !== "all") pendingParams.request_type = dom.approvalPendingType.value;
    if ((dom.approvalPendingRequester?.value || "all") !== "all") pendingParams.requester_id = dom.approvalPendingRequester.value;

    const myParams = {};
    if ((dom.approvalMyStatus?.value || "all") !== "all") myParams.status = dom.approvalMyStatus.value;

    const historyParams = { period: dom.approvalPeriod?.value || "30d" };
    if ((dom.approvalHistoryStatus?.value || "all") !== "all") historyParams.status = dom.approvalHistoryStatus.value;

    const [pendingRes, myRes, histRes] = await Promise.allSettled([
      state.api.tryLive(() => state.api.api.approvals.pending(pendingParams), { op: "approval.pending" }),
      state.api.tryLive(() => state.api.api.approvals.myRequests(myParams), { op: "approval.my" }),
      state.api.tryLive(() => state.api.api.approvals.history(historyParams), { op: "approval.history" }),
    ]);

    if (pendingRes.status === "fulfilled" && pendingRes.value.live && pendingRes.value.data) {
      applyPendingApprovalsFromApi(normalizeApprovalListPayload(pendingRes.value.data, "pending"));
    }
    if (myRes.status === "fulfilled" && myRes.value.live && myRes.value.data) {
      applyMyApprovalsFromApi(normalizeApprovalListPayload(myRes.value.data, "my"));
    }
    if (histRes.status === "fulfilled" && histRes.value.live && histRes.value.data) {
      applyApprovalHistoryFromApi(histRes.value.data);
    }

    if (state.api.settings.mode === "live") {
      if (pendingRes.status === "rejected") toast(explainApiError(pendingRes.reason).message, "error");
      if (myRes.status === "rejected") toast(explainApiError(myRes.reason).message, "error");
      if (histRes.status === "rejected") toast(explainApiError(histRes.reason).message, "error");
    }

    syncApprovalUI(false);
  }

  function applyPendingApprovalsFromApi(data) {
    const body = dom.approvalPendingTable?.tBodies?.[0];
    if (!body) return;
    body.innerHTML = "";
    (data.requests || []).forEach((r) => {
      upsertApprovalFromListItem(r, "pending");
      addPendingRow({
        id: r.id,
        type: r.request_type,
        requester: r.requester_name || r.requester_id || "unknown",
        status: "pending",
        risk: r.risk_level,
        reason: r.reason,
      }, {
        ttlText: Number.isFinite(r.remaining_hours) && r.remaining_hours > 0 ? `${r.remaining_hours.toFixed(1)}h 残` : "期限不明",
      });
    });
  }

  function applyMyApprovalsFromApi(data) {
    const body = dom.approvalMyTable?.tBodies?.[0];
    if (!body) return;
    body.innerHTML = "";
    (data.requests || []).forEach((r) => {
      upsertApprovalFromListItem(r, "my");
      addMyRow({
        id: r.id,
        type: r.request_type,
        requester: state.session?.username || "operator",
        status: r.status,
        risk: r.risk_level,
        reason: r.reason,
      }, { createdText: isoToUi(r.created_at) });
    });
  }

  function applyApprovalHistoryFromApi(payload) {
    const root = payload?.data ?? payload ?? {};
    const body = dom.approvalHistoryTable?.tBodies?.[0];
    if (!body) return;
    if (!Array.isArray(root.history)) return;
    const latestByReq = new Map();
    for (const item of root.history) {
      const reqId = String(item.approval_request_id || item.request_id || "");
      if (!reqId) continue;
      const prev = latestByReq.get(reqId);
      const ts = Date.parse(item.timestamp || 0) || 0;
      const prevTs = Date.parse(prev?.timestamp || 0) || 0;
      if (!prev || ts >= prevTs) latestByReq.set(reqId, item);
      if (!state.approvals[reqId]) {
        state.approvals[reqId] = {
          id: reqId,
          type: item.request_type || "unknown",
          requester: item.actor_name || "unknown",
          requesterRole: item.actor_role || "Operator",
          status: normalizeApprovalStatus(item.new_status || "pending"),
          risk: (APPROVAL_META[item.request_type] || { risk: "MEDIUM" }).risk,
          reason: "",
          payload: {},
          timeline: [],
        };
      }
    }
    body.innerHTML = "";
    [...latestByReq.values()]
      .sort((a, b) => (Date.parse(b.timestamp || 0) || 0) - (Date.parse(a.timestamp || 0) || 0))
      .forEach((item) => {
        const reqId = String(item.approval_request_id || item.request_id || "");
        const rec = state.approvals[reqId];
        if (rec) {
          rec.type = item.request_type || rec.type;
          rec.status = normalizeApprovalStatus(item.new_status || rec.status);
        }
        addHistoryRow({
          id: reqId,
          type: item.request_type || rec?.type || "unknown",
          requester: item.actor_name || rec?.requester || "-",
          status: normalizeApprovalStatus(item.new_status || rec?.status || "pending"),
        }, item.actor_name || "-", { timeText: isoToUi(item.timestamp) });
      });
  }

  function upsertApprovalFromListItem(item, source) {
    if (!item?.id) return;
    const current = state.approvals[item.id] || {
      id: item.id,
      type: item.request_type,
      requester: item.requester_name || "unknown",
      requesterRole: "Operator",
      status: "pending",
      risk: item.risk_level || "MEDIUM",
      reason: "",
      payload: {},
      timeline: [],
    };
    current.type = item.request_type || current.type;
    current.risk = item.risk_level || current.risk;
    current.reason = item.reason || current.reason;
    current.requester = item.requester_name || current.requester;
    if (item.status) current.status = normalizeApprovalStatus(item.status);
    if (!current.timeline?.length && item.created_at) current.timeline = [{ tone: "info", title: `created / ${current.requester}`, time: isoToUi(item.created_at) }];
    state.approvals[item.id] = current;
    if (source === "my" && item.approved_by_name) {
      current.approved_by = item.approved_by_name;
    }
  }

  async function loadApprovalDetailFromApi(id) {
    if (!state.session || !state.api || !id) return;
    const live = await state.api.tryLive(() => state.api.api.approvals.detail(id), { op: "approval.detail" });
    if (!live.live || !live.data) return;
    const d = normalizeApprovalDetailPayload(live.data);
    if (!d || !d.id) return;
    const rec = state.approvals[d.id] || { id: d.id, type: d.request_type, requester: d.requester_name || "unknown", requesterRole: "Operator", status: d.status, risk: d.risk_level, reason: d.reason, payload: {}, timeline: [] };
    rec.type = d.request_type;
    rec.risk = d.risk_level;
    rec.requester = d.requester_name || rec.requester;
    rec.reason = d.reason || rec.reason;
    rec.status = normalizeApprovalStatus(d.status);
    rec.payload = d.request_payload || rec.payload;
    rec.timeline = (d.history || []).map((h) => ({
      tone: h.action === "approved" || h.action === "executed" ? "success" : h.action === "rejected" || h.action === "cancelled" ? "warning" : "info",
      title: `${h.action} / ${h.actor_name || h.actor_id || "system"} (${h.actor_role || "-"})${h.details?.comment ? ` - ${h.details.comment}` : ""}${h.details?.reason ? ` - ${h.details.reason}` : ""}`,
      time: isoToUi(h.timestamp),
    }));
    state.approvals[d.id] = rec;
    renderApprovalDetail(rec);
  }

  function syncApprovalUI(periodToast) {
    syncApprovalRows();
    const tp = dom.approvalPendingType?.value || "all";
    const rq = dom.approvalPendingRequester?.value || "all";
    qsa("tr[data-approval-row]", dom.approvalPendingTable).forEach((r) => {
      const rec = state.approvals[rowApId(r)];
      const ok = rec && rec.status === "pending"
        && (tp === "all" || rec.type === tp)
        && (rq === "all" || rec.requester === rq);
      r.classList.toggle("hidden", !ok);
    });
    const ms = dom.approvalMyStatus?.value || "all";
    qsa("tr[data-my-approval-row]", dom.approvalMyTable).forEach((r) => {
      const rec = state.approvals[rowApId(r)];
      const ok = rec && (ms === "all" || rec.status === ms);
      r.classList.toggle("hidden", !ok);
    });
    const hs = dom.approvalHistoryStatus?.value || "all";
    qsa("tr[data-history-row]", dom.approvalHistoryTable).forEach((r) => {
      const rec = state.approvals[rowApId(r)];
      const st = rec?.status || r.dataset.historyStatus;
      r.classList.toggle("hidden", !(hs === "all" || st === hs));
    });
    txt(dom.pendingCountValue, String(Object.values(state.approvals).filter((a) => a.status === "pending").length));
    renderDraftPreview();
    const curId = (dom.approvalDetailId?.textContent || "").trim();
    if (curId && state.approvals[curId]) renderApprovalDetail(state.approvals[curId]);
    if (periodToast) toast(`承認履歴期間を ${dom.approvalPeriod.value} に変更`, "info");
  }

  function syncApprovalRows() {
    qsa("tr[data-approval-row], tr[data-my-approval-row], tr[data-history-row]").forEach((r) => {
      const id = rowApId(r);
      const rec = state.approvals[id];
      if (!rec) return;
      if (r.dataset.approvalRow !== undefined) r.dataset.approvalStatus = rec.status;
      if (r.dataset.myApprovalRow !== undefined) r.dataset.approvalStatus = rec.status;
      if (r.dataset.historyRow !== undefined) r.dataset.historyStatus = rec.status;
      const chip = r.querySelector(".approval-status-chip")
        || (r.dataset.myApprovalRow !== undefined ? r.querySelector("td:nth-child(3) .chip") : null)
        || (r.dataset.historyRow !== undefined ? r.querySelector("td:nth-child(5) .chip") : null);
      if (chip) statusChip(chip, rec.status);
      const lastTd = r.querySelector("td:last-child");
      if (lastTd && (r.dataset.approvalRow !== undefined || r.dataset.myApprovalRow !== undefined)) {
        if (rec.status === "pending" && r.dataset.myApprovalRow !== undefined) {
          lastTd.innerHTML = `<button class="btn btn-mini btn-danger-soft" data-open-modal="approval-action" data-approval-op="cancel" data-approval-id="${escHtml(id)}">キャンセル</button>`;
        } else if (rec.status !== "pending" && r.dataset.approvalRow !== undefined) {
          lastTd.innerHTML = `<button class="btn btn-mini btn-soft" data-approval-select="${escHtml(id)}">詳細</button>`;
        } else if (rec.status !== "pending" && r.dataset.myApprovalRow !== undefined) {
          lastTd.innerHTML = `<button class="btn btn-mini btn-soft" data-approval-select="${escHtml(id)}">詳細</button>`;
        }
      }
    });
  }

  function rowApId(row) {
    return row.dataset.approvalId || row.querySelector("[data-approval-select]")?.dataset.approvalSelect || row.cells?.[0]?.textContent?.trim() || "";
  }

  function selectApproval(id) {
    const rec = state.approvals[id];
    if (!rec) return;
    renderApprovalDetail(rec);
    void loadApprovalDetailFromApi(id);
    qsa("[data-approval-select]").forEach((b) => {
      const on = b.dataset.approvalSelect === id;
      b.style.outline = on ? "2px solid #d8e8fb" : "";
      b.style.outlineOffset = on ? "2px" : "";
    });
  }

  function renderApprovalDetail(rec) {
    txt(dom.approvalDetailTitle, (APPROVAL_META[rec.type] || { label: rec.type }).label);
    txt(dom.approvalDetailId, rec.id);
    statusChip(dom.approvalDetailStatus, rec.status);
    riskChip(dom.approvalDetailRisk, rec.risk);
    txt(dom.approvalDetailRequesterRole, rec.requesterRole);
    txt(dom.approvalDetailRequester, `${rec.requester} (user_${Math.abs(hash(rec.requester)).toString().slice(0, 3)})`);
    txt(dom.approvalDetailReason, rec.reason);
    txt(dom.approvalDetailPayload, JSON.stringify(rec.payload || {}, null, 2));
    renderTimeline(dom.approvalDetailTimeline, rec.timeline || []);
  }

  function renderTimeline(el, items) {
    if (!el) return;
    el.innerHTML = "";
    const f = document.createDocumentFragment();
    items.forEach((it) => {
      const row = document.createElement("div");
      row.className = "timeline-item";
      row.innerHTML = `<div class="timeline-dot ${it.tone || "info"}"></div><div><div class="timeline-title">${escHtml(it.title || "")}</div><div class="timeline-text">${escHtml(it.time || "")}</div></div>`;
      f.appendChild(row);
    });
    el.appendChild(f);
  }

  function applyDraftDefaults() {
    const type = dom.approvalDraftType?.value || "user_add";
    const defs = {
      user_add: { username: "newuser", group: "developers", home: "/home/newuser", shell: "/bin/bash" },
      user_delete: { username: "tempstaff" },
      cron_add: { schedule: "0 2 * * *", command: "/usr/bin/rsync" },
      cron_modify: { schedule: "*/10 * * * *", command: "/usr/local/bin/healthcheck.sh" },
      service_stop: { service: "nginx" },
      group_modify: { group: "developers" },
      group_delete: { group: "legacyops" },
      user_passwd: { username: "kensan" },
      firewall_modify: { rule: "allow tcp/443" },
    }[type] || {};
    qsa("[data-approval-field]", dom.approvalDraftFields).forEach((i) => { i.value = defs[i.dataset.approvalField] || ""; });
    if (dom.approvalDraftReason) dom.approvalDraftReason.value = `${(APPROVAL_META[type] || { label: type }).label} のため承認を依頼します。`;
  }

  function draftPayload() {
    const p = {};
    qsa("[data-approval-field]", dom.approvalDraftFields).forEach((i) => {
      const v = (i.value || "").trim();
      if (v) p[i.dataset.approvalField] = v;
    });
    return p;
  }

  function renderDraftPreview() {
    if (!dom.approvalDraftType) return;
    const type = dom.approvalDraftType.value;
    const meta = APPROVAL_META[type] || { risk: "MEDIUM", roles: "Approver", timeout: "24h" };
    txt(dom.approvalPreviewType, type);
    riskChip(dom.approvalPreviewRisk, meta.risk);
    txt(dom.approvalPreviewRoles, meta.roles);
    txt(dom.approvalPreviewTimeout, meta.timeout);
    txt(dom.approvalPreviewPayload, JSON.stringify(draftPayload(), null, 2));
  }

  async function submitDraft() {
    const type = dom.approvalDraftType?.value || "user_add";
    const reason = (dom.approvalDraftReason?.value || "").trim();
    if (reason.length < 5) return toast("申請理由は5文字以上で入力してください。", "error");
    const payload = draftPayload();
    if (state.session && state.api) {
      try {
        const live = await state.api.tryLive(
          () => state.api.api.approvals.create({ request_type: type, payload, reason }),
          { op: "approval.request" }
        );
        if (live.live && live.data) {
          const resp = live.data?.data ?? live.data;
          const rec = createApproval({ type, reason, payload, forceId: resp.request_id || undefined });
          if (resp.risk_level) rec.risk = resp.risk_level;
          addApprovalRows(rec);
          syncApprovalUI();
          activateTab("approvals", "ap-my", false);
          selectApproval(rec.id);
          void refreshApprovalsFromApi();
          toast(resp.message || `承認リクエストを作成しました: ${rec.id}`, "success");
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") { toast(explainApiError(err).message, "error"); return; }
      }
    }
    const rec = createApproval({ type, reason, payload });
    addApprovalRows(rec);
    syncApprovalUI();
    activateTab("approvals", "ap-my", false);
    selectApproval(rec.id);
    toast(`承認リクエストを作成しました: ${rec.id}`, "success");
  }

  function createApproval({ type, reason, payload, forceId }) {
    const id = forceId || `apr-${state.nextApprovalId++}`;
    if (forceId) {
      const m = String(forceId).match(/(\d+)$/);
      if (m) state.nextApprovalId = Math.max(state.nextApprovalId, Number(m[1]) + 1);
    }
    const req = state.session?.username || "operator";
    const role = roleLabel(state.session?.role || "Operator");
    const meta = APPROVAL_META[type] || { risk: "MEDIUM" };
    const rec = { id, type, requester: req, requesterRole: role, status: "pending", risk: meta.risk, reason, payload: payload || {}, timeline: [
      { tone: "info", title: `created / ${req} (${role})`, time: nowLong() }
    ]};
    state.approvals[id] = rec;
    return rec;
  }

  function addApprovalRows(rec) {
    addPendingRow(rec);
    addMyRow(rec);
  }

  function addPendingRow(rec, opts = {}) {
    const body = dom.approvalPendingTable?.tBodies?.[0];
    if (!body || body.querySelector(`[data-approval-id="${escSel(rec.id)}"]`)) return;
    const tr = document.createElement("tr");
    tr.dataset.approvalRow = "";
    tr.dataset.approvalId = rec.id;
    tr.dataset.approvalType = rec.type;
    tr.dataset.approvalRequester = rec.requester;
    tr.dataset.approvalStatus = rec.status;
    tr.innerHTML = `<td class="mono">${escHtml(rec.id)}</td><td>${escHtml((APPROVAL_META[rec.type] || { label: rec.type }).label)}</td><td>${escHtml(rec.requester)}</td><td>${riskChipHtml(rec.risk)}</td><td>${escHtml(rec.reason)}</td><td>${escHtml(opts.ttlText || "24.0h 残")}</td><td><span class="chip chip-warning approval-status-chip">pending</span></td><td><div class="inline-actions"><button class="btn btn-mini btn-soft" data-approval-select="${escHtml(rec.id)}">詳細</button><button class="btn btn-mini btn-success-soft" data-open-modal="approval-action" data-approval-op="approve" data-approval-id="${escHtml(rec.id)}">承認</button><button class="btn btn-mini btn-danger-soft" data-open-modal="approval-action" data-approval-op="reject" data-approval-id="${escHtml(rec.id)}">拒否</button></div></td>`;
    body.prepend(tr);
  }

  function addMyRow(rec, opts = {}) {
    const body = dom.approvalMyTable?.tBodies?.[0];
    if (!body || [...body.rows].some((r) => rowApId(r) === rec.id)) return;
    const tr = document.createElement("tr");
    tr.dataset.myApprovalRow = "";
    tr.dataset.approvalId = rec.id;
    tr.dataset.approvalStatus = rec.status;
    tr.innerHTML = `<td class="mono">${escHtml(rec.id)}</td><td>${escHtml(rec.type)}</td><td>${statusChipHtml(rec.status || "pending")}</td><td>${escHtml(rec.reason)}</td><td>${escHtml(opts.createdText || nowShort())}</td><td>${(rec.status || "pending") === "pending" ? `<button class="btn btn-mini btn-danger-soft" data-open-modal="approval-action" data-approval-op="cancel" data-approval-id="${escHtml(rec.id)}">キャンセル</button>` : `<button class="btn btn-mini btn-soft" data-approval-select="${escHtml(rec.id)}">詳細</button>`}</td>`;
    body.prepend(tr);
  }

  function addHistoryRow(rec, approver, opts = {}) {
    const body = dom.approvalHistoryTable?.tBodies?.[0];
    if (!body || [...body.rows].some((r) => rowApId(r) === rec.id)) return;
    const tr = document.createElement("tr");
    tr.dataset.historyRow = "";
    tr.dataset.approvalId = rec.id;
    tr.dataset.historyStatus = rec.status;
    tr.innerHTML = `<td>${escHtml(opts.timeText || nowShort())}</td><td>${escHtml(rec.type)}</td><td>${escHtml(rec.requester)}</td><td>${escHtml(approver || "-")}</td><td>${statusChipHtml(rec.status)}</td><td><button class="btn btn-mini btn-soft" data-approval-select="${escHtml(rec.id)}">詳細</button></td>`;
    body.prepend(tr);
  }

  function riskChipHtml(r) {
    const s = String(r || "MEDIUM").toUpperCase();
    const c = s === "CRITICAL" ? "chip-critical" : s === "HIGH" ? "chip-high" : s === "MEDIUM" ? "chip-medium" : "chip-low";
    return `<span class="chip chip-risk ${c}">${escHtml(s)}</span>`;
  }
  function statusChipHtml(s) {
    const v = String(s || "pending").toLowerCase();
    const c = ["approved", "executed", "success"].includes(v) ? "chip-success" : ["pending", "attempt"].includes(v) ? "chip-warning" : ["rejected", "denied", "failure", "execution_failed"].includes(v) ? "chip-danger" : ["expired", "cancelled", "disabled"].includes(v) ? "chip-muted" : "chip-outline";
    return `<span class="chip ${c}">${escHtml(v)}</span>`;
  }

  function openModalByName(name, trigger) {
    if (name === "cron-delete") {
      return openConfirm(`Cronジョブ ${trigger.dataset.cronId || ""} の削除申請を作成しますか？`, () => {
        void submitCronDeleteRequest(trigger.dataset.cronId || "");
      });
    }
    const map = { "cron-add": "cronAddTemplate", "user-add": "userAddTemplate", "approval-action": "approvalActionTemplate", "service-stop": "serviceStopTemplate" };
    const tpl = byId(map[name]);
    if (!(tpl instanceof HTMLTemplateElement)) return toast(`テンプレート未検出: ${name}`, "error");
    dom.modalLayer.innerHTML = "";
    dom.modalLayer.appendChild(tpl.content.cloneNode(true));
    dom.modalLayer.classList.add("active");
    if (name === "service-stop") {
      const inp = dom.modalLayer.querySelector('input[name="service"]');
      if (inp) inp.value = trigger.dataset.serviceName || inp.value || "nginx";
    }
    if (name === "approval-action") setupApprovalActionModal(trigger.dataset.approvalOp, trigger.dataset.approvalId);
  }

  async function submitCronToggleRequest(id, rowEl) {
    if (state.session && state.api) {
      const currentEnabled = !String(rowEl?.querySelector("[data-cron-status]")?.textContent || "").toLowerCase().includes("disabled");
      try {
        const live = await state.api.tryLive(
          () => state.api.api.cron.toggle(id, { enabled: !currentEnabled, reason: `Cronジョブ ${id} の有効/無効切替` }),
          { op: "cron.toggle" }
        );
        if (live.live && live.data) {
          const res = normalizeCronApprovalPending(live.data);
          const rec = createApproval({ type: "cron_modify", reason: `Cronジョブ ${id} の切替`, payload: { cron_id: id, action: "toggle" }, forceId: res.request_id || undefined });
          addApprovalRows(rec);
          const chip = rowEl?.querySelector("[data-cron-status]");
          if (chip) { chip.className = "chip chip-warning"; chip.textContent = "Pending"; }
          syncApprovalUI();
          toast(res.message || `切替申請を作成しました: ${rec.id}`, "success");
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") { toast(explainApiError(err).message, "error"); return; }
      }
    }
    const rec = createApproval({ type: "cron_modify", reason: `Cronジョブ ${id} の切替`, payload: { cron_id: id, action: "toggle" } });
    addApprovalRows(rec);
    const chip = rowEl?.querySelector("[data-cron-status]");
    if (chip) { chip.className = "chip chip-warning"; chip.textContent = "Pending"; }
    syncApprovalUI();
    toast(`切替申請を作成しました: ${rec.id}`, "success");
  }

  async function submitCronDeleteRequest(id) {
    if (state.session && state.api) {
      try {
        const live = await state.api.tryLive(
          () => state.api.api.cron.delete(id, `Cronジョブ ${id} の削除申請`),
          { op: "cron.delete" }
        );
        if (live.live && live.data) {
          const res = normalizeCronApprovalPending(live.data);
          const rec = createApproval({ type: "cron_modify", reason: `Cronジョブ ${id} の削除申請`, payload: { cron_id: id, action: "delete" }, forceId: res.request_id || undefined });
          addApprovalRows(rec); syncApprovalUI(); toast(res.message || `削除申請を作成しました: ${rec.id}`, "success");
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") { toast(explainApiError(err).message, "error"); return; }
      }
    }
    const rec = createApproval({ type: "cron_modify", reason: `Cronジョブ ${id} の削除申請`, payload: { cron_id: id, action: "delete" } });
    addApprovalRows(rec); syncApprovalUI(); toast(`削除申請を作成しました: ${rec.id}`, "success");
  }

  function setupApprovalActionModal(op, id) {
    const rec = state.approvals[id];
    txt(dom.modalLayer.querySelector("[data-approval-modal-id]"), id || "-");
    txt(dom.modalLayer.querySelector("[data-approval-modal-op]"), op || "-");
    txt(dom.modalLayer.querySelector("[data-approval-modal-label]"), op === "reject" ? "拒否理由 *" : op === "cancel" ? "キャンセル理由" : "承認コメント");
    const ta = dom.modalLayer.querySelector("[data-approval-modal-textarea]");
    if (ta) {
      ta.required = op === "reject";
      ta.placeholder = op === "reject" ? "拒否理由を入力してください。" : "コメント（任意）";
      ta.value = op === "approve" && rec ? `確認済み: ${(APPROVAL_META[rec.type] || { label: rec.type }).label}` : "";
    }
    const idIn = dom.modalLayer.querySelector('input[name="approvalId"]');
    const opIn = dom.modalLayer.querySelector('input[name="op"]');
    if (idIn) idIn.value = id || "";
    if (opIn) opIn.value = op || "";
    const sb = dom.modalLayer.querySelector("[data-approval-modal-submit]");
    if (sb) sb.textContent = op === "reject" ? "拒否する" : op === "cancel" ? "キャンセルする" : "承認する";
  }

  function openConfirm(msg, fn) {
    state.confirmFn = fn;
    const tpl = byId("confirmTemplate");
    if (!(tpl instanceof HTMLTemplateElement)) return;
    dom.modalLayer.innerHTML = "";
    dom.modalLayer.appendChild(tpl.content.cloneNode(true));
    dom.modalLayer.classList.add("active");
    txt(dom.modalLayer.querySelector("#confirmMessage"), msg);
  }

  function closeModal() {
    dom.modalLayer?.classList.remove("active");
    if (dom.modalLayer) dom.modalLayer.innerHTML = "";
    state.confirmFn = null;
  }

  function modalMsg(form, msg, tone) {
    setMsg(form.querySelector("[data-modal-message]"), msg, tone);
  }

  async function submitCronAdd(form) {
    const fd = new FormData(form);
    const schedule = (fd.get("schedule") || "").toString().trim();
    const cmd = (fd.get("command") || "").toString().trim();
    const args = (fd.get("arguments") || "").toString().trim();
    const reason = (fd.get("reason") || "").toString().trim();
    if (!validateCronSchedule(schedule)) return modalMsg(form, "Cron式が不正、または毎分実行は禁止です。", "error");
    if (!CRON_ALLOW.has(cmd)) return modalMsg(form, "allowlist外コマンドは使用できません。", "error");
    if (!validateCronArguments(args)) return modalMsg(form, "引数に禁止文字が含まれています。", "error");
    if (reason.length < 10) return modalMsg(form, "理由は10文字以上で入力してください。", "error");
    const payload = { schedule, command: cmd, arguments: args, comment: (fd.get("comment") || "").toString().trim(), reason };
    if (state.session && state.api) {
      try {
        const live = await state.api.tryLive(() => state.api.api.cron.create(payload), { op: "cron.create" });
        if (live.live && live.data) {
          const res = normalizeCronApprovalPending(live.data);
          const rec = createApproval({ type: "cron_add", reason, payload, forceId: res.request_id || undefined });
          addApprovalRows(rec); closeModal(); syncApprovalUI(); selectApproval(rec.id); void refreshApprovalsFromApi(); toast(res.message || `Cron追加申請を作成しました: ${rec.id}`, "success");
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") return modalMsg(form, explainApiError(err).message, "error");
      }
    }
    const rec = createApproval({ type: "cron_add", reason, payload });
    addApprovalRows(rec); closeModal(); syncApprovalUI(); selectApproval(rec.id); toast(`Cron追加申請を作成しました: ${rec.id}`, "success");
  }

  async function submitUserAdd(form) {
    const fd = new FormData(form);
    const u = (fd.get("username") || "").toString().trim();
    const sh = (fd.get("shell") || "").toString().trim();
    const pw = (fd.get("password") || "").toString();
    const cf = (fd.get("confirm") || "").toString();
    const groups = (fd.get("groups") || "").toString().split(",").map((s) => s.trim()).filter(Boolean);
    const home = (fd.get("home") || "").toString().trim();
    const reason = (fd.get("reason") || "").toString().trim();
    if (!validateUsername(u)) return modalMsg(form, "username形式が不正です。", "error");
    if (!ALLOWED_SHELLS.has(sh)) return modalMsg(form, "許可されていない shell です。", "error");
    if (pw !== cf) return modalMsg(form, "パスワード確認が一致しません。", "error");
    if (!validateStrongPassword(pw, u)) return modalMsg(form, "パスワードポリシーを満たしていません。", "error");
    if (groups.some((g) => !validateUsername(g))) return modalMsg(form, "group 名形式が不正です。", "error");
    if (groups.some((g) => FORBIDDEN_GROUPS.has(g))) return modalMsg(form, "禁止グループが含まれます。", "error");
    if (reason.length < 10) return modalMsg(form, "理由は10文字以上で入力してください。", "error");
    if (state.session && state.api) {
      try {
        const live = await state.api.tryLive(
          () => state.api.api.users.create({ username: u, password: pw, groups, home_dir: home, shell: sh, reason }),
          { op: "users.create" }
        );
        if (live.live && live.data) {
          const d = live.data?.data ?? live.data;
          const approvalId = d.request_id || d.approval_id || null;
          const rec = createApproval({ type: "user_add", reason, payload: { username: u, shell: sh, groups, home }, forceId: approvalId || undefined });
          addApprovalRows(rec); closeModal(); syncApprovalUI(); selectApproval(rec.id); void refreshApprovalsFromApi(); toast(d.message || `ユーザー追加申請を作成しました: ${rec.id}`, "success");
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") {
          return modalMsg(form, explainApiError(err).message, "error");
        }
      }
    }
    const rec = createApproval({ type: "user_add", reason, payload: { username: u, shell: sh, groups, home } });
    addApprovalRows(rec); closeModal(); syncApprovalUI(); selectApproval(rec.id); toast(`ユーザー追加申請を作成しました: ${rec.id}`, "success");
  }

  async function submitServiceStop(form) {
    const fd = new FormData(form);
    const service = (fd.get("service") || "").toString().trim();
    const reason = (fd.get("reason") || "").toString().trim();
    if (!service) return modalMsg(form, "service 名を確認してください。", "error");
    if (reason.length < 10) return modalMsg(form, "理由は10文字以上で入力してください。", "error");
    if (state.session && state.api) {
      try {
        const live = await state.api.tryLive(
          () => state.api.api.approvals.create({ request_type: "service_stop", payload: { service }, reason }),
          { op: "approval.request.service_stop" }
        );
        if (live.live && live.data) {
          const d = live.data?.data ?? live.data;
          const rec = createApproval({ type: "service_stop", reason, payload: { service }, forceId: d.request_id || undefined });
          addApprovalRows(rec); closeModal(); syncApprovalUI(); selectApproval(rec.id); void refreshApprovalsFromApi(); toast(d.message || `サービス停止申請を作成しました: ${rec.id}`, "success");
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") return modalMsg(form, explainApiError(err).message, "error");
      }
    }
    const rec = createApproval({ type: "service_stop", reason, payload: { service } });
    addApprovalRows(rec); closeModal(); syncApprovalUI(); selectApproval(rec.id); toast(`サービス停止申請を作成しました: ${rec.id}`, "success");
  }

  async function submitApprovalAction(form) {
    const fd = new FormData(form);
    const id = (fd.get("approvalId") || "").toString();
    const op = (fd.get("op") || "").toString();
    const msg = (fd.get("message") || "").toString().trim();
    const rec = state.approvals[id];
    if (!rec) return modalMsg(form, "承認IDが見つかりません。", "error");
    if (!["approve", "reject", "cancel"].includes(op)) return modalMsg(form, "不正な操作です。", "error");
    if (op === "reject" && msg.length < 3) return modalMsg(form, "拒否理由を入力してください。", "error");
    const actor = state.session?.username || "operator";
    if ((op === "approve" || op === "reject") && actor === rec.requester) return modalMsg(form, "自己承認は禁止です。", "error");
    if (state.session && state.api) {
      try {
        const fn = op === "approve" ? state.api.api.approvals.approve
          : op === "reject" ? state.api.api.approvals.reject
          : state.api.api.approvals.cancel;
        const payload = op === "approve" ? { comment: msg || undefined } : { reason: msg || undefined };
        const live = await state.api.tryLive(() => fn(id, payload), { op: `approval.${op}` });
        if (live.live && live.data) {
          const mapped = normalizeApprovalActionResponse(live.data, op === "approve" ? "approved" : op === "reject" ? "rejected" : "cancelled");
          rec.status = mapped.next_status;
          rec.timeline.push({ tone: op === "approve" ? "success" : "warning", title: `${op} / ${actor} (${roleLabel(state.session?.role)})${msg ? ` - ${msg}` : ""}`, time: nowLong() });
          if (["approved", "rejected", "executed", "expired", "cancelled"].includes(rec.status)) addHistoryRow(rec, actor);
          syncApprovalUI();
          renderApprovalDetail(rec);
          closeModal();
          void refreshApprovalsFromApi();
          toast(mapped.message || `承認操作を実行しました: ${id} → ${rec.status}`, op === "approve" ? "success" : "warning");
          return;
        }
      } catch (err) {
        if (state.api.settings.mode === "live") return modalMsg(form, explainApiError(err).message, "error");
      }
    }
    rec.status = op === "approve" ? "approved" : op === "reject" ? "rejected" : "cancelled";
    rec.timeline.push({ tone: op === "approve" ? "success" : "warning", title: `${op} / ${actor} (${roleLabel(state.session?.role)})${msg ? ` - ${msg}` : ""}`, time: nowLong() });
    if (["approved", "rejected", "executed", "expired", "cancelled"].includes(rec.status)) addHistoryRow(rec, actor);
    syncApprovalUI();
    renderApprovalDetail(rec);
    closeModal();
    toast(`承認操作を実行しました: ${id} → ${rec.status}`, op === "approve" ? "success" : "warning");
  }

  function strongPw(pw, username) { return validateStrongPassword(pw, username); }

  function openDraftReset() { applyDraftDefaults(); renderDraftPreview(); }

  function hash(s) {
    let h = 0;
    for (let i = 0; i < s.length; i += 1) h = ((h << 5) - h) + s.charCodeAt(i) | 0;
    return h;
  }

})();

</script>
</body>
</html>
